<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metal Workout Builder</title>

<style>
  :root {
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#ffffff;
    --card:#f1f5f9;
    --pill:#e8eeff;
  }

  body {
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro", Segoe UI, Roboto, sans-serif;
    margin:0; padding:0;
    background:var(--bg);
    color:var(--ink);
  }

  .container { padding:24px; max-width:480px; margin:auto; }

  .weather { font-size:15px; color:var(--sub); display:flex; gap:6px; margin-bottom:20px; }

  h1 { font-size:28px; font-weight:700; margin:0 0 22px; }

  .card {
    background:var(--card);
    padding:20px;
    border-radius:16px;
    margin-bottom:20px;
    font-size:18px;
  }

  .card-title { font-weight:600; font-size:18px; margin-bottom:8px; display:flex; gap:8px; }

  .type-list div { font-size:16px; margin:4px 0; display:flex; gap:8px; }

  .weighted-label {
    background:#e0ecff;
    color:#2453f5;
    padding:2px 8px;
    border-radius:8px;
    font-size:12px;
  }

  #countdownBox {
    width:100%;
    margin-top:40px;
    text-align:center;
    font-size:18px;
    color:var(--sub);
  }

  .fab {
    position:fixed;
    bottom:20px; left:50%; transform:translateX(-50%);
    width:90%;
    background:var(--brand);
    color:#fff;
    height:56px;
    border:none;
    border-radius:28px;
    font-size:20px;
    font-weight:600;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
  }

  .fab[disabled] {
    opacity:0.5;
    cursor:not-allowed;
  }
</style>
</head>
<body>
<div class="container">

  <div class="weather" id="weather">Enable location for weather</div>

  <h1>Hi Jy, welcome back</h1>

  <div id="cards"></div>

  <div id="countdownBox"></div>

</div>

<button class="fab" id="createBtn">Create Workout</button>

<script>
/* --------------------------------------------------------
   DEV MODE TOGGLE
---------------------------------------------------------*/
const urlParams = new URLSearchParams(window.location.search);
const DEV_MODE = urlParams.get("dev") === "true";  
// const DEV_MODE = true; // manual switch if needed

/* Fake date override for DEV MODE */
if (DEV_MODE) {
  console.log("DEV MODE ENABLED â€” Time forced to 18:00 and unlimited workouts allowed.");

  const RealDate = Date;
  Date = class extends RealDate {
    constructor(...args) {
      if (args.length === 0) {
        return new RealDate("2025-01-01T18:00:00");
      }
      return new RealDate(...args);
    }
  };
}

/* --------------------------------------------------------
   TIME SETTINGS
---------------------------------------------------------*/
const OPEN_HOUR = 17;
const OPEN_MIN = 30;
const RESET_HOUR = 23;
const RESET_MIN = 0;

/* --------------------------------------------------------
   HELPERS
---------------------------------------------------------*/
function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
function chance(p) { return Math.random() < p; }
function now() { return new Date(); }

/* --------------------------------------------------------
   WEATHER EMOJI SYSTEM
---------------------------------------------------------*/
function weatherCodeToText(code) {
  if (code === 0) return "Clear";
  if ([1,2,3].includes(code)) return "Cloudy";
  if ([45,48].includes(code)) return "Fog";
  if ([51,53,55].includes(code)) return "Drizzle";
  if ([61,63,65].includes(code)) return "Rain";
  if ([66,67].includes(code)) return "Freezing rain";
  if ([71,73,75].includes(code)) return "Snow";
  if ([95].includes(code)) return "Thunderstorm";
  return "Weather";
}

function weatherEmoji(condition) {
  switch(condition) {
    case "Clear": return "â˜€ï¸";
    case "Cloudy": return "â›…ï¸";
    case "Fog": return "ðŸŒ«ï¸";
    case "Drizzle": return "ðŸŒ¦ï¸";
    case "Rain": return "ðŸŒ§ï¸";
    case "Freezing rain": return "ðŸ§ŠðŸŒ§ï¸";
    case "Snow": return "â„ï¸";
    case "Thunderstorm": return "â›ˆï¸";
    default: return "ðŸŒ¡ï¸";
  }
}

async function updateWeatherUI() {
  const el = document.getElementById("weather");

  if (!navigator.geolocation) {
    el.textContent = "Location unavailable";
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    try {
      const { latitude, longitude } = pos.coords;

      const weatherRes = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`
      );
      const weatherData = await weatherRes.json();

      const rev = await fetch(
        `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`
      );
      const loc = await rev.json();

      const city = loc.address.city || loc.address.town || loc.address.village || "Your area";
      const temp = weatherData.current_weather.temperature;
      const condition = weatherCodeToText(weatherData.current_weather.weathercode);
      const emoji = weatherEmoji(condition);

      el.textContent = `${emoji} ${temp}Â°C ${city}`;
    } catch (e) {
      el.textContent = "Weather unavailable";
    }
  });
}

updateWeatherUI();

/* --------------------------------------------------------
   METAL TYPES
---------------------------------------------------------*/
const metalTypes = ["Metacon", "EMOM", "Tabata", "AMRAP", "Ladder"];

function generateMetalTypes(minCount, maxCount) {
  const count = Math.random() < 0.5 ? minCount : maxCount;
  let out = [];
  for (let i = 0; i < count; i++) {
    let m = pick(metalTypes);
    let weighted = chance(0.2);
    out.push({ name:m, weighted });
  }
  return out;
}

/* --------------------------------------------------------
   WORKOUT GENERATOR
---------------------------------------------------------*/
function generateWorkout() {
  const isFullBody = chance(0.5);

  let workout = { mode: isFullBody ? "full" : "split", blocks: [] };

  if (isFullBody) {
    workout.blocks.push({
      title:"ðŸ”¥ Full Body",
      abs:false,
      types:generateMetalTypes(2,3)
    });
  } else {
    workout.blocks.push({
      title:"ðŸ’ª Upper Body",
      abs:chance(0.5),
      types:generateMetalTypes(1,2)
    });
    workout.blocks.push({
      title:"ðŸ¦µ Lower Body",
      abs:chance(0.5),
      types:generateMetalTypes(1,2)
    });
  }

  return workout;
}

/* --------------------------------------------------------
   STORAGE
---------------------------------------------------------*/
function saveWorkout(w) { localStorage.setItem("workout", JSON.stringify(w)); }
function loadWorkout() { return JSON.parse(localStorage.getItem("workout") || "null"); }
function clearWorkout() { localStorage.removeItem("workout"); }

/* --------------------------------------------------------
   TIME LOGIC
---------------------------------------------------------*/
function isOpenWindow() {
  if (DEV_MODE) return true;

  const t = now();

  const afterOpen =
    t.getHours() > OPEN_HOUR ||
    (t.getHours() === OPEN_HOUR && t.getMinutes() >= OPEN_MIN);

  const beforeReset =
    t.getHours() < RESET_HOUR ||
    (t.getHours() === RESET_HOUR && t.getMinutes() < RESET_MIN);

  return afterOpen && beforeReset;
}

function checkForDailyReset() {
  if (DEV_MODE) return;
  const t = now();
  if (t.getHours() === RESET_HOUR && t.getMinutes() === RESET_MIN) {
    clearWorkout();
  }
}

/* --------------------------------------------------------
   COUNTDOWN
---------------------------------------------------------*/
function updateCountdown() {
  const box = document.getElementById("countdownBox");

  if (DEV_MODE) {
    box.textContent = "";
    return;
  }

  if (isOpenWindow()) {
    box.textContent = "";
    return;
  }

  const t = now();
  let target = new Date();
  target.setHours(OPEN_HOUR, OPEN_MIN, 0, 0);

  if (t > target) target.setDate(target.getDate() + 1);

  const diff = target - t;
  let sec = Math.floor(diff / 1000);
  let hrs = Math.floor(sec / 3600); sec %= 3600;
  let mins = Math.floor(sec / 60); sec %= 60;

  box.textContent = `Workout opens in: ${hrs}h ${mins}m ${sec}s`;
}

/* --------------------------------------------------------
   RENDER
---------------------------------------------------------*/
function renderWorkout(w) {
  const container = document.getElementById("cards");
  container.innerHTML = "";

  if (!w) return;

  w.blocks.forEach(b => {
    const div = document.createElement("div");
    div.className = "card";

    const title = document.createElement("div");
    title.className = "card-title";
    title.textContent = b.title + (b.abs ? " + Abs" : "");
    div.appendChild(title);

    const list = document.createElement("div");
    list.className = "type-list";

    b.types.forEach(t => {
      const row = document.createElement("div");
      row.textContent = t.name;

      if (t.weighted) {
        const span = document.createElement("span");
        span.className = "weighted-label";
        span.textContent = "Weighted";
        row.appendChild(span);
      }

      list.appendChild(row);
    });

    div.appendChild(list);
    container.appendChild(div);
  });
}

/* --------------------------------------------------------
   BUTTON STATE
---------------------------------------------------------*/
function updateButtonState() {
  const btn = document.getElementById("createBtn");
  const saved = loadWorkout();

  if (DEV_MODE) {
    btn.style.display = "flex";
    btn.disabled = false;
    btn.textContent = "Create Workout (DEV)";
    return;
  }

  if (!isOpenWindow()) {
    btn.disabled = true;
    btn.textContent = "Locked";
    return;
  }

  if (saved) {
    btn.style.display = "none";
  } else {
    btn.style.display = "flex";
    btn.disabled = false;
    btn.textContent = "Create Workout";
  }
}

/* --------------------------------------------------------
   CREATE BUTTON
---------------------------------------------------------*/
document.getElementById("createBtn").addEventListener("click", () => {
  const w = generateWorkout();
  saveWorkout(w);
  renderWorkout(w);
  updateButtonState();
});

/* --------------------------------------------------------
   INIT
---------------------------------------------------------*/
function init() {
  const saved = loadWorkout();
  if (saved) renderWorkout(saved);

  updateButtonState();
  updateCountdown();
  setInterval(updateCountdown, 1000);
  setInterval(checkForDailyReset, 60000);
}

init();

</script>
</body>
</html>
