<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metal Workout Builder</title>

<style>
  :root {
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#ffffff;
    --card:#f8f9fb;
    --pill:#e8eeff;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro", Segoe UI, Roboto, sans-serif;
    background: var(--bg);
    color: var(--ink);
    margin: 0;
  }

  .container {
    padding: 24px;
    max-width: 500px;
    margin: auto;
  }

  .weather {
    font-size: 15px;
    color: var(--sub);
    margin-bottom: 16px;
  }

  h1 {
    font-size: 28px;
    font-weight: 700;
    margin: 0;
    margin-bottom: 20px;
  }

  /* -------------------------------------------------------
     AI GLOW STAGE
  ------------------------------------------------------- */
  .ai-stage {
    position: relative;
    height: 160px;
    margin-top: 8px;
    margin-bottom: 16px;
    display: none;
    border-radius: 100%;
    overflow: visible;
  }

  .ai-stage::before {
    content:"";
    position:absolute;
    inset:-20% -15% -20% -15%;
    filter: blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    transition:opacity .25s ease;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode: screen;
    animation: meshBreath 2s ease-in-out infinite,
               meshDrift 3s ease-in-out infinite;
  }

  .ai-stage.show::before {
    opacity: .9;
  }

  @keyframes meshBreath {
    0%,100% { transform:scale(1); opacity:.7 }
    50%     { transform:scale(1.03); opacity:.3 }
  }

  @keyframes meshDrift {
    0% { transform:translate3d(0,0,0); }
    50% { transform:translate3d(2%,-1.5%,0); }
    100% { transform:translate3d(0,0,0); }
  }

  /* -------------------------------------------------------
     WORKOUT CARD
  ------------------------------------------------------- */
  #output {
    margin-top: 12px;
    display: none;
  }

  .workout-card {
    background: var(--card);
    border-radius: 16px;
    padding: 20px;
  }

  .section-title {
    font-weight: 700;
    font-size: 17px;
    margin-bottom: 4px;
  }

  .type {
    font-size: 16px;
    color: var(--sub);
    margin-bottom: 12px;
  }

  .pill {
    background: var(--pill);
    color: var(--brand);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  hr {
    border: none;
    border-bottom: 1px solid #e2e8f0;
    margin: 12px 0;
  }

  /* -------------------------------------------------------
     CREATE BUTTON
  ------------------------------------------------------- */
  .create-btn {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 48px);
    max-width: 480px;
    height: 56px;
    background: var(--brand);
    color: #fff;
    border: none;
    border-radius: 28px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
  }
  .create-btn:disabled { opacity:0.7; }
</style>
</head>

<body>
<div class="container">
  <div class="weather" id="weather">Loading weather...</div>

  <h1>Hi Jy, welcome back</h1>

  <div id="aiStage" class="ai-stage"></div>

  <div id="output">
    <div class="workout-card">
      <div id="upperLabel" class="section-title"></div>
      <div id="upperType" class="type"></div>

      <hr>

      <div id="lowerLabel" class="section-title"></div>
      <div id="lowerType" class="type"></div>
    </div>
  </div>
</div>

<button class="create-btn" id="create">Create Workout</button>

<script>
/* ----------------------------------------------------
   DEV MODE
----------------------------------------------------- */
const urlParams = new URLSearchParams(window.location.search);
const DEV = urlParams.get("dev") === "true";

/* ----------------------------------------------------
   SOUND
----------------------------------------------------- */
const Sound = (() => {
  let ctx = null;
  function ensure() {
    if (!ctx) {
      const A = window.AudioContext || window.webkitAudioContext;
      if (!A) return;
      ctx = new A();
    }
    if (ctx.state === "suspended") ctx.resume();
    return ctx;
  }
  document.addEventListener("pointerdown", ensure, { once:true });

  function beep(f=880,d=.15,t="sine",v=.25,w=0){
    if(!ensure())return;
    const T = ctx.currentTime + w;
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type=t;
    o.frequency.setValueAtTime(f,T);
    g.gain.setValueAtTime(0.0001,T);
    g.gain.exponentialRampToValueAtTime(v,T+.02);
    g.gain.exponentialRampToValueAtTime(0.0001,T+d);
    o.connect(g); g.connect(ctx.destination);
    o.start(T); o.stop(T+d+.02);
  }
  return { beep };
})();

/* ----------------------------------------------------
   WORKOUT GENERATOR
----------------------------------------------------- */
const metalTypes=["Metacon","EMOM","Tabata","AMRAP","Ladder"];
const upperLabel=document.getElementById("upperLabel");
const lowerLabel=document.getElementById("lowerLabel");
const upperType=document.getElementById("upperType");
const lowerType=document.getElementById("lowerType");

function pick(a){return a[Math.floor(Math.random()*a.length)];}
function chance(p){return Math.random()<p;}

function saveWorkout(data){
  if(!DEV) localStorage.setItem("workoutData",JSON.stringify(data));
}

function loadWorkout(){
  if(DEV) return null;
  const s=localStorage.getItem("workoutData");
  return s?JSON.parse(s):null;
}

function generateWorkout(){
  const upper=pick(metalTypes);
  const lower=pick(metalTypes.filter(t=>t!==upper));
  const uw=chance(0.2);
  const lw=chance(0.2);

  const upperAbs=chance(0.5);
  const lowerAbs=chance(0.5);

  const upperText=upperAbs?"ðŸ’ª Upper Body + Abs":"ðŸ’ª Upper Body";
  const lowerText=lowerAbs?"ðŸ¦µ Lower Body + Abs":"ðŸ¦µ Lower Body";

  const upperHTML=upper+(uw?` <span class="pill">Weighted</span>`:"");
  const lowerHTML=lower+(lw?` <span class="pill">Weighted</span>`:"");

  upperLabel.innerHTML=upperText;
  lowerLabel.innerHTML=lowerText;
  upperType.innerHTML=upperHTML;
  lowerType.innerHTML=lowerHTML;

  saveWorkout({
    date:todayString(),
    upperText,
    lowerText,
    upperHTML,
    lowerHTML
  });
}

/* ----------------------------------------------------
   TIME + DAILY LOCK
----------------------------------------------------- */
const createBtn=document.getElementById("create");
const aiStage=document.getElementById("aiStage");
const output=document.getElementById("output");

function todayString(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function hasGeneratedToday(){
  if(DEV) return false;
  return localStorage.getItem("generatedDate")===todayString();
}

function lockGeneration(){
  if(!DEV) localStorage.setItem("generatedDate",todayString());
}

function canGenerateNow(){
  if(DEV) return true;
  const now=new Date();
  const limit=new Date();
  limit.setHours(17,30,0,0);
  return now>=limit;
}

function restoreWorkout(){
  if(DEV) return false;
  const data=loadWorkout();
  if(!data || data.date!==todayString()) return false;

  upperLabel.innerHTML=data.upperText;
  lowerLabel.innerHTML=data.lowerText;
  upperType.innerHTML=data.upperHTML;
  lowerType.innerHTML=data.lowerHTML;

  output.style.display="block";
  createBtn.style.display="none";
  return true;
}

function updateButton(){
  if(restoreWorkout()) return;

  if(hasGeneratedToday()){
    createBtn.style.display="none";
    return;
  }

  if(!canGenerateNow()){
    createBtn.disabled=true;
    createBtn.textContent="Available at 5:30 PM";
    createBtn.style.display="block";
  } else {
    createBtn.disabled=false;
    createBtn.textContent=DEV?"Create Workout (DEV)":"Create Workout";
    createBtn.style.display="block";
  }
}

function startGenerate(){
  if(!canGenerateNow() || hasGeneratedToday()) return;

  output.style.display="none";
  aiStage.style.display="block";
  aiStage.classList.add("show");

  createBtn.disabled=true;
  createBtn.textContent=DEV?"Generating (DEV)...":"Generating...";

  setTimeout(()=>{
    generateWorkout();

    aiStage.classList.remove("show");
    aiStage.style.display="none";
    output.style.display="block";

    lockGeneration();

    if(!DEV){
      createBtn.style.display="none";
    } else {
      createBtn.disabled=false;
      createBtn.textContent="Create Workout (DEV)";
    }

    Sound.beep();
  },1000);
}

createBtn.addEventListener("click",startGenerate);

/* ----------------------------------------------------
   WEATHER
----------------------------------------------------- */
async function getWeatherEmoji(c){
  c=c.toLowerCase();
  if(c.includes("clear"))return"â˜€ï¸";
  if(c.includes("cloud"))return"â›…";
  if(c.includes("rain"))return"ðŸŒ§ï¸";
  if(c.includes("drizzle"))return"ðŸŒ¦ï¸";
  if(c.includes("thunder"))return"ðŸŒ©ï¸";
  if(c.includes("snow"))return"â„ï¸";
  if(c.includes("fog")||c.includes("mist"))return"ðŸŒ«ï¸";
  return"ðŸŒ¡ï¸";
}

const mapWeather={
  0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
  45:"Fog",48:"Fog",
  51:"Drizzle",53:"Drizzle",55:"Drizzle",
  61:"Rain",63:"Rain",65:"Rain",
  71:"Snow",73:"Snow",75:"Snow",
  80:"Rain shower",81:"Rain shower",82:"Rain shower",
  95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
};

function weatherCodeToText(code){return mapWeather[code]||"Unknown";}

async function updateWeatherUI(){
  const el=document.getElementById("weather");
  el.textContent="Enable location for weather";

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;

    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res=await fetch(url);
      const data=await res.json();
      const temp=Math.round(data.current_weather.temperature);

      const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
      const r=await rev.json();
      const city=r.address.city||r.address.town||r.address.village||r.address.county||"your area";

      const cond=weatherCodeToText(data.current_weather.weathercode);
      const emoji=await getWeatherEmoji(cond);

      el.innerHTML=`${emoji} ${temp}Â°C ${city}`;

    }catch(e){
      el.textContent="Weather unavailable";
    }
  },()=>{
    el.textContent="Enable location for weather";
  });
}

updateWeatherUI();
updateButton();
</script>
</body>
</html>
