
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<style>
  :root{
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;

    --bg:#f7f8f9;
    --card:#ffffff;

    /* tag palette (all unique) */
    --tag-purple-bg:#ede9fe; --tag-purple-fg:#7c3aed;   /* upper */
    --tag-orange-bg:#ffe6bf; --tag-orange-fg:#d97706;   /* legs */
    --tag-red-bg:#ffe0e0;    --tag-red-fg:#e11d48;      /* fullbody */
    --tag-pink-bg:#ffe4f1;   --tag-pink-fg:#db2777;     /* shoulders */
    --tag-blue-bg:#e4ecff;   --tag-blue-fg:#2453f5;     /* push */
    --tag-yellow-bg:#fff5bf; --tag-yellow-fg:#b45309;   /* cardio */
    --tag-teal-bg:#ccfbf1;   --tag-teal-fg:#0f766e;     /* abs */
    --tag-green-bg:#d9fbe3;  --tag-green-fg:#16a34a;    /* pull */

    --shadow-soft:0 18px 48px rgba(15,23,42,0.16);
    --shadow-subtle:0 10px 22px rgba(15,23,42,0.12);

    --streak-bg:#e5e7eb;
    --streak-fill:#f97316;

    --radius:18px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }

  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased;
    overflow:hidden; /* âœ… kill vertical scroll */
  }

  .app{
    height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  .container{
    width:100%;
    max-width:520px;
    padding:24px;
    padding-bottom:140px; /* space for fixed buttons */
    flex:1;
    display:flex;
    flex-direction:column;
  }

  /* ===== TOP ROW: weather + streak ===== */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-top:6px;
    margin-bottom:18px;
    min-height:28px;
  }
  .weather{
    font-size:14px;
    color:var(--sub);
    opacity:.9;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:58%;
  }

  .streak{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:10px;
    min-width:160px;
  }
  .streak-fire{
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:700;
    color:var(--streak-fill);
    font-variant-numeric:tabular-nums;
  }
  .streak-bar{
    width:100px; /* âœ… requested */
    height:10px;
    border-radius:999px;
    background:var(--streak-bg);
    overflow:hidden;
  }
  .streak-fill{
    height:100%;
    width:0%;
    background:var(--streak-fill);
    transition:width .35s cubic-bezier(.22,.8,.4,1);
  }

  h1{
    font-size:42px;
    line-height:1.05;
    margin:0 0 8px;
    font-weight:800;
    letter-spacing:-.03em;
  }
  .subtitle{
    font-size:20px;
    color:var(--sub);
    margin:0 0 20px;
  }

  /* ===== CENTER AREA ===== */
  .center{
    flex:1;
    position:relative;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding-top:18px; /* card sits a bit higher, like earlier */
    overflow:hidden;
  }

  /* workout card */
  .card{
    width:100%;
    background:var(--card);
    border-radius:26px;
    box-shadow:var(--shadow-soft);
    padding:22px 22px 18px;
    opacity:0;
    transform:translateY(18px) scale(.98);
    transition:opacity .28s ease, transform .28s cubic-bezier(.18,.84,.32,1.12);
  }
  .card.show{
    opacity:1;
    transform:translateY(0) scale(1);
  }
  .card h2{
    margin:0 0 14px;
    font-size:26px;
    font-weight:900;
    letter-spacing:-.02em;
  }
  .rows{
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    font-size:20px;
  }
  .row .label{
    min-width:0;
    flex:1;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .tags{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
    flex-shrink:0;
  }
  .tag{
    padding:6px 12px;
    border-radius:999px;
    font-size:16px;
    font-weight:800;
    line-height:1;
    letter-spacing:-.01em;
    box-shadow:0 0 0 1px rgba(15,23,42,0.04);
    text-transform:lowercase;
  }

  /* tag variants (8 unique) */
  .t-upper{ background:var(--tag-purple-bg); color:var(--tag-purple-fg); }
  .t-legs{ background:var(--tag-orange-bg); color:var(--tag-orange-fg); }
  .t-fullbody{ background:var(--tag-red-bg); color:var(--tag-red-fg); }
  .t-shoulders{ background:var(--tag-pink-bg); color:var(--tag-pink-fg); }
  .t-push{ background:var(--tag-blue-bg); color:var(--tag-blue-fg); }
  .t-cardio{ background:var(--tag-yellow-bg); color:var(--tag-yellow-fg); }
  .t-abs{ background:var(--tag-teal-bg); color:var(--tag-teal-fg); }
  .t-pull{ background:var(--tag-green-bg); color:var(--tag-green-fg); }

  /* ===== SUMMARY overlay (centered, independent of card positioning) ===== */
  .summary{
    position:absolute;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    text-align:center;
    pointer-events:none;
  }
  .summary.show{ display:flex; }

  .engravedNum{
    font-size:150px;
    font-weight:900;
    line-height:1;
    letter-spacing:-.06em;
    color:rgba(15,23,42,0.08);
    text-shadow:
      0 2px 0 rgba(255,255,255,0.7),
      0 -2px 0 rgba(15,23,42,0.05);
    margin:0;
  }
  .engravedText{
    font-size:28px;
    font-weight:800;
    color:rgba(100,116,139,0.85);
    margin-top:14px;
    letter-spacing:-.02em;
  }

  /* ===== AI MESH (generation) ===== */
  .ai-stage{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    width:320px;
    height:320px;
    border-radius:50%;
    display:none;
    pointer-events:none;
    z-index:0;
  }
  .ai-stage::before{
    content:"";
    position:absolute;
    inset:-20% -15% -25% -15%;
    filter:blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    transition:opacity .25s ease;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    animation:meshBreath 2s ease-in-out infinite, meshDrift 3s ease-in-out infinite;
  }
  .ai-stage.show{ display:block; }
  .ai-stage.show::before{ opacity:.9; }

  @keyframes meshBreath{
    0%,100%{ transform:scale(1); opacity:.7 }
    50%{ transform:scale(1.04); opacity:.35 }
  }
  @keyframes meshDrift{
    0%{ transform:translate3d(0,0,0); }
    50%{ transform:translate3d(2%,-1.5%,0); }
    100%{ transform:translate3d(0,0,0); }
  }

  /* keep content above mesh */
  .card, .summary{ z-index:1; }

  /* ===== FIXED ACTIONS ===== */
  .actions{
    position:fixed;
    left:50%;
    bottom:26px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:520px;
    display:flex;
    flex-direction:column;
    gap:14px;
    z-index:5; /* always above page */
  }

  .btn{
    height:66px;
    border-radius:999px;
    border:none;
    font-size:22px;
    font-weight:700; /* keep normal (not too bold) */
    letter-spacing:-.01em;
    cursor:pointer;
    width:100%;
  }
  .btn-primary{
    background:var(--brand);
    color:#fff;
    box-shadow:none; /* âœ… remove shadow */
  }
  .btn-secondary{
    background:#eef1f4;
    color:var(--brand);
    font-weight:800;
  }
  .btn[disabled]{
    opacity:.5;
    pointer-events:none;
  }

  /* ===== SLIDER (replaces buttons during workout) ===== */
  .slide-wrap{
    display:none;
    width:100%;
  }
  .slide-wrap.show{ display:block; }

  .slide-track{
    position:relative;
    height:66px;
    border-radius:999px;
    background:#eef1f4;
    overflow:hidden;
    user-select:none;
    touch-action:none;
    box-shadow:0 10px 22px rgba(15,23,42,0.12);
  }
  .slide-fill{
    position:absolute;
    inset:0;
    border-radius:999px;
    background:linear-gradient(120deg,#2453f5,#4f8cff);
    transform-origin:left center;
    transform:scaleX(0);
    transition:transform .18s ease-out;
  }
  .slide-label{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    font-size:20px;
    font-weight:800;
    letter-spacing:-.01em;
    transition:color .1s ease;
    color:rgba(15,23,42,0.55); /* default */
  }
  .slide-track.filled .slide-label{
    color:#fff; /* âœ… ensure white when filled */
  }
  .slide-track.sliding .slide-label{
    color:#fff; /* âœ… ensure white while sliding */
  }

  .slide-knob{
    position:absolute;
    top:50%;
    left:6px;
    width:54px;
    height:54px;
    border-radius:50%;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 10px 18px rgba(15,23,42,0.18);
    transform:translate(0,-50%);
    touch-action:none;
    transition:transform .18s ease;
  }
  .slide-knob .arrow{
    font-size:22px;
    color:var(--brand);
    font-weight:900;
  }

  /* ===== MODAL (full height) ===== */
  .modal{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.35);
    display:none;
    z-index:20;
  }
  .modal.show{ display:block; }

  .sheet{
    position:absolute;
    inset:0;
    background:#ffffff;
    border-radius:0;
    display:flex;
    flex-direction:column;
  }

  .sheet-header{
    padding:18px 20px 14px;
    border-bottom:1px solid #eef1f4;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .sheet-title{
    font-size:20px;
    font-weight:900;
  }
  .close-btn{
    border:none;
    background:#eef1f4;
    color:var(--ink);
    font-size:16px;
    font-weight:800;
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
  }

  .tabs{
    padding:10px 14px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    border-bottom:1px solid #eef1f4;
  }
  .tab{
    border:none;
    background:#f5f6f8;
    color:var(--ink);
    padding:10px 12px;
    border-radius:999px;
    font-weight:800;
    cursor:pointer;
    font-size:14px;
  }
  .tab.active{
    background:var(--tag-blue-bg);
    color:var(--tag-blue-fg);
  }

  .sheet-body{
    flex:1;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  .list{
    flex:1;
    overflow:auto; /* âœ… scroll only inside */
    padding:14px 16px 22px;
  }

  .item{
    display:flex;
    gap:10px;
    align-items:center;
    padding:12px;
    border:1px solid #eef1f4;
    border-radius:14px;
    margin-bottom:10px;
  }
  .item input[type="text"], .item input[type="number"]{
    height:44px; /* âœ… bigger inputs */
    border-radius:12px;
    border:1px solid #e5e7eb;
    padding:0 12px;
    font-size:16px;
    outline:none;
    width:100%;
  }
  .item .rep{
    width:110px;
    flex:0 0 110px;
  }
  .item .remove{
    flex:0 0 auto;
    border:none;
    background:#ffe0e0;
    color:#e11d48;
    font-weight:900;
    border-radius:12px;
    padding:10px 12px;
    cursor:pointer;
  }

  .add-row{
    padding:14px 16px 18px;
    border-top:1px solid #eef1f4;
    display:flex;
    gap:10px;
  }
  .add-row input{
    height:48px;
    border-radius:14px;
    border:1px solid #e5e7eb;
    padding:0 12px;
    font-size:16px;
    width:100%;
  }
  .add-row .rep{
    width:120px;
    flex:0 0 120px;
  }
  .add-row button{
    border:none;
    background:var(--brand);
    color:#fff;
    font-weight:900;
    border-radius:14px;
    padding:0 16px;
    height:48px;
    cursor:pointer;
  }

  /* small helper */
  .muted{
    color:var(--sub);
    font-size:14px;
    padding:0 16px 10px;
  }

  @media (max-width:430px){
    h1{ font-size:40px; }
    .row{ font-size:19px; }
    .tag{ font-size:15px; padding:6px 11px; }
    .engravedNum{ font-size:140px; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="container">
    <div class="topbar">
      <div class="weather" id="weather">Enable location for weather</div>

      <div class="streak">
        <div class="streak-fire"><span>ðŸ”¥</span><span id="streakCount">0</span></div>
        <div class="streak-bar"><div class="streak-fill" id="streakFill"></div></div>
      </div>
    </div>

    <h1>Welcome back Jy</h1>
    <p class="subtitle">Today's mixed workout</p>

    <div class="center" id="center">
      <div class="ai-stage" id="aiStage"></div>

      <!-- workout card -->
      <div class="card" id="workoutCard" style="display:none;">
        <h2 id="workoutTitle"></h2>
        <div class="rows" id="workoutRows"></div>
      </div>

      <!-- summary overlay -->
      <div class="summary" id="summary">
        <div class="engravedNum" id="weekNum">0</div>
        <div class="engravedText" id="weekText">workouts completed this week</div>
      </div>
    </div>
  </div>

  <!-- fixed actions -->
  <div class="actions">
    <button class="btn btn-primary" id="generateBtn">Generate Workout</button>
    <button class="btn btn-secondary" id="exercisesBtn">Exercises</button>

    <!-- slider replaces buttons during workout -->
    <div class="slide-wrap" id="slideWrap">
      <div class="slide-track" id="slideTrack">
        <div class="slide-fill" id="slideFill"></div>
        <div class="slide-label" id="slideLabel">Slide to Complete</div>
        <div class="slide-knob" id="slideKnob"><span class="arrow">â†’</span></div>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-header">
        <div class="sheet-title">Exercises</div>
        <button class="close-btn" id="closeModal">Close</button>
      </div>

      <div class="tabs" id="tabs"></div>
      <div class="muted">Reps are used for <b>As Many Rounds As Possible</b>. Metabolic Conditioning ignores reps.</div>

      <div class="sheet-body">
        <div class="list" id="list"></div>

        <div class="add-row">
          <input id="newName" type="text" placeholder="Add exercise (e.g. Dips)" />
          <input id="newReps" class="rep" type="number" min="1" step="1" placeholder="Reps" />
          <button id="addBtn">Add</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* ===================== STORAGE KEYS ===================== */
const LS_PREFIX = "jy_workout_";
const k = (s)=> LS_PREFIX + s;

const KEY_WEEK = k("week_key");
const KEY_WEEK_COUNT = k("week_count");
const KEY_STREAK = k("streak");
const KEY_STREAK_COUNTED_WEEK = k("streak_counted_week"); // week_key where streak was incremented
const KEY_ACTIVE_WORKOUT = k("active_workout");
const KEY_EXERCISES = k("exercises");

/* ===================== DATE / WEEK HELPERS ===================== */
function weekKey(d=new Date()){
  // ISO-ish week key (Year-W##)
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

function ensureWeekState(){
  const cur = weekKey();
  const prev = localStorage.getItem(KEY_WEEK);

  let streak = parseInt(localStorage.getItem(KEY_STREAK) || "0", 10) || 0;
  let prevCount = parseInt(localStorage.getItem(KEY_WEEK_COUNT) || "0", 10) || 0;

  if(prev && prev !== cur){
    // week rolled over: if previous week < 3, lose streak
    if(prevCount < 3){
      streak = 0;
      localStorage.setItem(KEY_STREAK, String(streak));
    }
    // reset weekly count
    localStorage.setItem(KEY_WEEK_COUNT, "0");
    localStorage.setItem(KEY_STREAK_COUNTED_WEEK, ""); // allow new increment in new week
  }

  if(!prev) localStorage.setItem(KEY_WEEK, cur);
  if(prev && prev !== cur) localStorage.setItem(KEY_WEEK, cur);

  // also ensure exists
  if(!localStorage.getItem(KEY_WEEK_COUNT)) localStorage.setItem(KEY_WEEK_COUNT, "0");
  if(!localStorage.getItem(KEY_STREAK)) localStorage.setItem(KEY_STREAK, "0");
  if(!localStorage.getItem(KEY_STREAK_COUNTED_WEEK)) localStorage.setItem(KEY_STREAK_COUNTED_WEEK, "");
}

/* ===================== DOM ===================== */
const weatherEl = document.getElementById("weather");

const streakCountEl = document.getElementById("streakCount");
const streakFillEl  = document.getElementById("streakFill");

const aiStage = document.getElementById("aiStage");

const workoutCard = document.getElementById("workoutCard");
const workoutTitle = document.getElementById("workoutTitle");
const workoutRows = document.getElementById("workoutRows");

const summary = document.getElementById("summary");
const weekNum = document.getElementById("weekNum");

const generateBtn = document.getElementById("generateBtn");
const exercisesBtn = document.getElementById("exercisesBtn");

const slideWrap = document.getElementById("slideWrap");
const slideTrack = document.getElementById("slideTrack");
const slideFill = document.getElementById("slideFill");
const slideKnob = document.getElementById("slideKnob");
const slideLabel = document.getElementById("slideLabel");

const modal = document.getElementById("modal");
const closeModalBtn = document.getElementById("closeModal");
const tabsEl = document.getElementById("tabs");
const listEl = document.getElementById("list");
const newName = document.getElementById("newName");
const newReps = document.getElementById("newReps");
const addBtn = document.getElementById("addBtn");

/* ===================== TAGS / COLORS ===================== */
const TAGS = {
  pull:      { class:"t-pull" },
  push:      { class:"t-push" },
  legs:      { class:"t-legs" },
  abs:       { class:"t-abs" },
  cardio:    { class:"t-cardio" },
  fullbody:  { class:"t-fullbody" },
  shoulders: { class:"t-shoulders" },
  upper:     { class:"t-upper" }
};

const TAB_ORDER = ["push","pull","upper","shoulders","legs","abs","cardio","fullbody"];

/* ===================== DEFAULT EXERCISES ===================== */
/* reps are used ONLY for AMRAP. Metacon ignores reps display. */
const DEFAULT_EXERCISES = {
  pull: [
    { name:"Pull-Ups", reps:5 },
    { name:"Chin-Ups", reps:5 },
    { name:"Australian Chin-Ups", reps:10 }
  ],
  push: [
    { name:"Push-Ups", reps:10 },
    { name:"Dips", reps:10 },
    { name:"Decline Push-Ups", reps:10 },
    { name:"Diamond Push-Ups", reps:10 }
  ],
  upper: [
    { name:"Muscle-Up", reps:1 }
  ],
  shoulders: [
    { name:"Pike Push-Ups", reps:10 },
    { name:"Dolphin Push-Ups", reps:10 }
  ],
  legs: [
    { name:"Jumping Squats", reps:15 },
    { name:"Jumping Lunges", reps:15 }
  ],
  abs: [
    { name:"Knee Raises", reps:20 },
    { name:"Full Body Raises", reps:20 },
    { name:"Oblique Twists", reps:10 }
  ],
  cardio: [
    { name:"Jumping Jacks", reps:20 },
    { name:"Mountain Climbers", reps:20 }
  ],
  fullbody: [
    { name:"Burpees", reps:10 },
    { name:"Kettlebell Swings", reps:10 }
  ]
};

function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

function loadExercises(){
  const raw = localStorage.getItem(KEY_EXERCISES);
  if(!raw){
    const init = deepClone(DEFAULT_EXERCISES);
    localStorage.setItem(KEY_EXERCISES, JSON.stringify(init));
    return init;
  }
  try{
    const obj = JSON.parse(raw);
    // ensure any missing tabs are restored
    for(const t of TAB_ORDER){
      if(!obj[t]) obj[t] = [];
    }
    return obj;
  }catch{
    const init = deepClone(DEFAULT_EXERCISES);
    localStorage.setItem(KEY_EXERCISES, JSON.stringify(init));
    return init;
  }
}

function saveExercises(obj){
  localStorage.setItem(KEY_EXERCISES, JSON.stringify(obj));
}

/* ===================== WEEK / STREAK UI ===================== */
function getWeekCount(){
  ensureWeekState();
  return parseInt(localStorage.getItem(KEY_WEEK_COUNT) || "0", 10) || 0;
}
function setWeekCount(n){
  localStorage.setItem(KEY_WEEK_COUNT, String(Math.max(0, n|0)));
}
function getStreak(){
  ensureWeekState();
  return parseInt(localStorage.getItem(KEY_STREAK) || "0", 10) || 0;
}
function setStreak(n){
  localStorage.setItem(KEY_STREAK, String(Math.max(0, n|0)));
}

function renderTopBar(){
  const wk = getWeekCount();
  const streak = getStreak();
  streakCountEl.textContent = String(streak);
  const pct = Math.min(wk / 3, 1) * 100;
  streakFillEl.style.width = pct + "%";
}

function maybeIncrementStreak(){
  const wk = getWeekCount();
  if(wk < 3) return false;

  const cur = weekKey();
  const countedWeek = (localStorage.getItem(KEY_STREAK_COUNTED_WEEK) || "");
  if(countedWeek === cur) return false;

  const s = getStreak() + 1;
  setStreak(s);
  localStorage.setItem(KEY_STREAK_COUNTED_WEEK, cur);
  return true;
}

/* ===================== WORKOUT GEN ===================== */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function workoutTitleFor(type){
  return type === "amrap"
    ? "As Many Rounds As Possible"
    : "Metabolic Conditioning";
}

function buildAMRAP(exByTag){
  // AMRAP shows 3â€“4 items (requested)
  const targetN = randInt(3,4);

  // probability of inclusion for each tag
  const chance = {
    pull: 0.80,
    push: 0.80,
    upper: 0.50,
    shoulders: 0.50,
    legs: 0.50,
    abs: 0.50,
    cardio: 0.50,
    fullbody: 0.50
  };

  // start with inclusion sampling
  let chosenTags = [];
  for(const t of TAB_ORDER){
    if(Math.random() < (chance[t] ?? 0.5)) chosenTags.push(t);
  }

  // If too many, cut down randomly
  chosenTags = shuffle(chosenTags).slice(0, targetN);

  // If too few, fill up with weighted preference (push/pull slightly more likely)
  const fillPool = [];
  TAB_ORDER.forEach(t=>{
    const w = (t==="push"||t==="pull") ? 3 : 2;
    for(let i=0;i<w;i++) fillPool.push(t);
  });

  while(chosenTags.length < targetN){
    const t = pick(fillPool);
    chosenTags.push(t);
  }

  // Allow duplicates naturally (user wants possibility like push+push)
  // Build items
  const items = chosenTags.map(t=>{
    const list = exByTag[t] || [];
    if(!list.length) return null;
    const e = pick(list);
    return { name:e.name, reps: Number(e.reps)||0, tags:[t] };
  }).filter(Boolean);

  // If we somehow got less, fill with random valid
  while(items.length < targetN){
    const t = pick(TAB_ORDER);
    const list = exByTag[t] || [];
    if(!list.length) continue;
    const e = pick(list);
    items.push({ name:e.name, reps:Number(e.reps)||0, tags:[t] });
  }

  // Special case: if exercise belongs to "upper" show tag upper only (not push/pull)
  // You asked "push/pull called upper" â€” so upper is single tag.
  // done already.

  // Ensure reps are present (fallback to 10 if missing)
  items.forEach(it=>{
    if(!it.reps || it.reps < 1) it.reps = 10;
  });

  return { type:"amrap", title: workoutTitleFor("amrap"), items };
}

function buildMETACON(exByTag){
  // Metacon shows ALL categories, but order is randomized every time.
  const tags = shuffle(TAB_ORDER);
  const items = tags.map(t=>{
    const list = exByTag[t] || [];
    const e = list.length ? pick(list) : { name: t[0].toUpperCase()+t.slice(1), reps:0 };
    return { name:e.name, reps:0, tags:[t] };
  });
  return { type:"metacon", title: workoutTitleFor("metacon"), items };
}

function buildWorkout(){
  const exByTag = loadExercises();
  const type = (Math.random() < 0.5) ? "amrap" : "metacon";
  return (type === "amrap") ? buildAMRAP(exByTag) : buildMETACON(exByTag);
}

/* ===================== RENDER ===================== */
function clearWorkoutCard(){
  workoutRows.innerHTML = "";
  workoutCard.classList.remove("show");
  workoutCard.style.display = "none";
}

function renderWorkoutCard(w){
  workoutTitle.textContent = w.title;
  workoutRows.innerHTML = "";

  w.items.forEach(it=>{
    const row = document.createElement("div");
    row.className = "row";

    const label = document.createElement("div");
    label.className = "label";

    if(w.type === "amrap"){
      label.textContent = `${it.reps} ${it.name}`;
    }else{
      label.textContent = it.name; // âœ… no reps for metacon
    }

    const tags = document.createElement("div");
    tags.className = "tags";
    (it.tags || []).forEach(t=>{
      const s = document.createElement("span");
      s.className = `tag ${TAGS[t]?.class || ""}`;
      s.textContent = t;
      tags.appendChild(s);
    });

    row.appendChild(label);
    row.appendChild(tags);

    workoutRows.appendChild(row);
  });

  workoutCard.style.display = "block";
  requestAnimationFrame(()=> workoutCard.classList.add("show"));
}

function showSummary(){
  const wk = getWeekCount();
  weekNum.textContent = String(wk);
  summary.classList.add("show");
}
function hideSummary(){
  summary.classList.remove("show");
}

/* ===================== GENERATE FLOW ===================== */
function setModeIdle(){
  // no active workout: show buttons, hide slider, show summary
  slideWrap.classList.remove("show");
  generateBtn.style.display = "block";
  exercisesBtn.style.display = "block";
  generateBtn.disabled = false;
  exercisesBtn.disabled = false;

  clearWorkoutCard();
  hideMesh();
  hideSummary();
  showSummary(); // always show weekly count on idle
}

function setModeActive(){
  // active workout: show slider only; hide exercise + generate
  generateBtn.style.display = "none";
  exercisesBtn.style.display = "none";
  slideWrap.classList.add("show");
  resetSlider();
  hideSummary();
}

function showMesh(){
  aiStage.classList.add("show");
}
function hideMesh(){
  aiStage.classList.remove("show");
}

function saveActiveWorkout(w){
  localStorage.setItem(KEY_ACTIVE_WORKOUT, JSON.stringify(w));
}
function loadActiveWorkout(){
  const raw = localStorage.getItem(KEY_ACTIVE_WORKOUT);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function clearActiveWorkout(){
  localStorage.removeItem(KEY_ACTIVE_WORKOUT);
}

async function handleGenerate(){
  generateBtn.disabled = true;
  showMesh();

  // hide summary while generating
  hideSummary();

  // slight delay for the mesh animation feel
  setTimeout(()=>{
    const w = buildWorkout();
    saveActiveWorkout(w);

    hideMesh();
    renderWorkoutCard(w);
    setModeActive();
  }, 850);
}

/* ===================== SLIDER ===================== */
let sliding=false;
let startX=0;
let currentX=0;
let maxSlide=0;

function resetSlider(){
  slideTrack.classList.remove("filled","sliding");
  slideKnob.style.transition = "none";
  slideFill.style.transition = "none";

  slideKnob.style.transform = "translate(0,-50%)";
  slideFill.style.transform = "scaleX(0)";

  requestAnimationFrame(()=>{
    const trackRect = slideTrack.getBoundingClientRect();
    const knobRect = slideKnob.getBoundingClientRect();
    const trackW = trackRect.width || 1;
    const knobW = knobRect.width || 54;
    maxSlide = Math.max(0, trackW - knobW - 12);
    slideKnob.style.transition = "transform .2s ease-out";
    slideFill.style.transition = "transform .2s ease-out";
  });
}

slideKnob.addEventListener("pointerdown",(e)=>{
  e.preventDefault();
  sliding=true;
  slideKnob.setPointerCapture(e.pointerId);

  const trackRect = slideTrack.getBoundingClientRect();
  const knobRect = slideKnob.getBoundingClientRect();
  const trackW = trackRect.width || 1;
  const knobW = knobRect.width || 54;
  maxSlide = Math.max(0, trackW - knobW - 12);

  startX = e.clientX;
  currentX = 0;

  slideTrack.classList.add("sliding"); // âœ… makes label white
  slideKnob.style.transition = "none";
  slideFill.style.transition = "none";

  if(navigator.vibrate) navigator.vibrate(6);
});

slideKnob.addEventListener("pointermove",(e)=>{
  if(!sliding) return;
  const dx = e.clientX - startX;
  const x = Math.max(0, Math.min(maxSlide, dx));
  currentX = x;

  const progress = maxSlide === 0 ? 0 : (x / maxSlide);
  slideKnob.style.transform = `translate(${x}px,-50%)`;
  slideFill.style.transform = `scaleX(${progress})`;
});

function endSlide(e){
  if(!sliding) return;
  sliding=false;
  try{ slideKnob.releasePointerCapture(e.pointerId); }catch{}

  slideKnob.style.transition = "transform .22s ease-out";
  slideFill.style.transition = "transform .22s ease-out";

  const progress = maxSlide === 0 ? 0 : (currentX / maxSlide);

  if(progress > 0.92){
    slideKnob.style.transform = `translate(${maxSlide}px,-50%)`;
    slideFill.style.transform = `scaleX(1)`;
    slideTrack.classList.add("filled");
    slideTrack.classList.remove("sliding");
    if(navigator.vibrate) navigator.vibrate(12);
    handleComplete();
  }else{
    slideTrack.classList.remove("filled","sliding");
    slideKnob.style.transform = "translate(0,-50%)";
    slideFill.style.transform = "scaleX(0)";
  }
}
slideKnob.addEventListener("pointerup", endSlide);
slideKnob.addEventListener("pointercancel", endSlide);

/* ===================== COMPLETE (confetti under slider) ===================== */
function confettiFromUnderButton(){
  if(!window.confetti) return;

  // fire from near bottom center (under slider), keep it "coming out"
  const originY = 1.15; // below the viewport bottom edge
  confetti({
    particleCount: 160,
    spread: 90,
    startVelocity: 34,
    scalar: 0.9,
    origin: { x: 0.5, y: originY }
  });
}

function handleComplete(){
  // increment weekly count and maybe streak
  const wk = getWeekCount() + 1;
  setWeekCount(wk);
  maybeIncrementStreak();
  renderTopBar();

  // confetti (under button)
  confettiFromUnderButton();

  // clear active workout + return to idle summary
  clearActiveWorkout();

  // hide card and reset
  workoutCard.classList.remove("show");
  setTimeout(()=>{
    clearWorkoutCard();
    setModeIdle();
  }, 260);
}

/* ===================== MODAL UI ===================== */
let activeTab = "push";
let exercisesCache = loadExercises();

function openModal(){
  exercisesCache = loadExercises();
  modal.classList.add("show");
  renderTabs();
  renderList();
}
function closeModal(){
  modal.classList.remove("show");
  newName.value = "";
  newReps.value = "";
}

function renderTabs(){
  tabsEl.innerHTML = "";
  TAB_ORDER.forEach(t=>{
    const b = document.createElement("button");
    b.className = "tab" + (t===activeTab ? " active" : "");
    b.textContent = t;
    b.addEventListener("click",()=>{
      activeTab = t;
      renderTabs();
      renderList();
    });
    tabsEl.appendChild(b);
  });
}

function renderList(){
  listEl.innerHTML = "";
  const arr = exercisesCache[activeTab] || [];

  arr.forEach((ex, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "item";

    const name = document.createElement("input");
    name.type = "text";
    name.value = ex.name || "";
    name.addEventListener("input",()=>{
      exercisesCache[activeTab][idx].name = name.value;
      saveExercises(exercisesCache);
    });

    const reps = document.createElement("input");
    reps.type = "number";
    reps.min = "1";
    reps.step = "1";
    reps.className = "rep";
    reps.value = (ex.reps ?? "");
    reps.addEventListener("input",()=>{
      exercisesCache[activeTab][idx].reps = Number(reps.value)||0;
      saveExercises(exercisesCache);
    });

    const rm = document.createElement("button");
    rm.className = "remove";
    rm.textContent = "Remove";
    rm.addEventListener("click",()=>{
      exercisesCache[activeTab].splice(idx,1);
      saveExercises(exercisesCache);
      renderList();
    });

    wrap.appendChild(name);
    wrap.appendChild(reps);
    wrap.appendChild(rm);
    listEl.appendChild(wrap);
  });
}

addBtn.addEventListener("click",()=>{
  const name = newName.value.trim();
  const reps = Number(newReps.value) || 0;
  if(!name) return;

  exercisesCache = loadExercises();
  exercisesCache[activeTab] = exercisesCache[activeTab] || [];
  exercisesCache[activeTab].push({ name, reps: reps || 10 });
  saveExercises(exercisesCache);

  newName.value = "";
  newReps.value = "";
  renderList();
});

closeModalBtn.addEventListener("click", closeModal);
modal.addEventListener("click",(e)=>{
  if(e.target === modal) closeModal();
});

/* ===================== WEATHER ===================== */
function weatherCodeToText(code){
  const map={
    0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
    45:"Fog",48:"Fog",51:"Drizzle",53:"Drizzle",55:"Drizzle",
    61:"Rain",63:"Rain",65:"Rain",71:"Snow",73:"Snow",75:"Snow",
    80:"Rain shower",81:"Rain shower",82:"Rain shower",
    95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
  };
  return map[code] || "Weather";
}
function getWeatherEmoji(cond){
  const c=cond.toLowerCase();
  if(c.includes("clear")) return "â˜€ï¸";
  if(c.includes("cloud")) return "â›…";
  if(c.includes("rain")) return "ðŸŒ§ï¸";
  if(c.includes("drizzle")) return "ðŸŒ¦ï¸";
  if(c.includes("thunder")) return "ðŸŒ©ï¸";
  if(c.includes("snow")) return "â„ï¸";
  if(c.includes("fog")||c.includes("mist")) return "ðŸŒ«ï¸";
  return "ðŸŒ¡ï¸";
}
function updateWeatherUI(){
  if(!navigator.geolocation){
    weatherEl.textContent="Location unavailable";
    return;
  }
  weatherEl.textContent="Loading weatherâ€¦";
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res=await fetch(url);
      const data=await res.json();
      const temp=Math.round(data.current_weather.temperature);
      const cond=weatherCodeToText(data.current_weather.weathercode);
      const emoji=getWeatherEmoji(cond);
      let city="Your area";
      try{
        const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const r=await rev.json();
        city=r.address.city||r.address.town||r.address.village||r.address.county||city;
      }catch{}
      weatherEl.textContent=`${emoji} ${temp}Â°C ${city}`;
    }catch{
      weatherEl.textContent="Weather unavailable";
    }
  },()=>{
    weatherEl.textContent="Enable location for weather";
  },{timeout:10000,maximumAge:600000});
}

/* ===================== BOOT ===================== */
function init(){
  ensureWeekState();
  renderTopBar();

  const active = loadActiveWorkout();
  if(active){
    hideSummary();
    renderWorkoutCard(active);
    setModeActive();
  }else{
    setModeIdle();
  }

  // modal triggers
  exercisesBtn.addEventListener("click", openModal);
  generateBtn.addEventListener("click", handleGenerate);

  updateWeatherUI();
}

init();
</script>
</body>
</html>
