<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<!-- =========================================================
     CSS â€” CLEAN, STABLE, POLISHED, ALL ANIMATIONS WORKING
========================================================= -->
<style>
  :root{
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#ffffff;
    --card:#f8fafc;
    --pill-blue:#e4ecff;
    --pill-green:#d9fbe3;
    --pill-orange:#ffe6bf;
    --pill-red:#ffe0e0;
    --pill-purple:#ede9fe;

    --shadow-soft:0 18px 48px rgba(15,23,42,0.16);
    --shadow-subtle:0 8px 18px rgba(15,23,42,0.12);
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased;
  }

  .container{
    max-width:480px;
    margin:0 auto;
    padding:24px;
    padding-bottom:120px;
  }

  .weather{
    font-size:15px;
    color:var(--sub);
    margin-bottom:16px;
    opacity:.95;
    display:flex;
    align-items:center;
    gap:6px;
    transition:opacity .25s ease, transform .25s ease;
  }

  h1{
    font-size:30px;
    font-weight:700;
    margin:0 0 6px;
  }

  /* SUBTITLE ANIMATION */
  #subtitle{
    font-size:17px;
    font-weight:400;
    color:var(--sub);
    margin:0 0 18px;
    position:relative;
    display:inline-block;
    overflow:hidden;
  }
  .subtitle-enter{
    opacity:0; transform:translateY(10px);
  }
  .subtitle-enter-active{
    opacity:1; transform:translateY(0);
    transition:opacity .32s ease, transform .32s cubic-bezier(.18,.84,.32,1.12);
  }
  .subtitle-exit{
    opacity:1; transform:translateY(0);
  }
  .subtitle-exit-active{
    opacity:0; transform:translateY(-10px);
    transition:opacity .32s ease, transform .32s cubic-bezier(.18,.84,.32,1.12);
  }

  /* RADIO ROW */
  #radioRow{
    display:flex;
    gap:22px;
    margin:0 0 6px;
    justify-content:flex-start; /* YOU ASKED THIS */
  }
  .opt{
    position:relative;
    display:flex;
    align-items:center;
    gap:6px;
    font-size:14px;
    color:var(--ink);
    padding:6px 12px;
    border-radius:999px;
    transition:background .2s ease, color .2s ease, transform .16s ease, box-shadow .16s ease;
  }
  .opt input{
    appearance:none;
    width:0; height:0;
    opacity:0; pointer-events:none;
    position:absolute;
  }
  .opt.disabled{
    opacity:.35;
    pointer-events:none;
  }
  .opt.active{
    color:var(--brand);
    font-weight:600;
    background:#e4ecff80;
    box-shadow:0 0 0 1px #e4ecff;
  }
  .opt:active:not(.disabled){
    transform:scale(.97);
    box-shadow:0 0 0 1px rgba(36,83,245,0.22);
  }

  /* PREVIEW CARD */
  .preview-card{
    position:relative;
    width:100%;
    max-width:420px;
    margin:32px auto 24px;
    border-radius:18px;
    background:#ffffff;
    box-shadow:var(--shadow-soft);
    padding:18px 20px;
    opacity:0;
    transform:translateY(26px) scale(.96) rotateX(5deg);
    transition:opacity .32s ease,
               transform .32s cubic-bezier(.18,.84,.32,1.12);
    pointer-events:none;
  }
  .preview-card.show{
    opacity:1;
    transform:translateY(0) scale(1) rotateX(0deg);
  }
  .preview-card.hidden{ display:none; }

  .preview-title{
    font-size:18px;
    font-weight:700;
    margin-bottom:22px; /* EXTRA SPACE YOU WANTED */
  }

  .preview-lines{
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .preview-row{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    gap:8px;
    opacity:0; transform:translateY(6px);
    transition:opacity .28s ease, transform .28s ease;
  }
  .preview-row.show-row{
    opacity:1; transform:translateY(0);
  }

  /* Wireframe shimmer */
  .preview-wire{
    position:relative;
    height:12px;
    width:32%;
    min-width:90px;
    border-radius:6px;
    overflow:hidden;
    background:#f2f3f5;
  }
  .preview-wire::before{
    content:"";
    position:absolute;
    inset:0;
    background:linear-gradient(120deg,
      transparent,
      rgba(255,255,255,0.8),
      transparent);
    transform:translateX(-100%);
    animation:wireShimmer 1.7s linear infinite;
  }
  @keyframes wireShimmer{
    0%{ transform:translateX(-100%); }
    100%{ transform:translateX(100%); }
  }

  /* PREVIEW TAGS */
  .preview-tag{
    padding:4px 10px;
    border-radius:999px;
    font-size:13px;
    font-weight:600;
    white-space:nowrap;
  }
  .preview-tag-weighted{ background:var(--pill-blue); color:var(--brand); }
  .preview-tag-abs{ background:var(--pill-green); color:#22c55e; }
  .preview-tag-shoulders{ background:var(--pill-purple); color:#7c3aed; }
  .preview-tag-biceps{ background:var(--pill-orange); color:#d97706; }
  .preview-tag-kettlebell{ background:var(--pill-red); color:#e11d48; }

  /* AI MESH */
  .ai-stage{
    position:absolute;
    left:50%; top:260px;
    transform:translateX(-50%);
    width:260px; height:260px;
    border-radius:50%;
    display:none; pointer-events:none;
  }
  .ai-stage::before{
    content:"";
    position:absolute;
    inset:-20% -15% -25% -15%;
    filter:blur(84px);
    background:
      radial-gradient(circle at 30% 30%, #3A7BFF66 0%, transparent 60%),
      radial-gradient(circle at 70% 40%, #7DFF5C66 0%, transparent 60%),
      radial-gradient(circle at 50% 70%, #FFA43A66 0%, transparent 60%);
    opacity:0;
    transition:opacity .28s ease;
    animation:meshBreath 2.2s ease-in-out infinite alternate;
  }
  .ai-stage.show::before{
    opacity:.92;
  }
  @keyframes meshBreath{
    0%{ transform:scale(1); }
    100%{ transform:scale(1.05); }
  }

  /* TODAY CARD */
  #card{
    background:var(--card);
    border-radius:16px;
    padding:20px;
    margin-top:4px;
    display:none;
    opacity:0;
    transform:translateY(12px) scale(.98);
    box-shadow:var(--shadow-subtle);
    transition:opacity .3s ease,
               transform .3s cubic-bezier(.18,.84,.32,1.12);
  }
  #card.visible{
    opacity:1;
    transform:translateY(0) scale(1);
  }
  #dayTitle{
    font-size:20px;
    font-weight:700;
    margin-bottom:22px;
  }

  .line{
    font-size:16px;
    margin-bottom:12px;
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    opacity:0; transform:translateY(6px);
    transition:opacity .22s ease, transform .22s ease;
  }
  .line.show-line{
    opacity:1; transform:translateY(0);
  }

  .pill{
    padding:3px 8px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }
  .pill-weighted{ background:var(--pill-blue); color:var(--brand); }
  .pill-abs{ background:var(--pill-green); color:#22c55e; }
  .pill-shoulders{ background:var(--pill-purple); color:#7c3aed; }
  .pill-biceps{ background:var(--pill-orange); color:#d97706; }
  .pill-kettlebell{ background:var(--pill-red); color:#e11d48; }

  /* HISTORY CARD */
  #pastCard{
    background:var(--card);
    border-radius:16px;
    padding:18px 20px;
    margin-top:18px;
    display:none;
    opacity:0;
    transform:translateY(18px) scale(.98);
    box-shadow:var(--shadow-subtle);
    transition:opacity .25s ease,
               transform .25s cubic-bezier(.18,.84,.32,1.12);
  }
  #pastCard.visible{
    opacity:1;
    transform:translateY(0) scale(1);
  }
  .past-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    margin-bottom:16px;
  }
  #pastTitle{
    font-size:18px;
    font-weight:700;
  }
  #pastMeta{
    font-size:14px;
    color:var(--sub);
  }

  /* PAST LINES */
  .past-line{
    font-size:16px;
    margin-bottom:10px;
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }

  /* MAIN BUTTON */
  #mainBtn{
    position:fixed;
    left:50%; bottom:24px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    height:56px;
    border-radius:28px;
    border:none;
    background:var(--brand);
    color:#fff;
    font-size:18px;
    font-weight:600;
    transition:opacity .25s ease,
               transform .16s ease,
               box-shadow .22s ease;
    box-shadow:0 15px 30px rgba(36,83,245,0.35);
  }
  #mainBtn.hidden{ display:none; }
  #mainBtn.disabled{
    opacity:.4;
    pointer-events:none;
    box-shadow:none;
  }
  #mainBtn:active:not(.disabled){
    transform:translateX(-50%) scale(.97);
  }

  /* BIG TIMER */
  #bigTimer{
    position:fixed;
    top:55%;
    left:50%;
    transform:translate(-50%,-50%);
    display:flex;
    gap:1.5rem;
    opacity:0;
    transition:opacity .35s ease;
  }
  #bigTimer.hidden{ display:none; }
  #bigTimer.show{ opacity:1; }

  .t-col{
    display:flex;
    flex-direction:column;
    align-items:center;
    width:72px;
  }
  .t-num{
    font-size:48px;
    font-weight:400;
    font-variant-numeric:tabular-nums;
  }
  .t-label{
    font-size:14px;
    color:var(--sub);
    margin-top:6px;
  }

  /* SLIDE TO COMPLETE */
  .slide-wrap{
    position:fixed;
    left:50%; bottom:24px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
  }
  .slide-wrap.hidden{ display:none; }

  .slide-track{
    height:56px;
    border-radius:999px;
    background:#f7f8f9;
    position:relative;
    overflow:hidden;
    user-select:none;
    touch-action:none;
    box-shadow:0 10px 22px rgba(15,23,42,0.15);
  }
  .slide-fill{
    position:absolute;
    inset:0;
    width:0;
    background:linear-gradient(120deg,#2453f5,#4f8cff);
    border-radius:999px;
    transition:width .18s ease-out;
  }

  .slide-label{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:17px;
    font-weight:600;
    pointer-events:none;
  }
  .slide-label span{
    color:var(--brand);
    animation:slidePulse 1.8s ease-in-out infinite;
  }
  @keyframes slidePulse{
    0%,100%{opacity:.7;}
    50%{opacity:1;}
  }

  .slide-knob{
    position:absolute;
    top:50%; left:4px;
    transform:translate(0,-50%);
    width:48px; height:48px;
    border-radius:50%;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 8px 16px rgba(15,23,42,0.18);
    transition:box-shadow .18s ease;
  }

  .slide-knob .arrow{
    font-size:20px;
    color:var(--brand);
  }
</style>
</head>
<body>

<div class="container">

  <div class="weather">Enable location for weather</div>

  <h1>Welcome back Jy</h1>

  <div id="subtitle">What would you like to train?</div>

  <!-- RADIO ROW -->
  <div id="radioRow">
    <label class="opt" data-mode="pull">
      <input type="radio" name="mode" value="pull"> Pull
    </label>
    <label class="opt" data-mode="push">
      <input type="radio" name="mode" value="push"> Push
    </label>
    <label class="opt" data-mode="legs">
      <input type="radio" name="mode" value="legs"> Legs
    </label>
    <label class="opt" data-mode="full">
      <input type="radio" name="mode" value="full"> Full body
    </label>
  </div>

  <!-- PREVIEW CARD -->
  <div id="previewCard" class="preview-card hidden">
    <div id="previewTitle" class="preview-title"></div>
    <div id="previewLines" class="preview-lines"></div>
  </div>

  <!-- AI LOADING -->
  <div id="aiStage" class="ai-stage"></div>

  <!-- TODAY WORKOUT CARD -->
  <div id="card">
    <div id="dayTitle"></div>
    <div id="lines"></div>
  </div>

  <!-- PAST HISTORY CARD -->
  <div id="pastCard">
    <div class="past-header">
      <div id="pastTitle"></div>
      <div id="pastMeta"></div>
    </div>
    <div id="pastLines"></div>
  </div>

  <!-- TIMER -->
  <div id="bigTimer" class="hidden">
    <div class="t-col">
      <div id="tHours" class="t-num">00</div>
      <div class="t-label">HOURS</div>
    </div>
    <div class="t-col">
      <div id="tMins" class="t-num">00</div>
      <div class="t-label">MINS</div>
    </div>
    <div class="t-col">
      <div id="tSecs" class="t-num">00</div>
      <div class="t-label">SECS</div>
    </div>
  </div>

</div>

<!-- GENERATE BUTTON -->
<button id="mainBtn" class="disabled hidden">Generate</button>

<!-- SLIDE COMPLETE -->
<div id="slideWrap" class="slide-wrap hidden">
  <div class="slide-track">
    <div class="slide-fill"></div>
    <div class="slide-label"><span>Slide To Complete</span></div>
    <div class="slide-knob"><span class="arrow">â†’</span></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- ===================== JS START ===================== -->
<script>
/* ------------------------------------------------------
   CONFIG / HELPERS
------------------------------------------------------ */
const DEV = new URLSearchParams(location.search).get("dev")==="true";

const START_HOUR = 17;
const START_MIN  = 30;

const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function weekKey(){
  const d=new Date();
  const jan1 = new Date(d.getFullYear(),0,1);
  const days = Math.floor((d-jan1)/86400000);
  const week = Math.ceil((days+d.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
}

function getStartTime(tomorrow=false){
  const d=new Date();
  if(tomorrow) d.setDate(d.getDate()+1);
  d.setHours(START_HOUR,START_MIN,0,0);
  return d;
}

function afterStart(){
  if (DEV) return false;   // DEV is ALWAYS locked = you can test history properly
  return new Date() >= getStartTime(false);
}

const WEEKDAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

/* ------------------------------------------------------
   SUBTITLE ANIMATION
------------------------------------------------------ */
function setSubtitle(text){
  const el = qs("#subtitle");
  const old = el.textContent;
  if(old === text) return;

  el.classList.remove("subtitle-enter","subtitle-enter-active");
  el.classList.add("subtitle-exit");
  requestAnimationFrame(()=> el.classList.add("subtitle-exit-active"));

  setTimeout(()=>{
    el.textContent = text;
    el.classList.remove("subtitle-exit","subtitle-exit-active");
    el.classList.add("subtitle-enter");
    requestAnimationFrame(()=> el.classList.add("subtitle-enter-active"));
  },260);
}

/* ------------------------------------------------------
   STORAGE
------------------------------------------------------ */
function resetWeekIfNeeded(){
  const wk = weekKey();
  const prev = localStorage.getItem("jy_weekKey");
  if(wk !== prev){
    localStorage.setItem("jy_weekKey", wk);
    localStorage.removeItem("jy_locks");
    localStorage.removeItem("jy_workoutToday");
    localStorage.removeItem("jy_completedToday");
    localStorage.removeItem("jy_history_week");
  }
}

function loadLocks(){
  try{ return JSON.parse(localStorage.getItem("jy_locks")||"{}"); }
  catch{ return {}; }
}
function saveLocks(obj){
  localStorage.setItem("jy_locks", JSON.stringify(obj));
}

function saveWorkoutToday(data){
  localStorage.setItem("jy_workoutToday", JSON.stringify({
    date: todayKey(),
    data
  }));
}

function loadWorkoutToday(){
  const raw = localStorage.getItem("jy_workoutToday");
  if(!raw) return null;
  try{
    const obj = JSON.parse(raw);
    if(obj.date === todayKey()) return obj.data;
  }catch{}
  return null;
}

function saveCompletedToday(mode){
  localStorage.setItem("jy_completedToday", JSON.stringify({
    date: todayKey(),
    mode
  }));
}

function loadCompletedToday(){
  const raw = localStorage.getItem("jy_completedToday");
  if(!raw) return null;
  try{
    const o = JSON.parse(raw);
    if(o.date === todayKey()) return o;
  }catch{}
  return null;
}

/* WEEK HISTORY */
function saveHistoryForMode(workout){
  const wk = weekKey();
  let data;
  try{
    data = JSON.parse(localStorage.getItem("jy_history_week")||"{}");
  }catch{ data = {}; }

  if(!data || data.week !== wk){
    data = {week:wk, entries:{}};
  }

  const d=new Date();
  const dayName = WEEKDAYS[d.getDay()];

  data.entries[workout.mode] = {
    mode: workout.mode,
    items: workout.items,
    dayName
  };

  localStorage.setItem("jy_history_week", JSON.stringify(data));
}

function loadHistory(){
  try{
    const raw = localStorage.getItem("jy_history_week");
    if(!raw) return {};
    const obj = JSON.parse(raw);
    if(obj.week !== weekKey()) return {};
    return obj.entries || {};
  }catch{
    return {};
  }
}

/* ------------------------------------------------------
   DOM REFS
------------------------------------------------------ */
const radioRow   = qs("#radioRow");
const aiStage    = qs("#aiStage");
const cardEl     = qs("#card");
const dayTitleEl = qs("#dayTitle");
const linesEl    = qs("#lines");
const mainBtn    = qs("#mainBtn");

const bigTimer   = qs("#bigTimer");
const tH         = qs("#tHours");
const tM         = qs("#tMins");
const tS         = qs("#tSecs");

const slideWrap  = qs("#slideWrap");
const slideTrack = qs(".slide-track");
const slideFill  = qs(".slide-fill");
const slideKnob  = qs(".slide-knob");

const weatherEl  = qs(".weather");

/* PREVIEW CARD */
const previewCard  = qs("#previewCard");
const previewTitle = qs("#previewTitle");
const previewLines = qs("#previewLines");

/* HISTORY CARD */
const pastCardEl   = qs("#pastCard");
const pastTitleEl  = qs("#pastTitle");
const pastMetaEl   = qs("#pastMeta");
const pastLinesEl  = qs("#pastLines");

let selectedMode   = null;
let currentWorkout = null;
let countdownInterval = null;
let historyMode = false;

/* ------------------------------------------------------
   WORKOUT GENERATION
------------------------------------------------------ */
const METALS = ["Metacon","EMOM","Ladder","AMRAP","Tabata"];
const rand = arr => arr[Math.floor(Math.random()*arr.length)];

function buildWorkout(mode){
  const items=[];
  let weightedUsed=false, absUsed=false, shouldersUsed=false,
      bicepsUsed=false, kettlebellUsed=false;

  if(mode==="push" || mode==="pull"){
    items.push({label:"Sets & Reps", weighted:true});
    weightedUsed=true;

    const m1={ label:rand(METALS) };
    const m2={ label:rand(METALS) };

    if(mode==="push" && Math.random()<0.5){
      m1.shoulders=true; shouldersUsed=true;
    }
    if(mode==="pull" && Math.random()<0.5){
      m1.biceps=true; bicepsUsed=true;
    }
    if(!absUsed && Math.random()<0.5){
      m2.abs=true; absUsed=true;
    }

    if(Math.random()<0.5 && !m1.weighted) m1.weighted=true;
    else if(Math.random()<0.5 && !m2.weighted) m2.weighted=true;

    items.push(m1,m2);
  }

  else if(mode==="legs"){
    const count = Math.random()<0.5 ? 2 : 3;
    for(let i=0;i<count;i++){
      const m={label:rand(METALS)};
      if(!kettlebellUsed && Math.random()<0.5){
        m.kettlebell=true; kettlebellUsed=true;
      }else if(!weightedUsed && Math.random()<0.5){
        m.weighted=true; weightedUsed=true;
      }
      if(!absUsed && Math.random()<0.5){
        m.abs=true; absUsed=true;
      }
      items.push(m);
    }
  }

  else if(mode==="full"){
    const count = Math.random()<0.5 ? 3 : 4;
    for(let i=0;i<count;i++){
      const m={label:rand(METALS)};
      if(!weightedUsed && Math.random()<0.5){
        m.weighted=true; weightedUsed=true;
      }
      if(!absUsed && Math.random()<0.5){
        m.abs=true; absUsed=true;
      }
      if(!shouldersUsed && Math.random()<0.3){
        m.shoulders=true; shouldersUsed=true;
      }
      if(!bicepsUsed && Math.random()<0.3){
        m.biceps=true; bicepsUsed=true;
      }
      if(!kettlebellUsed && Math.random()<0.3){
        m.kettlebell=true; kettlebellUsed=true;
      }
      items.push(m);
    }
  }

  return {mode, items};
}

function modeTitle(mode){
  if(mode==="pull") return "Pull Day";
  if(mode==="push") return "Push Day";
  if(mode==="legs") return "Legs Day";
  if(mode==="full") return "Full Body Day";
  return "Workout";
}

/* ------------------------------------------------------
   PREVIEW CARD (WIREFRAME + TAGS)
------------------------------------------------------ */
function allowedPreviewTags(mode){
  switch(mode){
    case "pull":
      return [
        {label:"Weighted", class:"preview-tag preview-tag-weighted"},
        {label:"Abs", class:"preview-tag preview-tag-abs"},
        {label:"Biceps", class:"preview-tag preview-tag-biceps"},
        null
      ];
    case "push":
      return [
        {label:"Weighted", class:"preview-tag preview-tag-weighted"},
        {label:"Abs", class:"preview-tag preview-tag-abs"},
        {label:"Shoulders", class:"preview-tag preview-tag-shoulders"},
        null
      ];
    case "legs":
      return [
        {label:"Weighted", class:"preview-tag preview-tag-weighted"},
        {label:"Abs", class:"preview-tag preview-tag-abs"},
        {label:"Kettlebell", class:"preview-tag preview-tag-kettlebell"},
        null
      ];
    case "full":
      return [
        {label:"Weighted", class:"preview-tag preview-tag-weighted"},
        {label:"Abs", class:"preview-tag preview-tag-abs"},
        {label:"Kettlebell", class:"preview-tag preview-tag-kettlebell"},
        {label:"Shoulders", class:"preview-tag preview-tag-shoulders"},
        {label:"Biceps", class:"preview-tag preview-tag-biceps"},
        null
      ];
  }
}

function randomPreviewRows(mode){
  const pool = allowedPreviewTags(mode).filter(x => x !== null);
  const used = new Set();
  const rows=[];
  const count=3;

  if(mode==="pull" || mode==="push"){
    rows.push({label:"Weighted", class:"preview-tag preview-tag-weighted"});
    used.add("Weighted");

    for(let i=1;i<count;i++){
      const remaining = pool.filter(t=>!used.has(t.label));
      if(Math.random()<0.4){
        rows.push(null);
        continue;
      }
      if(remaining.length){
        const pick = remaining[Math.floor(Math.random()*remaining.length)];
        used.add(pick.label);
        rows.push(pick);
      }else rows.push(null);
    }

    return rows;
  }

  for(let i=0;i<count;i++){
    const remaining = pool.filter(t=>!used.has(t.label));
    if(Math.random()<0.4){
      rows.push(null);
      continue;
    }
    if(remaining.length){
      const pick=remaining[Math.floor(Math.random()*remaining.length)];
      used.add(pick.label);
      rows.push(pick);
    }else rows.push(null);
  }

  return rows;
}

function renderPreviewCard(mode){
  previewLines.innerHTML="";
  previewTitle.textContent = modeTitle(mode);

  const rows = randomPreviewRows(mode);
  rows.forEach((r,i)=>{
    const row=document.createElement("div");
    row.className="preview-row";

    const wire=document.createElement("div");
    wire.className="preview-wire";
    row.appendChild(wire);

    if(r){
      const tag=document.createElement("span");
      tag.className=r.class;
      tag.textContent=r.label;
      row.appendChild(tag);
    }else{
      const sp=document.createElement("span");
      sp.style.minWidth="40px";
      row.appendChild(sp);
    }

    previewLines.appendChild(row);
    setTimeout(()=> row.classList.add("show-row"), 40*i+60);
  });
}

function showPreviewCard(){
  previewCard.classList.remove("hidden","show");
  void previewCard.offsetWidth;
  previewCard.classList.add("show");
}

function hidePreviewCard(immediate=false){
  if(immediate){
    previewCard.classList.remove("show");
    previewCard.classList.add("hidden");
  }else{
    previewCard.classList.remove("show");
    setTimeout(()=> previewCard.classList.add("hidden"), 260);
  }
}

function updatePreviewForMode(mode){
  if(!mode){ hidePreviewCard(); return; }
  renderPreviewCard(mode);
  showPreviewCard();
}

/* ------------------------------------------------------
   RENDER TODAY CARD
------------------------------------------------------ */
function renderWorkoutCard(workout){
  const {mode, items}=workout;
  dayTitleEl.textContent = modeTitle(mode);
  linesEl.innerHTML="";

  items.forEach((it,i)=>{
    const row=document.createElement("div");
    row.className="line";
    row.appendChild(document.createTextNode(it.label));

    if(it.weighted){
      const p=document.createElement("span");
      p.className="pill pill-weighted"; p.textContent="Weighted";
      row.appendChild(p);
    }
    if(it.abs){
      const p=document.createElement("span");
      p.className="pill pill-abs"; p.textContent="Abs";
      row.appendChild(p);
    }
    if(it.shoulders){
      const p=document.createElement("span");
      p.className="pill pill-shoulders"; p.textContent="Shoulders";
      row.appendChild(p);
    }
    if(it.biceps){
      const p=document.createElement("span");
      p.className="pill pill-biceps"; p.textContent="Biceps";
      row.appendChild(p);
    }
    if(it.kettlebell){
      const p=document.createElement("span");
      p.className="pill pill-kettlebell"; p.textContent="Kettlebell";
      row.appendChild(p);
    }

    linesEl.appendChild(row);
    setTimeout(()=> row.classList.add("show-line"), 40*i+60);
  });

  cardEl.style.display="block";
  cardEl.classList.remove("visible");
  void cardEl.offsetWidth;
  cardEl.classList.add("visible");
}

/* ------------------------------------------------------
   HISTORY CARD (PREVIOUS WORKOUT)
------------------------------------------------------ */
function renderPastCardForMode(mode){
  const hist = loadHistory();
  const entry = hist[mode];
  if(!entry){ hidePastCard(); return false; }

  pastTitleEl.textContent = modeTitle(mode);
  pastMetaEl.textContent  = entry.dayName || "";
  pastLinesEl.innerHTML="";

  entry.items.forEach(it=>{
    const row=document.createElement("div");
    row.className="past-line";

    row.appendChild(document.createTextNode(it.label));

    if(it.weighted){
      const p=document.createElement("span");
      p.className="pill pill-weighted"; p.textContent="Weighted";
      row.appendChild(p);
    }
    if(it.abs){
      const p=document.createElement("span");
      p.className="pill pill-abs"; p.textContent="Abs";
      row.appendChild(p);
    }
    if(it.shoulders){
      const p=document.createElement("span");
      p.className="pill pill-shoulders"; p.textContent="Shoulders";
      row.appendChild(p);
    }
    if(it.biceps){
      const p=document.createElement("span");
      p.className="pill pill-biceps"; p.textContent="Biceps";
      row.appendChild(p);
    }
    if(it.kettlebell){
      const p=document.createElement("span");
      p.className="pill pill-kettlebell"; p.textContent="Kettlebell";
      row.appendChild(p);
    }

    pastLinesEl.appendChild(row);
  });

  pastCardEl.style.display="block";
  pastCardEl.classList.remove("visible");
  void pastCardEl.offsetWidth;
  pastCardEl.classList.add("visible");

  bigTimer.classList.remove("show");
  setTimeout(()=> bigTimer.classList.add("hidden"), 260);

  return true;
}

function hidePastCard(){
  if(pastCardEl.style.display==="none") return;

  pastCardEl.classList.remove("visible");
  setTimeout(()=>{
    pastCardEl.style.display="none";
    if(historyMode){
      bigTimer.classList.remove("hidden");
      requestAnimationFrame(()=> bigTimer.classList.add("show"));
    }
  },220);
}

/* ------------------------------------------------------
   VIEW STATES
------------------------------------------------------ */
function anyUnlockedModes(){
  const locks = loadLocks();
  return ["pull","push","legs","full"].some(k => !locks[k]);
}

function applyLocksToRadios(){
  const locks = loadLocks();
  qsa(".opt").forEach(lbl=>{
    const mode = lbl.dataset.mode;
    const input = lbl.querySelector("input");
    lbl.classList.remove("disabled");
    input.disabled = false;
    if(locks[mode]){
      input.disabled=true;
      lbl.classList.add("disabled");
    }
  });
}

function applyHistoryLocksToRadios(){
  const hist = loadHistory();
  qsa(".opt").forEach(lbl=>{
    const mode = lbl.dataset.mode;
    const input = lbl.querySelector("input");
    const has = !!hist[mode];
    input.disabled = !has;
    lbl.classList.toggle("disabled", !has);
  });
}

function clearRadioSelection(){
  qsa("input[name='mode']").forEach(r=> r.checked=false);
  qsa(".opt").forEach(lbl=> lbl.classList.remove("active"));
}

/* SELECTION MODE */
function showSelectionState(){
  historyMode=false;

  stopCountdown();
  bigTimer.classList.add("hidden");
  bigTimer.classList.remove("show");

  setSubtitle("What would you like to train?");
  radioRow.style.display="flex";

  applyLocksToRadios();

  cardEl.style.display="none";
  pastCardEl.style.display="none";
  slideWrap.classList.add("hidden");

  mainBtn.classList.remove("hidden");
  mainBtn.classList.add("disabled");
  mainBtn.textContent="Generate";

  hidePreviewCard(true);
}

/* LOCKED BY TIME */
function showPreLockedState(){
  historyMode=false;

  setSubtitle("Next workout in");
  radioRow.style.display="none";

  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");

  hidePreviewCard(true);
  startBigTimer(getStartTime(false));
}

/* TODAY WORKOUT SCREEN */
function showWorkoutState(workout){
  historyMode=false;

  stopCountdown();
  bigTimer.classList.add("hidden");
  bigTimer.classList.remove("show");

  currentWorkout = workout;
  setSubtitle("Todayâ€™s workout");

  renderWorkoutCard(workout);
  radioRow.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.remove("hidden");
  resetSlider();
  hidePreviewCard(true);
}

/* COMPLETED â†’ HISTORY MODE */
function showCompletedState(){
  historyMode=true;

  clearRadioSelection();
  applyHistoryLocksToRadios();

  setSubtitle("Hereâ€™s what you trained this week");
  radioRow.style.display="flex";

  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");

  startBigTimer(getStartTime(true));
}

/* ALL USED THIS WEEK */
function showAllUsedWeekState(){
  historyMode=false;

  setSubtitle("All workouts used this week");

  radioRow.style.display="none";
  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");
  bigTimer.classList.add("hidden");
}

/* ------------------------------------------------------
   TIMER
------------------------------------------------------ */
function stopCountdown(){
  if(countdownInterval){
    clearInterval(countdownInterval);
    countdownInterval=null;
  }
}

function startBigTimer(target){
  stopCountdown();

  bigTimer.classList.remove("hidden");
  requestAnimationFrame(()=> bigTimer.classList.add("show"));

  function tick(){
    const now=new Date();
    let diff = target-now;

    if(diff<=0){
      stopCountdown();
      bigTimer.classList.remove("show");
      setTimeout(()=>{
        bigTimer.classList.add("hidden");
        initUI();
      },260);
      return;
    }

    const sec = Math.floor(diff/1000);
    const h = String(Math.floor(sec/3600)).padStart(2,"0");
    const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");

    tH.textContent=h;
    tM.textContent=m;
    tS.textContent=s;
  }

  tick();
  countdownInterval=setInterval(tick,1000);
}

/* ------------------------------------------------------
   GENERATE WORKOUT
------------------------------------------------------ */
function handleGenerate(){
  if(!selectedMode) return;

  hidePreviewCard();

  aiStage.style.display="block";
  aiStage.classList.add("show");

  mainBtn.disabled=true;
  mainBtn.textContent="Generating...";
  cardEl.style.display="none";

  setTimeout(()=>{
    const workout = buildWorkout(selectedMode);
    currentWorkout = workout;

    saveWorkoutToday(workout);

    const locks=loadLocks();
    locks[selectedMode]=true;
    saveLocks(locks);

    aiStage.classList.remove("show");
    aiStage.style.display="none";
    mainBtn.disabled=false;

    showWorkoutState(workout);
  },900);
}

/* ------------------------------------------------------
   SLIDE TO COMPLETE
------------------------------------------------------ */
function handleComplete(){
  if(window.confetti){
    confetti({
      particleCount:160,
      spread:90,
      startVelocity:35,
      origin:{x:0.5,y:1.05}
    });
  }
  if(navigator.vibrate) navigator.vibrate(15);

  saveCompletedToday(currentWorkout.mode);
  saveHistoryForMode(currentWorkout);

  cardEl.style.display="none";
  slideWrap.classList.add("hidden");

  setTimeout(()=> showCompletedState(), 600);
}

/* ---- SLIDER MOVEMENT ---- */
let sliding=false;
let startX=0;
let maxSlide=0;

function resetSlider(){
  const knobW = slideKnob.offsetWidth;
  slideKnob.style.transition="none";
  slideFill.style.transition="none";
  slideKnob.style.transform="translate(0,-50%)";
  slideFill.style.width=`${knobW}px`;

  setTimeout(()=>{
    slideKnob.style.transition="";
    slideFill.style.transition="width .18s ease-out";
  },20);
}

slideKnob.addEventListener("pointerdown", e=>{
  e.preventDefault();
  sliding=true;
  slideKnob.setPointerCapture(e.pointerId);

  slideKnob.style.transition="none";
  slideFill.style.transition="none";

  const trackRect = slideTrack.getBoundingClientRect();
  const knobRect  = slideKnob.getBoundingClientRect();
  maxSlide = trackRect.width - knobRect.width - 8;

  startX = e.clientX;
});

slideKnob.addEventListener("pointermove", e=>{
  if(!sliding) return;

  const dx = e.clientX - startX;
  let x = Math.max(0, Math.min(maxSlide, dx));

  slideKnob.style.transform = `translate(${x}px,-50%)`;
  slideFill.style.width = `${x + slideKnob.offsetWidth}px`;
});

function endSlide(e){
  if(!sliding) return;

  sliding=false;
  if(e.pointerId) slideKnob.releasePointerCapture(e.pointerId);

  const match = /translate\(([-0-9.]+)px/.exec(slideKnob.style.transform);
  const x = match ? parseFloat(match[1]) : 0;

  slideKnob.style.transition="transform .22s ease-out";
  slideFill.style.transition="width .22s ease-out";

  if(x >= maxSlide*0.9){
    slideKnob.style.transform=`translate(${maxSlide}px,-50%)`;
    slideFill.style.width=`${maxSlide+slideKnob.offsetWidth}px`;
    handleComplete();
  } else {
    resetSlider();
  }
}

slideKnob.addEventListener("pointerup", endSlide);
slideKnob.addEventListener("pointercancel", endSlide);

/* ------------------------------------------------------
   WEATHER
------------------------------------------------------ */
function weatherCodeToText(code){
  const map={
    0:"Clear",
    1:"Clear",
    2:"Cloudy",
    3:"Cloudy",
    45:"Fog",48:"Fog",
    51:"Drizzle",53:"Drizzle",55:"Drizzle",
    61:"Rain",63:"Rain",65:"Rain",
    71:"Snow",73:"Snow",75:"Snow",
    80:"Rain",81:"Rain",82:"Rain",
    95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
  };
  return map[code] || "Weather";
}

function getWeatherEmoji(cond){
  const c = cond.toLowerCase();
  if(c.includes("clear")) return "â˜€ï¸";
  if(c.includes("cloud")) return "â›…";
  if(c.includes("rain"))  return "ðŸŒ§ï¸";
  if(c.includes("drizzle")) return "ðŸŒ¦ï¸";
  if(c.includes("snow")) return "â„ï¸";
  if(c.includes("fog"))  return "ðŸŒ«ï¸";
  if(c.includes("thunder"))return "ðŸŒ©ï¸";
  return "ðŸŒ¡ï¸";
}

function updateWeatherUI(){
  if(!navigator.geolocation){
    weatherEl.textContent="Location unavailable";
    return;
  }

  weatherEl.textContent="Loading weatherâ€¦";

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;

    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res=await fetch(url);
      const data=await res.json();

      const temp=Math.round(data.current_weather.temperature);
      const cond=weatherCodeToText(data.current_weather.weathercode);
      const emoji=getWeatherEmoji(cond);

      weatherEl.textContent=`${emoji} ${temp}Â°C`;

    }catch{
      weatherEl.textContent="Weather unavailable";
    }

  },()=>{
    weatherEl.textContent="Enable location for weather";
  });
}

/* ------------------------------------------------------
   INIT UI
------------------------------------------------------ */
function initUI(){
  resetWeekIfNeeded();

  clearRadioSelection();
  hidePreviewCard(true);
  hidePastCard();

   /* ------------------------------------------------------
     FINAL UI DECISION LOGIC
  ------------------------------------------------------ */
  const workout   = loadWorkoutToday();
  const completed = loadCompletedToday();
  const lockedByTime = !afterStart();

  if (!workout && !completed && lockedByTime) {
    showPreLockedState();
    return;
  }
  if (completed) {
    showCompletedState();
    return;
  }
  if (workout) {
    showWorkoutState(workout);
    return;
  }
  if (!anyUnlockedModes()) {
    showAllUsedWeekState();
    return;
  }

  showSelectionState();
}

/* ------------------------------------------------------
   RADIO BUTTON INTERACTION
   (Selection mode + History mode)
------------------------------------------------------ */
qsa("input[name='mode']").forEach(radio => {
  radio.addEventListener("change", () => {
    selectedMode = radio.value;

    // Set active state
    qsa(".opt").forEach(lbl => {
      lbl.classList.toggle("active", lbl.dataset.mode === selectedMode);
    });

    /* ---------- HISTORY MODE ---------- */
    if (historyMode) {
      const shown = renderPastCardForMode(selectedMode);
      if (shown && navigator.vibrate) navigator.vibrate(6);
      return;
    }

    /* ---------- SELECTION MODE ---------- */
    hidePastCard();
    mainBtn.textContent =
      `Generate ${modeTitle(selectedMode).replace(" Day", "")}`;
    mainBtn.classList.remove("disabled");
    updatePreviewForMode(selectedMode);

    if (navigator.vibrate) navigator.vibrate(8);
  });
});

/* ------------------------------------------------------
   OUTSIDE CLICK â†’ HIDE HISTORY CARD
   (THIS IS THE FIX YOU NEEDED)
------------------------------------------------------ */
document.addEventListener("click", e => {
  if (!historyMode) return;
  if (pastCardEl.style.display === "none") return;

  const insideCard  = pastCardEl.contains(e.target);
  const insideRadio = radioRow.contains(e.target);

  if (!insideCard && !insideRadio) {
    hidePastCard();

    // FIX: Reset radio fully so tapping again works
    qsa(".opt").forEach(lbl => {
      lbl.classList.remove("active");
      const input = lbl.querySelector("input");
      if (input) input.checked = false;
    });

    selectedMode = null;
  }
});

/* ------------------------------------------------------
   MAIN BUTTON (Generate)
------------------------------------------------------ */
mainBtn.addEventListener("click", handleGenerate);

/* ------------------------------------------------------
   BOOT
------------------------------------------------------ */
initUI();
updateWeatherUI();

</script>
<!-- ===================== JS END ===================== -->
</body>
</html> 
