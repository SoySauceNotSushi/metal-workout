<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<style>
:root{
  --brand:#2453f5;
  --ink:#0f172a;
  --sub:#64748b;
  --bg:#ffffff;
  --card:#f8fafc;
  --pill-blue:#e4ecff;
  --pill-green:#d9fbe3;
  --pill-orange:#ffe6bf;
  --pill-red:#ffe0e0;

  --shadow-soft:0 18px 48px rgba(15,23,42,0.16);
  --shadow-subtle:0 8px 18px rgba(15,23,42,0.12);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
  -webkit-font-smoothing:antialiased;
}

.container{
  max-width:480px;
  margin:0 auto;
  padding:24px;
  padding-bottom:120px;
}

/* ------------------------------
   TOP HEADER
--------------------------------*/
.top-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}

.weather{
  font-size:15px;
  color:var(--sub);
  opacity:.95;
  display:flex;
  align-items:center;
  gap:6px;
  transition:opacity .25s ease, transform .25s ease;
}

.dev-reset-btn{
  font-size:13px;
  padding:6px 12px;
  border-radius:8px;
  border:none;
  background:#f3f4f6;
  color:#0f172a;
  cursor:pointer;
}
.dev-reset-btn.hidden{ display:none; }

/* ------------------------------
   NEW STREAK WIDGET
--------------------------------*/
.streak-widget{
  width:100%;
  background:#0f0f0f;
  border-radius:20px;
  padding:16px 18px;
  margin:18px 0 26px;
  display:flex;
  align-items:center;
  gap:18px;
  box-shadow:0 6px 16px rgba(0,0,0,0.25);
  color:#fff;
}

/* FIRE BOX */
.streak-fire-box{
  width:78px;
  min-width:78px;
  height:78px;
  background:#181818;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
}

.fire-icon{
  width:32px;
  height:32px;
  background:linear-gradient(180deg,#FFE066,#FF8A00,#FF3C00);
  -webkit-mask:url('data:image/svg+xml;utf8,<svg fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C12 2 7 7 7 11C7 14.3137 9.68629 17 13 17C16.3137 17 19 14.3137 19 11C19 8 17 5 12 2Z"/></svg>') center/contain no-repeat;
  mask:url('data:image/svg+xml;utf8,<svg fill="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C12 2 7 7 7 11C7 14.3137 9.68629 17 13 17C16.3137 17 19 14.3137 19 11C19 8 17 5 12 2Z"/></svg>') center/contain no-repeat;
}

.streak-days{
  font-size:15px;
  font-weight:700;
  margin-top:4px;
}

.streak-label{
  font-size:11px;
  opacity:.65;
  margin-top:2px;
}

/* MID COLUMN */
.streak-mid{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.streak-progress-number{
  font-size:20px;
  font-weight:700;
  color:white;
}

/* PROGRESS BAR */
.streak-progress-bar{
  width:100%;
  height:8px;
  background:#2a2a2a;
  border-radius:999px;
  overflow:hidden;
}

.streak-progress-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#FF8A00,#FF3C00);
  border-radius:999px;
  transition:width .35s ease;
}

/* DOTS */
.streak-dots{
  display:flex;
  gap:6px;
  margin-top:2px;
}

.dot{
  width:10px;
  height:10px;
  background:#3a3a3a;
  border-radius:50%;
}

.dot.filled{
  background:#FF8A00;
}

/* ------------------------------
   TITLES
--------------------------------*/
h1{
  font-size:30px;
  font-weight:700;
  margin:4px 0 10px;
}

#subtitle{
  font-size:17px;
  font-weight:400;
  color:var(--sub);
  margin-bottom:18px;
}

/* ------------------------------
   RADIO
--------------------------------*/
#radioRow{
  display:flex;
  gap:22px;
  margin-bottom:12px;
}

.opt{
  position:relative;
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:999px;
  font-size:14px;
  color:var(--ink);
  background:#f2f2f2;
}

.opt input{
  display:none;
}

.opt.active{
  background:#e4ecff80;
  color:var(--brand);
  font-weight:600;
}

/* ------------------------------
   PREVIEW CARD
--------------------------------*/
.preview-card{
  width:100%;
  max-width:420px;
  margin:28px auto 24px;
  border-radius:18px;
  background:#ffffff;
  box-shadow:var(--shadow-soft);
  padding:18px 20px;
  opacity:0;
  transform:translateY(26px) scale(.96);
  transition:opacity .32s ease, transform .32s ease;
  pointer-events:none;
}

.preview-card.show{
  opacity:1;
  transform:translateY(0) scale(1);
}

.preview-card.hidden{
  display:none;
}

.preview-title{
  font-size:18px;
  font-weight:700;
  margin-bottom:14px;
}

.preview-lines{
  display:flex;
  flex-direction:column;
  gap:14px;
}

.preview-row{
  display:flex;
  align-items:center;
  gap:8px;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .28s ease, transform .28s ease;
}

.preview-row.show-row{
  opacity:1;
  transform:translateY(0);
}

.preview-wire{
  height:12px;
  width:32%;
  background:#f2f3f5;
  border-radius:6px;
  overflow:hidden;
  position:relative;
}

.preview-wire::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(120deg,transparent,rgba(255,255,255,.8),transparent);
  transform:translateX(-100%);
  animation:shimmer 1.5s linear infinite;
}

@keyframes shimmer{
  0%{ transform:translateX(-100%); }
  100%{ transform:translateX(100%); }
}

.preview-tag{
  padding:4px 10px;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
  white-space:nowrap;
}

.preview-tag-weighted{ background:var(--pill-blue); color:var(--brand); }
.preview-tag-abs{ background:var(--pill-green); color:#22c55e; }
.preview-tag-shoulders{ background:#ede9fe; color:#7c3aed; }
.preview-tag-biceps{ background:var(--pill-orange); color:#d97706; }
.preview-tag-kettlebell{ background:var(--pill-red); color:#e11d48; }

/* ------------------------------
   AI MESH
--------------------------------*/
.ai-stage{
  position:absolute;
  left:50%;
  top:260px;
  transform:translateX(-50%);
  width:260px;
  height:260px;
  border-radius:50%;
  display:none;
}

/* ------------------------------
   TODAY WORKOUT CARD
--------------------------------*/
#card{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  display:none;
  opacity:0;
  transform:translateY(12px) scale(.98);
  transition:opacity .3s ease, transform .3s ease;
}
#card.visible{
  opacity:1;
  transform:translateY(0) scale(1);
}

.line{
  font-size:16px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:8px;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .22s ease, transform .22s ease;
}

.line.show-line{
  opacity:1;
  transform:translateY(0);
}

.pill{
  padding:3px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}

.pill-weighted{ background:var(--pill-blue); color:var(--brand); }
.pill-abs{ background:var(--pill-green); color:#22c55e; }
.pill-shoulders{ background:#ede9fe; color:#7c3aed; }
.pill-biceps{ background:var(--pill-orange); color:#d97706; }
.pill-kettlebell{ background:var(--pill-red); color:#e11d48; }

/* ------------------------------
   PAST CARD
--------------------------------*/
#pastCard{
  background:var(--card);
  border-radius:16px;
  padding:18px 20px;
  margin-top:18px;
  display:none;
  opacity:0;
  transform:translateY(18px) scale(.98);
  transition:opacity .25s ease, transform .25s ease;
}
#pastCard.visible{
  opacity:1;
  transform:translateY(0) scale(1);
}

.past-header{
  display:flex;
  justify-content:space-between;
  margin-bottom:18px;
}

#pastTitle{
  font-size:18px;
  font-weight:700;
}

#pastMeta{
  font-size:14px;
  color:var(--sub);
}

.past-line{
  font-size:16px;
  margin-bottom:10px;
  display:flex;
  gap:8px;
}

/* ------------------------------
   MAIN BUTTON
--------------------------------*/
#mainBtn{
  position:fixed;
  left:50%;
  bottom:24px;
  transform:translateX(-50%);
  width:calc(100% - 48px);
  max-width:480px;
  height:56px;
  border:none;
  border-radius:28px;
  background:var(--brand);
  color:#fff;
  font-size:18px;
  font-weight:600;
}
#mainBtn.hidden{ display:none; }
#mainBtn.disabled{
  opacity:.4;
  pointer-events:none;
}

/* ------------------------------
   SLIDER
--------------------------------*/
.slide-wrap{
  position:fixed;
  left:50%;
  bottom:24px;
  transform:translateX(-50%);
  width:calc(100% - 48px);
  max-width:480px;
}
.slide-wrap.hidden{ display:none; }

.slide-track{
  position:relative;
  height:56px;
  border-radius:999px;
  background:#f7f8f9;
  overflow:hidden;
}
.slide-track.filled{
  background:linear-gradient(135deg,#2453f5,#4f8cff);
}

.slide-fill{
  position:absolute;
  inset:0;
  transform:scaleX(0);
  transform-origin:left center;
  background:linear-gradient(120deg,#2453f5,#4f8cff);
}

.slide-label{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:17px;
  font-weight:600;
}

.slide-knob{
  position:absolute;
  top:50%;
  left:4px;
  width:48px;
  height:48px;
  transform:translateY(-50%);
  background:#fff;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 8px 16px rgba(15,23,42,0.18);
}

/* ------------------------------
   TIMER
--------------------------------*/
#bigTimer{
  position:fixed;
  top:calc(50% + 2rem);
  left:50%;
  transform:translate(-50%,-50%);
  display:flex;
  gap:1.5rem;
  opacity:0;
  transition:opacity .45s ease;
}

#bigTimer.hidden{
  display:none;
}

#bigTimer.show{
  opacity:1;
}

.t-col{
  display:flex;
  flex-direction:column;
  align-items:center;
}

.t-num{
  font-size:48px;
  font-variant-numeric:tabular-nums;
}

.t-label{
  font-size:14px;
  color:var(--sub);
}
</style>

</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="top-header">
    <div class="weather">Enable location for weather</div>
    <button id="devResetBtn" class="dev-reset-btn hidden">Reset Dev</button>
  </div>

  <!-- NEW STREAK WIDGET (FINAL VERSION) -->
  <div id="streakWidget" class="streak-widget">

      <!-- LEFT FIRE BOX -->
      <div class="streak-fire-box">
        <div class="fire-icon"></div>
        <div class="streak-days"><span id="streakDayCount">0</span> days</div>
        <div class="streak-label">streak</div>
      </div>

      <!-- MIDDLE COLUMN -->
      <div class="streak-mid">
        <div class="streak-progress-number">
          <span id="weekProgressCount">0</span> / 3
        </div>

        <div class="streak-progress-bar">
          <div class="streak-progress-fill" id="weekProgressFill"></div>
        </div>

        <div class="streak-dots">
          <span class="dot" id="dot-mon"></span>
          <span class="dot" id="dot-tue"></span>
          <span class="dot" id="dot-wed"></span>
          <span class="dot" id="dot-thu"></span>
          <span class="dot" id="dot-fri"></span>
          <span class="dot" id="dot-sat"></span>
          <span class="dot" id="dot-sun"></span>
        </div>
      </div>

  </div>

  <!-- TITLE -->
  <h1>Welcome back Jy</h1>
  <div id="subtitle">What would you like to train?</div>

  <!-- RADIO BUTTONS -->
  <div id="radioRow">
    <label class="opt" data-mode="pull"><input type="radio" name="mode" value="pull"> Pull</label>
    <label class="opt" data-mode="push"><input type="radio" name="mode" value="push"> Push</label>
    <label class="opt" data-mode="legs"><input type="radio" name="mode" value="legs"> Legs</label>
    <label class="opt" data-mode="full"><input type="radio" name="mode" value="full"> Full</label>
  </div>

  <!-- PREVIEW CARD -->
  <div id="previewCard" class="preview-card hidden">
    <div id="previewTitle" class="preview-title"></div>
    <div id="previewLines" class="preview-lines"></div>
  </div>

  <!-- AI LOADING -->
  <div id="aiStage" class="ai-stage"></div>

  <!-- TODAY CARD -->
  <div id="card">
    <div id="dayTitle"></div>
    <div id="lines"></div>
  </div>

  <!-- PAST CARD -->
  <div id="pastCard">
    <div class="past-header">
      <div id="pastTitle"></div>
      <div id="pastMeta"></div>
    </div>
    <div id="pastLines"></div>
  </div>

  <!-- COUNTDOWN TIMER -->
  <div id="bigTimer" class="hidden">
    <div class="t-col"><div id="tHours" class="t-num">00</div><div class="t-label">HOURS</div></div>
    <div class="t-col"><div id="tMins" class="t-num">00</div><div class="t-label">MINS</div></div>
    <div class="t-col"><div id="tSecs" class="t-num">00</div><div class="t-label">SECS</div></div>
  </div>

</div>

<!-- MAIN BUTTON -->
<button id="mainBtn">Generate</button>

<!-- SLIDE -->
<div id="slideWrap" class="slide-wrap hidden">
  <div class="slide-track">
    <div class="slide-fill"></div>
    <div class="slide-label"><span>Slide To Complete</span></div>
    <div class="slide-knob"><span class="arrow">â†’</span></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* CONFIG / UTIL */

// DEV mode = ?dev=true OR ?dev=1
const urlParams = new URLSearchParams(window.location.search);
const DEV = urlParams.get("dev")==="true" || urlParams.get("dev")==="1";

// storage prefix so dev + prod don't clash
const STORAGE_PREFIX = DEV ? "jy_dev_" : "jy_";
const lsKey  = k => STORAGE_PREFIX + k;
const lsGet  = k => localStorage.getItem(lsKey(k));
const lsSet  = (k,v) => localStorage.setItem(lsKey(k), v);
const lsRemove = k => localStorage.removeItem(lsKey(k));

const START_HOUR = 17;
const START_MIN  = 30;

const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function weekKey(){
  const d=new Date();
  const jan1=new Date(d.getFullYear(),0,1);
  const days=Math.floor((d-jan1)/86400000);
  const week=Math.ceil((days+d.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
}
function getStartTime(tomorrow=false){
  const d=new Date();
  if(tomorrow) d.setDate(d.getDate()+1);
  d.setHours(START_HOUR,START_MIN,0,0);
  return d;
}

/* DEV unlock timestamp helper */
function getDevUnlockTime(){
  if(!DEV) return null;
  const raw = lsGet("dev_time_lock");
  if(!raw) return null;
  const ts = parseInt(raw,10);
  if(Number.isNaN(ts)) return null;
  return new Date(ts);
}

/* TIME LOCK */
function afterStart(){
  if(DEV){
    const unlockAt = getDevUnlockTime();
    if(!unlockAt) return true;
    return new Date() >= unlockAt;
  }
  return new Date() >= getStartTime(false);
}

const WEEKDAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

/* -------------------------
      STREAK HELPERS
-------------------------- */

function getStreak(){
  const raw = lsGet("streak");
  const n = parseInt(raw||"0",10);
  return Number.isFinite(n) && n>0 ? n : 0;
}
function setStreak(val){
  lsSet("streak", String(Math.max(0, val|0)));
}

function loadWeekSummary(){
  const raw = lsGet("week_summary");
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function saveWeekSummary(obj){
  lsSet("week_summary", JSON.stringify(obj));
}

function resetWeekIfNeeded(){
  const cur  = weekKey();
  const prev = lsGet("weekKey");
  let summary = loadWeekSummary();
  let streak = getStreak();

  if(prev && prev !== cur){
    if(summary && summary.week === prev){
      if(summary.workouts < 3 && !summary.counted){
        streak = 0;
        setStreak(streak);
      }
    }

    lsSet("weekKey", cur);
    lsRemove("locks");
    lsRemove("workoutToday");
    lsRemove("completedToday");
    lsRemove("history_week");

    summary = {week:cur, workouts:0, counted:false};
    saveWeekSummary(summary);
  } else {
    if(!prev) lsSet("weekKey", cur);
    if(!summary || summary.week !== cur){
      summary = {week:cur, workouts:0, counted:false};
      saveWeekSummary(summary);
    }
  }
}

/* -------------------------
      STREAK WIDGET UPDATE
-------------------------- */

function updateStreakWidget() {
  const streak = getStreak();
  const streakEl = qs("#streakDayCount");
  if (streakEl) streakEl.textContent = streak;

  const hist = loadHistory();
  const completedDaysSet = new Set();

  Object.keys(hist).forEach(mode => {
    const entry = hist[mode];
    if (entry && entry.dayName) {
      completedDaysSet.add(entry.dayName);
    }
  });

  const weekCount = Math.min(completedDaysSet.size, 3);
  const weekNumberEl = qs("#weekProgressCount");
  const weekFillEl = qs("#weekProgressFill");

  if (weekNumberEl) weekNumberEl.textContent = weekCount;
  if (weekFillEl) {
    const pct = (weekCount / 3) * 100;
    weekFillEl.style.width = pct + "%";
  }

  ["mon","tue","wed","thu","fri","sat","sun"].forEach(d=>{
    const el = qs(`#dot-${d}`);
    if (el) el.classList.remove("filled");
  });

  completedDaysSet.forEach(dayName=>{
    const short = dayName.slice(0,3).toLowerCase();
    const el = qs(`#dot-${short}`);
    if (el) el.classList.add("filled");
  });
}

function updateWeeklyStatsAfterCompletion(){
  const wk = weekKey();
  let summary = loadWeekSummary() || {week:wk, workouts:0, counted:false};
  if(summary.week !== wk){
    summary = {week:wk, workouts:0, counted:false};
  }

  const hist = loadHistory();
  const doneCount = Object.keys(hist).length;
  summary.workouts = doneCount;

  let streak = getStreak();
  if(doneCount>=3 && !summary.counted){
    streak += 1;
    summary.counted = true;
    setStreak(streak);
  } else {
    setStreak(streak);
  }

  saveWeekSummary(summary);
  return {doneCount, streak};
}

/* -------------------------
      STORAGE HELPERS
-------------------------- */

function loadLocks(){
  try{ return JSON.parse(lsGet("locks")||"{}"); }
  catch{ return {}; }
}
function saveLocks(obj){
  lsSet("locks", JSON.stringify(obj));
}

function saveWorkoutToday(data){
  lsSet("workoutToday", JSON.stringify({date:todayKey(),data}));
}
function loadWorkoutToday(){
  const raw = lsGet("workoutToday");
  if(!raw) return null;
  try{
    const obj=JSON.parse(raw);
    if(obj.date===todayKey()) return obj.data;
  }catch{}
  return null;
}

function saveCompletedToday(mode){
  lsSet("completedToday", JSON.stringify({date:todayKey(),mode}));
}
function loadCompletedToday(){
  const raw=lsGet("completedToday");
  if(!raw) return null;
  try{
    const obj=JSON.parse(raw);
    if(obj.date===todayKey()) return obj;
  }catch{}
  return null;
}

function saveHistoryForMode(workout){
  const wk = weekKey();
  let data;
  try{
    data = JSON.parse(lsGet("history_week")||"{}");
  }catch{ data = {}; }

  if(!data || data.week !== wk){
    data = {week:wk, entries:{}};
  }

  const d=new Date();
  const dayName=WEEKDAYS[d.getDay()];

  data.entries[workout.mode] = {
    mode: workout.mode,
    items: workout.items,
    dayName
  };

  lsSet("history_week", JSON.stringify(data));
}

function loadHistory(){
  try{
    const raw=lsGet("history_week");
    if(!raw) return {};
    const obj=JSON.parse(raw);
    if(obj.week !== weekKey()) return {};
    return obj.entries || {};
  }catch{
    return {};
  }
}

/* -------------------------
      DOM REFS
-------------------------- */

const radioRow   = qs("#radioRow");
const aiStage    = qs("#aiStage");
const cardEl     = qs("#card");
const dayTitleEl = qs("#dayTitle");
const linesEl    = qs("#lines");
const mainBtn    = qs("#mainBtn");

const bigTimer   = qs("#bigTimer");
const tH         = qs("#tHours");
const tM         = qs("#tMins");
const tS         = qs("#tSecs");

const slideWrap  = qs("#slideWrap");
const slideTrackEl = qs(".slide-track");
const slideFillEl  = qs(".slide-fill");
const slideKnob  = qs(".slide-knob");

const weatherEl  = qs(".weather");

const devResetBtn = qs("#devResetBtn");

const previewCard  = qs("#previewCard");
const previewTitle = qs("#previewTitle");
const previewLines = qs("#previewLines");

const pastCardEl   = qs("#pastCard");
const pastTitleEl  = qs("#pastTitle");
const pastMetaEl   = qs("#pastMeta");
const pastLinesEl  = qs("#pastLines");

let selectedMode   = null;
let currentWorkout = null;
let countdownInterval = null;
let historyMode = false;

/* -------------------------
      DEV RESET
-------------------------- */
if(DEV && devResetBtn){
  devResetBtn.classList.remove("hidden");
  devResetBtn.addEventListener("click", ()=>{
    ["streak","weekKey","week_summary","locks","workoutToday",
     "completedToday","history_week","dev_time_lock"]
     .forEach(k=>lsRemove(k));
    initUI();
  });
}

/* -------------------------
      WORKOUT GENERATOR
-------------------------- */

const METALS = ["Metacon","EMOM","Ladder","AMRAP","Tabata"];
const rand = arr => arr[Math.floor(Math.random()*arr.length)];

function buildWorkout(mode){
  const items=[];
  let weightedUsed=false, absUsed=false, shouldersUsed=false,
      bicepsUsed=false, kettlebellUsed=false;

  if(mode==="push" || mode==="pull"){
    items.push({label:"Sets & Reps", weighted:true});
    weightedUsed=true;

    const m1={ label:rand(METALS) };
    const m2={ label:rand(METALS) };

    if(mode==="push" && Math.random()<0.5){
      m1.shoulders=true; shouldersUsed=true;
    }
    if(mode==="pull" && Math.random()<0.5){
      m1.biceps=true; bicepsUsed=true;
    }
    if(Math.random()<0.5){ m2.abs=true; absUsed=true; }

    if(Math.random()<0.5 && !m1.weighted) m1.weighted=true;
    else if(Math.random()<0.5 && !m2.weighted) m2.weighted=true;

    items.push(m1,m2);
  }

  else if(mode==="legs"){
    const count = Math.random()<0.5 ? 2 : 3;
    for(let i=0;i<count;i++){
      const m={label:rand(METALS)};
      if(Math.random()<0.5 && !kettlebellUsed){
        m.kettlebell=true; kettlebellUsed=true;
      }else if(Math.random()<0.5 && !weightedUsed){
        m.weighted=true; weightedUsed=true;
      }
      if(Math.random()<0.5 && !absUsed){
        m.abs=true; absUsed=true;
      }
      items.push(m);
    }
  }

  else if(mode==="full"){
    const count = Math.random()<0.5 ? 3 : 4;
    for(let i=0;i<count;i++){
      const m={label:rand(METALS)};
      if(Math.random()<0.5 && !weightedUsed){
        m.weighted=true; weightedUsed=true;
      }
      if(Math.random()<0.5 && !absUsed){
        m.abs=true; absUsed=true;
      }
      if(Math.random()<0.3 && !shouldersUsed){
        m.shoulders=true; shouldersUsed=true;
      }
      if(Math.random()<0.3 && !bicepsUsed){
        m.biceps=true; bicepsUsed=true;
      }
      if(Math.random()<0.3 && !kettlebellUsed){
        m.kettlebell=true; kettlebellUsed=true;
      }
      items.push(m);
    }
  }

  return {mode, items};
}

function modeTitle(mode){
  if(mode==="pull") return "Pull Day";
  if(mode==="push") return "Push Day";
  if(mode==="legs") return "Legs Day";
  if(mode==="full") return "Full Body Day";
  return "Workout";
}

/* -------------------------
   PREVIEW CARD
-------------------------- */

function allowedPreviewTags(mode){
  switch(mode){
    case "pull":
      return [
        {label:"Weighted", class:"preview-tag preview-tag-weighted"},
        {label:"Abs", class:"preview-tag preview-tag-abs"},
        {label:"Biceps", class:"preview-tag preview-tag-biceps"},
        null
      ];
    case "push":
      return [
        {label:"Weighted", class:"preview-tag preview-tag-weighted"},
        {label:"Abs", class:"preview-tag preview-tag-abs"},
        {label:"Shoulders", class:"preview-tag preview-tag-shoulders"},
        null
      ];
    case "legs":
      return [
        {label:"Weighted", class:"preview-tag preview-tag-weighted"},
        {label:"Abs", class:"preview-tag preview-tag-abs"},
        {label:"Kettlebell", class:"preview-tag preview-tag-kettlebell"},
        null
      ];
    case "full":
      return [
        {label:"Weighted", class:"preview-tag preview-tag-weighted"},
        {label:"Abs", class:"preview-tag preview-tag-abs"},
        {label:"Kettlebell", class:"preview-tag preview-tag-kettlebell"},
        {label:"Shoulders", class:"preview-tag preview-tag-shoulders"},
        {label:"Biceps", class:"preview-tag preview-tag-biceps"},
        null
      ];
  }
}

function randomPreviewRows(mode){
  const pool=allowedPreviewTags(mode).filter(x=>x!==null);
  const used=new Set();
  const rows=[];

  if(mode==="pull"||mode==="push"){
    rows.push(pool.find(t=>t.label==="Weighted"));
    used.add("Weighted");
    for(let i=1;i<3;i++){
      const rem=pool.filter(t=>!used.has(t.label));
      if(Math.random()<0.4){
        rows.push(null);
      }else if(rem.length){
        const p=rem[Math.floor(Math.random()*rem.length)];
        used.add(p.label);
        rows.push(p);
      }else rows.push(null);
    }
  }else{
    for(let i=0;i<3;i++){
      const rem=pool.filter(t=>!used.has(t.label));
      if(Math.random()<0.4){
        rows.push(null);
      }else if(rem.length){
        const p=rem[Math.floor(Math.random()*rem.length)];
        used.add(p.label);
        rows.push(p);
      }else rows.push(null);
    }
  }

  return rows;
}

function renderPreviewCard(mode){
  previewTitle.textContent = modeTitle(mode);
  previewLines.innerHTML = "";

  const rows=randomPreviewRows(mode);
  rows.forEach((r,idx)=>{
    const row=document.createElement("div");
    row.className="preview-row";

    const wire=document.createElement("div");
    wire.className="preview-wire";
    row.appendChild(wire);

    if(r){
      const tag=document.createElement("span");
      tag.className=r.class;
      tag.textContent=r.label;
      row.appendChild(tag);
    }else{
      const empty=document.createElement("div");
      empty.style.minWidth="40px";
      row.appendChild(empty);
    }

    previewLines.appendChild(row);
    setTimeout(()=>row.classList.add("show-row"), idx*50);
  });
}

function showPreviewCard(){
  previewCard.classList.remove("hidden","show");
  void previewCard.offsetWidth;
  previewCard.classList.add("show");
}
function hidePreviewCard(immediate=false){
  if(immediate){
    previewCard.classList.remove("show");
    previewCard.classList.add("hidden");
  } else {
    previewCard.classList.remove("show");
    setTimeout(()=>previewCard.classList.add("hidden"), 250);
  }
}

/* -------------------------
      RENDER WORKOUTS
-------------------------- */

function renderWorkoutCard(workout){
  const {mode, items} = workout;

  dayTitleEl.textContent = modeTitle(mode);
  linesEl.innerHTML = "";

  items.forEach((it,idx)=>{
    const row=document.createElement("div");
    row.className="line";
    row.textContent = it.label;

    if(it.weighted){
      const p=document.createElement("span");
      p.className="pill pill-weighted";
      p.textContent="Weighted";
      row.appendChild(p);
    }
    if(it.abs){
      const p=document.createElement("span");
      p.className="pill pill-abs";
      p.textContent="Abs";
      row.appendChild(p);
    }
    if(it.shoulders){
      const p=document.createElement("span");
      p.className="pill pill-shoulders";
      p.textContent="Shoulders";
      row.appendChild(p);
    }
    if(it.biceps){
      const p=document.createElement("span");
      p.className="pill pill-biceps";
      p.textContent="Biceps";
      row.appendChild(p);
    }
    if(it.kettlebell){
      const p=document.createElement("span");
      p.className="pill pill-kettlebell";
      p.textContent="Kettlebell";
      row.appendChild(p);
    }

    linesEl.appendChild(row);
    setTimeout(()=>row.classList.add("show-line"), idx*50);
  });

  cardEl.style.display="block";
  requestAnimationFrame(()=> cardEl.classList.add("visible"));
}

/* PAST CARD */
function renderPastCardForMode(mode){
  const hist=loadHistory();
  const data=hist[mode];
  if(!data){ hidePastCard(); return false; }

  pastTitleEl.textContent = modeTitle(mode);
  pastMetaEl.textContent = data.dayName || "";
  pastLinesEl.innerHTML = "";

  data.items.forEach(it=>{
    const row=document.createElement("div");
    row.className="past-line";
    row.textContent=it.label;

    if(it.weighted){
      const p=document.createElement("span");
      p.className="pill pill-weighted"; p.textContent="Weighted";
      row.appendChild(p);
    }
    if(it.abs){
      const p=document.createElement("span");
      p.className="pill pill-abs"; p.textContent="Abs";
      row.appendChild(p);
    }
    if(it.shoulders){
      const p=document.createElement("span");
      p.className="pill pill-shoulders"; p.textContent="Shoulders";
      row.appendChild(p);
    }
    if(it.biceps){
      const p=document.createElement("span");
      p.className="pill pill-biceps"; p.textContent="Biceps";
      row.appendChild(p);
    }
    if(it.kettlebell){
      const p=document.createElement("span");
      p.className="pill pill-kettlebell"; p.textContent="Kettlebell";
      row.appendChild(p);
    }

    pastLinesEl.appendChild(row);
  });

  pastCardEl.style.display="block";
  requestAnimationFrame(()=> pastCardEl.classList.add("visible"));

  bigTimer.classList.remove("show");
  setTimeout(()=> bigTimer.classList.add("hidden"), 200);

  return true;
}

function hidePastCard(){
  if(pastCardEl.style.display==="none") return;
  pastCardEl.classList.remove("visible");
  setTimeout(()=>{
    pastCardEl.style.display="none";
    if(historyMode){
      bigTimer.classList.remove("hidden");
      requestAnimationFrame(()=> bigTimer.classList.add("show"));
    }
  },200);
}

/* -------------------------
      VIEW STATES
-------------------------- */

function anyUnlockedModes(){
  const locks=loadLocks();
  return ["pull","push","legs","full"].some(k=>!locks[k]);
}

function applyLocksToRadios(){
  const locks=loadLocks();
  qsa(".opt").forEach(lbl=>{
    const mode=lbl.dataset.mode;
    const input=lbl.querySelector("input");
    input.disabled=false;
    lbl.classList.remove("disabled");
    if(locks[mode]){
      input.disabled=true;
      lbl.classList.add("disabled");
    }
  });
}

function applyHistoryLocksToRadios(){
  const hist=loadHistory();
  qsa(".opt").forEach(lbl=>{
    const mode=lbl.dataset.mode;
    const input=lbl.querySelector("input");
    const has = !!hist[mode];
    input.disabled=!has;
    lbl.classList.toggle("disabled", !has);
  });
}

function clearRadioSelection(){
  qsa("input[name='mode']").forEach(r=> r.checked=false);
  qsa(".opt").forEach(lbl=> lbl.classList.remove("active"));
}

function showSelectionState(){
  historyMode=false;
  stopCountdown();
  bigTimer.classList.add("hidden");
  bigTimer.classList.remove("show");

  document.querySelector("#subtitle").textContent = "What would you like to train?";

  radioRow.style.display="flex";
  applyLocksToRadios();

  cardEl.style.display="none";
  pastCardEl.style.display="none";
  slideWrap.classList.add("hidden");
  mainBtn.classList.remove("hidden");
  mainBtn.classList.add("disabled");
  mainBtn.textContent="Generate";

  hidePreviewCard(true);
}

function showPreLockedState(){
  historyMode=false;
  document.querySelector("#subtitle").textContent="Next workout in";
  radioRow.style.display="none";
  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");
  hidePreviewCard(true);

  let target;
  if(DEV){
    target=getDevUnlockTime();
    if(!target){ showSelectionState(); return; }
  } else {
    target=getStartTime(false);
  }

  startBigTimer(target);
}

function showWorkoutState(workout){
  historyMode=false;
  stopCountdown();
  bigTimer.classList.add("hidden");
  bigTimer.classList.remove("show");

  document.querySelector("#subtitle").textContent="Todayâ€™s workout";

  renderWorkoutCard(workout);
  radioRow.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.remove("hidden");
  resetSlider();
  hidePreviewCard(true);
}

function showCompletedState(){
  historyMode=true;
  clearRadioSelection();
  applyHistoryLocksToRadios();

  document.querySelector("#subtitle").textContent="Hereâ€™s what you trained this week";

  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");

  updateStreakWidget();

  let target;
  if(DEV){
    target=getDevUnlockTime();
    if(!target){
      const unlockAt=Date.now()+30000;
      lsSet("dev_time_lock", String(unlockAt));
      target=new Date(unlockAt);
    }
  } else {
    target=getStartTime(true);
  }

  startBigTimer(target);
}

function showAllUsedWeekState(){
  historyMode=false;
  document.querySelector("#subtitle").textContent="All workouts used this week";
  radioRow.style.display="none";
  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");
  bigTimer.classList.add("hidden");
}

/* -------------------------
      TIMER
-------------------------- */

function stopCountdown(){
  if(countdownInterval){
    clearInterval(countdownInterval);
    countdownInterval=null;
  }
}

function startBigTimer(target){
  stopCountdown();
  bigTimer.classList.remove("hidden");
  requestAnimationFrame(()=> bigTimer.classList.add("show"));

  function tick(){
    const now=new Date();
    let diff=target-now;
    if(diff<=0){
      stopCountdown();
      bigTimer.classList.remove("show");
      setTimeout(()=>{
        bigTimer.classList.add("hidden");
        initUI();
      },300);
      return;
    }

    const totalSec=Math.floor(diff/1000);
    const h=String(Math.floor(totalSec/3600)).padStart(2,"0");
    const m=String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
    const s=String(totalSec%60).padStart(2,"0");

    tH.textContent=h;
    tM.textContent=m;
    tS.textContent=s;
  }

  tick();
  countdownInterval=setInterval(tick,1000);
}

/* -------------------------
      GENERATION
-------------------------- */

function handleGenerate(){
  if(!selectedMode) return;

  hidePreviewCard();
  aiStage.style.display="block";
  aiStage.classList.add("show");
  mainBtn.disabled=true;
  mainBtn.textContent="Generating...";
  cardEl.style.display="none";

  setTimeout(()=>{
    const workout=buildWorkout(selectedMode);
    currentWorkout=workout;

    saveWorkoutToday(workout);
    const locks=loadLocks();
    locks[selectedMode]=true;
    saveLocks(locks);

    aiStage.classList.remove("show");
    aiStage.style.display="none";
    mainBtn.disabled=false;

    showWorkoutState(workout);
  },900);
}

/* -------------------------
      SLIDE TO COMPLETE
-------------------------- */

let sliding=false;
let startX=0;
let currentX=0;
let maxSlide=0;
let knobWidth=0;
let trackWidth=0;

function resetSlider(){
  const rect=slideTrackEl.getBoundingClientRect();
  const knobRect=slideKnob.getBoundingClientRect();
  trackWidth=rect.width;
  knobWidth=knobRect.width;
  maxSlide=trackWidth-knobWidth-8;

  slideTrackEl.classList.remove("filled");
  slideKnob.style.transform="translate(0,-50%)";
  slideFillEl.style.transform="scaleX(0)";
}

slideKnob.addEventListener("pointerdown",e=>{
  e.preventDefault();
  sliding=true;
  startX=e.clientX;
  slideKnob.setPointerCapture(e.pointerId);
});

slideKnob.addEventListener("pointermove",e=>{
  if(!sliding) return;
  const dx=e.clientX - startX;
  currentX=Math.max(0, Math.min(maxSlide, dx));

  const progress=currentX/maxSlide;
  slideKnob.style.transform=`translate(${currentX}px,-50%)`;
  slideFillEl.style.transform=`scaleX(${progress})`;
});

function endSlide(e){
  if(!sliding) return;
  sliding=false;
  slideKnob.releasePointerCapture(e.pointerId);

  const progress=currentX/maxSlide;

  if(progress>0.92){
    slideKnob.style.transform=`translate(${maxSlide}px,-50%)`;
    slideFillEl.style.transform=`scaleX(1)`;
    slideTrackEl.classList.add("filled");

    if(window.confetti){
      confetti({particleCount:150,spread:80,startVelocity:30,origin:{x:0.5,y:1.1}});
    }

    saveCompletedToday(currentWorkout.mode);
    saveHistoryForMode(currentWorkout);

    if(DEV){
      const unlockAt = Date.now()+30000;
      lsSet("dev_time_lock",String(unlockAt));
    }

    updateWeeklyStatsAfterCompletion();
    updateStreakWidget();

    cardEl.style.display="none";
    slideWrap.classList.add("hidden");

    setTimeout(()=> showCompletedState(),600);

  } else {
    slideKnob.style.transform="translate(0,-50%)";
    slideFillEl.style.transform="scaleX(0)";
    slideTrackEl.classList.remove("filled");
  }
}

slideKnob.addEventListener("pointerup",endSlide);
slideKnob.addEventListener("pointercancel",endSlide);

/* -------------------------
      WEATHER
-------------------------- */

function weatherCodeToText(code){
  const map={
    0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
    45:"Fog",48:"Fog",
    51:"Drizzle",53:"Drizzle",55:"Drizzle",
    61:"Rain",63:"Rain",65:"Rain",
    71:"Snow",73:"Snow",75:"Snow",
    80:"Rain shower",81:"Rain shower",82:"Rain shower",
    95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
  };
  return map[code]||"Unknown";
}
function getWeatherEmoji(cond){
  const c=cond.toLowerCase();
  if(c.includes("clear")) return "â˜€ï¸";
  if(c.includes("cloud")) return "â›…";
  if(c.includes("rain")) return "ðŸŒ§ï¸";
  if(c.includes("drizzle")) return "ðŸŒ¦ï¸";
  if(c.includes("thunder")) return "ðŸŒ©ï¸";
  if(c.includes("snow")) return "â„ï¸";
  if(c.includes("fog")||c.includes("mist")) return "ðŸŒ«ï¸";
  return "ðŸŒ¡ï¸";
}

function updateWeatherUI(){
  if(!navigator.geolocation){
    weatherEl.textContent="Location unavailable";
    return;
  }
  weatherEl.textContent="Loading weatherâ€¦";

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;

    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res=await fetch(url);
      const data=await res.json();

      const temp=Math.round(data.current_weather.temperature);
      const cond=weatherCodeToText(data.current_weather.weathercode);
      const emoji=getWeatherEmoji(cond);

      let city="Your area";
      try{
        const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const r=await rev.json();
        city=r.address.city||r.address.town||r.address.village||r.address.county||city;
      }catch{}

      weatherEl.textContent=`${emoji} ${temp}Â°C ${city}`;
    }catch{
      weatherEl.textContent="Weather unavailable";
    }
  },()=>{
    weatherEl.textContent="Enable location for weather";
  });
}

/* -------------------------
      INIT UI
-------------------------- */

function initUI(){
  resetWeekIfNeeded();
  clearRadioSelection();
  selectedMode=null;
  hidePreviewCard(true);
  hidePastCard();

  const workout=loadWorkoutToday();
  const completed=loadCompletedToday();
  const lockedByTime=!afterStart();

  if(completed){
    showCompletedState();
  }
  else if(workout){
    showWorkoutState(workout);
  }
  else if(lockedByTime){
    showPreLockedState();
  }
  else if(!anyUnlockedModes()){
    showAllUsedWeekState();
  }
  else{
    showSelectionState();
  }

  updateStreakWidget();
}

/* -------------------------
      RADIO EVENTS
-------------------------- */

qsa("input[name='mode']").forEach(r=>{
  r.addEventListener("change",()=>{
    selectedMode=r.value;

    qsa(".opt").forEach(lbl=>{
      lbl.classList.toggle("active", lbl.dataset.mode===selectedMode);
    });

    if(historyMode){
      const shown=renderPastCardForMode(selectedMode);
      if(shown && navigator.vibrate) navigator.vibrate(6);
      return;
    }

    hidePastCard();

    mainBtn.textContent=`Generate ${modeTitle(selectedMode).replace(" Day","")}`;
    mainBtn.classList.remove("disabled");

    renderPreviewCard(selectedMode);
    showPreviewCard();
  });
});

/* -------------------------
    CLICK OUTSIDE PAST CARD
-------------------------- */

document.addEventListener("click",(e)=>{
  if(!historyMode) return;
  if(pastCardEl.style.display==="none") return;

  const insideCard=pastCardEl.contains(e.target);
  const insideRadio=radioRow.contains(e.target);

  if(!insideCard && !insideRadio){
    hidePastCard();
    clearRadioSelection();
    selectedMode=null;
  }
});

/* -------------------------
      MAIN BUTTON
-------------------------- */

mainBtn.addEventListener("click", handleGenerate);

/* -------------------------
      BOOT
-------------------------- */

initUI();
updateWeatherUI();
</script>

</body>
</html>
