<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metal Workout Builder</title>
<style>
:root {
  --bg: #ffffff;
  --ink: #0f172a;
  --sub: #64748b;
  --card: #f1f5f9;
  --pill: #3b82f6;
  --brand: #2345f5;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro", system-ui, sans-serif;
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--ink);
}
.container {
  padding: 20px;
  max-width: 480px;
  margin: auto;
}
.weather {
  font-size: 16px;
  color: var(--sub);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}
h1 {
  font-size: 32px;
  margin: 0 0 20px;
}
.block {
  background: var(--card);
  padding: 24px;
  border-radius: 20px;
  margin-bottom: 24px;
}
.block-title {
  font-size: 22px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}
.type-pill {
  display: inline-block;
  background: #e1ecff;
  color: #1d4ed8;
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 13px;
  margin-left: 8px;
}
#createBtn {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  height: 60px;
  background: var(--brand);
  color: white;
  border-radius: 40px;
  border: none;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  justify-content: center;
  align-items: center;
}
#countdownWrap {
  display: none;
  text-align: center;
  margin-top: 60px;
}
#countdownNumbers {
  font-size: 38px;
  font-weight: 700;
  letter-spacing: 4px;
}
.label-row {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-top: 8px;
  color: var(--sub);
  font-size: 14px;
}
#closedMessage {
  font-size: 16px;
  color: var(--sub);
  margin-top: 8px;
  display: none;
}
</style>
</head>
<body>

<div class="container">

  <div id="weather" class="weather">Enable location for weather</div>

  <h1>Hi Jy, welcome back</h1>

  <div id="closedMessage">Workout is currently closed</div>

  <div id="countdownWrap">
    <div id="countdownNumbers">00 00 00</div>
    <div class="label-row">
      <div>HOURS</div><div>MINS</div><div>SECS</div>
    </div>
  </div>

  <div id="workout"></div>

</div>

<button id="createBtn">Create Workout</button>

<script>
/* ------------------------------------------------------
   SETTINGS
------------------------------------------------------ */
const DEV_MODE = false;     // Set true for no restrictions
const OPEN_HOUR = 17;
const OPEN_MIN  = 30;

const metalTypes = ["Tabata","AMRAP","EMOM","Ladder","Metacon"];

/* Utility */
const chance = (p) => Math.random() < p;
const now = () => new Date();

/* ------------------------------------------------------
   WEATHER EMOJI
------------------------------------------------------ */
function weatherCodeToText(code){
  if(code===0) return "Clear";
  if([1,2,3].includes(code)) return "Partly cloudy";
  if([45,48].includes(code)) return "Fog";
  if([51,53,55].includes(code)) return "Drizzle";
  if([61,63,65].includes(code)) return "Rain";
  if([66,67].includes(code)) return "Freezing rain";
  if([71,73,75].includes(code)) return "Snow";
  if(code===95) return "Thunderstorm";
  return "Weather";
}
function weatherEmoji(txt){
  if(txt==="Clear") return "â˜€ï¸";
  if(txt==="Partly cloudy") return "â›…ï¸";
  if(txt==="Fog") return "ðŸŒ«ï¸";
  if(txt==="Drizzle") return "ðŸŒ¦ï¸";
  if(txt==="Rain") return "ðŸŒ§ï¸";
  if(txt==="Freezing rain") return "ðŸ§ŠðŸŒ§ï¸";
  if(txt==="Snow") return "â„ï¸";
  if(txt==="Thunderstorm") return "â›ˆï¸";
  return "ðŸŒ¡ï¸";
}

/* ------------------------------------------------------
   WORKOUT STORAGE
------------------------------------------------------ */
function saveWorkout(w){ localStorage.setItem("workout", JSON.stringify(w)); }
function loadWorkout(){
  let w = localStorage.getItem("workout");
  if(!w) return null;
  w = JSON.parse(w);
  return w;
}
function clearWorkout(){ localStorage.removeItem("workout"); }

/* Reset after midnight */
setInterval(() => {
  const t = now();
  if(t.getHours() === 0 && t.getMinutes() < 2){
    clearWorkout();
  }
}, 60_000);

/* ------------------------------------------------------
   TIME WINDOW
------------------------------------------------------ */
function isOpenWindow(){
  if(DEV_MODE) return true;
  const t = now();
  const start = new Date(t);
  start.setHours(OPEN_HOUR, OPEN_MIN, 0, 0);
  return t >= start;
}

/* ------------------------------------------------------
   COUNTDOWN UI
------------------------------------------------------ */
function updateCountdown(){
  const wrap = document.getElementById("countdownWrap");
  const msg  = document.getElementById("closedMessage");
  const nums = document.getElementById("countdownNumbers");

  if(DEV_MODE){
    wrap.style.display = "none";
    msg.style.display  = "none";
    return;
  }
  if(isOpenWindow()){
    wrap.style.display = "none";
    msg.style.display  = "none";
    return;
  }

  wrap.style.display = "block";
  msg.style.display  = "block";

  let t = now();
  let target = new Date();
  target.setHours(OPEN_HOUR, OPEN_MIN, 0, 0);
  if(t > target) target.setDate(target.getDate()+1);

  let diff = target - t;
  let sec = Math.floor(diff/1000);
  let hr  = Math.floor(sec/3600); sec%=3600;
  let mn  = Math.floor(sec/60);   sec%=60;

  const pad = n => (n<10?"0"+n:n);

  nums.textContent = `${pad(hr)}   ${pad(mn)}   ${pad(sec)}`;
}

/* ------------------------------------------------------
   METAL TYPE GENERATOR
------------------------------------------------------ */
function generateMetalTypes(min, max){
  let count = Math.floor(Math.random()*(max-min+1))+min;
  let copy = [...metalTypes];
  let out = [];
  for(let i=0; i<count; i++){
    let pick = copy.splice(Math.floor(Math.random()*copy.length),1)[0];
    out.push(pick);
  }
  return out;
}

/* ------------------------------------------------------
   WORKOUT GENERATOR
------------------------------------------------------ */
function generateWorkout(){
  let workout = { blocks: [] };

  /* Decide fullbody or split */
  let fullbody = chance(0.5);

  if(fullbody){
    let count = chance(0.5) ? 2 : 3;
    workout.blocks = [{
      title:"ðŸ”¥ Full body",
      abs:false,
      types: generateMetalTypes(count,count)
    }];
  } else {
    // SPLIT MODE â€” never both have 2
    let upperCount, lowerCount;

    if(chance(0.33)){
      upperCount = 1; lowerCount = 1;
    } else {
      if(chance(0.5)){
        upperCount = 2; lowerCount = 1;
      } else {
        upperCount = 1; lowerCount = 2;
      }
    }

    workout.blocks.push({
      title:"ðŸ’ª Upper Body",
      abs: chance(0.5),
      types: generateMetalTypes(upperCount, upperCount)
    });
    workout.blocks.push({
      title:"ðŸ¦µ Lower Body",
      abs: chance(0.5),
      types: generateMetalTypes(lowerCount, lowerCount)
    });
  }

  saveWorkout(workout);
  renderWorkout(workout);
}

/* ------------------------------------------------------
   RENDER WORKOUT
------------------------------------------------------ */
function renderWorkout(w){
  const wrap = document.getElementById("workout");
  wrap.innerHTML = "";

  w.blocks.forEach(b => {
    let div = document.createElement("div");
    div.className = "block";

    let t = document.createElement("div");
    t.className = "block-title";
    t.textContent = b.title + (b.abs ? " + Abs" : "");
    div.appendChild(t);

    b.types.forEach(type=>{
      let p = document.createElement("div");
      p.style.fontSize = "18px";
      p.style.marginTop = "10px";
      p.textContent = type;
      div.appendChild(p);
    });

    wrap.appendChild(div);
  });
}

/* ------------------------------------------------------
   BUTTON STATE
------------------------------------------------------ */
function updateButtonState(){
  const btn = document.getElementById("createBtn");
  const saved = loadWorkout();

  if(DEV_MODE){
    btn.style.display = "flex";
    btn.disabled = false;
    btn.textContent = "Create Workout (DEV)";
    return;
  }
  if(!isOpenWindow()){
    btn.style.display = "none";
    return;
  }
  if(saved){
    btn.style.display = "none";
  } else {
    btn.style.display = "flex";
    btn.disabled = false;
    btn.textContent = "Create Workout";
  }
}

/* ------------------------------------------------------
   WEATHER FETCH
------------------------------------------------------ */
async function updateWeather(){
  const el = document.getElementById("weather");
  if(!navigator.geolocation){
    el.textContent = "Enable location for weather";
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      let lat = pos.coords.latitude;
      let lon = pos.coords.longitude;

      let w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
      let wj = await w.json();
      let temp = wj.current_weather.temperature;
      let cond = weatherCodeToText(wj.current_weather.weathercode);
      let emoji = weatherEmoji(cond);

      let rev = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      let r = await rev.json();
      let city = r.address.city || r.address.town || r.address.village || "Your area";

      el.textContent = `${emoji} ${temp}Â°C ${city}`;
    }catch(e){
      el.textContent = "Weather unavailable";
    }
  },()=>{
    el.textContent = "Enable location for weather";
  });
}

/* ------------------------------------------------------
   INIT
------------------------------------------------------ */
document.getElementById("createBtn").onclick = ()=>{
  generateWorkout();
  updateButtonState();
};

let saved = loadWorkout();
if(saved) renderWorkout(saved);

updateWeather();
updateButtonState();
updateCountdown();
setInterval(updateCountdown,1000);
</script>
</body>
</html>>
