<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metal Workout Builder</title>

<style>
:root {
  --bg: #ffffff;
  --ink: #0f172a;
  --sub: #64748b;
  --card: #f1f5f9;
  --brand: #2345f5;
}

/* GENERAL */
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--ink);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro", system-ui, sans-serif;
}

/* HEADER */
.header {
  padding: 20px;
  max-width: 480px;
  margin: auto;
}

.weather {
  font-size: 16px;
  color: var(--sub);
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
}

h1 {
  font-size: 32px;
  margin: 0 0 20px;
}

/* CENTERED COUNTDOWN */
.center-vertical {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -40%);
  width: 100%;
  max-width: 480px;
  text-align: center;
  padding: 20px;
  pointer-events: none;
}

#closedMessage {
  font-size: 16px;
  color: var(--sub);
  display: none;
  margin-bottom: 20px;
}

#countdownWrap {
  display: none;
}

#countdownGrid {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 10px;
}

.col {
  text-align: center;
}

.num {
  font-size: 44px;
  letter-spacing: 2px;
  font-weight: 400;
}

.label {
  margin-top: 10px;
  font-size: 15px;
  color: var(--sub);
}

/* WORKOUT BLOCKS */
#workout {
  padding: 20px;
  max-width: 480px;
  margin: 140px auto 100px;
}

.block {
  background: var(--card);
  padding: 24px;
  border-radius: 20px;
  margin-bottom: 24px;
}

.block-title {
  font-size: 22px;
  font-weight: 700;
}

/* BUTTON */
#createBtn {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  height: 60px;
  background: var(--brand);
  color: white;
  border-radius: 40px;
  border: none;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  justify-content: center;
  align-items: center;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div id="weather" class="weather">Enable location for weather</div>
  <h1>Hi Jy, welcome back</h1>
</div>

<!-- COUNTDOWN CENTERED -->
<div class="center-vertical">
  <div id="closedMessage">Workout is currently closed</div>

  <div id="countdownWrap">
    <div id="countdownGrid">
      <div class="col">
        <div id="cc-hours" class="num">00</div>
        <div class="label">HOURS</div>
      </div>
      <div class="col">
        <div id="cc-mins" class="num">00</div>
        <div class="label">MINS</div>
      </div>
      <div class="col">
        <div id="cc-secs" class="num">00</div>
        <div class="label">SECS</div>
      </div>
    </div>
  </div>
</div>

<!-- WORKOUT AREA -->
<div id="workout"></div>

<!-- BUTTON -->
<button id="createBtn">Create Workout</button>

<script>
/* -------------------------------------------------
   DEV MODE
-------------------------------------------------- */
const params = new URLSearchParams(window.location.search);
const DEV_MODE = params.get("dev") === "true";

/* -------------------------------------------------
   WEATHER EMOJI TABLE (Fixed)
-------------------------------------------------- */
const WEATHER = {
  0: "â˜€ï¸", 1: "ðŸŒ¤ï¸", 2: "â›…ï¸", 3: "â˜ï¸",
  45: "ðŸŒ«ï¸", 48: "ðŸŒ«ï¸",
  51: "ðŸŒ¦ï¸", 53: "ðŸŒ¦ï¸", 55: "ðŸŒ¦ï¸",
  61: "ðŸŒ§ï¸", 63: "ðŸŒ§ï¸", 65: "ðŸŒ§ï¸",
  66: "ðŸŒ§ï¸", 67: "ðŸŒ§ï¸",
  71: "â„ï¸", 73: "â„ï¸", 75: "â„ï¸",
  95: "â›ˆï¸", 96: "â›ˆï¸", 99: "â›ˆï¸"
};

async function updateWeather(){
  const el = document.getElementById("weather");

  if(!navigator.geolocation){
    el.innerHTML = "Enable location for weather";
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
      const jw = await w.json();

      const temp = jw.current_weather.temperature;
      const code = jw.current_weather.weathercode;
      const emoji = WEATHER[code] || "ðŸŒ¡ï¸";

      const r = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
      );
      const jr = await r.json();
      const city = jr.address.city || jr.address.town || jr.address.village || "Your area";

      el.innerHTML = `${emoji} ${temp}Â°C ${city}`;
    } catch {
      el.innerHTML = "Weather unavailable";
    }
  },()=> el.innerHTML = "Enable location for weather");
}

/* -------------------------------------------------
   TIME WINDOW (LIVE MODE)
-------------------------------------------------- */
const OPEN_H = 17;
const OPEN_M = 30;

function isOpenWindow(){
  if(DEV_MODE) return true;
  const t = new Date();
  const start = new Date();
  start.setHours(OPEN_H, OPEN_M, 0, 0);
  return t >= start;
}

/* -------------------------------------------------
   COUNTDOWN 
-------------------------------------------------- */
function updateCountdown(){
  const msg  = document.getElementById("closedMessage");
  const wrap = document.getElementById("countdownWrap");

  if(DEV_MODE){
    msg.style.display = "none";
    wrap.style.display = "none";
    return;
  }

  if(isOpenWindow()){
    msg.style.display = "none";
    wrap.style.display = "none";
    return;
  }

  msg.style.display = "block";
  wrap.style.display = "block";

  const now = new Date();
  let open = new Date();
  open.setHours(OPEN_H, OPEN_M, 0, 0);

  let diff = open - now;
  if(diff < 0) diff += 24*3600*1000;

  let s = Math.floor(diff / 1000);
  let h = Math.floor(s / 3600); s %= 3600;
  let m = Math.floor(s / 60); s %= 60;

  const pad = n => n < 10 ? "0"+n : n;

  document.getElementById("cc-hours").textContent = pad(h);
  document.getElementById("cc-mins").textContent  = pad(m);
  document.getElementById("cc-secs").textContent  = pad(s);
}

/* -------------------------------------------------
   WORKOUT GENERATOR
-------------------------------------------------- */
const metalTypes = ["Tabata","AMRAP","EMOM","Ladder","Metacon"];
const chance = p => Math.random() < p;

function pickRandom(list, count){
  let pool = [...list];
  let out = [];
  while(out.length < count && pool.length){
    const idx = Math.floor(Math.random() * pool.length);
    out.push(pool.splice(idx,1)[0]);
  }
  return out;
}

function generateWorkout(){
  let workout = { blocks: [] };

  if(chance(0.5)){
    const count = chance(0.5) ? 2 : 3;
    workout.blocks.push({
      title: "ðŸ”¥ Full Body",
      abs: false,
      types: pickRandom(metalTypes, count)
    });
  } else {
    let upperCount, lowerCount;

    if(chance(0.33)){
      upperCount = 1;
      lowerCount = 1;
    } else {
      if(chance(0.5)){ upperCount = 2; lowerCount = 1; }
      else           { upperCount = 1; lowerCount = 2; }
    }

    workout.blocks.push({
      title: "ðŸ’ª Upper Body",
      abs: chance(0.5),
      types: pickRandom(metalTypes, upperCount)
    });

    workout.blocks.push({
      title: "ðŸ¦µ Lower Body",
      abs: chance(0.5),
      types: pickRandom(metalTypes, lowerCount)
    });
  }

  if(!DEV_MODE){
    localStorage.setItem("workout", JSON.stringify(workout));
  }

  return workout;
}

/* -------------------------------------------------
   RENDER WORKOUT (NO STACKING EVER)
-------------------------------------------------- */
function renderWorkout(w){
  const wrap = document.getElementById("workout");

  wrap.innerHTML = ""; // ALWAYS REPLACE

  w.blocks.forEach(b=>{
    const div = document.createElement("div");
    div.className = "block";

    const title = document.createElement("div");
    title.className = "block-title";
    title.textContent = b.title + (b.abs ? " + Abs" : "");
    div.appendChild(title);

    b.types.forEach(type=>{
      const item = document.createElement("div");
      item.style.fontSize = "18px";
      item.style.marginTop = "10px";
      item.textContent = type;
      div.appendChild(item);
    });

    wrap.appendChild(div);
  });
}

/* -------------------------------------------------
   BUTTON STATE
-------------------------------------------------- */
function updateButtonState(){
  const btn = document.getElementById("createBtn");

  if(DEV_MODE){
    btn.style.display = "flex";
    btn.disabled = false;
    return;
  }

  if(!isOpenWindow()){
    btn.style.display = "none";
    return;
  }

  const saved = localStorage.getItem("workout");

  if(saved){
    btn.style.display = "none";
  } else {
    btn.style.display = "flex";
  }
}

/* -------------------------------------------------
   INIT + CLICK LOGIC
-------------------------------------------------- */
document.getElementById("createBtn").onclick = () => {
  const w = generateWorkout();
  renderWorkout(w);
  updateButtonState();
};

function init(){
  updateWeather();

  const stored = !DEV_MODE ? localStorage.getItem("workout") : null;
  if(stored && isOpenWindow()){
    renderWorkout(JSON.parse(stored));
  }

  updateButtonState();
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

init();
</script>
</body>
</html>
