<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

<style>
  :root{
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#f8fafc;

    --shadow-soft:0 18px 48px rgba(15,23,42,0.14);
    --shadow-subtle:0 8px 18px rgba(15,23,42,0.10);

    /* streak */
    --streak-bg:#e5e7eb;
    --streak-fill:#f97316;

    /* 8 distinct soft pills (previous vibe, none duplicated) */
    --pill-blue-bg:#e4ecff;   --pill-blue-tx:#2453f5;  /* push */
    --pill-green-bg:#d9fbe3;  --pill-green-tx:#22c55e; /* pull */
    --pill-purple-bg:#ede9fe; --pill-purple-tx:#7c3aed;/* upper */
    --pill-pink-bg:#fce7f3;   --pill-pink-tx:#db2777;  /* shoulders */
    --pill-orange-bg:#fff7ed; --pill-orange-tx:#ea580c;/* legs */
    --pill-teal-bg:#ecfeff;   --pill-teal-tx:#0891b2;  /* abs */
    --pill-yellow-bg:#fef9c3; --pill-yellow-tx:#ca8a04;/* cardio */
    --pill-red-bg:#ffe4e6;    --pill-red-tx:#e11d48;   /* fullbody */
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased;
  }

  .container{
    max-width:480px;
    margin:0 auto;
    padding:24px;
    padding-bottom:200px;
  }

  /* STREAK (top-left) */
  .streak-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .streak-fire{
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:800;
    color:var(--streak-fill);
  }
  .streak-count{ min-width:18px; font-variant-numeric:tabular-nums; }
  .streak-bar{
    width:150px;
    height:8px;
    border-radius:999px;
    background:var(--streak-bg);
    overflow:hidden;
  }
  .streak-bar-fill{
    height:100%;
    width:0%;
    background:var(--streak-fill);
    transition:width .32s ease;
  }

  h1{
    font-size:30px;
    font-weight:900;
    margin:6px 0 6px;
    letter-spacing:-0.2px;
  }
  .subtitle{
    font-size:17px;
    color:var(--sub);
    margin:0 0 18px;
  }

  /* AI gradient loader */
  .ai{
    position:fixed;
    inset:0;
    display:none;
    pointer-events:none;
    z-index:20;
  }
  .ai::before{
    content:"";
    position:absolute;
    inset:-20%;
    filter:blur(90px) saturate(160%) contrast(115%);
    opacity:.95;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    animation:meshBreath 2s ease-in-out infinite, meshDrift 3s ease-in-out infinite;
  }
  @keyframes meshBreath{
    0%,100%{ transform:scale(1); opacity:.75 }
    50%{ transform:scale(1.05); opacity:.35 }
  }
  @keyframes meshDrift{
    0%{ transform:translate3d(0,0,0); }
    50%{ transform:translate3d(2%,-1.5%,0); }
    100%{ transform:translate3d(0,0,0); }
  }

  /* WORKOUT CARD */
  .card{
    background:#fff;
    border-radius:18px;
    padding:20px;
    box-shadow:var(--shadow-soft);
    display:none;
    opacity:0;
    transform:translateY(18px) scale(.97);
    transition:
      opacity .35s ease,
      transform .35s cubic-bezier(.18,.84,.32,1.12);
  }
  .card.show{ display:block; }
  .card.visible{
    opacity:1;
    transform:translateY(0) scale(1);
  }

  .card-title{
    font-size:20px;
    font-weight:900;
    margin:0 0 16px;
    letter-spacing:-0.2px;
  }

  .line{
    font-size:16px;
    margin-bottom:10px;
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .pill{
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:800;
    line-height:1;
    box-shadow:0 0 0 1px rgba(15,23,42,0.04);
    text-transform:lowercase;
  }

  .pill-push{ background:var(--pill-blue-bg); color:var(--pill-blue-tx); }
  .pill-pull{ background:var(--pill-green-bg); color:var(--pill-green-tx); }
  .pill-upper{ background:var(--pill-purple-bg); color:var(--pill-purple-tx); }
  .pill-shoulders{ background:var(--pill-pink-bg); color:var(--pill-pink-tx); }
  .pill-legs{ background:var(--pill-orange-bg); color:var(--pill-orange-tx); }
  .pill-abs{ background:var(--pill-teal-bg); color:var(--pill-teal-tx); }
  .pill-cardio{ background:var(--pill-yellow-bg); color:var(--pill-yellow-tx); }
  .pill-fullbody{ background:var(--pill-red-bg); color:var(--pill-red-tx); }

  /* WEEK SUMMARY (engraved) */
  .summary{
    display:none;
    text-align:center;
    margin-top:28px;
  }
  .summary.show{ display:block; }
  .summary-num{
    font-size:96px;
    font-weight:950;
    letter-spacing:-2px;
    color:#e5e7eb;
    text-shadow:
      0 1px 0 rgba(255,255,255,.9),
      0 -1px 0 rgba(0,0,0,.05);
  }
  .summary-text{
    font-size:18px;
    color:var(--sub);
    margin-top:4px;
  }

  /* FIXED BUTTON STACK */
  .fixed-stack{
    position:fixed;
    left:50%;
    bottom:24px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    z-index:10;
  }

  .btn{
    width:100%;
    height:56px;
    border-radius:28px;
    border:none;
    font-size:18px;
    font-weight:800;
    cursor:pointer;
  }

  /* Generate (NO shadow) */
  #generateBtn{
    background:var(--brand);
    color:#fff;
    box-shadow:none;
  }
  #generateBtn:active{ transform:scale(.985); }

  /* Exercises full-size */
  #exerciseBtn{
    margin-top:12px;
    background:#eef2f7;
    color:var(--brand);
    box-shadow:none;
    font-size:16px;
    font-weight:900;
  }
  #exerciseBtn:active{ transform:scale(.99); }

  /* SLIDER (sits where exercise button was) */
  #slideWrap{
    margin-top:12px;
    display:none;
  }
  .slide-track{
    position:relative;
    height:56px;
    border-radius:999px;
    background:#e5e7eb;
    overflow:hidden;
    user-select:none;
    touch-action:none;
    box-shadow:0 10px 22px rgba(15,23,42,0.12);
  }
  .slide-track.filled{
    background:linear-gradient(135deg,#2453f5,#4f8cff);
  }
  .slide-fill{
    position:absolute;
    inset:0;
    border-radius:999px;
    pointer-events:none;
    background:linear-gradient(120deg,#2453f5,#4f8cff);
    transform-origin:left center;
    transform:scaleX(0);
    transition:transform .18s ease-out;
  }
  .slide-label{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    font-size:16px;
    font-weight:900;
    color:#2453f5;
  }
  /* accessibility: when filled text becomes white */
  .slide-track.filled .slide-label{ color:#fff; }

  .slide-knob{
    position:absolute;
    top:50%;
    left:4px;
    width:48px;
    height:48px;
    border-radius:50%;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 8px 16px rgba(15,23,42,0.18);
    transform:translate(0,-50%);
    touch-action:none;
  }
  .slide-knob .arrow{
    font-size:20px;
    color:var(--brand);
    font-weight:900;
  }

  /* MODAL */
  .modal{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.35);
    display:none;
    z-index:50;
  }
  .modal.show{ display:block; }

  .sheet{
    position:absolute;
    left:0; right:0; bottom:0;
    background:#fff;
    border-radius:18px 18px 0 0;
    max-height:78vh;
    overflow:auto;
    padding:14px 14px 18px;
    box-shadow:0 -20px 60px rgba(15,23,42,0.18);
  }

  .modal-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .modal-title{
    font-size:16px;
    font-weight:950;
  }
  .modal-close{
    border:none;
    background:#eef2f7;
    border-radius:10px;
    padding:8px 10px;
    font-weight:950;
    cursor:pointer;
  }

  .tabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .tab{
    padding:7px 12px;
    border-radius:999px;
    background:#f1f5f9;
    font-size:13px;
    font-weight:900;
    cursor:pointer;
    text-transform:lowercase;
  }
  .tab.active{
    background:#e4ecff;
    color:#1d4ed8;
  }

  .ex-row{
    display:flex;
    gap:8px;
    margin-bottom:8px;
  }
  .ex-row input{
    flex:1;
    padding:10px 10px;
    border:1px solid #e5e7eb;
    border-radius:12px;
    font-size:14px;
    outline:none;
  }
  .ex-del{
    border:none;
    background:#ffe4e6;
    color:#be123c;
    border-radius:12px;
    padding:10px 12px;
    font-weight:950;
    cursor:pointer;
  }

  .add-row{
    display:flex;
    gap:8px;
    margin-top:12px;
  }
  .add-row input{
    flex:1;
    padding:10px 10px;
    border:1px solid #e5e7eb;
    border-radius:12px;
    font-size:14px;
  }
  .add-btn{
    border:none;
    background:#dcfce7;
    color:#166534;
    border-radius:12px;
    padding:10px 14px;
    font-weight:950;
    cursor:pointer;
  }

  /* LOTTIE overlay */
  #celebration{
    position:fixed;
    inset:0;
    display:none;
    pointer-events:none;
    z-index:9999;
  }
</style>
</head>

<body>
  <div class="container">
    <!-- STREAK -->
    <div class="streak-row">
      <div class="streak-fire">
        <span>ðŸ”¥</span>
        <span id="streakCount" class="streak-count">0</span>
      </div>
      <div class="streak-bar">
        <div id="streakBarFill" class="streak-bar-fill"></div>
      </div>
    </div>

    <h1>Welcome back Jy</h1>
    <div class="subtitle">Today's mixed workout</div>

    <!-- Workout Card -->
    <div id="workoutCard" class="card"></div>

    <!-- Weekly Summary -->
    <div id="weekSummary" class="summary">
      <div id="weekNumber" class="summary-num">0</div>
      <div class="summary-text">
        workout<span id="plural">s</span> completed this week
      </div>
    </div>
  </div>

  <!-- AI Gradient -->
  <div id="ai" class="ai"></div>

  <!-- FIXED BUTTONS -->
  <div class="fixed-stack">
    <button id="generateBtn" class="btn">Generate Workout</button>
    <button id="exerciseBtn" class="btn">Exercises</button>

    <!-- Slider replaces exercise button when workout is active -->
    <div id="slideWrap">
      <div id="slideTrack" class="slide-track">
        <div id="slideFill" class="slide-fill"></div>
        <div class="slide-label">Slide to Complete</div>
        <div id="slideKnob" class="slide-knob"><span class="arrow">â†’</span></div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="modal-top">
        <div class="modal-title">Exercises</div>
        <button id="modalClose" class="modal-close">Close</button>
      </div>

      <div id="tabs" class="tabs"></div>
      <div id="exerciseList"></div>

      <div class="add-row">
        <input id="newName" placeholder="Exercise name" />
        <input id="newReps" placeholder="Reps (AMRAP only)" />
        <button id="addExercise" class="add-btn">Add</button>
      </div>
    </div>
  </div>

  <!-- LOTTIE -->
  <div id="celebration">
    <lottie-player
      src="https://assets10.lottiefiles.com/packages/lf20_touohxv0.json"
      background="transparent"
      speed="1"
      style="width:100%;height:100%;"
      autoplay>
    </lottie-player>
  </div>

<script>
/* =========================
   STORAGE KEYS
========================= */
const LS = {
  exercises:   "jy_exercises_v3",
  weekKey:     "jy_week_key_v3",
  weekSummary: "jy_week_summary_v3",  // {week, workouts, counted}
  streak:      "jy_streak_v3"
};

/* =========================
   WEEK KEY (stable)
========================= */
function weekKey(){
  const d = new Date();
  const jan1 = new Date(d.getFullYear(),0,1);
  const days = Math.floor((d - jan1) / 86400000);
  const week = Math.ceil((days + jan1.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${week}`;
}

/* =========================
   STREAK + WEEKLY ROLLOVER
   - 3 completions in a week -> +1 streak (once)
   - if week ends with <3 -> streak resets to 0
========================= */
function getStreak(){
  const n = parseInt(localStorage.getItem(LS.streak) || "0", 10);
  return Number.isFinite(n) && n > 0 ? n : 0;
}
function setStreak(n){
  localStorage.setItem(LS.streak, String(Math.max(0, n|0)));
}
function loadWeekSummary(){
  const raw = localStorage.getItem(LS.weekSummary);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function saveWeekSummary(obj){
  localStorage.setItem(LS.weekSummary, JSON.stringify(obj));
}

function rolloverWeekIfNeeded(){
  const curWeek = weekKey();
  const prevWeek = localStorage.getItem(LS.weekKey);
  let streak = getStreak();
  let summary = loadWeekSummary();

  if(prevWeek && prevWeek !== curWeek){
    // week changed -> evaluate last week
    if(summary && summary.week === prevWeek){
      if(summary.workouts < 3){
        streak = 0;
        setStreak(streak);
      }
    }
    // new week reset
    localStorage.setItem(LS.weekKey, curWeek);
    summary = {week:curWeek, workouts:0, counted:false};
    saveWeekSummary(summary);
  }else{
    if(!prevWeek) localStorage.setItem(LS.weekKey, curWeek);
    if(!summary || summary.week !== curWeek){
      summary = {week:curWeek, workouts:0, counted:false};
      saveWeekSummary(summary);
    }
  }
}

/* update streak + progress after a completion */
function recordCompletion(){
  rolloverWeekIfNeeded();
  let streak = getStreak();
  let summary = loadWeekSummary() || {week:weekKey(), workouts:0, counted:false};

  summary.workouts = Math.max(0, (summary.workouts|0) + 1);

  let streakIncreased = false;
  if(summary.workouts >= 3 && !summary.counted){
    streak += 1;
    summary.counted = true;
    setStreak(streak);
    streakIncreased = true;
  }else{
    setStreak(streak);
  }
  saveWeekSummary(summary);

  return { streak, workouts: summary.workouts, streakIncreased };
}

/* render streak UI */
function renderStreakUI(){
  rolloverWeekIfNeeded();
  const streak = getStreak();
  const summary = loadWeekSummary() || {workouts:0};
  const done = summary.workouts || 0;

  document.getElementById("streakCount").textContent = String(streak);
  document.getElementById("streakBarFill").style.width = (Math.min(done/3,1)*100) + "%";
}

/* render week summary screen */
function renderWeekSummary(){
  rolloverWeekIfNeeded();
  const summary = loadWeekSummary() || {workouts:0};
  const done = summary.workouts || 0;

  const el = document.getElementById("weekSummary");
  const num = document.getElementById("weekNumber");
  const plural = document.getElementById("plural");

  num.textContent = String(done);
  plural.textContent = done === 1 ? "" : "s";

  el.classList.add("show");
}

/* =========================
   CATEGORIES (8 tags)
   - pull: 80%
   - push: 80%
   - upper: 50%
   - shoulders: 50%
   - rest: 50%
========================= */
const CATS = [
  { key:"pull",      pill:"pill-pull",      p:0.80 },
  { key:"push",      pill:"pill-push",      p:0.80 },
  { key:"upper",     pill:"pill-upper",     p:0.50 },
  { key:"shoulders", pill:"pill-shoulders", p:0.50 },
  { key:"legs",      pill:"pill-legs",      p:0.50 },
  { key:"abs",       pill:"pill-abs",       p:0.50 },
  { key:"cardio",    pill:"pill-cardio",    p:0.50 },
  { key:"fullbody",  pill:"pill-fullbody",  p:0.50 }
];
const CAT_KEYS = CATS.map(c => c.key);

function pillClass(cat){
  const c = CATS.find(x => x.key === cat);
  return c ? c.pill : "pill-push";
}

/* =========================
   DEFAULT EXERCISES
   - reps are single reps (not range)
   - MetCon will NOT show reps
========================= */
const DEFAULT = {
  push:      [{name:"Push-Ups", reps:"10"}, {name:"Dips", reps:"10"}, {name:"Decline Push-Ups", reps:"10"}, {name:"Diamond Push-Ups", reps:"10"}],
  pull:      [{name:"Pull-Ups", reps:"5"}, {name:"Chin-Ups", reps:"5"}, {name:"Australian Chin-Ups", reps:"10"}],
  upper:     [{name:"Muscle-Up", reps:"1"}],
  shoulders: [{name:"Pike Push-Ups", reps:"10"}, {name:"Dolphin Push-Ups", reps:"10"}],
  legs:      [{name:"Jumping Squats", reps:"15"}, {name:"Jumping Lunges", reps:"15"}],
  abs:       [{name:"Knee Raises", reps:"20"}, {name:"Full Body Raises", reps:"20"}, {name:"Oblique Twists", reps:"10"}],
  cardio:    [{name:"Jumping Jacks", reps:"20"}, {name:"Mountain Climbers", reps:"20"}],
  fullbody:  [{name:"Burpees", reps:"10"}, {name:"Kettlebell Swings", reps:"10"}]
};

function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

function loadExercises(){
  const raw = localStorage.getItem(LS.exercises);
  if(!raw){
    localStorage.setItem(LS.exercises, JSON.stringify(DEFAULT));
    return deepClone(DEFAULT);
  }
  try{
    const obj = JSON.parse(raw);
    CAT_KEYS.forEach(k => { if(!Array.isArray(obj[k])) obj[k] = []; });
    return obj;
  }catch{
    localStorage.setItem(LS.exercises, JSON.stringify(DEFAULT));
    return deepClone(DEFAULT);
  }
}
function saveExercises(obj){
  localStorage.setItem(LS.exercises, JSON.stringify(obj));
}

/* =========================
   DOM
========================= */
const workoutCard = document.getElementById("workoutCard");
const generateBtn = document.getElementById("generateBtn");
const exerciseBtn = document.getElementById("exerciseBtn");

const ai = document.getElementById("ai");

const slideWrap = document.getElementById("slideWrap");
const slideTrack = document.getElementById("slideTrack");
const slideFill = document.getElementById("slideFill");
const slideKnob = document.getElementById("slideKnob");

const weekSummaryEl = document.getElementById("weekSummary");

const celebration = document.getElementById("celebration");

/* modal */
const modal = document.getElementById("modal");
const modalClose = document.getElementById("modalClose");
const tabsEl = document.getElementById("tabs");
const listEl = document.getElementById("exerciseList");
const newNameEl = document.getElementById("newName");
const newRepsEl = document.getElementById("newReps");
const addExerciseBtn = document.getElementById("addExercise");

let activeWorkout = null;

/* =========================
   UI STATES
========================= */
function showAI(on){
  ai.style.display = on ? "block" : "none";
}
function showCard(html){
  workoutCard.innerHTML = html;
  workoutCard.classList.add("show");
  workoutCard.classList.remove("visible");
  void workoutCard.offsetWidth;
  workoutCard.classList.add("visible");
}
function hideCard(){
  workoutCard.classList.remove("visible");
  setTimeout(()=>{
    workoutCard.classList.remove("show");
    workoutCard.innerHTML = "";
  },180);
}

function setIdle(){
  generateBtn.style.display = "block";
  exerciseBtn.style.display = "block";
  slideWrap.style.display = "none";
  resetSlider();
}
function setInWorkout(){
  generateBtn.style.display = "none";
  exerciseBtn.style.display = "none";
  slideWrap.style.display = "block";
  resetSlider();
}

/* =========================
   WORKOUT GENERATION
========================= */
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){ return arr.slice().sort(()=>Math.random()-0.5); }

function buildAMRAP(exData){
  // pick categories based on probability -> then clamp to 2..4
  let eligible = CATS.filter(c => Math.random() < c.p).map(c => c.key);
  eligible = shuffle(eligible);

  // ensure at least 2
  if(eligible.length < 2){
    const pool = shuffle(CAT_KEYS.filter(k => !eligible.includes(k)));
    while(eligible.length < 2 && pool.length) eligible.push(pool.pop());
  }

  const target = Math.floor(Math.random()*3) + 2; // 2..4
  eligible = eligible.slice(0, Math.min(4, target));

  // safety
  if(eligible.length < 2){
    const pool = shuffle(CAT_KEYS.filter(k => !eligible.includes(k)));
    while(eligible.length < 2 && pool.length) eligible.push(pool.pop());
  }

  const items = eligible.map(cat=>{
    const list = exData[cat] || [];
    const ex = list.length ? rand(list) : {name:cat, reps:""};
    return {cat, name:ex.name, reps:ex.reps};
  });

  return { type:"amrap", title:"As Many Rounds As Possible", items };
}

function buildMetCon(exData){
  const cats = shuffle(CAT_KEYS); // all categories, random order each time
  const items = cats.map(cat=>{
    const list = exData[cat] || [];
    const ex = list.length ? rand(list) : {name:cat, reps:""};
    return {cat, name:ex.name, reps:ex.reps};
  });
  return { type:"metcon", title:"Metabolic Conditioning", items };
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll("\"","&quot;")
    .replaceAll("'","&#039;");
}

function renderWorkout(workout){
  const header = `<div class="card-title">${escapeHtml(workout.title)}</div>`;

  const rows = workout.items.map(it=>{
    const left = workout.type === "amrap"
      ? `${(it.reps||"").trim()} ${it.name}`.trim()
      : it.name;

    return `
      <div class="line">
        <span>${escapeHtml(left)}</span>
        <span class="pill ${pillClass(it.cat)}">${escapeHtml(it.cat)}</span>
      </div>
    `;
  }).join("");

  showCard(header + rows);
}

function generateWorkout(){
  if(activeWorkout) return;

  // hide week summary if visible
  weekSummaryEl.classList.remove("show");

  showAI(true);
  generateBtn.disabled = true;

  setTimeout(()=>{
    showAI(false);
    generateBtn.disabled = false;

    const exData = loadExercises();

    // 60% AMRAP, 40% MetCon (tweak if you want)
    const isAMRAP = Math.random() < 0.6;
    activeWorkout = isAMRAP ? buildAMRAP(exData) : buildMetCon(exData);

    renderWorkout(activeWorkout);
    setInWorkout();
  }, 900);
}

/* =========================
   SLIDER
========================= */
let sliding=false;
let startX=0;
let currentX=0;
let maxSlide=0;

function resetSlider(){
  slideTrack.classList.remove("filled");
  slideKnob.style.transition = "none";
  slideFill.style.transition = "none";
  slideKnob.style.transform = "translate(0,-50%)";
  slideFill.style.transform = "scaleX(0)";
  setTimeout(()=>{
    slideKnob.style.transition = "transform .2s ease-out";
    slideFill.style.transition = "transform .2s ease-out";
  }, 20);
}

slideKnob.addEventListener("pointerdown",(e)=>{
  if(!activeWorkout) return;
  e.preventDefault();
  sliding=true;
  slideKnob.setPointerCapture(e.pointerId);

  const trackRect = slideTrack.getBoundingClientRect();
  const knobRect  = slideKnob.getBoundingClientRect();
  maxSlide = (trackRect.width - knobRect.width - 8);

  startX = e.clientX;
  currentX = 0;

  slideKnob.style.transition = "none";
  slideFill.style.transition = "none";

  if(navigator.vibrate) navigator.vibrate(6);
});

slideKnob.addEventListener("pointermove",(e)=>{
  if(!sliding) return;
  const dx = e.clientX - startX;
  const x = Math.max(0, Math.min(maxSlide, dx));
  currentX = x;

  const progress = maxSlide === 0 ? 0 : (x / maxSlide);
  slideKnob.style.transform = `translate(${x}px,-50%)`;
  slideFill.style.transform = `scaleX(${progress})`;
});

function endSlide(e){
  if(!sliding) return;
  sliding=false;
  try{ slideKnob.releasePointerCapture(e.pointerId); }catch{}

  slideKnob.style.transition = "transform .22s ease-out";
  slideFill.style.transition = "transform .22s ease-out";

  const progress = maxSlide === 0 ? 0 : (currentX / maxSlide);

  if(progress > 0.92){
    slideKnob.style.transform = `translate(${maxSlide}px,-50%)`;
    slideFill.style.transform = "scaleX(1)";
    slideTrack.classList.add("filled"); // text becomes white here (CSS)
    if(navigator.vibrate) navigator.vibrate(15);

    // Lottie celebration
    celebration.style.display = "block";
    setTimeout(()=>{ celebration.style.display = "none"; }, 2200);

    // Record completion (streak/progress)
    const stats = recordCompletion();
    renderStreakUI();

    // Hide workout + return to idle + show summary
    setTimeout(()=>{
      hideCard();
      activeWorkout = null;
      slideWrap.style.display = "none";
      setIdle();
      renderWeekSummary();
    }, 200);

  }else{
    slideTrack.classList.remove("filled");
    slideKnob.style.transform = "translate(0,-50%)";
    slideFill.style.transform = "scaleX(0)";
  }
  currentX = 0;
}

slideKnob.addEventListener("pointerup", endSlide);
slideKnob.addEventListener("pointercancel", endSlide);

/* =========================
   MODAL EDITOR (8 tabs)
========================= */
let activeTab = "push";

function renderTabs(){
  tabsEl.innerHTML = "";
  CAT_KEYS.forEach(k=>{
    const t = document.createElement("div");
    t.className = "tab" + (k === activeTab ? " active" : "");
    t.textContent = k;
    t.addEventListener("click", ()=>{
      activeTab = k;
      renderExerciseList();
    });
    tabsEl.appendChild(t);
  });
}

function renderExerciseList(){
  const exData = loadExercises();
  renderTabs();

  listEl.innerHTML = "";
  (exData[activeTab] || []).forEach((ex, idx)=>{
    const row = document.createElement("div");
    row.className = "ex-row";

    const name = document.createElement("input");
    name.value = ex.name || "";
    name.placeholder = "Exercise";
    name.addEventListener("change", ()=>{
      const data = loadExercises();
      data[activeTab][idx].name = name.value;
      saveExercises(data);
    });

    const reps = document.createElement("input");
    reps.value = ex.reps || "";
    reps.placeholder = "Reps (AMRAP)";
    reps.addEventListener("change", ()=>{
      const data = loadExercises();
      data[activeTab][idx].reps = reps.value;
      saveExercises(data);
    });

    const del = document.createElement("button");
    del.className = "ex-del";
    del.textContent = "âœ•";
    del.addEventListener("click", ()=>{
      const data = loadExercises();
      data[activeTab].splice(idx, 1);
      saveExercises(data);
      renderExerciseList();
    });

    row.appendChild(name);
    row.appendChild(reps);
    row.appendChild(del);
    listEl.appendChild(row);
  });
}

function openModal(){
  modal.classList.add("show");
  renderExerciseList();
}
function closeModal(){
  modal.classList.remove("show");
}

exerciseBtn.addEventListener("click", openModal);
modalClose.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{
  if(e.target === modal) closeModal();
});

addExerciseBtn.addEventListener("click", ()=>{
  const name = (newNameEl.value || "").trim();
  const reps = (newRepsEl.value || "").trim();
  if(!name) return;

  const data = loadExercises();
  data[activeTab] = data[activeTab] || [];
  data[activeTab].push({name, reps});
  saveExercises(data);

  newNameEl.value = "";
  newRepsEl.value = "";
  renderExerciseList();
});

/* =========================
   BOOT
========================= */
rolloverWeekIfNeeded();
renderStreakUI();
renderWeekSummary();      // show current week count (0 on new week)
setIdle();

generateBtn.addEventListener("click", generateWorkout);
</script>
</body>
</html>
