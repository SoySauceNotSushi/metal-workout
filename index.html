<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  :root{
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#f8fafc;
    --card:#ffffff;

    --shadow-soft:0 18px 48px rgba(15,23,42,0.14);
    --shadow-subtle:0 10px 24px rgba(15,23,42,0.12);

    --streak-bg:#e5e7eb;
    --streak-fill:#f97316;

    /* 8 distinct tag palettes (nice + readable) */
    --tag-purple-bg:#ede9fe; --tag-purple-tx:#6d28d9;
    --tag-orange-bg:#ffedd5; --tag-orange-tx:#c2410c;
    --tag-red-bg:#fee2e2;    --tag-red-tx:#b91c1c;
    --tag-pink-bg:#fce7f3;   --tag-pink-tx:#be185d;
    --tag-blue-bg:#e4ecff;   --tag-blue-tx:#2453f5;
    --tag-yellow-bg:#fef9c3; --tag-yellow-tx:#a16207;
    --tag-teal-bg:#ccfbf1;   --tag-teal-tx:#0f766e;
    --tag-green-bg:#d9fbe3;  --tag-green-tx:#16a34a;
  }

  *{ box-sizing:border-box; }

  html, body{
    height:100%;
  }

  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased;

    /* âœ… lock scrolling */
    overflow:hidden;
    overscroll-behavior:none;
    touch-action:manipulation;
  }

  .container{
    max-width:480px;
    margin:0 auto;
    padding:24px;
    height:100%;
    display:flex;
    flex-direction:column;
    position:relative;
  }

  /* TOP STREAK ROW */
  .top-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:12px;
  }
  .streak-fire{
    display:flex;
    align-items:center;
    gap:6px;
    font-weight:700;
    color:var(--streak-fill);
    font-variant-numeric:tabular-nums;
    min-width:44px;
  }
  .streak-bar{
    width:100px; /* âœ… requested */
    height:8px;
    background:var(--streak-bg);
    border-radius:999px;
    overflow:hidden;
  }
  .streak-bar-fill{
    height:100%;
    width:0%;
    background:var(--streak-fill);
    transform-origin:left;
    transition:width .28s ease;
  }

  h1{
    font-size:34px;
    font-weight:800;
    margin:2px 0 6px;
    letter-spacing:-.3px;
  }
  .subtitle{
    color:var(--sub);
    font-size:18px;
    margin-bottom:14px;
  }

  /* CENTER AREA (no scroll) */
 .center{
  flex:1;
  display:flex;
  align-items:flex-start;   /* ðŸ‘ˆ key change */
  justify-content:center;
  padding-top:32px;         /* ðŸ‘ˆ controlled upward offset */
  position:relative;
}

  /* WORKOUT CARD */
  .card{
    width:100%;
    max-width:420px;
    background:var(--card);
    border-radius:18px;
    box-shadow:var(--shadow-soft);
    padding:22px 20px;
    opacity:0;
    transform:translateY(18px) scale(.98);
    transition:opacity .28s ease, transform .32s cubic-bezier(.18,.84,.32,1.12);
    display:none;
  }
  .card.show{
    display:block;
    opacity:1;
    transform:translateY(0) scale(1);
  }
  .card-title{
    font-size:22px;
    font-weight:900;
    margin:0 0 14px;
    letter-spacing:-.2px;
  }
  .line{
    font-size:18px;
    display:flex;
    align-items:center;
    gap:10px;
    margin:12px 0;
    flex-wrap:wrap;
  }

  /* PILLS */
  .pill{
    padding:5px 12px;
    border-radius:999px;
    font-size:13px;
    font-weight:800;
    line-height:1;
    text-transform:lowercase;
    box-shadow:0 0 0 1px rgba(15,23,42,0.04);
    user-select:none;
  }

  /* Tag â†’ color mapping (8 tags) */
  .tag-push{ background:var(--tag-blue-bg); color:var(--tag-blue-tx); }
  .tag-pull{ background:var(--tag-green-bg); color:var(--tag-green-tx); }
  .tag-legs{ background:var(--tag-orange-bg); color:var(--tag-orange-tx); }
  .tag-abs{ background:var(--tag-teal-bg); color:var(--tag-teal-tx); }
  .tag-cardio{ background:var(--tag-yellow-bg); color:var(--tag-yellow-tx); }
  .tag-fullbody{ background:var(--tag-red-bg); color:var(--tag-red-tx); }
  .tag-shoulders{ background:var(--tag-purple-bg); color:var(--tag-purple-tx); }
  .tag-upper{ background:var(--tag-pink-bg); color:var(--tag-pink-tx); }

  /* WEEK SUMMARY (centered big engraved number) */
  .summary{
    width:100%;
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    text-align:center;
  }
  .summary.show{ display:flex; }

  .big-num{
    font-size:140px;
    font-weight:900;
    line-height:1;
    letter-spacing:-3px;
    color:#e5e7eb;
    text-shadow:
      0 2px 0 rgba(255,255,255,0.9),
      0 -1px 0 rgba(15,23,42,0.05);
    margin:0;
    user-select:none;
  }
  .summary-text{
    margin-top:10px;
    font-size:20px;
    font-weight:700;
    color:#94a3b8;
  }

  /* AI GRADIENT STAGE (does NOT touch buttons) */
  .ai-stage{
    position:absolute;
    left:50%;
    top:54%;
    transform:translate(-50%,-50%);
    width:320px;
    height:320px;
    border-radius:50%;
    pointer-events:none;
    display:none;
    z-index:1; /* behind card, above background */
  }
  .ai-stage::before{
    content:"";
    position:absolute;
    inset:-20% -15% -25% -15%;
    filter:blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    transition:opacity .25s ease;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    animation:meshBreath 2s ease-in-out infinite, meshDrift 3s ease-in-out infinite;
  }
  .ai-stage.show::before{ opacity:.9; }

  @keyframes meshBreath{
    0%,100%{ transform:scale(1); opacity:.7 }
    50%{ transform:scale(1.04); opacity:.35 }
  }
  @keyframes meshDrift{
    0%{ transform:translate3d(0,0,0); }
    50%{ transform:translate3d(2%,-1.5%,0); }
    100%{ transform:translate3d(0,0,0); }
  }

  /* FIXED ACTIONS (no shadow on generate button) */
  .actions{
    position:fixed;
    left:50%;
    bottom:22px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    z-index:20; /* above confetti */
  }

  .btn{
    width:100%;
    height:56px;
    border-radius:28px;
    border:none;
    font-size:18px;
    font-weight:600; /* keep normal weight */
    cursor:pointer;
  }
  #generateBtn{
    background:var(--brand);
    color:#fff;
    box-shadow:none; /* âœ… remove shadow */
  }
  #exerciseBtn{
    margin-top:12px;
    background:#eef2f7;
    color:var(--brand);
    font-weight:700;
  }

  /* SLIDER sits where Exercises button was */
  .slider-wrap{
    margin-top:12px;
    display:none;
  }
  .slide-track{
    position:relative;
    height:56px;
    border-radius:999px;
    background:#e5e7eb;
    overflow:hidden;
    user-select:none;
    touch-action:none;
  }
  .slide-fill{
    position:absolute;
    inset:0;
    border-radius:999px;
    background:linear-gradient(120deg,#2453f5,#4f8cff);
    transform:scaleX(0);
    transform-origin:left;
    transition:transform .12s ease-out;
  }
  .slide-label{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    font-size:18px;
    font-weight:700;
    color:rgba(36,83,245,0.95);
    transition:color .12s ease-out;
  }
  .slide-track.filled .slide-label{
    color:#fff; /* âœ… white when filled (accessibility) */
  }
  .slide-knob{
    position:absolute;
    top:50%;
    left:4px;
    width:48px;
    height:48px;
    border-radius:50%;
    background:#fff;
    transform:translate(0,-50%);
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 10px 22px rgba(15,23,42,0.15);
    touch-action:none;
  }
  .slide-arrow{
    font-size:20px;
    color:var(--brand);
  }

  /* MODAL (full screen) */
  .modal{
    position:fixed;
    inset:0;
    background:rgba(2,6,23,0.42);
    display:none;
    z-index:60;
  }
  .modal.show{ display:block; }

  .sheet{
    position:absolute;
    inset:0;
    background:#fff;
    display:flex;
    flex-direction:column;
    padding:16px;
  }

  .sheet-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding-bottom:10px;
  }
  .sheet-title{
    font-weight:900;
    font-size:18px;
    letter-spacing:-.2px;
  }
  .close{
    border:none;
    background:#f1f5f9;
    border-radius:999px;
    padding:10px 14px;
    font-weight:900;
    cursor:pointer;
  }

  .tabs{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    padding:8px 0 6px;
  }
  .tab{
    border:none;
    cursor:pointer;
    padding:10px 14px;
    border-radius:999px;
    background:#f1f5f9;
    font-weight:900;
    color:#0f172a;
  }
  .tab.active{
    background:#e4ecff;
    color:#1d4ed8;
  }

  /* modal content area fixed height; list scrolls */
  .sheet-body{
    flex:1;
    min-height:0;
    display:flex;
    flex-direction:column;
  }

  .add-row{
    display:grid;
    grid-template-columns: 1fr 140px;
    gap:10px;
    margin-top:10px;
  }
  .input{
    height:52px;           /* âœ… normal size */
    padding:0 14px;
    font-size:16px;        /* âœ… readable */
    border-radius:14px;
    border:1px solid #e5e7eb;
    outline:none;
  }
  .add-btn{
    height:52px;
    border-radius:14px;
    border:none;
    background:var(--brand);
    color:#fff;
    font-weight:900;
    cursor:pointer;
  }

  .list{
    margin-top:12px;
    flex:1;
    min-height:0;
    overflow:auto; /* âœ… scroll inside modal only */
    padding-right:2px;
  }

  .item{
    display:grid;
    grid-template-columns: 1fr 120px 44px;
    gap:10px;
    align-items:center;
    margin-bottom:10px;
  }
  .del{
    width:44px;height:44px;
    border-radius:14px;
    border:none;
    background:#fee2e2;
    color:#b91c1c;
    font-weight:900;
    cursor:pointer;
  }

  /* Small helper */
  .muted{
    color:var(--sub);
    font-size:13px;
    margin-top:6px;
  }
</style>
</head>

<body>
  <div class="container">
    <div class="top-row">
      <div class="streak-fire"><span>ðŸ”¥</span><span id="streakCount">0</span></div>
      <div class="streak-bar"><div id="streakFill" class="streak-bar-fill"></div></div>
    </div>

    <h1>Welcome back Jy</h1>
    <div class="subtitle">Today's mixed workout</div>

    <div class="center">
      <div id="aiStage" class="ai-stage"></div>

      <div id="workoutCard" class="card" aria-live="polite"></div>

      <div id="summary" class="summary">
        <div id="weekNum" class="big-num">0</div>
        <div class="summary-text">workouts completed this week</div>
      </div>
    </div>
  </div>

  <div class="actions">
    <button id="generateBtn" class="btn">Generate Workout</button>

    <button id="exerciseBtn" class="btn">Exercises</button>

    <div id="sliderWrap" class="slider-wrap">
      <div id="slideTrack" class="slide-track">
        <div id="slideFill" class="slide-fill"></div>
        <div id="slideLabel" class="slide-label">Slide to Complete</div>
        <div id="slideKnob" class="slide-knob"><span class="slide-arrow">â†’</span></div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheet-top">
        <div class="sheet-title">Exercises</div>
        <button id="closeModal" class="close">Close</button>
      </div>

      <div class="tabs" id="tabs"></div>

      <div class="sheet-body">
        <div class="add-row">
          <input id="newName" class="input" type="text" placeholder="Exercise (e.g., Pull-Ups)" />
          <input id="newReps" class="input" type="number" inputmode="numeric" placeholder="Reps" />
        </div>
        <button id="addBtn" class="add-btn" style="margin-top:10px;">Add exercise</button>
        <div class="muted">Tip: reps are shown for AMRAP. Metabolic Conditioning ignores reps.</div>

        <div id="list" class="list"></div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   STORAGE KEYS
=========================== */
const LS = {
  weekKey: "jy_weekKey",
  weekCount: "jy_weekCount",
  streak: "jy_streak",
  weekSummary: "jy_weekSummary",
  exercises: "jy_exercises",
};

/* ===========================
   WEEK KEY + STREAK LOGIC
   - streak increments when reaching 3 workouts within a week (once)
   - on week rollover: if previous week <3 -> streak resets to 0
=========================== */
function getWeekKey(d=new Date()){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

function lsGet(k){ return localStorage.getItem(k); }
function lsSet(k,v){ localStorage.setItem(k,v); }
function lsJSONGet(k, fallback){
  try{
    const raw = lsGet(k);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch{ return fallback; }
}
function lsJSONSet(k, obj){ lsSet(k, JSON.stringify(obj)); }

function getStreak(){
  const n = parseInt(lsGet(LS.streak) || "0", 10);
  return Number.isFinite(n) && n>0 ? n : 0;
}
function setStreak(n){
  lsSet(LS.streak, String(Math.max(0, n|0)));
}

function getWeekCount(){
  const n = parseInt(lsGet(LS.weekCount) || "0", 10);
  return Number.isFinite(n) && n>=0 ? n : 0;
}
function setWeekCount(n){
  lsSet(LS.weekCount, String(Math.max(0, n|0)));
}

function getWeekSummary(){
  return lsJSONGet(LS.weekSummary, null);
}
function setWeekSummary(obj){
  lsJSONSet(LS.weekSummary, obj);
}

function resetWeekIfNeeded(){
  const cur = getWeekKey();
  const prev = lsGet(LS.weekKey);
  let summary = getWeekSummary();
  let streak = getStreak();

  if(prev && prev !== cur){
    // week rolled over -> evaluate last week
    if(summary && summary.week === prev){
      if((summary.workouts || 0) < 3){
        streak = 0; // lose streak
        setStreak(0);
      }
    }
    // new week reset
    lsSet(LS.weekKey, cur);
    setWeekCount(0);
    summary = { week:cur, workouts:0, counted:false };
    setWeekSummary(summary);
  }else{
    if(!prev) lsSet(LS.weekKey, cur);
    if(!summary || summary.week !== cur){
      summary = { week:cur, workouts:getWeekCount(), counted:false };
      setWeekSummary(summary);
    }
  }
}

/* ===========================
   DEFAULT EXERCISES (editable)
   8 tags: push, pull, legs, abs, cardio, fullbody, shoulders, upper
=========================== */
const TAGS = [
  { key:"pull", label:"Pull", pill:"tag-pull" },
  { key:"push", label:"Push", pill:"tag-push" },
  { key:"upper", label:"Upper", pill:"tag-upper" },
  { key:"shoulders", label:"Shoulders", pill:"tag-shoulders" },
  { key:"legs", label:"Legs", pill:"tag-legs" },
  { key:"abs", label:"Abs", pill:"tag-abs" },
  { key:"fullbody", label:"Fullbody", pill:"tag-fullbody" },
  { key:"cardio", label:"Cardio", pill:"tag-cardio" },
];

const DEFAULT_EX = {
  pull: [
    { name:"Pull-Ups", reps:5 },
    { name:"Chin-Ups", reps:5 },
    { name:"Australian Chin-Ups", reps:10 },
  ],
  push: [
    { name:"Push-Ups", reps:10 },
    { name:"Dips", reps:10 },
    { name:"Decline Push-Ups", reps:10 },
    { name:"Diamond Push-Ups", reps:10 },
  ],
  upper: [
    { name:"Muscle-Up", reps:1 },
  ],
  shoulders: [
    { name:"Pike Push-Ups", reps:10 },
    { name:"Dolphin Push-Ups", reps:10 },
  ],
  legs: [
    { name:"Jumping Squats", reps:15 },
    { name:"Jumping Lunges", reps:15 },
  ],
  abs: [
    { name:"Knee Raises", reps:20 },
    { name:"Full Body Raises", reps:20 },
    { name:"Oblique Twists", reps:10 },
  ],
  fullbody: [
    { name:"Burpees", reps:10 },
    { name:"Kettlebell Swings", reps:10 },
  ],
  cardio: [
    { name:"Jumping Jacks", reps:20 },
    { name:"Mountain Climbers", reps:20 },
  ],
};

function loadExercises(){
  const saved = lsJSONGet(LS.exercises, null);
  if(saved && typeof saved === "object") return saved;
  lsJSONSet(LS.exercises, DEFAULT_EX);
  return structuredClone(DEFAULT_EX);
}
function saveExercises(data){
  lsJSONSet(LS.exercises, data);
}

/* ===========================
   UI REFS
=========================== */
const streakCountEl = document.getElementById("streakCount");
const streakFillEl  = document.getElementById("streakFill");

const aiStageEl     = document.getElementById("aiStage");
const cardEl        = document.getElementById("workoutCard");
const summaryEl     = document.getElementById("summary");
const weekNumEl     = document.getElementById("weekNum");

const generateBtn   = document.getElementById("generateBtn");
const exerciseBtn   = document.getElementById("exerciseBtn");

const sliderWrap    = document.getElementById("sliderWrap");
const slideTrack    = document.getElementById("slideTrack");
const slideFill     = document.getElementById("slideFill");
const slideKnob     = document.getElementById("slideKnob");

const modal         = document.getElementById("modal");
const closeModalBtn = document.getElementById("closeModal");
const tabsEl        = document.getElementById("tabs");
const listEl        = document.getElementById("list");
const newNameEl     = document.getElementById("newName");
const newRepsEl     = document.getElementById("newReps");
const addBtn        = document.getElementById("addBtn");

/* ===========================
   STATE
=========================== */
let exercises = loadExercises();
let activeTab = "pull";
let currentWorkout = null;

/* ===========================
   RENDER STREAK + SUMMARY
=========================== */
function renderTop(){
  const streak = getStreak();
  const weekCount = getWeekCount();

  streakCountEl.textContent = streak;

  const pct = Math.min(weekCount/3, 1) * 100;
  streakFillEl.style.width = `${pct}%`;

  weekNumEl.textContent = weekCount;
}

/* ===========================
   WORKOUT GENERATION
   - 50% chance for shoulders and upper in AMRAP pool (effectively by pool weight)
   - AMRAP shows 3â€“4 exercises
   - MetCon shows ALL categories, shuffled, NO reps shown
=========================== */
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* Weighted chance by tag:
   - pull: 80%
   - push: 80%
   - everything else: 50%
   NOTE: user also wanted shoulders + upper 50% (fits here)
*/
function includeTagChance(tagKey){
  if(tagKey === "pull") return Math.random() < 0.80;
  if(tagKey === "push") return Math.random() < 0.80;
  return Math.random() < 0.50;
}

function buildAMRAP(){
  const tags = TAGS.map(t=>t.key);

  // decide which categories are included based on chance
  let included = tags.filter(t => includeTagChance(t));

  // Ensure we don't end up empty
  if(included.length === 0){
    included = ["pull","push"];
  }

  // pick 3â€“4 unique exercises total (not per category)
  const targetCount = randInt(3,4);

  // build candidate pool from included categories
  let pool = [];
  included.forEach(tag=>{
    const list = exercises[tag] || [];
    list.forEach(ex => pool.push({ tag, ...ex }));
  });

  // if pool too small, fall back to all categories
  if(pool.length < targetCount){
    pool = [];
    tags.forEach(tag=>{
      (exercises[tag]||[]).forEach(ex => pool.push({ tag, ...ex }));
    });
  }

  // pick unique by name+tag
  pool = shuffle(pool);
  const chosen = [];
  const seen = new Set();
  for(const it of pool){
    const k = `${it.tag}__${it.name}`.toLowerCase();
    if(seen.has(k)) continue;
    seen.add(k);
    chosen.push(it);
    if(chosen.length >= targetCount) break;
  }

  return {
    type: "amrap",
    title: "As Many Rounds As Possible",
    items: chosen.map(it => ({
      name: it.name,
      reps: Number(it.reps)||0,
      tags: [it.tag],
    }))
  };
}

function buildMetCon(){
  // must include all categories, but order shuffled, and show EXERCISE name (no reps)
  const order = shuffle(TAGS.map(t=>t.key));

  const items = order.map(tag=>{
    const list = exercises[tag] || [];
    const ex = list.length ? pick(list) : { name: tag, reps: 0 };
    return { name: ex.name, tags: [tag] };
  });

  return {
    type: "metcon",
    title: "Metabolic Conditioning",
    items
  };
}

function buildWorkout(){
  // 50/50 AMRAP vs MetCon
  return Math.random() < 0.5 ? buildAMRAP() : buildMetCon();
}

/* ===========================
   RENDER WORKOUT CARD
=========================== */
function pillClass(tag){
  return `pill tag-${tag}`;
}

function renderWorkout(workout){
  cardEl.innerHTML = "";

  const title = document.createElement("div");
  title.className = "card-title";
  title.textContent = workout.title;
  cardEl.appendChild(title);

  workout.items.forEach(it=>{
    const row = document.createElement("div");
    row.className = "line";

    const txt = document.createTextNode(
      workout.type === "amrap"
        ? `${it.reps} ${it.name}`
        : `${it.name}`
    );
    row.appendChild(txt);

    (it.tags||[]).forEach(tag=>{
      const p = document.createElement("span");
      p.className = pillClass(tag);
      p.textContent = tag;
      row.appendChild(p);
    });

    cardEl.appendChild(row);
  });

  cardEl.classList.add("show");
  summaryEl.classList.remove("show");
}

/* ===========================
   GENERATION FLOW (mesh gradient)
   - mesh appears while generating
   - does NOT cover buttons (it's centered in .center with lower z-index than footer)
=========================== */
function showMesh(){
  aiStageEl.style.display="block";
  requestAnimationFrame(()=> aiStageEl.classList.add("show"));
}
function hideMesh(){
  aiStageEl.classList.remove("show");
  setTimeout(()=>{ aiStageEl.style.display="none"; }, 220);
}

/* ===========================
   SLIDER
=========================== */
let sliding=false, startX=0, currentX=0, maxSlide=0;

function resetSlider(){
  slideTrack.classList.remove("filled");
  slideKnob.style.transition="none";
  slideFill.style.transition="none";
  slideKnob.style.transform="translate(0,-50%)";
  slideFill.style.transform="scaleX(0)";
  setTimeout(()=>{
    slideKnob.style.transition="transform .18s ease-out";
    slideFill.style.transition="transform .12s ease-out";
  },10);
}

slideKnob.addEventListener("pointerdown",(e)=>{
  e.preventDefault();
  sliding=true;
  slideKnob.setPointerCapture(e.pointerId);
  startX=e.clientX;
  currentX=0;

  const trackW = slideTrack.getBoundingClientRect().width;
  const knobW  = slideKnob.getBoundingClientRect().width;
  maxSlide = Math.max(0, trackW - knobW - 8);

  slideKnob.style.transition="none";
  slideFill.style.transition="none";
});

slideKnob.addEventListener("pointermove",(e)=>{
  if(!sliding) return;
  const dx = e.clientX - startX;
  const x = Math.max(0, Math.min(maxSlide, dx));
  currentX = x;
  const p = maxSlide===0 ? 0 : x/maxSlide;

  slideKnob.style.transform = `translate(${x}px,-50%)`;
  slideFill.style.transform = `scaleX(${p})`;

  // becomes "filled" pretty early so text turns white while sliding over
  slideTrack.classList.toggle("filled", p > 0.18);
});

function endSlide(e){
  if(!sliding) return;
  sliding=false;
  try{ slideKnob.releasePointerCapture(e.pointerId); }catch{}

  const p = maxSlide===0 ? 0 : currentX/maxSlide;

  slideKnob.style.transition="transform .18s ease-out";
  slideFill.style.transition="transform .12s ease-out";

  if(p > 0.92){
    slideKnob.style.transform = `translate(${maxSlide}px,-50%)`;
    slideFill.style.transform = `scaleX(1)`;
    slideTrack.classList.add("filled");

    completeWorkout();
  }else{
    resetSlider();
  }
}
slideKnob.addEventListener("pointerup", endSlide);
slideKnob.addEventListener("pointercancel", endSlide);

/* ===========================
   COMPLETE WORKOUT
   - increments weekCount persistently
   - updates weekly summary + streak progression
   - confetti comes from UNDER button (zIndex lower than footer)
=========================== */
function updateAfterCompletion(){
  const curWeek = getWeekKey();
  let summary = getWeekSummary() || { week:curWeek, workouts:0, counted:false };
  if(summary.week !== curWeek){
    summary = { week:curWeek, workouts:0, counted:false };
  }

  let weekCount = getWeekCount() + 1;
  setWeekCount(weekCount);

  summary.workouts = weekCount;

  let streak = getStreak();
  if(weekCount >= 3 && !summary.counted){
    streak += 1;
    summary.counted = true;
    setStreak(streak);
  }
  setWeekSummary(summary);
}

function confettiUnderButton(){
  if(!window.confetti) return;

  // Confetti under the fixed footer:
  // - use lower zIndex than .actions (which is 20)
  // - origin slightly below bottom to make it feel like it comes out from under the button
  confetti({
    particleCount: 140,
    spread: 85,
    startVelocity: 34,
    origin: { x: 0.5, y: 1.22 },
    zIndex: 10
  });
}

function completeWorkout(){
  // persist + UI
  updateAfterCompletion();
  renderTop();

  // animation + confetti
  confettiUnderButton();

  // hide workout, show summary, restore buttons
  setTimeout(()=>{
    cardEl.classList.remove("show");
    sliderWrap.style.display="none";
    exerciseBtn.style.display="block";
    generateBtn.style.display="block";
    summaryEl.classList.add("show");
    currentWorkout = null;
    resetSlider();
  }, 220);
}

/* ===========================
   BUTTONS
   - generate -> mesh -> card -> show slider, hide exercises
   - while workout exists -> slider only
=========================== */
generateBtn.addEventListener("click", ()=>{
  // start generation
  showMesh();

  // hide card if any
  cardEl.classList.remove("show");

  generateBtn.disabled = true;
  generateBtn.textContent = "Generating...";

  // keep buttons safe: mesh is centered and footer is zIndex 20
  setTimeout(()=>{
    currentWorkout = buildWorkout();
    hideMesh();
    renderWorkout(currentWorkout);

    // lock UI: only slider available
    generateBtn.style.display="none";
    exerciseBtn.style.display="none";
    sliderWrap.style.display="block";
    resetSlider();

    // restore generate button state (for next time)
    generateBtn.disabled = false;
    generateBtn.textContent = "Generate Workout";
  }, 850);
});

exerciseBtn.addEventListener("click", ()=>{
  openModal();
});

/* ===========================
   MODAL (full screen)
   - tabs: push pull legs abs cardio fullbody shoulders upper
   - add/edit/remove exercises + reps
=========================== */
function openModal(){
  modal.classList.add("show");
  document.body.style.overflow="hidden";
  renderTabs();
  renderList();
}
function closeModal(){
  modal.classList.remove("show");
}
closeModalBtn.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{
  if(e.target === modal) closeModal();
});

function renderTabs(){
  tabsEl.innerHTML = "";
  TAGS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "tab" + (t.key===activeTab ? " active" : "");
    b.textContent = t.label;
    b.addEventListener("click", ()=>{
      activeTab = t.key;
      renderTabs();
      renderList();
    });
    tabsEl.appendChild(b);
  });
}

function renderList(){
  listEl.innerHTML = "";
  const arr = exercises[activeTab] || [];

  arr.forEach((ex, idx)=>{
    const row = document.createElement("div");
    row.className = "item";

    const name = document.createElement("input");
    name.className = "input";
    name.value = ex.name || "";
    name.placeholder = "Exercise";
    name.addEventListener("input", ()=>{
      exercises[activeTab][idx].name = name.value;
      saveExercises(exercises);
    });

    const reps = document.createElement("input");
    reps.className = "input";
    reps.type = "number";
    reps.inputMode = "numeric";
    reps.value = (ex.reps ?? "");
    reps.placeholder = "Reps";
    reps.addEventListener("input", ()=>{
      exercises[activeTab][idx].reps = parseInt(reps.value||"0",10);
      saveExercises(exercises);
    });

    const del = document.createElement("button");
    del.className = "del";
    del.textContent = "Ã—";
    del.addEventListener("click", ()=>{
      exercises[activeTab].splice(idx,1);
      saveExercises(exercises);
      renderList();
    });

    row.appendChild(name);
    row.appendChild(reps);
    row.appendChild(del);
    listEl.appendChild(row);
  });
}

addBtn.addEventListener("click", ()=>{
  const name = (newNameEl.value || "").trim();
  const reps = parseInt(newRepsEl.value || "0", 10);

  if(!name) return;

  if(!exercises[activeTab]) exercises[activeTab] = [];
  exercises[activeTab].push({ name, reps: Number.isFinite(reps) ? reps : 0 });
  saveExercises(exercises);

  newNameEl.value = "";
  newRepsEl.value = "";

  renderList();
});

/* ===========================
   INIT
   - week rollover check
   - show summary centered with persisted weekCount on load
=========================== */
function init(){
  resetWeekIfNeeded();
  exercises = loadExercises();

  // show summary by default
  renderTop();
  summaryEl.classList.add("show");
  cardEl.classList.remove("show");

  // ensure slider hidden, buttons shown
  sliderWrap.style.display="none";
  generateBtn.style.display="block";
  exerciseBtn.style.display="block";
  resetSlider();
}

init();
</script>
</body>
</html>
