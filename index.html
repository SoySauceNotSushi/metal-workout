<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<!-- ===================== CSS START ===================== -->
<style>
  :root{
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#ffffff;
    --card:#f8fafc;
    --pill-blue:#e4ecff;
    --pill-green:#d9fbe3;
    --pill-orange:#ffe6bf;
    --pill-red:#ffe0e0;

    --shadow-soft:0 18px 48px rgba(15,23,42,0.16);
    --shadow-subtle:0 8px 18px rgba(15,23,42,0.12);
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased;
  }

  .container{
    max-width:480px;
    margin:0 auto;
    padding:24px;
    padding-bottom:120px;
  }

  .weather{
    font-size:15px;
    color:var(--sub);
    margin-bottom:16px;
    opacity:.95;
    display:flex;
    align-items:center;
    gap:6px;
    transition:opacity .25s ease, transform .25s ease;
  }

  h1{
    font-size:30px;
    font-weight:700;
    margin:0 0 6px;
  }

  #subtitle{
    font-size:17px;
    font-weight:400;
    color:var(--sub);
    margin:0 0 18px;
    position:relative;
    display:inline-block;
    overflow:hidden;
  }

  .subtitle-enter{
    opacity:0;
    transform:translateY(10px);
  }
  .subtitle-enter-active{
    opacity:1;
    transform:translateY(0);
    transition:opacity .32s ease, transform .32s cubic-bezier(.18,.84,.32,1.12);
  }

  .subtitle-exit{
    opacity:1;
    transform:translateY(0);
  }
  .subtitle-exit-active{
    opacity:0;
    transform:translateY(-10px);
    transition:opacity .32s ease, transform .32s cubic-bezier(.18,.84,.32,1.12);
  }

  /* RADIO ROW */
  #radioRow{
    display:flex;
    gap:22px;
    margin:0 0 6px;
    justify-content:flex-start;
  }

  .opt{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:14px;
    color:var(--ink);
    padding:6px 10px;
    border-radius:999px;
    transition:background .2s ease, color .2s ease, transform .16s ease, box-shadow .16s ease;
  }

  .opt input{
    appearance:none;
    -webkit-appearance:none;
    width:0;
    height:0;
    position:absolute;
    opacity:0;
    pointer-events:none;
  }

  .opt.disabled{
    opacity:.35;
    pointer-events:none;
  }
  .opt.active{
    color:var(--brand);
    font-weight:600;
    background:#e4ecff80;
    box-shadow:0 0 0 1px #e4ecff;
  }
  .opt:active:not(.disabled){
    transform:scale(.97);
    box-shadow:0 0 0 1px rgba(36,83,245,0.22);
  }

  /* WORKOUT CARD (shared with past-week view) */
  #card,
  .past-card{
    background:var(--card);
    border-radius:16px;
    padding:20px;
    margin-top:16px;
    display:none;
    opacity:0;
    transform:translateY(12px) scale(.98);
    box-shadow:var(--shadow-subtle);
    transition:
      opacity .3s ease,
      transform .3s cubic-bezier(.18,.84,.32,1.12);
  }
  #card.visible,
  .past-card.visible{
    opacity:1;
    transform:translateY(0) scale(1);
  }

  .card-title-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:22px;
  }
  .card-title{
    font-size:20px;
    font-weight:700;
  }
  .card-day{
    font-size:14px;
    color:var(--sub);
    font-weight:500;
  }

  .line{
    font-size:16px;
    margin-bottom:10px;
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    opacity:0;
    transform:translateY(6px);
    transition:opacity .22s ease, transform .22s ease;
  }
  .line.show-line{
    opacity:1;
    transform:translateY(0);
  }

  .pill{
    padding:3px 8px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }
  .pill-weighted{ background:var(--pill-blue); color:var(--brand); }
  .pill-abs{ background:var(--pill-green); color:#22c55e; }
  .pill-shoulders{ background:#ede9fe; color:#7c3aed; }
  .pill-biceps{ background:var(--pill-orange); color:#d97706; }
  .pill-kettlebell{ background:var(--pill-red); color:#e11d48; }

  /* TIMER */
  #bigTimer{
    position:fixed;
    top:calc(50% + 2rem);
    left:50%;
    transform:translate(-50%,-50%);
    display:flex;
    gap:1.5rem;
    opacity:0;
    transition:opacity .45s ease;
  }
  #bigTimer.hidden{ display:none; }
  #bigTimer.show{ opacity:1; }

  .t-col{
    display:flex;
    flex-direction:column;
    align-items:center;
    width:72px;
  }

  .t-num{
    font-size:48px;
    font-weight:400;
    font-variant-numeric:tabular-nums;
  }
  .t-label{
    font-size:14px;
    color:var(--sub);
    margin-top:6px;
  }

  /* Generate Button */
  #mainBtn{
    position:fixed;
    left:50%;
    bottom:24px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    height:56px;
    border-radius:28px;
    border:none;
    background:var(--brand);
    color:#fff;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 15px 30px rgba(36,83,245,0.35);
    transition:opacity .25s ease;
  }
  #mainBtn.hidden{ display:none; }
  #mainBtn.disabled{ opacity:.4; pointer-events:none; }

</style>
<!-- ===================== CSS END ===================== -->
</head>
<body>

<div class="container">

  <div class="weather">Enable location for weather</div>

  <h1>Welcome back Jy</h1>

  <div id="subtitle">What would you like to train?</div>

  <!-- RADIO ROW -->
  <div id="radioRow">
    <label class="opt" data-mode="pull">
      <input type="radio" name="mode" value="pull"> Pull
    </label>
    <label class="opt" data-mode="push">
      <input type="radio" name="mode" value="push"> Push
    </label>
    <label class="opt" data-mode="legs">
      <input type="radio" name="mode" value="legs"> Legs
    </label>
    <label class="opt" data-mode="full">
      <input type="radio" name="mode" value="full"> Full body
    </label>
  </div>

  <!-- PAST WEEK CARD (invisible by default) -->
  <div id="pastCard" class="past-card"></div>

  <!-- WORKOUT CARD -->
  <div id="card">
    <div class="card-title-row">
      <div id="dayTitle" class="card-title"></div>
      <div id="dayOfWeek" class="card-day"></div>
    </div>
    <div id="lines"></div>
  </div>

  <!-- TIMER -->
  <div id="bigTimer" class="hidden">
    <div class="t-col"><div id="tHours" class="t-num"></div><div class="t-label">HOURS</div></div>
    <div class="t-col"><div id="tMins" class="t-num"></div><div class="t-label">MINS</div></div>
    <div class="t-col"><div id="tSecs" class="t-num"></div><div class="t-label">SECS</div></div>
  </div>

</div>

<button id="mainBtn">Generate</button>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  /* -------------------------------------------------
   CONFIG / UTIL
-------------------------------------------------- */
const DEV = new URLSearchParams(location.search).get("dev")==="true";
const START_HOUR = 17;
const START_MIN = 30;

const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function weekKey(){
  const d=new Date();
  const jan1=new Date(d.getFullYear(),0,1);
  const days=Math.floor((d-jan1)/86400000);
  const week=Math.ceil((days+d.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
}

function getStartTime(tomorrow=false){
  const d=new Date();
  if(tomorrow) d.setDate(d.getDate()+1);
  d.setHours(START_HOUR, START_MIN, 0, 0);
  return d;
}
function afterStart(){
  if(DEV) return true;
  return new Date() >= getStartTime();
}

function dayNameFromDate(str){
  const d = new Date(str);
  return d.toLocaleDateString("en-US",{ weekday:"long" });
}

/* -------------------------------------------------
   STORAGE — workouts per week
-------------------------------------------------- */
function resetWeekIfNeeded(){
  if(DEV) return;
  const cur = weekKey();
  const prev = localStorage.getItem("jy_weekKey");
  if(cur !== prev){
    localStorage.setItem("jy_weekKey", cur);
    localStorage.removeItem("jy_history");
    localStorage.removeItem("jy_workoutToday");
    localStorage.removeItem("jy_completedToday");
    localStorage.removeItem("jy_locks");
  }
}

function loadHistory(){
  try{
    return JSON.parse(localStorage.getItem("jy_history") || "{}");
  }catch{
    return {};
  }
}
function saveHistory(obj){
  localStorage.setItem("jy_history", JSON.stringify(obj));
}

function loadWorkoutToday(){
  const raw = localStorage.getItem("jy_workoutToday");
  if(!raw) return null;
  try{
    const obj = JSON.parse(raw);
    if(obj.date === todayKey()) return obj.data;
  }catch{}
  return null;
}

function saveWorkoutToday(data){
  localStorage.setItem("jy_workoutToday", JSON.stringify({date:todayKey(), data}));
}

function loadCompletedToday(){
  const raw = localStorage.getItem("jy_completedToday");
  if(!raw) return null;
  try{
    const obj = JSON.parse(raw);
    if(obj.date === todayKey()) return obj;
  }catch{}
  return null;
}

function saveCompletedToday(mode){
  localStorage.setItem("jy_completedToday", JSON.stringify({date:todayKey(),mode}));
}

function loadLocks(){
  try{return JSON.parse(localStorage.getItem("jy_locks")||"{}");}
  catch{return {};}
}
function saveLocks(obj){
  localStorage.setItem("jy_locks", JSON.stringify(obj));
}

/* -------------------------------------------------
   DOM REFERENCES
-------------------------------------------------- */
const subtitleEl = qs("#subtitle");
const radioRow   = qs("#radioRow");
const cardEl     = qs("#card");
const pastCardEl = qs("#pastCard");

const dayTitleEl = qs("#dayTitle");
const dayOfWeekEl = qs("#dayOfWeek");
const linesEl    = qs("#lines");

let selectedMode = null;
let currentWorkout = null;

/* TIMER */
const bigTimer = qs("#bigTimer");
const tH = qs("#tHours");
const tM = qs("#tMins");
const tS = qs("#tSecs");
let countdownInterval = null;

/* BUTTON */
const mainBtn = qs("#mainBtn");

/* -------------------------------------------------
   WORKOUT GENERATION
-------------------------------------------------- */
const METALS = ["Metacon","EMOM","Ladder","AMRAP","Tabata"];
const rand = arr => arr[Math.floor(Math.random()*arr.length)];

function buildWorkout(mode){
  const items=[];
  let weightedUsed=false, absUsed=false, shouldersUsed=false,
      bicepsUsed=false, kettlebellUsed=false;

  if(mode==="push" || mode==="pull"){
    items.push({label:"Sets & Reps", weighted:true});
    weightedUsed = true;

    const m1={ label:rand(METALS) };
    const m2={ label:rand(METALS) };

    if(mode==="push" && Math.random()<0.5){ m1.shoulders = true; }
    if(mode==="pull" && Math.random()<0.5){ m1.biceps = true; }
    if(Math.random()<0.5){ m2.abs = true; }

    if(Math.random()<0.5) m1.weighted = true;
    else if(Math.random()<0.5) m2.weighted = true;

    items.push(m1,m2);
  }
  else if(mode==="legs"){
    const count = Math.random()<0.5 ? 2 : 3;
    for(let i=0;i<count;i++){
      const m={ label:rand(METALS) };
      if(Math.random()<0.5) m.kettlebell = true;
      if(Math.random()<0.5) m.weighted = true;
      if(Math.random()<0.5) m.abs = true;
      items.push(m);
    }
  }
  else if(mode==="full"){
    const count = Math.random()<0.5 ? 3 : 4;
    for(let i=0;i<count;i++){
      const m={ label:rand(METALS) };
      if(Math.random()<0.5) m.weighted = true;
      if(Math.random()<0.5) m.abs = true;
      if(Math.random()<0.3) m.shoulders = true;
      if(Math.random()<0.3) m.biceps = true;
      if(Math.random()<0.3) m.kettlebell = true;
      items.push(m);
    }
  }
  return {mode, items};
}

function modeTitle(mode){
  if(mode==="pull") return "Pull Day";
  if(mode==="push") return "Push Day";
  if(mode==="legs") return "Legs Day";
  if(mode==="full") return "Full Body Day";
  return "Workout";
}

/* -------------------------------------------------
   RENDER PAST-WEEK CARD (under radios)
-------------------------------------------------- */
function renderPastCardForMode(mode){
  const hist = loadHistory();
  const entry = hist[mode];
  if(!entry) return false;

  pastCardEl.innerHTML = "";

  const div = document.createElement("div");
  div.className="card-title-row";

  const title = document.createElement("div");
  title.className="card-title";
  title.textContent = modeTitle(mode);

  const day = document.createElement("div");
  day.className="card-day";
  day.textContent = entry.day; // already weekday only

  div.appendChild(title);
  div.appendChild(day);
  pastCardEl.appendChild(div);

  entry.items.forEach(it=>{
    const row = document.createElement("div");
    row.className="line show-line";
    row.appendChild(document.createTextNode(it.label));

    if(it.weighted){ row.appendChild(makePill("Weighted","pill-weighted")); }
    if(it.abs){ row.appendChild(makePill("Abs","pill-abs")); }
    if(it.shoulders){ row.appendChild(makePill("Shoulders","pill-shoulders")); }
    if(it.biceps){ row.appendChild(makePill("Biceps","pill-biceps")); }
    if(it.kettlebell){ row.appendChild(makePill("Kettlebell","pill-kettlebell")); }

    pastCardEl.appendChild(row);
  });

  pastCardEl.style.display="block";
  void pastCardEl.offsetWidth;
  pastCardEl.classList.add("visible");
  return true;
}

function hidePastCard(){
  pastCardEl.classList.remove("visible");
  setTimeout(()=> pastCardEl.style.display="none",250);
}

/* Helper for pills */
function makePill(text, cls){
  const p=document.createElement("span");
  p.className="pill "+cls;
  p.textContent=text;
  return p;
}

/* -------------------------------------------------
   RENDER TODAY WORKOUT
-------------------------------------------------- */
function renderWorkoutCard(workout){
  const {mode, items} = workout;

  dayTitleEl.textContent = modeTitle(mode);
  dayOfWeekEl.textContent = dayNameFromDate(todayKey());

  linesEl.innerHTML = "";

  items.forEach((it,idx)=>{
    const row=document.createElement("div");
    row.className="line";

    row.appendChild(document.createTextNode(it.label));

    if(it.weighted){ row.appendChild(makePill("Weighted","pill-weighted")); }
    if(it.abs){ row.appendChild(makePill("Abs","pill-abs")); }
    if(it.shoulders){ row.appendChild(makePill("Shoulders","pill-shoulders")); }
    if(it.biceps){ row.appendChild(makePill("Biceps","pill-biceps")); }
    if(it.kettlebell){ row.appendChild(makePill("Kettlebell","pill-kettlebell")); }

    linesEl.appendChild(row);

    setTimeout(()=> row.classList.add("show-line"),40*idx+60);
  });

  cardEl.style.display="block";
  void cardEl.offsetWidth;
  cardEl.classList.add("visible");
}

/* -------------------------------------------------
   TIMER
-------------------------------------------------- */
function stopCountdown(){
  if(countdownInterval){
    clearInterval(countdownInterval);
    countdownInterval=null;
  }
}

function startBigTimer(target){
  stopCountdown();
  bigTimer.classList.remove("hidden");
  requestAnimationFrame(()=> bigTimer.classList.add("show"));

  function tick(){
    const diff = target - new Date();
    if(diff <= 0){
      stopCountdown();
      bigTimer.classList.remove("show");
      setTimeout(()=>{ bigTimer.classList.add("hidden"); initUI(); },300);
      return;
    }
    const total = Math.floor(diff/1000);
    tH.textContent = String(Math.floor(total/3600)).padStart(2,"0");
    tM.textContent = String(Math.floor((total%3600)/60)).padStart(2,"0");
    tS.textContent = String(total%60).padStart(2,"0");
  }
  tick();
  countdownInterval=setInterval(tick,1000);
}

/* -------------------------------------------------
   VIEW STATES
-------------------------------------------------- */
function showSelectionState(){
  hidePastCard();
  cardEl.style.display="none";
  cardEl.classList.remove("visible");

  stopCountdown();
  bigTimer.classList.add("hidden");
  bigTimer.classList.remove("show");

  subtitleEl.textContent="What would you like to train?";

  mainBtn.classList.remove("hidden");
  mainBtn.classList.add("disabled");
  mainBtn.textContent="Generate";
}

function showPreLockedState(){
  subtitleEl.textContent="Next workout in";
  hidePastCard();
  cardEl.style.display="none";
  mainBtn.classList.add("hidden");
  startBigTimer(getStartTime());
}

function showWorkoutState(workout){
  hidePastCard();
  stopCountdown();
  bigTimer.classList.add("hidden");

  currentWorkout = workout;
  subtitleEl.textContent="Today’s workout";

  renderWorkoutCard(workout);

  mainBtn.classList.add("hidden");
}

function showCompletedState(){
  subtitleEl.textContent="Next workout in";
  hidePastCard();
  cardEl.style.display="none";
  startBigTimer(getStartTime(true));
}

function showAllUsedState(){
  subtitleEl.textContent="All workouts used this week";
  hidePastCard();
  cardEl.style.display="none";
  mainBtn.classList.add("hidden");
}

/* -------------------------------------------------
   GENERATE
-------------------------------------------------- */
function handleGenerate(){
  if(!selectedMode) return;

  const workout = buildWorkout(selectedMode);
  currentWorkout = workout;

  saveWorkoutToday(workout);

  // save into weekly history
  const hist = loadHistory();
  hist[selectedMode] = {
    day: dayNameFromDate(todayKey()),
    items: workout.items
  };
  saveHistory(hist);

  // lock
  const locks = loadLocks();
  locks[selectedMode] = true;
  saveLocks(locks);

  showWorkoutState(workout);
}
/* -------------------------------------------------
   RADIO INTERACTION (history reveal)
-------------------------------------------------- */
qsa("input[name='mode']").forEach(r => {
  r.addEventListener("change", () => {
    selectedMode = r.value;

    qsa(".opt").forEach(lbl => {
      lbl.classList.toggle("active", lbl.dataset.mode === selectedMode);
    });

    // If history exists for that mode → show past card
    const shown = renderPastCardForMode(selectedMode);
    if (shown) {
      // Timer stays visible — do NOT hide bigTimer
      cardEl.classList.remove("visible");
      cardEl.style.display = "none";
      mainBtn.classList.add("hidden");
      return;
    }

    // If no history → normal selection mode
    hidePastCard();
    mainBtn.classList.remove("disabled");
    mainBtn.textContent =
      `Generate ${modeTitle(selectedMode).replace(" Day","")}`;
  });
});

/* -------------------------------------------------
   OUTSIDE CLICK — dismiss past card
-------------------------------------------------- */
document.addEventListener("click", (e) => {
  if (!pastCardEl.classList.contains("visible")) return;

  const insideCard = pastCardEl.contains(e.target);
  const insideRadio = radioRow.contains(e.target);

  if (!insideCard && !insideRadio) {
    hidePastCard();
    qsa(".opt").forEach(o => o.classList.remove("active"));
    selectedMode = null;
  }
});

/* -------------------------------------------------
   INIT UI
-------------------------------------------------- */
function initUI(){
  resetWeekIfNeeded();
  hidePastCard();

  const workout = loadWorkoutToday();
  const completed = loadCompletedToday();
  const lockedByTime = !afterStart();

  if (!workout && !completed && lockedByTime) {
    showPreLockedState();
    return;
  }

  if (completed) {
    showCompletedState();
    return;
  }

  if (workout) {
    showWorkoutState(workout);
    return;
  }

  // If all 4 modes have history this week → all used
  const hist = loadHistory();
  if (Object.keys(hist).length === 4) {
    showAllUsedState();
    return;
  }

  showSelectionState();
}

/* -------------------------------------------------
   BOOT
-------------------------------------------------- */
initUI();
      
