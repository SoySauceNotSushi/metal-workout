<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout Builder</title>

<style>
  :root {
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#ffffff;
    --card:#f8f9fb;
    --pill-blue:#e8eeff;
    --pill-orange:#fff4e6;
    --pill-green:#e6fae9;
    --pill-blue-text:#2453f5;
    --pill-orange-text:#ff9f43;
    --pill-green-text:#22c55e;
  }

  *{box-sizing:border-box;}

  body {
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro",Segoe UI,Roboto,sans-serif;
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--ink);
  }

  .container {
    padding:24px;
    max-width:480px;
    margin:auto;
    padding-bottom:96px; /* space for fixed button */
  }

  .weather {
    font-size:15px;
    color:var(--sub);
    margin-bottom:14px;
  }

  h1 {
    font-size:28px;
    font-weight:700;
    margin:0 0 6px;
  }

  #subtitle {
    font-size:16px;
    font-weight:400;
    color:var(--sub);
    margin:0 0 18px;
  }

  /* RADIO ROW --------------------------------------------------- */
  .radio-row {
    display:flex;
    gap:18px;
    margin-bottom:22px;
  }

  .radio-option {
    display:flex;
    align-items:center;
    gap:6px;
    font-size:14px;
    cursor:pointer;
    user-select:none;
    color:var(--ink);
    transition:opacity .2s ease,color .2s ease;
  }

  .radio-option input {
    appearance:none;
    width:18px;
    height:18px;
    border-radius:50%;
    border:2px solid #cbd5e1;
    background:#fff;
    position:relative;
    cursor:pointer;
  }

  .radio-option input:checked {
    border-color:var(--brand);
  }

  .radio-option input:checked::after {
    content:"";
    position:absolute;
    inset:4px;
    border-radius:50%;
    background:var(--brand);
  }

  .radio-option.disabled {
    opacity:0.35;
    cursor:not-allowed;
  }

  .radio-option.active {
    font-weight:600;
    color:var(--brand);
  }

  /* AI GRADIENT ------------------------------------------------- */
  .ai-stage {
    position:relative;
    height:160px;
    margin:10px 0 18px;
    border-radius:100%;
    display:none;
    overflow:visible;
  }

  .ai-stage::before{
    content:"";
    position:absolute;
    inset:-20% -15% -25% -15%;
    filter:blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    transition:opacity .25s ease;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    animation:meshBreath 2s ease-in-out infinite,
             meshDrift 3s ease-in-out infinite;
  }

  .ai-stage.show::before{opacity:.9;}

  @keyframes meshBreath{
    0%,100%{transform:scale(1);opacity:.7}
    50%{transform:scale(1.05);opacity:.3}
  }
  @keyframes meshDrift{
    0%{transform:translate3d(0,0,0);}
    50%{transform:translate3d(2%,-1.5%,0);}
    100%{transform:translate3d(0,0,0);}
  }

  /* WORKOUT CARD ------------------------------------------------ */
  .workout-card{
    background:var(--card);
    border-radius:16px;
    padding:20px;
    margin-top:8px;
  }

  .section-title{
    font-size:20px;
    font-weight:700;
    margin-bottom:10px;
  }

  .type-line{
    font-size:16px;
    margin-bottom:6px;
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }

  .pill{
    padding:2px 8px;
    border-radius:10px;
    font-size:12px;
    font-weight:600;
  }
  .pill-weighted{background:var(--pill-blue);color:var(--pill-blue-text);}
  .pill-shoulders,
  .pill-biceps{background:var(--pill-orange);color:var(--pill-orange-text);}
  .pill-abs{background:var(--pill-green);color:var(--pill-green-text);}

  /* BUTTONS ----------------------------------------------------- */
  .primary-btn{
    position:fixed;
    bottom:24px;
    left:50%;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    height:56px;
    border:none;
    border-radius:28px;
    background:var(--brand);
    color:#fff;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
    transition:opacity .25s ease;
  }
  .primary-btn[disabled]{opacity:.6;cursor:default;}
  .hidden{display:none!important;}

  /* CONFETTI ---------------------------------------------------- */
  .confetti-piece{
    position:fixed;
    top:-10px;
    width:6px;
    height:10px;
    border-radius:2px;
    opacity:0.9;
    pointer-events:none;
    animation:confettiFall var(--confetti-duration) ease-out forwards;
  }
  @keyframes confettiFall{
    0%{transform:translate3d(0,-20px,0) rotateZ(0deg);opacity:1;}
    100%{transform:translate3d(0,100vh,0) rotateZ(260deg);opacity:0;}
  }
</style>
</head>
<body>
<div class="container">
  <div id="weather" class="weather">Enable location for weather</div>

  <h1>Welcome back Jy</h1>
  <div id="subtitle">What would you like to train?</div>

  <div id="radioRow" class="radio-row">
    <label class="radio-option" id="optPull">
      <input type="radio" name="mode" value="pull"> Pull
    </label>
    <label class="radio-option" id="optPush">
      <input type="radio" name="mode" value="push"> Push
    </label>
    <label class="radio-option" id="optLegs">
      <input type="radio" name="mode" value="legs"> Legs
    </label>
    <label class="radio-option" id="optFull">
      <input type="radio" name="mode" value="full"> Full body
    </label>
  </div>

  <div id="aiStage" class="ai-stage"></div>

  <div id="output" style="display:none;">
    <div id="workoutCard" class="workout-card"></div>
  </div>
</div>

<button id="create" class="primary-btn">Generate</button>
<button id="completeBtn" class="primary-btn hidden">Workout completed</button>

<script>
const DEV = new URLSearchParams(location.search).get("dev")==="true";
const qs = s => document.querySelector(s);

/* ---------- SOUND (soft chime) ---------- */
const Sound = (() => {
  let ctx=null;
  function ensure(){
    if(!ctx){
      const A = window.AudioContext || window.webkitAudioContext;
      if(!A) return null;
      ctx = new A();
    }
    if(ctx.state==="suspended") ctx.resume();
    return ctx;
  }
  document.addEventListener("pointerdown",ensure,{once:true});

  function chime(){
    const ac=ensure(); if(!ac) return;
    const now=ac.currentTime;
    [880,1320].forEach((f,i)=>{
      const osc=ac.createOscillator();
      const g=ac.createGain();
      osc.type="sine";
      osc.frequency.setValueAtTime(f,now+i*0.12);
      g.gain.setValueAtTime(0,now+i*0.12);
      g.gain.linearRampToValueAtTime(0.2,now+i*0.12+0.02);
      g.gain.linearRampToValueAtTime(0,now+i*0.12+0.25);
      osc.connect(g); g.connect(ac.destination);
      osc.start(now+i*0.12); osc.stop(now+i*0.12+0.3);
    });
  }
  return { chime };
})();

/* ---------- CONFETTI ---------- */
function launchConfetti(){
  const colors=["#f97316","#fb7185","#22c55e","#38bdf8","#eab308"];
  const count=70;
  for(let i=0;i<count;i++){
    const el=document.createElement("div");
    el.className="confetti-piece";
    el.style.left=Math.random()*100+"vw";
    el.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
    el.style.animationDuration=(0.8+Math.random()*0.6).toFixed(2)+"s";
    el.style.transform=`translate3d(0,0,0) rotateZ(${Math.random()*360}deg)`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),1600);
  }
}

/* ---------- STORAGE HELPERS ---------- */
function todayString(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function getWeekKey(){
  const d=new Date();
  const s=new Date(d.getFullYear(),0,1);
  const days=Math.floor((d-s)/86400000);
  const week=Math.ceil((d.getDay()+1+days)/7);
  return `${d.getFullYear()}-W${week}`;
}
function resetWeekIfNeeded(){
  const nowKey=getWeekKey();
  const prev=localStorage.getItem("weekKey");
  if(prev!==nowKey){
    localStorage.setItem("weekKey",nowKey);
    localStorage.removeItem("locks");
    localStorage.removeItem("workoutToday");
    localStorage.removeItem("completedToday");
  }
}
function loadLocks(){ return DEV ? {} : JSON.parse(localStorage.getItem("locks")||"{}"); }
function saveLocks(l){ if(!DEV) localStorage.setItem("locks",JSON.stringify(l)); }

function saveWorkoutToday(mode,html){
  if(DEV) return;
  localStorage.setItem("workoutToday",JSON.stringify({date:todayString(),mode,html}));
}
function loadWorkoutToday(){
  if(DEV) return null;
  const raw=localStorage.getItem("workoutToday");
  if(!raw) return null;
  try{
    const d=JSON.parse(raw);
    if(d.date===todayString()) return d;
  }catch{}
  return null;
}
function saveCompletedToday(mode){
  if(DEV) return;
  localStorage.setItem("completedToday",JSON.stringify({date:todayString(),mode}));
}
function loadCompletedToday(){
  if(DEV) return null;
  const raw=localStorage.getItem("completedToday");
  if(!raw) return null;
  try{
    const d=JSON.parse(raw);
    if(d.date===todayString()) return d;
  }catch{}
  return null;
}

/* ---------- TIME + COUNTDOWN ---------- */
let countdownInterval=null;
function stopCountdown(){ if(countdownInterval){clearInterval(countdownInterval);countdownInterval=null;} }

function getNextWorkoutTime(){
  if(DEV) return null;
  const now=new Date();
  const workout=loadWorkoutToday();
  const completed=loadCompletedToday();

  if(!workout && !completed){
    const t=new Date();
    t.setHours(17,30,0,0);
    if(now<t) return t;
    return null; // open now
  }
  if(completed){
    const t=new Date();
    t.setDate(t.getDate()+1);
    t.setHours(17,30,0,0);
    return t;
  }
  return null; // workout exists and not completed; no countdown
}

function startCountdown(target){
  if(!target) return;
  const btn=createBtn;
  btn.disabled=true;

  function tick(){
    const now=new Date();
    let diff=target-now;
    if(diff<=0){
      stopCountdown();
      localStorage.removeItem("workoutToday");
      localStorage.removeItem("completedToday");
      initUI();
      return;
    }
    const totalSec=Math.floor(diff/1000);
    const h=String(Math.floor(totalSec/3600)).padStart(2,"0");
    const m=String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
    const s=String(totalSec%60).padStart(2,"0");
    btn.textContent=`Next workout in ${h}:${m}:${s}`;
  }
  tick();
  countdownInterval=setInterval(tick,1000);
}

/* ---------- WORKOUT BUILDERS ---------- */
const metals=["Metacon","EMOM","Ladder","AMRAP","Tabata"];
const maybeAbs = () => Math.random()<0.5;
const maybeWeighted = () => Math.random()<0.25;
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

function pillWeighted(){return `<span class="pill pill-weighted">Weighted</span>`}
function pillShoulders(){return `<span class="pill pill-shoulders">Shoulders</span>`}
function pillBiceps(){return `<span class="pill pill-biceps">Biceps</span>`}
function pillAbs(){return `<span class="pill pill-abs">Abs</span>`}
function assemblePills(weight,special,abs){
  let out="";
  if(weight) out+=pillWeighted()+" ";
  if(special) out+=special+" ";
  if(abs) out+=pillAbs();
  return out.trim();
}

function buildPushHTML(){
  let h=`<div class="section-title">Push Day</div>`;
  h+=`<div class="type-line">Strength ${pillWeighted()}</div>`;
  const addShoulders=Math.random()<0.5;
  const shouldersSlot=addShoulders?(Math.random()<0.5?1:2):0;
  for(let i=1;i<=2;i++){
    const label=pick(metals);
    const weighted=maybeWeighted();
    const abs=maybeAbs();
    const special=(i===shouldersSlot?pillShoulders():"");
    const pills=assemblePills(weighted,special,abs);
    h+=`<div class="type-line">${label} ${pills}</div>`;
  }
  return h;
}
function buildPullHTML(){
  let h=`<div class="section-title">Pull Day</div>`;
  h+=`<div class="type-line">Strength ${pillWeighted()}</div>`;
  const addBiceps=Math.random()<0.5;
  const bicepsSlot=addBiceps?(Math.random()<0.5?1:2):0;
  for(let i=1;i<=2;i++){
    const label=pick(metals);
    const weighted=maybeWeighted();
    const abs=maybeAbs();
    const special=(i===bicepsSlot?pillBiceps():"");
    const pills=assemblePills(weighted,special,abs);
    h+=`<div class="type-line">${label} ${pills}</div>`;
  }
  return h;
}
function buildLegsHTML(){
  let h=`<div class="section-title">Legs Day</div>`;
  const count=Math.random()<0.5?2:3;
  for(let i=0;i<count;i++){
    const label=pick(metals);
    const weighted=maybeWeighted();
    const abs=maybeAbs();
    const pills=assemblePills(weighted,"",abs);
    h+=`<div class="type-line">${label} ${pills}</div>`;
  }
  return h;
}
function buildFullHTML(){
  let h=`<div class="section-title">Full Body Day</div>`;
  const heavy=Math.random()<0.5;
  if(heavy){
    h+=`<div class="type-line">Push Strength ${pillWeighted()}</div>`;
    h+=`<div class="type-line">Pull Strength ${pillWeighted()}</div>`;
    const label=pick(metals);
    const weighted=maybeWeighted();
    const abs=maybeAbs();
    const pills=assemblePills(weighted,"",abs);
    h+=`<div class="type-line">${label} ${pills}</div>`;
  }else{
    for(let i=0;i<3;i++){
      const label=pick(metals);
      const weighted=maybeWeighted();
      const abs=maybeAbs();
      const pills=assemblePills(weighted,"",abs);
      h+=`<div class="type-line">${label} ${pills}</div>`;
    }
  }
  return h;
}
function modeTitle(mode){
  if(mode==="pull") return "Pull Day";
  if(mode==="push") return "Push Day";
  if(mode==="legs") return "Legs Day";
  if(mode==="full") return "Full Body Day";
  return "Workout";
}

/* ---------- DOM REFS ---------- */
const subtitleEl=qs("#subtitle");
const radioRow=qs("#radioRow");
const aiStage=qs("#aiStage");
const output=qs("#output");
const card=qs("#workoutCard");
const createBtn=qs("#create");
const completeBtn=qs("#completeBtn");

const radioMap={
  pull:qs("#optPull"),
  push:qs("#optPush"),
  legs:qs("#optLegs"),
  full:qs("#optFull")
};

/* ---------- RADIO + BUTTON STATE ---------- */
function anyUnlocked(){
  if(DEV) return true;
  const locks=loadLocks();
  return Object.keys(radioMap).some(m=>!locks[m]);
}

function refreshRadios(){
  const locks=loadLocks();
  Object.entries(radioMap).forEach(([mode,label])=>{
    const input=label.querySelector("input");
    label.classList.remove("active","disabled");
    input.disabled=false;
    if(!DEV && locks[mode]){
      input.disabled=true;
      label.classList.add("disabled");
    }
    if(input.checked) label.classList.add("active");
  });
}

function canGenerateNow(){
  if(DEV) return true;
  if(loadWorkoutToday() || loadCompletedToday()) return false;
  const now=new Date();
  const cut=new Date();
  cut.setHours(17,30,0,0);
  return now>=cut;
}

function updateCreateLabelFromSelection(){
  const sel=document.querySelector("input[name='mode']:checked");
  if(!sel){
    createBtn.textContent="Generate";
    createBtn.disabled=true;
    return;
  }
  const mode=sel.value;
  const label=mode==="full"?"Full Body":mode.charAt(0).toUpperCase()+mode.slice(1);
  if(canGenerateNow()){
    createBtn.textContent=`Generate ${label}`;
    createBtn.disabled=false;
  }else{
    // locked by time → text is handled by countdown
    createBtn.disabled=true;
  }
}

/* ---------- VIEW STATES ---------- */
function enterPreState(){
  stopCountdown();
  subtitleEl.textContent="What would you like to train?";
  radioRow.style.display="flex";
  output.style.display="none";
  completeBtn.classList.add("hidden");
  createBtn.classList.remove("hidden");
  createBtn.disabled=true;

  refreshRadios();

  const target=getNextWorkoutTime();
  if(target){
    startCountdown(target);
  }else{
    createBtn.textContent="Generate";
    createBtn.disabled=true;
  }
}

function enterWorkoutView(mode, html){
  stopCountdown();
  subtitleEl.textContent="Today’s workout";
  radioRow.style.display="none";
  output.style.display="block";
  card.innerHTML=html;
  createBtn.classList.add("hidden");

  const title=modeTitle(mode);
  completeBtn.textContent=`${title} completed`;
  completeBtn.classList.remove("hidden");
}

function enterCompletedView(){
  stopCountdown();
  subtitleEl.textContent="Workout completed";
  radioRow.style.display="none";
  output.style.display="none";
  completeBtn.classList.add("hidden");
  createBtn.classList.remove("hidden");
  const target=getNextWorkoutTime(); // tomorrow 17:30
  startCountdown(target);
}

function enterAllUsedState(){
  stopCountdown();
  subtitleEl.textContent="All workouts used this week";
  radioRow.style.display="none";
  output.style.display="none";
  createBtn.classList.add("hidden");
  completeBtn.classList.add("hidden");
}

/* ---------- INIT ---------- */
function initUI(){
  resetWeekIfNeeded();
  const workout=loadWorkoutToday();
  const completed=loadCompletedToday();

  if(workout && !DEV){
    if(completed){
      enterCompletedView();
    }else{
      enterWorkoutView(workout.mode,workout.html);
    }
  }else{
    if(!anyUnlocked() && !DEV){
      enterAllUsedState();
    }else{
      enterPreState();
    }
  }
}

/* ---------- EVENT: radios ---------- */
document.querySelectorAll("input[name='mode']").forEach(inp=>{
  inp.addEventListener("change",()=>{
    refreshRadios();
    if(canGenerateNow()){
      updateCreateLabelFromSelection();
    }
  });
});

/* ---------- EVENT: createBtn (Generate / Timer) ---------- */
createBtn.addEventListener("click",()=>{
  if(!canGenerateNow()) return; // if it's countdown state, button is disabled anyway

  const sel=document.querySelector("input[name='mode']:checked");
  if(!sel) return;
  const mode=sel.value;

  // show gradient while "generating"
  aiStage.style.display="block";
  aiStage.classList.add("show");
  output.style.display="none";
  createBtn.disabled=true;
  createBtn.textContent="Generating...";

  setTimeout(()=>{
    let html="";
    if(mode==="push") html=buildPushHTML();
    else if(mode==="pull") html=buildPullHTML();
    else if(mode==="legs") html=buildLegsHTML();
    else html=buildFullHTML();

    if(!DEV){
      saveWorkoutToday(mode,html);
      const locks=loadLocks();
      locks[mode]=true;
      saveLocks(locks);
    }

    aiStage.classList.remove("show");
    aiStage.style.display="none";

    enterWorkoutView(mode,html);
  },900);
});

/* ---------- EVENT: completeBtn ---------- */
completeBtn.addEventListener("click",()=>{
  const workout=loadWorkoutToday();
  const mode=workout?.mode || "workout";

  launchConfetti();
  Sound.chime();
  saveCompletedToday(mode);

  // fade out workout quickly
  output.style.opacity="1";
  output.style.transition="opacity .35s ease";
  output.style.opacity="0";
  completeBtn.disabled=true;

  setTimeout(()=>{
    output.style.display="none";
    output.style.opacity="1";
    completeBtn.classList.add("hidden");
    completeBtn.disabled=false;
    enterCompletedView(); // this shows countdown button
  },700);
});

/* ---------- WEATHER (simple) ---------- */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
      const j=await r.json();
      const temp=Math.round(j.current_weather.temperature);
      qs("#weather").textContent=`${temp}°C`;
    }catch{
      qs("#weather").textContent="Weather unavailable";
    }
  },()=>qs("#weather").textContent="Enable location for weather");
}

/* ---------- BOOT ---------- */
initUI();
</script>
</body>
</html>
