<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metal Workout Builder 2</title>

<style>
  :root {
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#ffffff;
    --card:#f8f9fb;
    --pill:#e8eeff;
  }

  * { box-sizing:border-box; }

  body {
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
    background:var(--bg);
    color:var(--ink);
    margin:0;
  }

  .container {
    padding:24px;
    max-width:500px;
    margin:auto;
  }

  .weather {
    font-size:15px;
    color:var(--sub);
    margin-bottom:16px;
  }

  h1 {
    font-size:28px;
    font-weight:700;
    margin:0 0 8px;
  }

  .subtitle {
    font-size:16px;
    color:var(--sub);
    margin:0 0 16px;
  }

  /* Mode selector -------------------------------------------------- */
  .modes {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:16px;
  }

  .mode-option {
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #e2e8f0;
    font-size:14px;
    cursor:pointer;
    user-select:none;
  }

  .mode-option input {
    display:none;
  }

  .mode-option span.emoji {
    font-size:16px;
  }

  .mode-option span.label {
    font-size:14px;
  }

  .mode-option.active {
    border-color:var(--brand);
    background:#e5edff;
    color:var(--brand);
  }

  /* AI glow stage -------------------------------------------------- */
  .ai-stage {
    position:relative;
    height:160px;
    margin-top:8px;
    margin-bottom:16px;
    display:none;
    border-radius:100%;
    overflow:visible;
  }

  .ai-stage::before {
    content:"";
    position:absolute;
    inset:-20% -15% -20% -15%;
    filter:blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    transition:opacity .25s ease;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    animation:meshBreath 2s ease-in-out infinite, meshDrift 3s ease-in-out infinite;
  }

  .ai-stage.show::before { opacity:.9; }

  @keyframes meshBreath {
    0%,100% { transform:scale(1); opacity:.7; }
    50% { transform:scale(1.03); opacity:.3; }
  }

  @keyframes meshDrift {
    0% { transform:translate3d(0,0,0); }
    50% { transform:translate3d(2%,-1.5%,0); }
    100% { transform:translate3d(0,0,0); }
  }

  /* Workout card --------------------------------------------------- */
  #output {
    margin-top:12px;
    display:none;
  }

  .workout-card {
    background:var(--card);
    border-radius:16px;
    padding:20px;
  }

  .workout-title {
    font-size:17px;
    font-weight:700;
    margin-bottom:8px;
  }

  .workout-list {
    list-style:none;
    padding-left:0;
    margin:0;
  }

  .workout-list li {
    font-size:16px;
    color:var(--ink);
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
  }

  .pill {
    background:var(--pill);
    color:var(--brand);
    padding:3px 10px;
    border-radius:12px;
    font-size:12px;
    font-weight:600;
  }

  /* Button ---------------------------------------------------------- */
  .create-btn {
    position:fixed;
    bottom:28px;
    left:50%;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    height:56px;
    background:var(--brand);
    color:#fff;
    border:none;
    border-radius:28px;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
  }
  .create-btn:disabled { opacity:0.7; }
</style>
</head>
<body>
<div class="container">
  <div class="weather" id="weather">Loading weather...</div>

  <h1>Welcome back Jy</h1>
  <p class="subtitle">What would you like to train?</p>

  <div class="modes" id="modes">
    <label class="mode-option" data-mode="pull">
      <input type="radio" name="mode" value="pull">
      <span class="emoji">âœŠ</span>
      <span class="label">Pull</span>
    </label>
    <label class="mode-option" data-mode="push">
      <input type="radio" name="mode" value="push">
      <span class="emoji">âœ‹</span>
      <span class="label">Push</span>
    </label>
    <label class="mode-option" data-mode="legs">
      <input type="radio" name="mode" value="legs">
      <span class="emoji">ðŸ¦µ</span>
      <span class="label">Legs</span>
    </label>
    <label class="mode-option" data-mode="fullbody">
      <input type="radio" name="mode" value="fullbody">
      <span class="emoji">ðŸ”¥</span>
      <span class="label">Full Body</span>
    </label>
  </div>

  <div id="aiStage" class="ai-stage"></div>

  <div id="output">
    <div class="workout-card">
      <div id="workoutTitle" class="workout-title"></div>
      <ul id="workoutList" class="workout-list"></ul>
    </div>
  </div>
</div>

<button class="create-btn" id="create">Create Workout</button>

<script>
/* ----------------------------------------------------
   DEV MODE (?dev=true)
----------------------------------------------------- */
const params = new URLSearchParams(window.location.search);
const DEV = params.get("dev") === "true";

/* ----------------------------------------------------
   SOUND
----------------------------------------------------- */
const Sound = (() => {
  let ctx = null;
  function ensure() {
    if (!ctx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) return;
      ctx = new AC();
    }
    if (ctx.state === "suspended") ctx.resume();
    return ctx;
  }
  document.addEventListener("pointerdown", ensure, { once:true });

  function beep(freq=880,dur=.15,type="sine",vol=.25,when=0){
    if (!ensure()) return;
    const t = ctx.currentTime + when;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq,t);
    gain.gain.setValueAtTime(0.0001,t);
    gain.gain.exponentialRampToValueAtTime(vol,t+.02);
    gain.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(t); osc.stop(t+dur+.02);
  }
  return { beep };
})();

/* ----------------------------------------------------
   DOM
----------------------------------------------------- */
const createBtn = document.getElementById("create");
const aiStage  = document.getElementById("aiStage");
const output   = document.getElementById("output");
const titleEl  = document.getElementById("workoutTitle");
const listEl   = document.getElementById("workoutList");
const modesEl  = document.getElementById("modes");

/* ----------------------------------------------------
   HELPERS
----------------------------------------------------- */
const metalTypes = ["Metacon","EMOM","Tabata","AMRAP","Ladder"];

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function chance(p){ return Math.random() < p; }

function todayString(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

/* state: selected mode */
let selectedMode = "fullbody";

/* ----------------------------------------------------
   MODE RADIO UI
----------------------------------------------------- */
function setSelectedMode(mode){
  selectedMode = mode;
  document.querySelectorAll(".mode-option").forEach(lbl => {
    const m = lbl.getAttribute("data-mode");
    const input = lbl.querySelector("input");
    if (m === mode){
      lbl.classList.add("active");
      input.checked = true;
    } else {
      lbl.classList.remove("active");
      input.checked = false;
    }
  });
}

modesEl.addEventListener("click", e => {
  const label = e.target.closest(".mode-option");
  if (!label) return;
  const mode = label.getAttribute("data-mode");
  setSelectedMode(mode);
});

setSelectedMode("fullbody");

/* ----------------------------------------------------
   STORAGE (live only, not in DEV)
----------------------------------------------------- */
const STORAGE_KEY = "metalWorkoutV3";

function saveWorkout(data){
  if (DEV) return;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadWorkout(){
  if (DEV) return null;
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return null;
  try{
    const data = JSON.parse(raw);
    if (!data || data.date !== todayString()) return null;
    return data;
  } catch(e){
    return null;
  }
}

function hasGeneratedToday(){
  return !!loadWorkout();
}

/* ----------------------------------------------------
   RENDER
----------------------------------------------------- */
function renderWorkout(data){
  titleEl.textContent = data.title;
  listEl.innerHTML = "";
  data.items.forEach(item => {
    const li = document.createElement("li");
    li.textContent = item.text;
    if (item.weighted){
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = "Weighted";
      li.appendChild(pill);
    }
    listEl.appendChild(li);
  });
  output.style.display = "block";
}

/* ----------------------------------------------------
   WORKOUT GENERATION LOGIC
----------------------------------------------------- */
function makeMetalItem(){
  const base = pick(metalTypes);
  const withAbs = chance(0.5);
  const text = base + (withAbs ? " + Abs" : "");
  const weighted = chance(0.2);
  return { text, weighted, type:"metal" };
}

function generateForMode(mode){
  const date = todayString();
  let title = "";
  let items = [];

  if (mode === "push"){
    title = "âœ‹ Push Day";
    // Always heavy at start
    items.push({ text:"Push Strength", weighted:true, type:"strength" });
    items.push(makeMetalItem());
    items.push(makeMetalItem());
  }
  else if (mode === "pull"){
    title = "âœŠ Pull Day";
    items.push({ text:"Pull Strength", weighted:true, type:"strength" });
    items.push(makeMetalItem());
    items.push(makeMetalItem());
  }
  else if (mode === "legs"){
    title = "ðŸ¦µ Legs Day";
    const count = chance(0.5) ? 2 : 3;
    for (let i=0;i<count;i++) items.push(makeMetalItem());
  }
  else { // fullbody
    title = "ðŸ”¥ Full Body Day";
    const heavyOn = chance(0.5);
    if (heavyOn){
      // both heavies + 1 metal (always 3 items)
      items.push({ text:"Push Strength", weighted:true, type:"strength" });
      items.push({ text:"Pull Strength", weighted:true, type:"strength" });
      items.push(makeMetalItem());
    } else {
      // no heavies: 3 metals
      for (let i=0;i<3;i++) items.push(makeMetalItem());
    }
  }

  const data = { date, mode, title, items };
  return data;
}

/* ----------------------------------------------------
   TIME & LOCK
----------------------------------------------------- */
function canGenerateNow(){
  if (DEV) return true;
  const now = new Date();
  const limit = new Date();
  limit.setHours(17,30,0,0);
  return now >= limit;
}

function restoreWorkoutIfAny(){
  const data = loadWorkout();
  if (!data) return false;
  setSelectedMode(data.mode || "fullbody");
  renderWorkout(data);
  createBtn.style.display = "none";
  return true;
}

function updateButtonState(){
  if (DEV){
    createBtn.style.display = "block";
    createBtn.disabled = false;
    createBtn.textContent = "Create Workout (DEV)";
    return;
  }

  if (restoreWorkoutIfAny()) return;

  if (hasGeneratedToday()){
    createBtn.style.display = "none";
    return;
  }

  if (!canGenerateNow()){
    createBtn.disabled = true;
    createBtn.textContent = "Available at 5:30 PM";
    createBtn.style.display = "block";
  } else {
    createBtn.disabled = false;
    createBtn.textContent = "Create Workout";
    createBtn.style.display = "block";
  }
}

/* ----------------------------------------------------
   FLOW
----------------------------------------------------- */
function startGenerate(){
  if (!canGenerateNow() || (!DEV && hasGeneratedToday())) return;

  output.style.display = "none";
  aiStage.style.display = "block";
  aiStage.classList.add("show");

  createBtn.disabled = true;
  createBtn.textContent = DEV ? "Generating (DEV)..." : "Generating...";

  setTimeout(() => {
    const data = generateForMode(selectedMode);
    renderWorkout(data);
    saveWorkout(data);

    aiStage.classList.remove("show");
    aiStage.style.display = "none";

    if (!DEV){
      createBtn.style.display = "none";
    } else {
      createBtn.disabled = false;
      createBtn.textContent = "Create Workout (DEV)";
    }

    Sound.beep();
  }, 900);
}

createBtn.addEventListener("click", startGenerate);

/* ----------------------------------------------------
   WEATHER
----------------------------------------------------- */
async function getWeatherEmoji(cond){
  cond = cond.toLowerCase();
  if (cond.includes("clear")) return "â˜€ï¸";
  if (cond.includes("cloud")) return "â›…";
  if (cond.includes("rain")) return "ðŸŒ§ï¸";
  if (cond.includes("drizzle")) return "ðŸŒ¦ï¸";
  if (cond.includes("thunder")) return "ðŸŒ©ï¸";
  if (cond.includes("snow")) return "â„ï¸";
  if (cond.includes("fog") || cond.includes("mist")) return "ðŸŒ«ï¸";
  return "ðŸŒ¡ï¸";
}

const weatherMap = {
  0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
  45:"Fog",48:"Fog",
  51:"Drizzle",53:"Drizzle",55:"Drizzle",
  61:"Rain",63:"Rain",65:"Rain",
  71:"Snow",73:"Snow",75:"Snow",
  80:"Rain shower",81:"Rain shower",82:"Rain shower",
  95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
};

function weatherCodeToText(code){ return weatherMap[code] || "Unknown"; }

async function updateWeatherUI(){
  const el = document.getElementById("weather");
  el.textContent = "Enable location for weather";

  if (!navigator.geolocation) {
    el.textContent = "Weather unavailable";
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res = await fetch(url);
      const data = await res.json();
      const temp = Math.round(data.current_weather.temperature);

      const rev = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
      const r = await rev.json();
      const city = r.address.city || r.address.town || r.address.village || r.address.county || "your area";

      const cond = weatherCodeToText(data.current_weather.weathercode);
      const emoji = await getWeatherEmoji(cond);

      el.innerHTML = `${emoji} ${temp}Â°C ${city}`;
    } catch(e){
      el.textContent = "Weather unavailable";
    }
  }, () => {
    el.textContent = "Enable location for weather";
  });
}

updateWeatherUI();
updateButtonState();
</script>
</body>
</html>
