<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metal Workout Builder</title>

<style>
:root {
  --bg: #ffffff;
  --ink: #0f172a;
  --sub: #64748b;
  --card: #f1f5f9;
  --brand: #2345f5;
}

/* =======================
   GENERAL
======================= */
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--ink);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro", system-ui, sans-serif;
}

/* Weather + Welcome */
.header {
  padding: 20px;
  max-width: 480px;
  margin: auto;
}
.weather {
  font-size: 16px;
  color: var(--sub);
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
}
h1 {
  font-size: 32px;
  margin: 0 0 20px;
}

/* =======================
   CENTERED COUNTDOWN
======================= */
.center-vertical {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -40%);
  width: 100%;
  max-width: 480px;
  text-align: center;
  padding: 20px;
  pointer-events: none;
}

#closedMessage {
  font-size: 16px;
  color: var(--sub);
  display: none;
  margin-bottom: 20px;
}

#countdownWrap {
  display: none;
}

/* Countdown grid */
#countdownGrid {
  display: flex;
  justify-content: center;
  gap: 50px;
  margin-top: 10px;
}

.col {
  text-align: center;
}

.num {
  font-size: 44px;
  letter-spacing: 2px;
  font-weight: 400; /* <-- NOT BOLD */
}

.label {
  margin-top: 10px;
  font-size: 15px;
  color: var(--sub);
}

/* =======================
   WORKOUT BLOCKS
======================= */
#workout {
  padding: 20px;
  max-width: 480px;
  margin: 140px auto 100px;
}
.block {
  background: var(--card);
  padding: 24px;
  border-radius: 20px;
  margin-bottom: 24px;
}
.block-title {
  font-size: 22px;
  font-weight: 700;
}

/* =======================
   BUTTON
======================= */
#createBtn {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  height: 60px;
  background: var(--brand);
  color: white;
  border-radius: 40px;
  border: none;
  font-size: 20px;
  font-weight: 600;
  display: flex;
  justify-content: center;
  align-items: center;
}
</style>
</head>
<body>

<!-- HEADER CONTENT -->
<div class="header">
  <div id="weather" class="weather">Enable location for weather</div>
  <h1>Hi Jy, welcome back</h1>
</div>

<!-- CENTERED COUNTDOWN -->
<div class="center-vertical">
  <div id="closedMessage">Workout will open in</div>

  <div id="countdownWrap">
    <div id="countdownGrid">
      <div class="col">
        <div id="cc-hours" class="num">00</div>
        <div class="label">HOURS</div>
      </div>

      <div class="col">
        <div id="cc-mins" class="num">00</div>
        <div class="label">MINS</div>
      </div>

      <div class="col">
        <div id="cc-secs" class="num">00</div>
        <div class="label">SECS</div>
      </div>
    </div>
  </div>
</div>

<!-- WORKOUT AREA -->
<div id="workout"></div>

<!-- BUTTON -->
<button id="createBtn">Create Workout</button>

<script>
/* -----------------------------------------
   SETTINGS
----------------------------------------- */
const DEV_MODE = false;
const OPEN_HOUR = 17;
const OPEN_MIN = 30;

const metalTypes = ["Tabata", "AMRAP", "EMOM", "Ladder", "Metacon"];
const chance = p => Math.random() < p;
const now = () => new Date();

/* -----------------------------------------
   WEATHER LOGIC
----------------------------------------- */
function weatherCodeToText(code){
  if(code===0) return "Clear";
  if([1,2,3].includes(code)) return "Partly cloudy";
  if([45,48].includes(code)) return "Fog";
  if([51,53,55].includes(code)) return "Drizzle";
  if([61,63,65].includes(code)) return "Rain";
  if([66,67].includes(code)) return "Freezing rain";
  if([71,73,75].includes(code)) return "Snow";
  if(code===95) return "Thunderstorm";
  return "Weather";
}
function weatherEmoji(t){
  return {
    "Clear":"â˜€ï¸",
    "Partly cloudy":"â›…ï¸",
    "Fog":"ðŸŒ«ï¸",
    "Drizzle":"ðŸŒ¦ï¸",
    "Rain":"ðŸŒ§ï¸",
    "Freezing rain":"ðŸ§ŠðŸŒ§ï¸",
    "Snow":"â„ï¸",
    "Thunderstorm":"â›ˆï¸"
  }[t] || "ðŸŒ¡ï¸";
}

async function updateWeather(){
  const el = document.getElementById("weather");
  if(!navigator.geolocation){
    el.textContent = "Enable location for weather";
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      let lat = pos.coords.latitude;
      let lon = pos.coords.longitude;

      let w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
      let j = await w.json();

      let temp = j.current_weather.temperature;
      let cond = weatherCodeToText(j.current_weather.weathercode);
      let emoji = weatherEmoji(cond);

      let r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      let jr = await r.json();
      let city = jr.address.city || jr.address.town || jr.address.village || "Your area";

      el.textContent = `${emoji} ${temp}Â°C ${city}`;
    }catch(e){
      el.textContent = "Weather unavailable";
    }
  },()=>{
    el.textContent = "Enable location for weather";
  });
}

/* -----------------------------------------
   STORAGE
----------------------------------------- */
function saveWorkout(w){ localStorage.setItem("workout", JSON.stringify(w)); }
function loadWorkout(){ let w = localStorage.getItem("workout"); return w ? JSON.parse(w) : null; }
function clearWorkout(){ localStorage.removeItem("workout"); }

/* Reset nightly */
setInterval(()=>{
  let t = now();
  if(t.getHours() === 0 && t.getMinutes() < 2) clearWorkout();
}, 60000);

/* -----------------------------------------
   OPEN WINDOW CHECK
----------------------------------------- */
function isOpenWindow(){
  if(DEV_MODE) return true;
  const t = now();
  const start = new Date();
  start.setHours(OPEN_HOUR, OPEN_MIN, 0, 0);
  return t >= start;
}

/* -----------------------------------------
   COUNTDOWN UPDATE
----------------------------------------- */
function updateCountdown(){
  const wrap = document.getElementById("countdownWrap");
  const msg = document.getElementById("closedMessage");

  if(DEV_MODE || isOpenWindow()){
    wrap.style.display = "none";
    msg.style.display = "none";
    return;
  }

  wrap.style.display = "block";
  msg.style.display = "block";

  let t = now();
  let target = new Date();
  target.setHours(OPEN_HOUR, OPEN_MIN, 0, 0);
  if(t > target) target.setDate(target.getDate() + 1);

  let diff = target - t;
  let sec = Math.floor(diff/1000);
  let hr = Math.floor(sec/3600); sec %= 3600;
  let mn = Math.floor(sec/60); sec %= 60;

  const pad = n => n < 10 ? "0"+n : n;

  document.getElementById("cc-hours").textContent = pad(hr);
  document.getElementById("cc-mins").textContent  = pad(mn);
  document.getElementById("cc-secs").textContent  = pad(sec);
}

/* -----------------------------------------
   METAL SELECTOR
----------------------------------------- */
function generateMetalTypes(count){
  let pool = [...metalTypes];
  let out = [];
  for(let i=0;i<count;i++){
    out.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]);
  }
  return out;
}

/* -----------------------------------------
   WORKOUT GENERATION
----------------------------------------- */
function generateWorkout(){
  let workout = { blocks: [] };

  // Full body or split
  if(chance(0.5)){
    let count = chance(0.5) ? 2 : 3;
    workout.blocks = [{
      title: "ðŸ”¥ Full Body",
      abs: false,
      types: generateMetalTypes(count)
    }];
  } else {
    // Enforce only one side can have 2 metals
    let upperCount, lowerCount;

    if(chance(0.33)){
      upperCount = 1; lowerCount = 1;
    } else {
      if(chance(0.5)){ upperCount = 2; lowerCount = 1; }
      else { upperCount = 1; lowerCount = 2; }
    }

    workout.blocks.push({
      title:"ðŸ’ª Upper Body",
      abs:chance(0.5),
      types:generateMetalTypes(upperCount)
    });

    workout.blocks.push({
      title:"ðŸ¦µ Lower Body",
      abs:chance(0.5),
      types:generateMetalTypes(lowerCount)
    });
  }

  saveWorkout(workout);
  renderWorkout(workout);
}

/* -----------------------------------------
   RENDER WORKOUT
----------------------------------------- */
function renderWorkout(w){
  const wrap = document.getElementById("workout");

  if(!isOpenWindow() && !DEV_MODE){
    wrap.innerHTML = "";
    return;
  }

  wrap.innerHTML = "";

  w.blocks.forEach(b=>{
    let div = document.createElement("div");
    div.className = "block";

    let t = document.createElement("div");
    t.className = "block-title";
    t.textContent = b.title + (b.abs ? " + Abs" : "");
    div.appendChild(t);

    b.types.forEach(type=>{
      let p = document.createElement("div");
      p.style.fontSize = "18px";
      p.style.marginTop = "10px";
      p.textContent = type;
      div.appendChild(p);
    });

    wrap.appendChild(div);
  });
}

/* -----------------------------------------
   BUTTON STATE
----------------------------------------- */
function updateButtonState(){
  const btn = document.getElementById("createBtn");
  const saved = loadWorkout();

  if(DEV_MODE){
    btn.style.display = "flex";
    btn.disabled = false;
    btn.textContent = "Create Workout (DEV)";
    return;
  }

  if(!isOpenWindow()){
    btn.style.display = "none";
    return;
  }

  if(saved){
    btn.style.display = "none";
  } else {
    btn.style.display = "flex";
    btn.disabled = false;
  }
}

/* -----------------------------------------
   INIT
----------------------------------------- */
document.getElementById("createBtn").onclick = ()=>{
  generateWorkout();
  updateButtonState();
};

let saved = loadWorkout();
if(saved) renderWorkout(saved);

updateWeather();
updateButtonState();
updateCountdown();
setInterval(updateCountdown, 1000);
</script>

</body>
</html>
