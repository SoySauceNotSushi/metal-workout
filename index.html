<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout Builder</title>

<style>
  :root {
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#ffffff;
    --card:#f8f9fb;
    --pill:#e8eeff;
  }

  body {
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro",Segoe UI,Roboto,sans-serif;
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--ink);
  }

  .container {
    padding:24px;
    max-width:480px;
    margin:auto;
  }

  .weather {
    font-size:15px;
    color:var(--sub);
    margin-bottom:14px;
  }

  h1 {
    font-size:28px;
    font-weight:700;
    margin:0 0 6px;
  }

  h2 {
    font-size:16px;
    color:var(--sub);
    margin:0 0 18px;
  }

  /* Minimal radio row ------------------------------------------- */
  .radio-row {
    display:flex;
    flex-wrap:nowrap;
    gap:16px;
    margin-bottom:20px;
  }

  .radio-option {
    display:flex;
    align-items:center;
    gap:6px;
    font-size:14px;
    cursor:pointer;
    user-select:none;
    transition:0.2s ease;
    color:var(--ink);
  }

  .radio-option input {
    appearance:none;
    width:18px;
    height:18px;
    border-radius:50%;
    border:2px solid #b7bfca;
    position:relative;
    background:#fff;
  }

  .radio-option input:checked {
    border-color:var(--brand);
  }

  .radio-option input:checked::after {
    content:"";
    position:absolute;
    inset:4px;
    border-radius:50%;
    background:var(--brand);
  }

  /* override default disabled grey */
  .radio-option input:disabled {
    border-color:#b7bfca;
    background:#fff;
    opacity:1;
  }

  .radio-option.active {
    color:var(--brand);
    font-weight:600;
  }

  .radio-option.disabled {
    opacity:0.4;
    cursor:not-allowed;
  }

  /* AI gradient -------------------------------------------------- */
  .ai-stage {
    position:relative;
    height:160px;
    margin:12px 0 18px;
    display:none;
    border-radius:100%;
  }

  .ai-stage::before {
    content:"";
    position:absolute;
    inset:-20% -15% -25% -15%;
    filter:blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    transition:opacity .25s ease;
    animation:meshBreath 2s ease-in-out infinite, meshDrift 3s ease-in-out infinite;
  }

  .ai-stage.show::before { opacity:.9; }

  @keyframes meshBreath {
    0%,100% { transform:scale(1); opacity:.7 }
    50% { transform:scale(1.05); opacity:.3 }
  }

  @keyframes meshDrift {
    0% { transform:translate3d(0,0,0); }
    50% { transform:translate3d(2%,-1.5%,0); }
    100% { transform:translate3d(0,0,0); }
  }

  /* Workout card ------------------------------------------------- */
  .workout-card {
    background:var(--card);
    border-radius:16px;
    padding:20px;
  }

  .section-title {
    font-size:20px;
    font-weight:700;
    margin-bottom:6px;
  }

  .type-line {
    font-size:16px;
    margin-bottom:6px;
    display:flex;
    gap:8px;
    align-items:center;
  }

  .pill {
    background:var(--pill);
    color:var(--brand);
    padding:2px 8px;
    border-radius:10px;
    font-size:12px;
    font-weight:600;
  }

  /* Button ------------------------------------------------------- */
  .create-btn {
    position:fixed;
    bottom:24px;
    left:50%;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    height:56px;
    background:var(--brand);
    color:#fff;
    border:none;
    border-radius:28px;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
  }

  .create-btn:disabled { opacity:0.6; cursor:default; }
</style>
</head>
<body>
<div class="container">
  <div id="weather" class="weather">Enable location for weather</div>

  <h1>Welcome back Jy</h1>
  <h2>What would you like to train?</h2>

  <div class="radio-row">
    <label class="radio-option" id="optPull">
      <input type="radio" name="mode" value="pull"> Pull
    </label>
    <label class="radio-option" id="optPush">
      <input type="radio" name="mode" value="push"> Push
    </label>
    <label class="radio-option" id="optLegs">
      <input type="radio" name="mode" value="legs"> Legs
    </label>
    <label class="radio-option" id="optFull">
      <input type="radio" name="mode" value="full"> Full body
    </label>
  </div>

  <div id="aiStage" class="ai-stage"></div>

  <div id="output" style="display:none;">
    <div id="workoutCard" class="workout-card"></div>
  </div>
</div>

<button id="create" class="create-btn">Create Workout</button>

<script>
const qs = s => document.querySelector(s);
const metals = ["Metacon","EMOM","Ladder","AMRAP","Tabata"];
const DEV = new URLSearchParams(location.search).get("dev") === "true";

const radioMap = {
  pull: qs("#optPull"),
  push: qs("#optPush"),
  legs: qs("#optLegs"),
  full: qs("#optFull")
};
const createBtn = qs("#create");
const aiStage = qs("#aiStage");
const output = qs("#output");
const card = qs("#workoutCard");

/* ---------- WEEKLY LOCKS ---------- */
function getWeekKey(){
  const d=new Date();
  const start=new Date(d.getFullYear(),0,1);
  const days=Math.floor((d-start)/86400000);
  const week=Math.ceil((d.getDay()+1+days)/7);
  return `${d.getFullYear()}-W${week}`;
}

function loadLocks(){ return JSON.parse(localStorage.getItem("locks")||"{}"); }
function saveLocks(locks){ localStorage.setItem("locks",JSON.stringify(locks)); }

(function resetIfNewWeek(){
  const nowKey=getWeekKey();
  const prev=localStorage.getItem("weekKey");
  if(prev!==nowKey){
    localStorage.setItem("weekKey",nowKey);
    saveLocks({});
  }
})();

/* ---------- RADIO UI ---------- */
function refreshRadios(){
  const locks = loadLocks();
  Object.entries(radioMap).forEach(([mode,label])=>{
    const input = label.querySelector("input");
    label.classList.remove("active","disabled");
    input.disabled = false;

    if(locks[mode] && !DEV){
      input.checked = true;
      input.disabled = true;
      label.classList.add("active","disabled");
      return;
    }
    if(input.checked){
      label.classList.add("active");
    }
  });
  updateButtonState();
}

function anyUnlockedMode(){
  if(DEV) return true;
  const locks = loadLocks();
  return Object.keys(radioMap).some(m=>!locks[m]);
}

function updateButtonState(){
  // if button already hidden because workout was generated this session,
  // don't bring it back
  if(!DEV && createBtn.style.display === "none") return;

  if(!anyUnlockedMode() && !DEV){
    createBtn.style.display = "none";
    return;
  } else {
    createBtn.style.display = "block";
  }

  const sel = document.querySelector("input[name='mode']:checked");
  createBtn.disabled = !sel;
  createBtn.textContent = DEV ? "Create Workout (DEV)" : "Create Workout";
}

document.querySelectorAll("input[name='mode']").forEach(inp=>{
  inp.addEventListener("change",refreshRadios);
});

refreshRadios(); // initial
createBtn.disabled = true;

/* ---------- WORKOUT GENERATION ---------- */
function maybeAbs(){ return Math.random()<0.5; }
function maybeWeighted(){ return Math.random()<0.2; }

function metalLine(){
  let label = metals[Math.floor(Math.random()*metals.length)];
  if(maybeAbs()) label += " + Abs";
  const weighted = maybeWeighted();
  return `<div class="type-line">${label}${weighted?` <span class="pill">Weighted</span>`:""}</div>`;
}

function buildWorkout(mode){
  let html = "";

  if(mode==="pull"){
    html += `<div class="section-title">Pull Day</div>`;
    html += `<div class="type-line">Strength <span class="pill">Weighted</span></div>`;
    html += metalLine();
    html += metalLine();
  }
  else if(mode==="push"){
    html += `<div class="section-title">Push Day</div>`;
    html += `<div class="type-line">Strength <span class="pill">Weighted</span></div>`;
    html += metalLine();
    html += metalLine();
  }
  else if(mode==="legs"){
    html += `<div class="section-title">Legs Day</div>`;
    const count = Math.random()<0.5?2:3;
    for(let i=0;i<count;i++) html += metalLine();
  }
  else if(mode==="full"){
    html += `<div class="section-title">Full Body Day</div>`;
    const heavy = Math.random() < 0.5;
    if(heavy){
      html += `<div class="type-line">Push Strength <span class="pill">Weighted</span></div>`;
      html += `<div class="type-line">Pull Strength <span class="pill">Weighted</span></div>`;
    }
    // always at least one metal
    html += metalLine();
    if(!heavy){
      // if no heavies, total 3 metals
      html += metalLine();
      html += metalLine();
    }
  }

  card.innerHTML = html;
}

/* ---------- BUTTON & FLOW ---------- */
createBtn.addEventListener("click",()=>{
  const sel = document.querySelector("input[name='mode']:checked");
  if(!sel) return;
  const mode = sel.value;

  // show gradient
  output.style.display = "none";
  aiStage.style.display = "block";
  aiStage.classList.add("show");
  createBtn.disabled = true;

  setTimeout(()=>{
    buildWorkout(mode);
    aiStage.classList.remove("show");
    aiStage.style.display = "none";
    output.style.display = "block";

    if(!DEV){
      const locks = loadLocks();
      locks[mode] = true;
      saveLocks(locks);
      // hide button for rest of this session
      createBtn.style.display = "none";
    }

    refreshRadios();
    if(DEV){
      // in dev keep button usable
      createBtn.disabled = false;
    }
  },900);
});

/* ---------- WEATHER (simple) ---------- */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(async pos=>{
    try{
      const {latitude:lat,longitude:lon}=pos.coords;
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
      const data = await res.json();
      const temp = Math.round(data.current_weather.temperature);
      qs("#weather").textContent = `${temp}Â°C`;
    }catch{
      qs("#weather").textContent = "Weather unavailable";
    }
  },()=>qs("#weather").textContent="Enable location for weather");
}
</script>
</body>
</html>
