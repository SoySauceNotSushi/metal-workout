<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<style>
/* ============================================
   ROOT VARIABLES
============================================ */
:root{
  --brand:#2453f5;
  --ink:#0f172a;
  --sub:#64748b;
  --bg:#ffffff;
  --card:#f8fafc;

  --pill-blue:#e4ecff;
  --pill-green:#d9fbe3;
  --pill-orange:#ffe6bf;
  --pill-red:#ffe0e0;

  --fire:#f97316; /* fire orange */

  --shadow-soft:0 18px 48px rgba(15,23,42,0.16);
  --shadow-subtle:0 8px 18px rgba(15,23,42,0.12);
}

*{ box-sizing:border-box; }

body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
  -webkit-font-smoothing:antialiased;
}

.container{
  max-width:480px;
  margin:0 auto;
  padding:24px;
  padding-bottom:120px;
}

/* ============================================
   HEADER â€” WEATHER + STREAK
============================================ */
.header-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}

.weather{
  font-size:15px;
  color:var(--sub);
  opacity:.95;
  display:flex;
  align-items:center;
  gap:6px;
}

.streak-wrap{
  display:flex;
  align-items:center;
  gap:10px;
}

.streak-bar{
  width:50px;
  height:8px;
  background:#f7f8f9;
  border-radius:6px;
  overflow:hidden;
  position:relative;
}
.streak-bar-fill{
  position:absolute;
  left:0;
  top:0;
  height:100%;
  width:0%;
  background:var(--fire);
  transition:width .35s ease;
}

.streak-badge{
  font-size:16px;
  font-weight:600;
  color:var(--ink);
  opacity:.85;
}

/* ============================================
   SUBTITLE ANIMATION
============================================ */
#subtitle{
  font-size:17px;
  font-weight:400;
  color:var(--sub);
  margin:0 0 18px;
  position:relative;
  display:inline-block;
  overflow:hidden;
}
.subtitle-enter{
  opacity:0;
  transform:translateY(10px);
}
.subtitle-enter-active{
  opacity:1;
  transform:translateY(0);
  transition:opacity .32s ease, transform .32s cubic-bezier(.18,.84,.32,1.12);
}
.subtitle-exit{
  opacity:1;
  transform:translateY(0);
}
.subtitle-exit-active{
  opacity:0;
  transform:translateY(-10px);
  transition:opacity .32s ease, transform .32s cubic-bezier(.18,.84,.32,1.12);
}

/* ============================================
   RADIO BUTTONS
============================================ */
#radioRow{
  display:flex;
  gap:22px;
  margin:0 0 6px;
  justify-content:flex-start;
}
.opt{
  position:relative;
  display:flex;
  align-items:center;
  gap:6px;
  font-size:14px;
  color:var(--ink);
  padding:6px 12px;
  border-radius:999px;
  transition:background .2s ease, color .2s ease, transform .16s ease, box-shadow .16s ease;
}
.opt input{
  appearance:none;
  position:absolute;
  width:0;
  height:0;
  opacity:0;
}
.opt.disabled{
  opacity:.35;
  pointer-events:none;
}
.opt.active{
  color:var(--brand);
  font-weight:600;
  background:#e4ecff80;
  box-shadow:0 0 0 1px #e4ecff;
}
.opt:active:not(.disabled){
  transform:scale(.97);
}

/* ============================================
   PREVIEW CARD (WIREFRAME)
============================================ */
.preview-card{
  position:relative;
  width:100%;
  max-width:420px;
  margin:32px auto 24px;
  border-radius:18px;
  background:#ffffff;
  box-shadow:var(--shadow-soft);
  padding:18px 20px;
  opacity:0;
  transform:translateY(26px) scale(.96) rotateX(5deg);
  transition:opacity .32s ease, transform .32s cubic-bezier(.18,.84,.32,1.12);
  pointer-events:none;
}
.preview-card.show{
  opacity:1;
  transform:translateY(0) scale(1);
}
.preview-card.hidden{
  display:none;
}

.preview-title{
  font-size:18px;
  font-weight:700;
  margin-bottom:14px;
}

.preview-lines{
  display:flex;
  flex-direction:column;
  gap:14px;
}

.preview-row{
  display:flex;
  align-items:center;
  gap:8px;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .25s ease, transform .25s ease;
}
.preview-row.show-row{
  opacity:1;
  transform:translateY(0);
}

/* Wireframe shimmer */
.preview-wire{
  position:relative;
  height:12px;
  width:32%;
  min-width:90px;
  border-radius:6px;
  background:#f2f3f5;
  overflow:hidden;
}
.preview-wire::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(120deg,
    rgba(255,255,255,0),
    rgba(255,255,255,.8),
    rgba(255,255,255,0));
  transform:translateX(-100%);
  animation:wireShimmer 1.7s linear infinite;
}
@keyframes wireShimmer{
  0%{ transform:translateX(-100%); }
  100%{ transform:translateX(100%); }
}

/* Preview tags */
.preview-tag{
  padding:4px 10px;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
  white-space:nowrap;
  box-shadow:0 0 0 1px rgba(15,23,42,0.04);
}
.preview-tag-weighted{ background:var(--pill-blue); color:var(--brand); }
.preview-tag-abs{ background:var(--pill-green); color:#22c55e; }
.preview-tag-shoulders{ background:#ede9fe; color:#7c3aed; }
.preview-tag-biceps{ background:var(--pill-orange); color:#d97706; }
.preview-tag-kettlebell{ background:var(--pill-red); color:#e11d48; }

/* ============================================
   AI MESH LOADING
============================================ */
.ai-stage{
  position:absolute;
  left:50%;
  top:260px;
  transform:translateX(-50%);
  width:260px;
  height:260px;
  border-radius:50%;
  display:none;
}
.ai-stage::before{
  content:"";
  position:absolute;
  inset:-20% -15% -25% -15%;
  filter:blur(84px) saturate(160%) contrast(115%);
  opacity:0;
  transition:opacity .25s ease;
  background:
    radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
    radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
    radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
    radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
  background-blend-mode:screen;
  animation:meshBreath 2s ease-in-out infinite, meshDrift 3s ease-in-out infinite;
}
.ai-stage.show::before{ opacity:.9; }

@keyframes meshBreath{
  0%,100%{ transform:scale(1); opacity:.7 }
  50%{ transform:scale(1.04); opacity:.35 }
}
@keyframes meshDrift{
  0%{ transform:translate3d(0,0,0); }
  50%{ transform:translate3d(2%,-1.5%,0); }
  100%{ transform:translate3d(0,0,0); }
}

/* ============================================
   TODAY WORKOUT CARD
============================================ */
#card{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  margin-top:4px;
  display:none;
  opacity:0;
  transform:translateY(12px) scale(.98);
  box-shadow:var(--shadow-subtle);
  transition:opacity .3s ease, transform .3s cubic-bezier(.18,.84,.32,1.12);
}
#card.visible{
  opacity:1;
  transform:translateY(0);
}

#lineTitle{
  font-size:20px;
  font-weight:700;
  margin-bottom:22px;
}

.line{
  font-size:16px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  opacity:0;
  transform:translateY(6px);
  transition:.25s ease;
}
.line.show-line{
  opacity:1;
  transform:translateY(0);
}

/* Pills */
.pill{ padding:3px 8px; border-radius:999px; font-size:12px; font-weight:600; }
.pill-weighted{ background:var(--pill-blue); color:var(--brand); }
.pill-abs{ background:var(--pill-green); color:#22c55e; }
.pill-shoulders{ background:#ede9fe; color:#7c3aed; }
.pill-biceps{ background:var(--pill-orange); color:#d97706; }
.pill-kettlebell{ background:var(--pill-red); color:#e11d48; }

/* ============================================
   PAST CARD (HISTORY)
============================================ */
#pastCard{
  background:var(--card);
  border-radius:16px;
  padding:18px 20px;
  margin-top:18px;
  display:none;
  opacity:0;
  transform:translateY(18px);
  box-shadow:var(--shadow-subtle);
  transition:.25s ease;
}
#pastCard.visible{
  opacity:1;
  transform:translateY(0);
}
.past-header{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  margin-bottom:18px;
}
#pastTitle{
  font-size:18px;
  font-weight:700;
}
#pastMeta{
  font-size:14px;
  color:var(--sub);
}
.past-line{
  font-size:16px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}

/* ============================================
   BIG TIMER
============================================ */
#bigTimer{
  position:fixed;
  top:calc(50% + 2rem);
  left:50%;
  transform:translate(-50%, -50%);
  display:flex;
  gap:1.5rem;
  opacity:0;
  transition:opacity .45s ease;
}
#bigTimer.show{ opacity:1; }
#bigTimer.hidden{ display:none; }
.t-col{ display:flex; flex-direction:column; align-items:center; }
.t-num{
  font-size:48px;
  font-weight:400;
  font-variant-numeric:tabular-nums;
}
.t-label{
  font-size:14px;
  color:var(--sub);
}

/* ============================================
   SLIDE TO COMPLETE
============================================ */
.slide-wrap{
  position:fixed;
  left:50%;
  bottom:24px;
  transform:translateX(-50%);
  width:calc(100% - 48px);
  max-width:480px;
}
.slide-wrap.hidden{ display:none; }

.slide-track{
  position:relative;
  height:56px;
  border-radius:999px;
  background:#f7f8f9;
  overflow:hidden;
  box-shadow:0 10px 22px rgba(15,23,42,0.15);
}
.slide-track.filled{
  background:linear-gradient(135deg,#2453f5,#4f8cff);
}

.slide-fill{
  position:absolute; left:0; top:0; height:100%; width:48px;
  background:linear-gradient(135deg,#2453f5,#4f8cff);
  border-radius:999px;
  pointer-events:none;
  transition:width .18s ease-out;
}

.slide-label{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  pointer-events:none;
  font-size:17px; font-weight:600;
}
.slide-label span{ color:var(--brand); opacity:.8; }

.slide-track.filled .slide-label span{ color:#fff; }

.slide-knob{
  position:absolute; top:50%; left:4px;
  width:48px; height:48px;
  background:#fff;
  border-radius:50%;
  display:flex; justify-content:center; align-items:center;
  transform:translate(0,-50%);
  box-shadow:0 8px 16px rgba(15,23,42,0.18);
}
.arrow{ font-size:20px; color:var(--brand); }

/* ============================================
   MAIN GENERATE BUTTON
============================================ */
#mainBtn{
  position:fixed;
  left:50%; bottom:24px;
  transform:translateX(-50%);
  width:calc(100% - 48px);
  max-width:480px;
  height:56px;
  border-radius:28px;
  background:var(--brand);
  color:#fff; font-size:18px; font-weight:600;
  border:none; cursor:pointer;
  box-shadow:0 15px 30px rgba(36,83,245,0.35);
}
#mainBtn.disabled{ opacity:.4; pointer-events:none; }
#mainBtn.hidden{ display:none; }

</style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="header-row">
    <div class="weather">Enable location for weather</div>

    <div class="streak-wrap">
      <div class="streak-bar">
        <div class="streak-bar-fill"></div>
      </div>
      <div class="streak-badge">ðŸ”¥ 0</div>
    </div>
  </div>

  <h1>Welcome back Jy</h1>
  <div id="subtitle">What would you like to train?</div>

  <!-- RADIO ROW -->
  <div id="radioRow">
    <label class="opt" data-mode="pull"><input type="radio" name="mode" value="pull">Pull</label>
    <label class="opt" data-mode="push"><input type="radio" name="mode" value="push">Push</label>
    <label class="opt" data-mode="legs"><input type="radio" name="mode" value="legs">Legs</label>
    <label class="opt" data-mode="full"><input type="radio" name="mode" value="full">Full</label>
  </div>

  <!-- PREVIEW -->
  <div id="previewCard" class="preview-card hidden">
    <div id="previewTitle" class="preview-title"></div>
    <div id="previewLines" class="preview-lines"></div>
  </div>

  <!-- AI LOADING -->
  <div id="aiStage" class="ai-stage"></div>

  <!-- TODAY CARD -->
  <div id="card">
    <div id="lineTitle"></div>
    <div id="lines"></div>
  </div>

  <!-- PAST CARD -->
  <div id="pastCard">
    <div class="past-header">
      <div id="pastTitle"></div>
      <div id="pastMeta"></div>
    </div>
    <div id="pastLines"></div>
  </div>

  <!-- TIMER -->
  <div id="bigTimer" class="hidden">
    <div class="t-col"><div id="tHours" class="t-num">00</div><div class="t-label">HOURS</div></div>
    <div class="t-col"><div id="tMins"  class="t-num">00</div><div class="t-label">MINS</div></div>
    <div class="t-col"><div id="tSecs"  class="t-num">00</div><div class="t-label">SECS</div></div>
  </div>

</div>

<button id="mainBtn" class="disabled">Generate</button>

<div id="slideWrap" class="slide-wrap hidden">
  <div class="slide-track">
    <div class="slide-fill"></div>
    <div class="slide-label"><span>Slide to complete</span></div>
    <div class="slide-knob"><span class="arrow">â†’</span></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* ======================================================
   CONFIG + UTIL
====================================================== */
const DEV = new URLSearchParams(location.search).get("dev")==="true";
const START_HOUR = 17;
const START_MIN  = 30;

const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
function weekKey(){
  const d=new Date();
  const onejan=new Date(d.getFullYear(),0,1);
  const diff=Math.floor((d-onejan)/86400000);
  const wk=Math.ceil((diff + onejan.getDay()+1)/7);
  return `${d.getFullYear()}-W${wk}`;
}
function getStartTime(tomorrow=false){
  const d=new Date();
  if(tomorrow) d.setDate(d.getDate()+1);
  d.setHours(START_HOUR,START_MIN,0,0);
  return d;
}
function afterStart(){
  if(DEV) return true;
  return new Date() >= getStartTime(false);
}

/* Weekdays */
const WEEKDAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

/* ======================================================
   DEV â€” NUCLEAR OVERRIDE
====================================================== */
if (DEV) {
  window.afterStart = () => true;
  window.anyUnlockedModes = () => true;
  window.loadLocks = () => ({});
  window.loadCompletedToday = () => null;
  window.loadWorkoutToday = () => null;
  window.saveLocks = () => {};
  window.saveCompletedToday = () => {};
  window.saveWorkoutToday = () => {};
  window.startBigTimer = () => {};
  window.stopCountdown = () => {};

  try {
    localStorage.removeItem("jy_locks");
    localStorage.removeItem("jy_workoutToday");
    localStorage.removeItem("jy_completedToday");
  }catch(e){}

  console.log("ðŸ”¥ DEV NUCLEAR MODE ACTIVE â€” all unlocked always");
}

/* ======================================================
   STORAGE
====================================================== */
function resetWeekIfNeeded(){
  const cur=weekKey();
  const prev=localStorage.getItem("jy_weekKey");

  if(cur!==prev){
    localStorage.setItem("jy_weekKey",cur);

    const hist = loadHistory();
    const entries = Object.keys(hist);

    const workoutsThisWeek = entries.length;
    let streak = loadStreak();

    if(workoutsThisWeek >= 3){
      streak++;
    } else {
      streak = 0;
    }

    saveStreak(streak);

    localStorage.removeItem("jy_locks");
    localStorage.removeItem("jy_completedToday");
    localStorage.removeItem("jy_workoutToday");
    localStorage.removeItem("jy_history_week");
  }
}

function loadStreak(){
  return Number(localStorage.getItem("jy_streak") || 0);
}
function saveStreak(n){
  localStorage.setItem("jy_streak",String(n));
}

function loadLocks(){
  try{ return JSON.parse(localStorage.getItem("jy_locks")||"{}"); }
  catch{ return {}; }
}
function saveLocks(obj){
  localStorage.setItem("jy_locks",JSON.stringify(obj));
}

function saveWorkoutToday(data){
  localStorage.setItem("jy_workoutToday",JSON.stringify({date:todayKey(),data}));
}
function loadWorkoutToday(){
  const raw=localStorage.getItem("jy_workoutToday");
  if(!raw) return null;
  try{
    const obj=JSON.parse(raw);
    if(obj.date===todayKey()) return obj.data;
  }catch{}
  return null;
}

function saveCompletedToday(mode){
  localStorage.setItem("jy_completedToday",JSON.stringify({date:todayKey(),mode}));
}
function loadCompletedToday(){
  const raw=localStorage.getItem("jy_completedToday");
  if(!raw) return null;
  try{
    const obj=JSON.parse(raw);
    if(obj.date===todayKey()) return obj;
  }catch{}
  return null;
}

function saveHistoryForMode(workout){
  const wk=weekKey();
  let data;
  try{ data=JSON.parse(localStorage.getItem("jy_history_week")||"{}"); }
  catch{ data={}; }

  if(!data || data.week!==wk){
    data={week:wk, entries:{}};
  }

  const d=new Date();
  const dayName=WEEKDAYS[d.getDay()];

  data.entries[workout.mode] = {
    mode:workout.mode,
    items:workout.items,
    dayName
  };
  localStorage.setItem("jy_history_week",JSON.stringify(data));
}
function loadHistory(){
  try{
    const raw=localStorage.getItem("jy_history_week");
    if(!raw) return {};
    const obj=JSON.parse(raw);
    if(obj.week!==weekKey()) return {};
    return obj.entries || {};
  }catch{return {}}
}

/* ======================================================
   DOM REFS
====================================================== */
const radioRow=qs("#radioRow");
const previewCard=qs("#previewCard");
const previewTitle=qs("#previewTitle");
const previewLines=qs("#previewLines");

const aiStage=qs("#aiStage");

const cardEl=qs("#card");
const lineTitleEl=qs("#lineTitle");
const linesEl=qs("#lines");

const pastCardEl=qs("#pastCard");
const pastTitleEl=qs("#pastTitle");
const pastMetaEl=qs("#pastMeta");
const pastLinesEl=qs("#pastLines");

const mainBtn=qs("#mainBtn");

const slideWrap=qs("#slideWrap");
const slideTrack=qs(".slide-track");
const slideFill=qs(".slide-fill");
const slideKnob=qs(".slide-knob");

const bigTimer=qs("#bigTimer");
const tH=qs("#tHours"); const tM=qs("#tMins"); const tS=qs("#tSecs");

const weatherEl=qs(".weather");
const subtitleEl=qs("#subtitle");

/* Streak UI */
const streakBadge=qs(".streak-badge");
const streakBarFill=qs(".streak-bar-fill");

/* ======================================================
   SUBTITLE ANIMATION
====================================================== */
function setSubtitle(txt){
  const old=subtitleEl.textContent;
  if(old===txt) return;

  subtitleEl.classList.remove("subtitle-enter","subtitle-enter-active");
  subtitleEl.classList.add("subtitle-exit");
  requestAnimationFrame(()=>subtitleEl.classList.add("subtitle-exit-active"));

  setTimeout(()=>{
    subtitleEl.textContent=txt;
    subtitleEl.classList.remove("subtitle-exit","subtitle-exit-active");
    subtitleEl.classList.add("subtitle-enter");
    requestAnimationFrame(()=>subtitleEl.classList.add("subtitle-enter-active"));
  },250);
}

/* ======================================================
   STREAK UI UPDATE
====================================================== */
function updateStreakUI(){
  const streak = loadStreak();

  streakBadge.textContent = `ðŸ”¥ ${streak}`;

  const hist = loadHistory();
  const count = Object.keys(hist).length;

  let pct = 0;
  if(count === 1) pct = 33;
  else if(count === 2) pct = 66;
  else if(count >= 3) pct = 100;

  streakBarFill.style.width = pct + "%";
}

/* ======================================================
   PREVIEW CARD
====================================================== */
function allowedPreviewTags(mode){
  if(mode==="pull"){
    return [
      {label:"Weighted", class:"preview-tag preview-tag-weighted"},
      {label:"Abs", class:"preview-tag preview-tag-abs"},
      {label:"Biceps", class:"preview-tag preview-tag-biceps"},
      null
    ];
  }
  if(mode==="push"){
    return [
      {label:"Weighted", class:"preview-tag preview-tag-weighted"},
      {label:"Abs", class:"preview-tag preview-tag-abs"},
      {label:"Shoulders", class:"preview-tag preview-tag-shoulders"},
      null
    ];
  }
  if(mode==="legs"){
    return [
      {label:"Weighted", class:"preview-tag preview-tag-weighted"},
      {label:"Abs", class:"preview-tag preview-tag-abs"},
      {label:"Kettlebell", class:"preview-tag preview-tag-kettlebell"},
      null
    ];
  }
  return [
    {label:"Weighted", class:"preview-tag preview-tag-weighted"},
    {label:"Abs", class:"preview-tag preview-tag-abs"},
    {label:"Kettlebell", class:"preview-tag preview-tag-kettlebell"},
    {label:"Shoulders", class:"preview-tag preview-tag-shoulders"},
    {label:"Biceps", class:"preview-tag preview-tag-biceps"},
    null
  ];
}

function randomPreviewRows(mode){
  const pool=allowedPreviewTags(mode).filter(x=>x!==null);
  const rows=[]; const used=new Set();
  const count=3;

  if(mode==="pull" || mode==="push"){
    rows.push({label:"Weighted", class:"preview-tag preview-tag-weighted"});
    used.add("Weighted");

    for(let i=1;i<count;i++){
      if(Math.random()<0.4){ rows.push(null); continue; }
      const rem=pool.filter(t=>!used.has(t.label));
      if(!rem.length){ rows.push(null); continue; }
      const pick=rem[Math.floor(Math.random()*rem.length)];
      used.add(pick.label);
      rows.push(pick);
    }
    return rows;
  }

  for(let i=0;i<count;i++){
    if(Math.random()<0.4){ rows.push(null); continue; }
    const rem=pool.filter(t=>!used.has(t.label));
    if(!rem.length){ rows.push(null); continue; }
    const pick=rem[Math.floor(Math.random()*rem.length)];
    used.add(pick.label);
    rows.push(pick);
  }
  return rows;
}

function renderPreviewCard(mode){
  previewTitle.textContent = {
    pull:"Pull Day",
    push:"Push Day",
    legs:"Legs Day",
    full:"Full Body Day"
  }[mode];

  previewLines.innerHTML="";
  const rows=randomPreviewRows(mode);

  rows.forEach((r,i)=>{
    const row=document.createElement("div");
    row.className="preview-row";

    const wire=document.createElement("div");
    wire.className="preview-wire";
    row.appendChild(wire);

    if(r){
      const tag=document.createElement("span");
      tag.className=r.class;
      tag.textContent=r.label;
      row.appendChild(tag);
    }else{
      const sp=document.createElement("span");
      sp.style.minWidth="40px";
      row.appendChild(sp);
    }

    previewLines.appendChild(row);
    setTimeout(()=>row.classList.add("show-row"),40*i+60);
  });
}

function showPreview(){ 
  previewCard.classList.remove("hidden");
  void previewCard.offsetWidth;
  previewCard.classList.add("show");
}
function hidePreview(immediate=false){
  if(immediate){
    previewCard.classList.remove("show");
    previewCard.classList.add("hidden");
  } else {
    previewCard.classList.remove("show");
    setTimeout(()=>previewCard.classList.add("hidden"),260);
  }
}

/* ======================================================
   WORKOUT GENERATION
====================================================== */
const METALS=["Metacon","EMOM","Ladder","AMRAP","Tabata"];
const rand = arr => arr[Math.floor(Math.random()*arr.length)];

function buildWorkout(mode){
  const items=[];
  let weightedUsed=false, absUsed=false, shouldersUsed=false,
      bicepsUsed=false, kettlebellUsed=false;

  if(mode==="push" || mode==="pull"){
    items.push({label:"Sets & Reps", weighted:true});
    weightedUsed=true;

    const m1={label:rand(METALS)};
    const m2={label:rand(METALS)};

    if(mode==="push" && Math.random()<0.5 && !shouldersUsed){
      m1.shoulders=true;
      shouldersUsed=true;
    }
    if(mode==="pull" && Math.random()<0.5 && !bicepsUsed){
      m1.biceps=true;
      bicepsUsed=true;
    }
    if(Math.random()<0.5 && !absUsed){
      m2.abs=true;
      absUsed=true;
    }
    if(Math.random()<0.5 && !m1.weighted) m1.weighted=true;
    else if(Math.random()<0.5 && !m2.weighted) m2.weighted=true;

    items.push(m1,m2);
  }

  else if(mode==="legs"){
    const count=Math.random()<0.5 ? 2 : 3;
    for(let i=0;i<count;i++){
      const m={label:rand(METALS)};
      if(Math.random()<0.5 && !kettlebellUsed){
        m.kettlebell=true; kettlebellUsed=true;
      } else if(Math.random()<0.5 && !weightedUsed){
        m.weighted=true; weightedUsed=true;
      }
      if(Math.random()<0.5 && !absUsed){
        m.abs=true; absUsed=true;
      }
      items.push(m);
    }
  }

  else if(mode==="full"){
    const count=Math.random()<0.5 ? 3 : 4;
    for(let i=0;i<count;i++){
      const m={label:rand(METALS)};
      if(!weightedUsed && Math.random()<0.5){
        m.weighted=true; weightedUsed=true;
      }
      if(!absUsed && Math.random()<0.5){
        m.abs=true; absUsed=true;
      }
      if(!shouldersUsed && Math.random()<0.3){
        m.shoulders=true; shouldersUsed=true;
      }
      if(!bicepsUsed && Math.random()<0.3){
        m.biceps=true; bicepsUsed=true;
      }
      if(!kettlebellUsed && Math.random()<0.3){
        m.kettlebell=true; kettlebellUsed=true;
      }
      items.push(m);
    }
  }

  return {mode, items};
}

/* ======================================================
   RENDER TODAY CARD
====================================================== */
function renderWorkoutCard(w){
  lineTitleEl.textContent = {
    pull:"Pull Day",
    push:"Push Day",
    legs:"Legs Day",
    full:"Full Body Day"
  }[w.mode];

  linesEl.innerHTML="";
  w.items.forEach((it,i)=>{
    const row=document.createElement("div");
    row.className="line";
    row.appendChild(document.createTextNode(it.label));

    if(it.weighted){
      let p=document.createElement("span");
      p.className="pill pill-weighted"; p.textContent="Weighted";
      row.appendChild(p);
    }
    if(it.abs){
      let p=document.createElement("span");
      p.className="pill pill-abs"; p.textContent="Abs";
      row.appendChild(p);
    }
    if(it.shoulders){
      let p=document.createElement("span");
      p.className="pill pill-shoulders"; p.textContent="Shoulders";
      row.appendChild(p);
    }
    if(it.biceps){
      let p=document.createElement("span");
      p.className="pill pill-biceps"; p.textContent="Biceps";
      row.appendChild(p);
    }
    if(it.kettlebell){
      let p=document.createElement("span");
      p.className="pill pill-kettlebell"; p.textContent="Kettlebell";
      row.appendChild(p);
    }

    linesEl.appendChild(row);
    setTimeout(()=>row.classList.add("show-line"),40*i+60);
  });

  cardEl.style.display="block";
  void cardEl.offsetWidth;
  cardEl.classList.add("visible");
}

/* ======================================================
   RENDER PAST CARD
====================================================== */
function renderPastCardForMode(mode){
  const hist=loadHistory();
  const data=hist[mode];
  if(!data){
    hidePastCard();
    return false;
  }

  pastTitleEl.textContent={
    pull:"Pull Day",
    push:"Push Day",
    legs:"Legs Day",
    full:"Full Body Day"
  }[data.mode];

  pastMetaEl.textContent=data.dayName || "";

  pastLinesEl.innerHTML="";
  (data.items||[]).forEach(it=>{
    const row=document.createElement("div");
    row.className="past-line";
    row.textContent=it.label;

    if(it.weighted){
      let p=document.createElement("span");
      p.className="pill pill-weighted"; p.textContent="Weighted";
      row.appendChild(p);
    }
    if(it.abs){
      let p=document.createElement("span");
      p.className="pill pill-abs"; p.textContent="Abs";
      row.appendChild(p);
    }
    if(it.shoulders){
      let p=document.createElement("span");
      p.className="pill pill-shoulders"; p.textContent="Shoulders";
      row.appendChild(p);
    }
    if(it.biceps){
      let p=document.createElement("span");
      p.className="pill pill-biceps"; p.textContent="Biceps";
      row.appendChild(p);
    }
    if(it.kettlebell){
      let p=document.createElement("span");
      p.className="pill pill-kettlebell"; p.textContent="Kettlebell";
      row.appendChild(p);
    }

    pastLinesEl.appendChild(row);
  });

  pastCardEl.style.display="block";
  void pastCardEl.offsetWidth;
  pastCardEl.classList.add("visible");

  bigTimer.classList.remove("show");
  setTimeout(()=>bigTimer.classList.add("hidden"),240);

  return true;
}
function hidePastCard(){
  pastCardEl.classList.remove("visible");
  setTimeout(()=>{
    pastCardEl.style.display="none";
    if(historyMode){
      bigTimer.classList.remove("hidden");
      requestAnimationFrame(()=>bigTimer.classList.add("show"));
    }
  },220);
}

/* ======================================================
   VIEW STATES
====================================================== */
function anyUnlockedModes(){
  const locks=loadLocks();
  return ["pull","push","legs","full"].some(m=>!locks[m]);
}

function applyLocksToRadios(){
  const locks=loadLocks();
  qsa(".opt").forEach(lbl=>{
    const mode=lbl.dataset.mode;
    const inp=lbl.querySelector("input");
    lbl.classList.remove("disabled");
    inp.disabled=false;
    if(locks[mode]){
      lbl.classList.add("disabled");
      inp.disabled=true;
    }
  });
}
function applyHistoryLocks(){
  const hist=loadHistory();
  qsa(".opt").forEach(lbl=>{
    const mode=lbl.dataset.mode;
    const inp=lbl.querySelector("input");
    const has=!!hist[mode];
    inp.disabled=!has;
    lbl.classList.toggle("disabled", !has);
  });
}
function clearRadios(){
  qsa(".opt").forEach(lbl=>{
    lbl.classList.remove("active");
    const inp=lbl.querySelector("input");
    if(inp) inp.checked=false;
  });
}

function showSelectionState(){
  historyMode=false;
  stopTimer();
  bigTimer.classList.add("hidden");

  setSubtitle("What would you like to train?");
  radioRow.style.display="flex";
  applyLocksToRadios();

  cardEl.style.display="none";
  pastCardEl.style.display="none";

  slideWrap.classList.add("hidden");
  mainBtn.classList.remove("hidden");
  mainBtn.classList.add("disabled");
  mainBtn.textContent="Generate";

  hidePreview(true);
}

function showPreLockedState(){
  historyMode=false;
  setSubtitle("Next workout in");

  radioRow.style.display="none";
  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");
  hidePreview(true);

  startTimer(getStartTime(false));
}

function showWorkoutState(workout){
  historyMode=false;
  stopTimer();
  bigTimer.classList.add("hidden");

  setSubtitle("Todayâ€™s workout");

  renderWorkoutCard(workout);

  radioRow.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.remove("hidden");

  hidePreview(true);
}

function showCompletedState(){
  historyMode=true;
  clearRadios();
  applyHistoryLocks();

  setSubtitle("Hereâ€™s what you trained this week");

  radioRow.style.display="flex";
  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");

  startTimer(getStartTime(true));
}

function showAllUsedState(){
  historyMode=false;
  setSubtitle("All workouts used this week");
  radioRow.style.display="none";
  cardEl.style.display="none";
  pastCardEl.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");
  bigTimer.classList.add("hidden");
}

/* ======================================================
   TIMER
====================================================== */
let timerInt=null;

function stopTimer(){
  if(timerInt){
    clearInterval(timerInt);
    timerInt=null;
  }
}

function startTimer(target){
  stopTimer();
  bigTimer.classList.remove("hidden");
  requestAnimationFrame(()=>bigTimer.classList.add("show"));

  function tick(){
    const now=new Date();
    let diff=target-now;
    if(diff<=0){
      stopTimer();
      bigTimer.classList.remove("show");
      setTimeout(()=>{
        bigTimer.classList.add("hidden");
        initUI();
      },300);
      return;
    }
    const sec=Math.floor(diff/1000);
    const h=String(Math.floor(sec/3600)).padStart(2,"0");
    const m=String(Math.floor((sec%3600)/60)).padStart(2,"0");
    const s=String(sec%60).padStart(2,"0");
    tH.textContent=h; tM.textContent=m; tS.textContent=s;
  }
  tick();
  timerInt=setInterval(tick,1000);
}

/* ======================================================
   GENERATE
====================================================== */
let selectedMode=null;
let currentWorkout=null;
let historyMode=false;

function generateWorkout(){
  if(!selectedMode) return;

  hidePreview();

  aiStage.style.display="block";
  aiStage.classList.add("show");

  mainBtn.textContent="Generating...";
  mainBtn.disabled=true;

  setTimeout(()=>{
    const workout=buildWorkout(selectedMode);
    currentWorkout=workout;

    saveWorkoutToday(workout);

    const locks=loadLocks();
    locks[selectedMode]=true;
    saveLocks(locks);

    aiStage.classList.remove("show");
    aiStage.style.display="none";

    showWorkoutState(workout);
    mainBtn.disabled=false;

  },900);
}

mainBtn.addEventListener("click", generateWorkout);

/* ======================================================
   SLIDE COMPLETE â†’ CONFETTI
====================================================== */
function handleComplete(){
  if(window.confetti){
    confetti({
      particleCount:160,
      spread:90,
      startVelocity:35,
      origin:{x:0.5,y:1.05}
    });
  }
  if(navigator.vibrate) navigator.vibrate(15);

  saveCompletedToday(currentWorkout.mode);
  saveHistoryForMode(currentWorkout);

  cardEl.style.display="none";
  slideWrap.classList.add("hidden");

  setTimeout(()=> showCompletedState(),600);
}

/* SLIDER */
let sliding=false, startX=0, maxSlide=0;

slideKnob.addEventListener("pointerdown",e=>{
  e.preventDefault();
  sliding=true;
  slideKnob.setPointerCapture(e.pointerId);

  const trackRect=slideTrack.getBoundingClientRect();
  const knobRect=slideKnob.getBoundingClientRect();
  maxSlide=trackRect.width-knobRect.width-8;
  startX=e.clientX;
});

slideKnob.addEventListener("pointermove",e=>{
  if(!sliding) return;
  const dx=e.clientX-startX;
  let x=Math.max(0,Math.min(maxSlide,dx));
  slideKnob.style.transform=`translate(${x}px,-50%)`;
  slideFill.style.width=(x+48)+"px";

  if(x>(maxSlide*0.5)){
    slideTrack.classList.add("filled");
  } else {
    slideTrack.classList.remove("filled");
  }
});

slideKnob.addEventListener("pointerup",finishSlide);
slideKnob.addEventListener("pointercancel",finishSlide);

function finishSlide(e){
  if(!sliding) return;
  sliding=false;
  slideKnob.releasePointerCapture(e.pointerId);

  const match=/translate\(([-0-9.]+)px/.exec(slideKnob.style.transform);
  const x=match?parseFloat(match[1]):0;

  if(x>=maxSlide*0.9){
    slideKnob.style.transform=`translate(${maxSlide}px,-50%)`;
    slideFill.style.width=(maxSlide+48)+"px";
    slideTrack.classList.add("filled");
    handleComplete();
  } else {
    slideKnob.style.transform="translate(0,-50%)";
    slideFill.style.width="48px";
    slideTrack.classList.remove("filled");
  }
}

/* ======================================================
   WEATHER
====================================================== */
function weatherCodeText(code){
  const map={
    0:"Clear",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
    45:"Fog",48:"Fog",
    51:"Drizzle",53:"Drizzle",55:"Drizzle",
    61:"Rain",63:"Rain",65:"Rain",
    71:"Snow",73:"Snow",75:"Snow",
    80:"Rain shower",81:"Rain shower",82:"Rain shower",
    95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
  };
  return map[code]||"Unknown";
}
function weatherEmoji(cond){
  cond=cond.toLowerCase();
  if(cond.includes("clear")) return "â˜€ï¸";
  if(cond.includes("cloud")) return "â›…";
  if(cond.includes("rain")) return "ðŸŒ§ï¸";
  if(cond.includes("drizzle")) return "ðŸŒ¦ï¸";
  if(cond.includes("thunder")) return "ðŸŒ©ï¸";
  if(cond.includes("snow")) return "â„ï¸";
  if(cond.includes("fog")) return "ðŸŒ«ï¸";
  return "ðŸŒ¡ï¸";
}

function updateWeather(){
  if(!navigator.geolocation){
    weatherEl.textContent="Location unavailable";
    return;
  }
  weatherEl.textContent="Loadingâ€¦";

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;

    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const r=await fetch(url);
      const d=await r.json();
      const temp=Math.round(d.current_weather.temperature);
      const cond=weatherCodeText(d.current_weather.weathercode);
      const emoji=weatherEmoji(cond);

      let city="Your area";
      try{
        const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const rr=await rev.json();
        city = rr.address.city || rr.address.town || rr.address.village || rr.address.county || city;
      }catch{}

      weatherEl.textContent = `${emoji} ${temp}Â°C ${city}`;
    }catch{
      weatherEl.textContent="Weather unavailable";
    }

  },()=>weatherEl.textContent="Enable location");
}

/* ======================================================
   RADIO LOGIC
====================================================== */
qsa("input[name='mode']").forEach(r=>{
  r.addEventListener("change",()=>{
    selectedMode=r.value;

    qsa(".opt").forEach(lbl=>{
      lbl.classList.toggle("active", lbl.dataset.mode===selectedMode);
    });

    if(historyMode){
      renderPastCardForMode(selectedMode);
      return;
    }

    hidePastCard();
    mainBtn.textContent="Generate " + {
      pull:"Pull",
      push:"Push",
      legs:"Legs",
      full:"Full Body"
    }[selectedMode];

    mainBtn.classList.remove("disabled");

    renderPreviewCard(selectedMode);
    showPreview();
  });
});

/* CLICK OUTSIDE HISTORY CARD */
document.addEventListener("click",e=>{
  if(!historyMode) return;
  if(pastCardEl.style.display==="none") return;

  const insideCard=pastCardEl.contains(e.target);
  const insideRadio=radioRow.contains(e.target);
  if(!insideCard && !insideRadio){
    hidePastCard();
    clearRadios();
    selectedMode=null;
  }
});

/* ======================================================
   INIT
====================================================== */
function initUI(){
  resetWeekIfNeeded();
  updateStreakUI();

  clearRadios();
  selectedMode=null;

  hidePreview(true);
  hidePastCard();

  const workout=loadWorkoutToday();
  const completed=loadCompletedToday();
  const lockedByTime=!afterStart();

  if(!workout && !completed && lockedByTime){
    showPreLockedState();
    return;
  }
  if(completed){
    showCompletedState();
    return;
  }
  if(workout){
    showWorkoutState(workout);
    return;
  }
  if(!anyUnlockedModes()){
    showAllUsedState();
    return;
  }

  showSelectionState();
}

updateWeather();
initUI();
</script>

</body>
</html>
