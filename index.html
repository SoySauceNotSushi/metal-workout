<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<style>
  :root{
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;

    --bgTop:#ffffff;
    --bgBottom:#ffffff;

    --card:#ffffff;
    --shadow-soft:0 18px 48px rgba(15,23,42,0.12);

    /* 8 unique tag colors (soft, like your earlier good set) */
    --tag-purple-bg:#ede9fe; --tag-purple-ink:#6d28d9; /* upper */
    --tag-green-bg:#dcfce7;  --tag-green-ink:#16a34a;  /* pull */
    --tag-blue-bg:#e4ecff;   --tag-blue-ink:#2453f5;   /* push */
    --tag-pink-bg:#ffe4f1;   --tag-pink-ink:#be185d;   /* shoulders */
    --tag-orange-bg:#ffe6bf; --tag-orange-ink:#b45309; /* legs */
    --tag-teal-bg:#d1fae5;   --tag-teal-ink:#0f766e;   /* abs */
    --tag-red-bg:#ffe0e0;    --tag-red-ink:#dc2626;    /* fullbody */
    --tag-yellow-bg:#fef3c7; --tag-yellow-ink:#a16207; /* cardio */

    --streak-fill:#f97316;
    --streak-bg:#F7F8F9;

    --radius:18px;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
    color:var(--ink);
    -webkit-font-smoothing:antialiased;
    background:linear-gradient(180deg,var(--bgTop),var(--bgBottom));
    overflow:hidden; /* no vertical scroll */
  }

  .container{
    max-width:520px;
    margin:0 auto;
    padding:18px 18px 0;
    height:100vh;
    display:flex;
    flex-direction:column;
  }

  /* TOP ROW: optional weather + streak */
  .top-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-top:6px;
    margin-bottom:8px;
    min-height:22px;
  }
  .weather{
    font-size:14px;
    color:var(--sub);
    opacity:.9;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:55%;
  }

  .streak-wrap{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:10px;
    min-width:180px;
  }
  .streak-fire{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:14px;
    font-weight:600;
    color:var(--streak-fill);
  }
  .streak-count{
    min-width:14px;
    font-variant-numeric:tabular-nums;
  }
  .streak-bar{
    width:100px; /* per your request */
    height:8px;
    border-radius:999px;
    background:var(--streak-bg);
    overflow:hidden;
    position:relative;
  }
  .streak-bar-fill{
    position:absolute;
    inset:0;
    background:var(--streak-fill);
    transform-origin:left center;
    transform:scaleX(0);
    transition:transform .35s cubic-bezier(.22,.8,.4,1);
  }

  h1{
    margin:6px 0 6px;
    font-size:36px;       /* back to sane */
    font-weight:800;
    letter-spacing:-0.02em;
  }
  .subtitle{
    margin:0 0 14px;
    font-size:16px;
    color:var(--sub);
  }

  /* CENTER AREA */
  .center{
    position:relative;
    flex:1;
    display:flex;
    align-items:flex-start; /* keep card higher */
    justify-content:center;
    padding-top:18px;
  }

  /* BIG WEEKLY COUNT (engraved style) */
  .weekly-center{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
  }
  .weekly-center.hidden{ display:none; }
  .weekly-count{
    text-align:center;
    transform:translateY(-10px);
    opacity:.95;
  }
  .weekly-count .num{
    font-size:150px;
    font-weight:900;
    letter-spacing:-0.05em;
    color:rgba(15,23,42,0.08);
    text-shadow:
      0 1px 0 rgba(255,255,255,0.8),
      0 -1px 0 rgba(15,23,42,0.05);
    line-height:0.9;
  }
  .weekly-count .label{
    margin-top:10px;
    font-size:16px;
    font-weight:400;
    color:rgba(100,116,139,0.65);
    letter-spacing:-0.02em;
  }

  /* WORKOUT CARD */
  .card{
    width:min(460px, 100%);
    background:var(--card);
    border-radius:22px;
    box-shadow:var(--shadow-soft);
    padding:22px 22px;
    opacity:0;
    transform:translateY(18px) scale(.98);
    transition:opacity .28s ease, transform .28s cubic-bezier(.18,.84,.32,1.12);
    position:relative;
    z-index:3; /* above mesh */
  }
  .card.visible{
    opacity:1;
    transform:translateY(0) scale(1);
  }
  .card.hidden{ display:none; }

  .card-title{
    font-size:20px;
    font-weight:900;
    margin:0 0 18px;
    letter-spacing:-0.03em;
  }

  .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:10px 0;
    border-bottom:1px solid rgba(15,23,42,0.04);
  }
  .row:last-child{ border-bottom:none; }
  .row-left{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }
  .row-text{
    font-size:16px;
    font-weight:500;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .tags{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .pill{
    padding:6px 12px;
    border-radius:999px;
    font-size:14px;
    font-weight:500;
    line-height:1;
    white-space:nowrap;
  }

  /* tag colors */
  .pill-upper{ background:var(--tag-purple-bg); color:var(--tag-purple-ink); }
  .pill-pull{ background:var(--tag-green-bg); color:var(--tag-green-ink); }
  .pill-push{ background:var(--tag-blue-bg); color:var(--tag-blue-ink); }
  .pill-shoulders{ background:var(--tag-pink-bg); color:var(--tag-pink-ink); }
  .pill-legs{ background:var(--tag-orange-bg); color:var(--tag-orange-ink); }
  .pill-abs{ background:var(--tag-teal-bg); color:var(--tag-teal-ink); }
  .pill-fullbody{ background:var(--tag-red-bg); color:var(--tag-red-ink); }
  .pill-cardio{ background:var(--tag-yellow-bg); color:var(--tag-yellow-ink); }

  /* MESH GRADIENT (only while generating) */
  .ai-stage{
    position:absolute;
    left:50%;
    top:38%;
    transform:translate(-50%,-50%);
    width:260px;
    height:260px;
    border-radius:50%;
    pointer-events:none;
    display:none;
    z-index:1; /* behind card */
    overflow:visible;
  }
  .ai-stage::before{
    content:"";
    position:absolute;
    inset:-20% -15% -25% -15%;
    filter:blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    transition:opacity .25s ease;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    animation:meshBreath 2s ease-in-out infinite, meshDrift 3s ease-in-out infinite;
  }
  .ai-stage.show::before{ opacity:.9; }
  @keyframes meshBreath{
    0%,100%{ transform:scale(1); opacity:.65 }
    50%{ transform:scale(1.04); opacity:.35 }
  }
  @keyframes meshDrift{
    0%{ transform:translate3d(0,0,0); }
    50%{ transform:translate3d(2%,-1.5%,0); }
    100%{ transform:translate3d(0,0,0); }
  }

  /* ACTION BAR (fixed) */
  .actions{
    position:relative;
    padding:12px 0 18px;
    z-index:10; /* always above mesh/confetti */
  }
  .btn{
    width:100%;
    height:42px;
    border:none;
    border-radius:999px;
    font-size:16px;
    font-weight:500; /* back to normal */
    cursor:pointer;
    background:var(--brand);
    color:white;
    box-shadow:none; /* remove shadow per your request */
  }
  .btn.secondary{
    margin-top:12px;
    background:#eef2f7;
    color:var(--brand);
    font-weight:500;
  }
  .btn:active{ transform:scale(.99); }

  .btn.hidden{ display:none; }

  /* SLIDER */
  .slide-wrap{
    width:100%;
    height:42px;
    border-radius:999px;
    background:#eef2f7;
    position:relative;
    overflow:hidden;
    box-shadow:none; /* no shadow */
    display:none;
  }
  .slide-wrap.show{ display:block; }

  .slide-fill{
    position:absolute;
    inset:0;
    background:linear-gradient(135deg,#2453f5,#4f8cff);
    transform-origin:left center;
    transform:scaleX(0);
    transition:transform .12s linear;
  }

  /* Label trick: base grey text + white text clipped by fill */
  .slide-label{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    font-weight:500;
    letter-spacing:.2px;
    user-select:none;
    pointer-events:none;
  }
  .slide-label .base{ color:#64748b; }
  .slide-label .white{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    clip-path:inset(0 100% 0 0); /* reveal from left */
    transition:clip-path .12s linear;
  }

  .slide-knob{
    position:absolute;
    left:7px;
    top:50%;
    transform:translate(0,-50%);
    width:32px;
    height:32px;
    border-radius:50%;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 10px 22px rgba(15,23,42,0.14);
    touch-action:none;
  }
  .slide-knob span{
    font-size:16px;
    color:var(--brand);
    font-weight:500;
  }

  /* CONFETTI CANVAS (behind buttons) */
  #confettiCanvas{
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:6; /* below actions (10), above background */
  }

  /* MODAL (full screen height) */
  .modal{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.35);
    display:none;
    z-index:50;
  }
  .modal.show{ display:block; }
  .modal-sheet{
    position:absolute;
    inset:0;
    background:#fff;
    border-radius:0; /* full screen */
    display:flex;
    flex-direction:column;
  }
  .modal-head{
    padding:16px 18px 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(15,23,42,0.06);
  }
  .modal-title{
    font-size:18px;
    font-weight:800;
  }
  .modal-close{
    border:none;
    background:#eef2f7;
    color:var(--ink);
    border-radius:10px;
    height:38px;
    padding:0 14px;
    font-weight:700;
  }
  .tabs{
    display:flex;
    gap:10px;
    padding:10px 18px;
    border-bottom:1px solid rgba(15,23,42,0.06);
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  .tab{
    border:none;
    background:#eef2f7;
    color:#0f172a;
    padding:10px 14px;
    border-radius:999px;
    font-weight:800;
    white-space:nowrap;
  }
  .tab.active{
    background:#e4ecff;
    color:var(--brand);
  }

  /* content scroll area (fixed height because modal is full screen) */
  .modal-body{
    padding:14px 18px 18px;
    overflow:auto; /* scroll only inside modal */
    flex:1;
  }

  .add-row{
    display:grid;
    grid-template-columns: 1fr 140px;
    gap:12px;
    margin-bottom:14px;
  }
  .input{
    height:48px; /* bigger */
    border-radius:12px;
    border:1px solid rgba(15,23,42,0.12);
    padding:0 14px;
    font-size:16px;
  }
  .add-btn{
    height:48px; /* bigger */
    border-radius:12px;
    border:none;
    background:var(--brand);
    color:#fff;
    font-weight:800;
    font-size:16px;
  }

  .list{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .item{
    display:grid;
    grid-template-columns: 1fr 160px 44px;
    gap:10px;
    align-items:center;
    padding:10px;
    border-radius:14px;
    background:#f7f8f9;
  }
  .item .name{
    height:44px;
    border-radius:12px;
    border:1px solid rgba(15,23,42,0.10);
    padding:0 12px;
    font-size:16px;
    background:#fff;
  }
  .item .reps{
    height:44px;
    border-radius:12px;
    border:1px solid rgba(15,23,42,0.10);
    padding:0 12px;
    font-size:16px;
    background:#fff;
  }
  .trash{
    height:44px;
    width:44px;
    border:none;
    border-radius:12px;
    background:#ffe0e0;
    color:#dc2626;
    font-weight:900;
    font-size:18px;
  }
</style>
</head>

<body>
<canvas id="confettiCanvas"></canvas>

<div class="container">

  <div class="top-row">
    <div class="weather" id="weather"> </div>

    <div class="streak-wrap">
      <div class="streak-fire"><span>ðŸ”¥</span><span id="streakCount" class="streak-count">0</span></div>
      <div class="streak-bar"><div class="streak-bar-fill" id="streakFill"></div></div>
    </div>
  </div>

  <h1>Welcome back Jy</h1>
  <div class="subtitle">Today's mixed workout</div>

  <div class="center">
    <!-- mesh -->
    <div class="ai-stage" id="aiStage"></div>

    <!-- weekly count center -->
    <div class="weekly-center" id="weeklyCenter">
      <div class="weekly-count">
        <div class="num" id="weekNum">0</div>
        <div class="label" id="weekLabel">workouts completed this week</div>
      </div>
    </div>

    <!-- card -->
    <div class="card hidden" id="card">
      <div class="card-title" id="cardTitle"></div>
      <div id="cardRows"></div>
    </div>
  </div>

  <div class="actions">
    <button class="btn" id="generateBtn">Generate Workout</button>

    <button class="btn secondary" id="exerciseBtn">Exercises</button>

    <div class="slide-wrap" id="slideWrap" aria-label="Slide to Complete">
      <div class="slide-fill" id="slideFill"></div>
      <div class="slide-label">
        <div class="base">Slide to Complete</div>
        <div class="white" id="slideWhite">Slide to Complete</div>
      </div>
      <div class="slide-knob" id="slideKnob"><span>â†’</span></div>
    </div>
  </div>

</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-sheet">
    <div class="modal-head">
      <div class="modal-title">Exercises</div>
      <button class="modal-close" id="closeModal">Done</button>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="modal-body">
      <div class="add-row">
        <input class="input" id="addName" placeholder="Exercise name (e.g. Dips)" />
        <input class="input" id="addReps" placeholder="Reps (e.g. 10)" />
      </div>
      <button class="add-btn" id="addBtn">Add Exercise</button>

      <div style="height:12px"></div>

      <div class="list" id="list"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
/* =========================================================
   CONFIG
========================================================= */

const SHOW_WEATHER = true; // set false if you want it gone

const TAGS = [
  { key:"upper",     label:"upper",     pill:"pill-upper" },
  { key:"pull",      label:"pull",      pill:"pill-pull" },
  { key:"push",      label:"push",      pill:"pill-push" },
  { key:"shoulders", label:"shoulders", pill:"pill-shoulders" },
  { key:"legs",      label:"legs",      pill:"pill-legs" },
  { key:"abs",       label:"abs",       pill:"pill-abs" },
  { key:"fullbody",  label:"fullbody",  pill:"pill-fullbody" },
  { key:"cardio",    label:"cardio",    pill:"pill-cardio" },
];

const DEFAULT_LIBRARY = {
  upper: [
    { name:"Muscle-Up", reps:"1" }
  ],
  pull: [
    { name:"Pull-Ups", reps:"5" },
    { name:"Chin-Ups", reps:"5" },
    { name:"Australian Chin-Ups", reps:"10" }
  ],
  push: [
    { name:"Push-Ups", reps:"10" },
    { name:"Dips", reps:"10" },
    { name:"Decline Push-Ups", reps:"10" },
    { name:"Diamond Push-Ups", reps:"10" }
  ],
  shoulders: [
    { name:"Dolphin Push-Ups", reps:"10" },
    { name:"Pike Push-Ups", reps:"10" }
  ],
  legs: [
    { name:"Jumping Squats", reps:"15" },
    { name:"Jumping Lunges", reps:"15" }
  ],
  abs: [
    { name:"Knee Raises", reps:"20" },
    { name:"Full Body Raises", reps:"20" },
    { name:"Oblique Twists", reps:"10" }
  ],
  fullbody: [
    { name:"Burpees", reps:"10" },
    { name:"Kettlebell Swings", reps:"10" }
  ],
  cardio: [
    { name:"Jumping Jacks", reps:"20" },
    { name:"Mountain Climbers", reps:"20" }
  ],
};

/* Storage keys */
const LS = {
  library: "jy_library_v1",
  streak: "jy_streak_v1",
  weekKey: "jy_weekKey_v1",
  weekCount: "jy_weekCount_v1",     // number of completed workouts this week
  weekCounted: "jy_week_counted_v1" // whether streak increment already applied this week
};

/* =========================================================
   UTIL
========================================================= */
const qs  = s => document.querySelector(s);
const rand = arr => arr[Math.floor(Math.random()*arr.length)];
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function isoWeekKey(d=new Date()){
  // ISO-ish week key: YYYY-Wxx (good enough for weekly reset)
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch{ return fallback; }
}
function saveJSON(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

function ensureWeekState(){
  const current = isoWeekKey();
  const storedWeek = localStorage.getItem(LS.weekKey);

  if(!storedWeek){
    localStorage.setItem(LS.weekKey, current);
    localStorage.setItem(LS.weekCount, "0");
    localStorage.setItem(LS.weekCounted, "0");
    return;
  }

  if(storedWeek !== current){
    // week rolled over: if last week < 3 -> lose streak
    const lastCount = parseInt(localStorage.getItem(LS.weekCount)||"0",10);
    if(lastCount < 3){
      localStorage.setItem(LS.streak, "0");
    }
    // reset for new week
    localStorage.setItem(LS.weekKey, current);
    localStorage.setItem(LS.weekCount, "0");
    localStorage.setItem(LS.weekCounted, "0");
  }
}

/* =========================================================
   DOM
========================================================= */
const weatherEl   = qs("#weather");
const streakCount = qs("#streakCount");
const streakFill  = qs("#streakFill");

const weeklyCenter = qs("#weeklyCenter");
const weekNumEl    = qs("#weekNum");
const weekLabelEl  = qs("#weekLabel");

const card      = qs("#card");
const cardTitle = qs("#cardTitle");
const cardRows  = qs("#cardRows");

const aiStage   = qs("#aiStage");

const generateBtn = qs("#generateBtn");
const exerciseBtn = qs("#exerciseBtn");

const slideWrap  = qs("#slideWrap");
const slideFill  = qs("#slideFill");
const slideKnob  = qs("#slideKnob");
const slideWhite = qs("#slideWhite");

const modal     = qs("#modal");
const closeModal= qs("#closeModal");
const tabsEl    = qs("#tabs");
const listEl    = qs("#list");
const addName   = qs("#addName");
const addReps   = qs("#addReps");
const addBtn    = qs("#addBtn");

/* Confetti */
const confettiCanvas = qs("#confettiCanvas");
const confettiInstance = window.confetti
  ? window.confetti.create(confettiCanvas, { resize:true, useWorker:true })
  : null;

/* =========================================================
   STATE
========================================================= */
let library = loadJSON(LS.library, null);
if(!library){
  library = structuredClone(DEFAULT_LIBRARY);
  saveJSON(LS.library, library);
}

let currentWorkout = null; // {type, rows: [{text, tags:[...]}]}

/* =========================================================
   WEATHER (optional)
========================================================= */
function weatherCodeToText(code){
  const map={
    0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
    45:"Fog",48:"Fog",
    51:"Drizzle",53:"Drizzle",55:"Drizzle",
    61:"Rain",63:"Rain",65:"Rain",
    71:"Snow",73:"Snow",75:"Snow",
    80:"Rain shower",81:"Rain shower",82:"Rain shower",
    95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
  };
  return map[code] || "Weather";
}
function getWeatherEmoji(cond){
  const c=cond.toLowerCase();
  if(c.includes("clear")) return "â˜€ï¸";
  if(c.includes("cloud")) return "â›…";
  if(c.includes("rain")) return "ðŸŒ§ï¸";
  if(c.includes("drizzle")) return "ðŸŒ¦ï¸";
  if(c.includes("thunder")) return "ðŸŒ©ï¸";
  if(c.includes("snow")) return "â„ï¸";
  if(c.includes("fog")||c.includes("mist")) return "ðŸŒ«ï¸";
  return "ðŸŒ¡ï¸";
}
async function updateWeather(){
  if(!SHOW_WEATHER){
    weatherEl.textContent="";
    return;
  }
  if(!navigator.geolocation){
    weatherEl.textContent="";
    return;
  }
  weatherEl.textContent="Loadingâ€¦";
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res=await fetch(url);
      const data=await res.json();
      const temp=Math.round(data.current_weather.temperature);
      const cond=weatherCodeToText(data.current_weather.weathercode);
      const emoji=getWeatherEmoji(cond);
      let city="Your area";
      try{
        const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const r=await rev.json();
        city=r.address.city||r.address.town||r.address.village||r.address.county||city;
      }catch{}
      weatherEl.textContent=`${emoji} ${temp}Â°C ${city}`;
    }catch{
      weatherEl.textContent="";
    }
  },()=>{
    weatherEl.textContent="";
  },{timeout:8000,maximumAge:600000});
}

/* =========================================================
   STREAK + WEEK COUNT UI
========================================================= */
function getStreak(){
  return parseInt(localStorage.getItem(LS.streak)||"0",10);
}
function setStreak(n){
  localStorage.setItem(LS.streak, String(Math.max(0, n|0)));
}
function getWeekCount(){
  return parseInt(localStorage.getItem(LS.weekCount)||"0",10);
}
function setWeekCount(n){
  localStorage.setItem(LS.weekCount, String(Math.max(0, n|0)));
}
function getWeekCounted(){
  return localStorage.getItem(LS.weekCounted)==="1";
}
function setWeekCounted(v){
  localStorage.setItem(LS.weekCounted, v ? "1" : "0");
}

function renderStreakUI(){
  const streak = getStreak();
  const done = getWeekCount();
  streakCount.textContent = String(streak);
  const pct = clamp(done/3, 0, 1);
  streakFill.style.transform = `scaleX(${pct})`;

  // weekly center
  weekNumEl.textContent = String(done);
  weekLabelEl.textContent = (done===1) ? "workout completed this week" : "workouts completed this week";
}

/* =========================================================
   WORKOUT GENERATION
========================================================= */

function pillForTag(tagKey){
  const t = TAGS.find(t=>t.key===tagKey);
  return t ? t.pill : "";
}

function pickExercise(tagKey){
  const arr = library[tagKey] || [];
  if(!arr.length){
    return { name:"(Add an exercise)", reps:"" };
  }
  return rand(arr);
}

/* AMRAP: 3-4 items; weights: pull 80%, push 80%, others 50% (upper/shoulders also 50%) */
function generateAMRAP(){
  const candidates = [
    { tag:"pull",      p:0.80 },
    { tag:"push",      p:0.80 },
    { tag:"upper",     p:0.50 },
    { tag:"shoulders", p:0.50 },
    { tag:"legs",      p:0.50 },
    { tag:"abs",       p:0.50 },
    { tag:"fullbody",  p:0.50 },
    { tag:"cardio",    p:0.50 },
  ];

  // roll candidates into a pool
  let pool = [];
  for(const c of candidates){
    if(Math.random() < c.p) pool.push(c.tag);
  }

  // ensure we have enough variety
  if(pool.length < 3){
    // force add until >=3
    const order = ["pull","push","fullbody","legs","cardio","abs","shoulders","upper"];
    for(const t of order){
      if(!pool.includes(t)) pool.push(t);
      if(pool.length>=3) break;
    }
  }

  // limit to 3-4 unique tags
  pool = [...new Set(pool)];
  // shuffle
  pool.sort(()=>Math.random()-0.5);
  const count = (Math.random() < 0.55) ? 3 : 4; // mostly 3, sometimes 4
  const chosen = pool.slice(0,count);

  const rows = chosen.map(tag=>{
    const ex = pickExercise(tag);
    const reps = (ex.reps||"").trim();
    const text = reps ? `${reps} ${ex.name}` : ex.name;
    return { text, tags:[tag] };
  });

  return { type:"As Many Rounds As Possible", rows };
}

/* Metacon: all 8 categories, shuffled, no reps in text */
function generateMETACON(){
  const tags = ["pull","push","upper","shoulders","legs","abs","fullbody","cardio"];
  const shuffled = tags.slice().sort(()=>Math.random()-0.5);

  const rows = shuffled.map(tag=>{
    const ex = pickExercise(tag);
    return { text: ex.name, tags:[tag] };
  });

  return { type:"Metabolic Conditioning", rows };
}

function renderWorkout(workout){
  cardTitle.textContent = workout.type;
  cardRows.innerHTML = "";

  workout.rows.forEach(r=>{
    const row = document.createElement("div");
    row.className = "row";

    const left = document.createElement("div");
    left.className = "row-left";

    const txt = document.createElement("div");
    txt.className = "row-text";
    txt.textContent = r.text;

    left.appendChild(txt);

    const tags = document.createElement("div");
    tags.className = "tags";
    r.tags.forEach(tag=>{
      const pill = document.createElement("span");
      pill.className = `pill ${pillForTag(tag)}`;
      pill.textContent = tag;
      tags.appendChild(pill);
    });

    row.appendChild(left);
    row.appendChild(tags);
    cardRows.appendChild(row);
  });

  card.classList.remove("hidden");
  requestAnimationFrame(()=> card.classList.add("visible"));
}

/* =========================================================
   UI STATES
========================================================= */
function showWeeklyCenter(){
  weeklyCenter.classList.remove("hidden");
  card.classList.remove("visible");
  setTimeout(()=> card.classList.add("hidden"), 160);

  // buttons visible
  generateBtn.classList.remove("hidden");
  exerciseBtn.classList.remove("hidden");
  slideWrap.classList.remove("show");

  currentWorkout = null;
}

function showWorkoutState(workout){
  weeklyCenter.classList.add("hidden");

  renderWorkout(workout);

  // swap buttons: hide Generate + Exercises; show slider
  generateBtn.classList.add("hidden");
  exerciseBtn.classList.add("hidden");
  slideWrap.classList.add("show");

  resetSlider();
}

/* =========================================================
   GENERATE FLOW + MESH
========================================================= */
function showMesh(on){
  if(on){
    aiStage.style.display = "block";
    requestAnimationFrame(()=> aiStage.classList.add("show"));
  }else{
    aiStage.classList.remove("show");
    setTimeout(()=>{ aiStage.style.display="none"; }, 220);
  }
}

generateBtn.addEventListener("click", ()=>{
  showMesh(true);

  // small delay like your original "AI generating"
  setTimeout(()=>{
    const workout = (Math.random() < 0.55) ? generateAMRAP() : generateMETACON(); // AMRAP slightly more frequent
    currentWorkout = workout;

    showMesh(false);
    showWorkoutState(workout);
  }, 850);
});

/* =========================================================
   SLIDER (with white text under fill)
========================================================= */
let sliding=false;
let startX=0;
let currentX=0;
let maxSlide=0;
let knobWidth=52;
let trackWidth=0;

function resetSlider(){
  const rect = slideWrap.getBoundingClientRect();
  trackWidth = rect.width || 1;
  maxSlide = trackWidth - knobWidth - 14; // left 7 + right 7
  currentX = 0;

  slideFill.style.transform = "scaleX(0)";
  slideKnob.style.transform = "translate(0,-50%)";
  slideWhite.style.clipPath = "inset(0 100% 0 0)";
}

function setSliderProgress(px){
  const x = clamp(px, 0, maxSlide);
  currentX = x;
  const progress = (maxSlide===0) ? 0 : (x/maxSlide);

  slideKnob.style.transform = `translate(${x}px,-50%)`;
  slideFill.style.transform = `scaleX(${progress})`;

  // Reveal white label from left as fill grows
  const rightInset = Math.round((1-progress)*100);
  slideWhite.style.clipPath = `inset(0 ${rightInset}% 0 0)`;
}

slideKnob.addEventListener("pointerdown", (e)=>{
  sliding=true;
  slideKnob.setPointerCapture(e.pointerId);
  startX = e.clientX;
  if(navigator.vibrate) navigator.vibrate(6);
});

slideKnob.addEventListener("pointermove",(e)=>{
  if(!sliding) return;
  const dx = e.clientX - startX;
  setSliderProgress(dx);
});

function finishSlide(e){
  if(!sliding) return;
  sliding=false;
  try{ slideKnob.releasePointerCapture(e.pointerId); }catch{}

  const progress = (maxSlide===0) ? 0 : (currentX/maxSlide);

  if(progress > 0.92){
    setSliderProgress(maxSlide);
    completeWorkout();
  }else{
    // snap back
    setSliderProgress(0);
  }
}
slideKnob.addEventListener("pointerup", finishSlide);
slideKnob.addEventListener("pointercancel", finishSlide);

/* =========================================================
   COMPLETE WORKOUT
========================================================= */
function shootConfettiFromUnderButtons(){
  if(!confettiInstance) return;

  // origin near bottom-center, slightly ABOVE the bottom edge, and BEHIND buttons (canvas z-index is below actions)
  confettiInstance({
    particleCount:160,
    spread:90,
    startVelocity:35,
    origin:{ x:0.5, y:0.92 }
  });
}

function completeWorkout(){
  // update week count
  ensureWeekState();
  let count = getWeekCount();
  count += 1;
  setWeekCount(count);

  // streak logic: when reaching 3, increment streak ONCE
  if(count >= 3 && !getWeekCounted()){
    setStreak(getStreak()+1);
    setWeekCounted(true);
  }

  renderStreakUI();

  shootConfettiFromUnderButtons();

  // haptic
  if(navigator.vibrate) navigator.vibrate(18);

  // hide workout and show weekly center again
  showWeeklyCenter();
}

/* =========================================================
   MODAL (exercise editor)
========================================================= */
const TAB_ORDER = ["upper","pull","push","shoulders","legs","abs","fullbody","cardio"];
let activeTab = "push";

function openModal(){
  modal.classList.add("show");
  renderTabs();
  renderList();
}
function closeModalFn(){
  modal.classList.remove("show");
  // save
  saveJSON(LS.library, library);
}
exerciseBtn.addEventListener("click", openModal);
closeModal.addEventListener("click", closeModalFn);
modal.addEventListener("click",(e)=>{
  if(e.target === modal) closeModalFn();
});

function renderTabs(){
  tabsEl.innerHTML = "";
  TAB_ORDER.forEach(k=>{
    const b = document.createElement("button");
    b.className = "tab" + (k===activeTab ? " active":"");
    b.textContent = k;
    b.addEventListener("click", ()=>{
      activeTab = k;
      renderTabs();
      renderList();
    });
    tabsEl.appendChild(b);
  });
}

function renderList(){
  listEl.innerHTML = "";
  const arr = library[activeTab] || [];
  if(!library[activeTab]) library[activeTab]=[];

  arr.forEach((item, idx)=>{
    const wrap = document.createElement("div");
    wrap.className = "item";

    const name = document.createElement("input");
    name.className = "name";
    name.value = item.name || "";
    name.addEventListener("input", ()=>{
      library[activeTab][idx].name = name.value;
      saveJSON(LS.library, library);
    });

    const reps = document.createElement("input");
    reps.className = "reps";
    reps.placeholder = "Reps (AMRAP)";
    reps.value = item.reps || "";
    reps.addEventListener("input", ()=>{
      library[activeTab][idx].reps = reps.value;
      saveJSON(LS.library, library);
    });

    const del = document.createElement("button");
    del.className = "trash";
    del.textContent = "Ã—";
    del.addEventListener("click", ()=>{
      library[activeTab].splice(idx,1);
      saveJSON(LS.library, library);
      renderList();
    });

    wrap.appendChild(name);
    wrap.appendChild(reps);
    wrap.appendChild(del);
    listEl.appendChild(wrap);
  });
}

addBtn.addEventListener("click", ()=>{
  const n = (addName.value||"").trim();
  const r = (addReps.value||"").trim();
  if(!n) return;
  if(!library[activeTab]) library[activeTab]=[];
  library[activeTab].unshift({ name:n, reps:r });
  addName.value="";
  addReps.value="";
  saveJSON(LS.library, library);
  renderList();
});

/* =========================================================
   INIT
========================================================= */
function init(){
  ensureWeekState();
  renderStreakUI();

  // show weekly count screen initially
  showWeeklyCenter();

  updateWeather();
}
init();
</script>
</body>
</html>
