<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<!-- Confetti (same lib you used earlier) -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  :root{
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;

    --bg:#f8fafc;
    --card:#ffffff;

    --shadow-soft:0 18px 48px rgba(15,23,42,0.14);
    --shadow-subtle:0 10px 24px rgba(15,23,42,0.10);

    --streak-bg:#eef2f7;
    --streak-fill:#f97316;

    /* 8 tag colors (previous style vibe: soft bg + stronger text) */
    --t-purple-bg:#ede9fe; --t-purple-tx:#7c3aed;
    --t-orange-bg:#ffedd5; --t-orange-tx:#ea580c;
    --t-red-bg:#ffe4e6;    --t-red-tx:#e11d48;
    --t-pink-bg:#fce7f3;   --t-pink-tx:#db2777;
    --t-blue-bg:#e4ecff;   --t-blue-tx:#2453f5;
    --t-yellow-bg:#fef9c3; --t-yellow-tx:#ca8a04;
    --t-teal-bg:#ecfeff;   --t-teal-tx:#0891b2;
    --t-green-bg:#d9fbe3;  --t-green-tx:#16a34a;
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased;
  }

  .container{
    max-width:480px;
    margin:0 auto;
    padding:24px;
    padding-bottom:220px;
    position:relative;
    min-height:100vh;
  }

  /* TOP HEADER ROW: weather + streak */
  .top-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:12px;
  }

  .weather{
    font-size:15px;
    color:var(--sub);
    opacity:.95;
    display:flex;
    align-items:center;
    gap:6px;
    transition:opacity .25s ease, transform .25s ease;
    min-width:160px;
  }

  .streak-wrap{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:10px;
    flex:1;
  }

  .streak-fire{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:14px;
    font-weight:700;
    color:var(--streak-fill);
    white-space:nowrap;
  }

  .streak-bar{
    position:relative;
    width:150px; /* NOT full width */
    height:8px;
    border-radius:999px;
    background:var(--streak-bg);
    overflow:hidden;
  }

  .streak-bar-fill{
    position:absolute;
    inset:0;
    background:var(--streak-fill);
    transform-origin:left center;
    transform:scaleX(0);
    transition:transform .35s cubic-bezier(.22,.8,.4,1);
  }

  .streak-count{
    font-variant-numeric:tabular-nums;
    min-width:16px;
  }
  .streak-count.flip{
    animation:streakFlip .32s ease-out;
  }
  @keyframes streakFlip{
    0%{ transform:translateY(-60%) rotateX(90deg); opacity:0; }
    100%{ transform:translateY(0) rotateX(0deg); opacity:1; }
  }

  h1{
    font-size:34px;
    font-weight:800;
    margin:8px 0 6px;
    letter-spacing:-0.02em;
  }

  #subtitle{
    font-size:17px;
    font-weight:400;
    color:var(--sub);
    margin:0 0 18px;
  }

  /* AI GRADIENT STAGE â€” your original style (kept), but DOES NOT cover buttons */
  .ai-stage{
    position:absolute;
    left:50%;
    top:240px;
    transform:translateX(-50%);
    width:260px;
    height:260px;
    border-radius:50%;
    display:none;
    pointer-events:none;
    z-index:1;
  }
  .ai-stage::before{
    content:"";
    position:absolute;
    inset:-20% -15% -25% -15%;
    filter:blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    transition:opacity .25s ease;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    animation:meshBreath 2s ease-in-out infinite, meshDrift 3s ease-in-out infinite;
  }
  .ai-stage.show{ display:block; }
  .ai-stage.show::before{ opacity:.9; }

  @keyframes meshBreath{
    0%,100%{ transform:scale(1); opacity:.7 }
    50%{ transform:scale(1.04); opacity:.35 }
  }
  @keyframes meshDrift{
    0%{ transform:translate3d(0,0,0); }
    50%{ transform:translate3d(2%,-1.5%,0); }
    100%{ transform:translate3d(0,0,0); }
  }

  /* MAIN WORKOUT CARD */
  #card{
    position:relative;
    background:var(--card);
    border-radius:18px;
    padding:22px;
    box-shadow:var(--shadow-soft);
    display:none;
    opacity:0;
    transform:translateY(18px) scale(.97);
    transition:
      opacity .32s ease,
      transform .32s cubic-bezier(.18,.84,.32,1.12);
    z-index:2;
  }
  #card.visible{
    opacity:1;
    transform:translateY(0) scale(1);
  }

  #workoutTitle{
    font-size:22px;
    font-weight:800;
    margin:2px 0 16px;
  }

  .line{
    font-size:18px;
    margin-bottom:12px;
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }

  .pill{
    padding:4px 12px;
    border-radius:999px;
    font-size:13px;
    font-weight:700;
    white-space:nowrap;
  }

  /* 8 pills mapped to 8 categories */
  .pill-push{ background:var(--t-blue-bg);   color:var(--t-blue-tx); }
  .pill-pull{ background:var(--t-green-bg);  color:var(--t-green-tx); }
  .pill-upper{background:var(--t-purple-bg); color:var(--t-purple-tx); }
  .pill-shoulders{background:var(--t-pink-bg); color:var(--t-pink-tx); }
  .pill-legs{ background:var(--t-orange-bg); color:var(--t-orange-tx); }
  .pill-abs{  background:var(--t-teal-bg);   color:var(--t-teal-tx); }
  .pill-cardio{background:var(--t-yellow-bg); color:var(--t-yellow-tx); }
  .pill-fullbody{background:var(--t-red-bg); color:var(--t-red-tx); }

  /* WEEK SUMMARY SCREEN (engraved number) */
  #weekSummary{
    display:none;
    text-align:center;
    margin-top:34px;
    position:relative;
    z-index:2;
  }

  .engravedNum{
    font-size:140px;
    font-weight:800;
    line-height:1;
    letter-spacing:-0.04em;
    color:rgba(15,23,42,0.07);
    text-shadow:
      0 1px 0 rgba(255,255,255,0.9),
      0 -1px 0 rgba(15,23,42,0.08);
    margin:24px 0 0;
    user-select:none;
  }

  .weekText{
    margin-top:-8px;
    font-size:20px;
    color:var(--sub);
    font-weight:600;
  }

  /* FIXED ACTIONS */
  .fixed-actions{
    position:fixed;
    left:50%;
    bottom:22px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    z-index:20; /* always above mesh/confetti */
  }

  .btn{
    width:100%;
    height:58px;
    border-radius:30px;
    border:none;
    font-size:18px;
    font-weight:600; /* keep sane */
    cursor:pointer;
  }

  /* Generate button: NO shadow */
  #generateBtn{
    background:var(--brand);
    color:#fff;
    box-shadow:none;
  }
  #generateBtn:active{ transform:scale(.99); }

  #exBtn{
    margin-top:12px;
    background:#eef2f7;
    color:var(--brand);
    font-weight:700;
  }
  #exBtn:active{ transform:scale(.99); }

  /* SLIDE TO COMPLETE â€” sits where the exercise button was (lower) */
  #slideWrap{
    margin-top:12px;
    display:none;
  }

  .slide-track{
    position:relative;
    height:58px;
    border-radius:999px;
    background:#eef2f7;
    overflow:hidden;
    user-select:none;
    touch-action:none;
  }

  .slide-fill{
    position:absolute;
    inset:0;
    border-radius:999px;
    pointer-events:none;
    background:linear-gradient(120deg,#2453f5,#4f8cff);
    transform-origin:left center;
    transform:scaleX(0);
  }

  .slide-label{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    font-size:17px;
    font-weight:700;
    color:var(--brand);
    transition:color .12s ease;
  }

  /* text turns WHITE while sliding (not only completion) */
  .slide-track.filled .slide-label{
    color:#fff;
  }

  .slide-knob{
    position:absolute;
    top:50%;
    left:6px;
    width:50px;
    height:50px;
    border-radius:50%;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 8px 16px rgba(15,23,42,0.18);
    transform:translate(0,-50%);
    touch-action:none;
  }

  .slide-knob .arrow{
    font-size:20px;
    color:var(--brand);
  }

  /* MODAL â€” FULL HEIGHT, CONTENT SCROLLS */
  #modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    display:none;
    z-index:60;
  }
  #modal.show{ display:block; }

  .sheet{
    position:absolute;
    inset:0;
    background:#fff;
    border-radius:18px 18px 0 0;
    padding:16px 16px 22px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .sheetHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .sheetTitle{
    font-size:18px;
    font-weight:800;
  }
  .closeBtn{
    border:none;
    background:#eef2f7;
    border-radius:10px;
    padding:10px 12px;
    font-weight:800;
    cursor:pointer;
  }

  .tabs{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  .tab{
    padding:8px 12px;
    border-radius:999px;
    background:#f1f5f9;
    font-size:13px;
    font-weight:800;
    border:none;
    cursor:pointer;
  }
  .tab.active{
    background:#e4ecff;
    color:#1d4ed8;
  }

  .list{
    flex:1;               /* key: modal height doesn't change */
    overflow:auto;        /* scroll list */
    padding-top:2px;
  }

  .row{
    display:grid;
    grid-template-columns: 1fr 90px 44px;
    gap:10px;
    align-items:center;
    margin-bottom:10px;
  }

  .row input{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid #e5e7eb;
    font-size:15px;
  }

  .trash{
    width:44px;
    height:44px;
    border-radius:12px;
    border:none;
    background:#f1f5f9;
    cursor:pointer;
    font-size:18px;
  }

  .addRow{
    display:flex;
    gap:10px;
    margin-top:14px;
    position:sticky;
    bottom:0;
    background:#fff;
    padding-top:10px;
  }

  .addRow input{
    flex:1;
  }

  .addBtn{
    width:120px;
    border:none;
    border-radius:14px;
    background:var(--brand);
    color:#fff;
    font-weight:800;
    cursor:pointer;
  }

  /* subtle separator on scroll */
  .sheet::before{
    content:"";
    position:absolute;
    top:0; left:0; right:0;
    height:1px;
    background:rgba(15,23,42,0.06);
  }
</style>
</head>

<body>

<div class="container">

  <div class="top-header">
    <div class="weather" id="weather">Enable location for weather</div>

    <div class="streak-wrap">
      <div class="streak-fire">
        <span>ðŸ”¥</span>
        <span id="streakCount" class="streak-count">0</span>
      </div>
      <div class="streak-bar">
        <div class="streak-bar-fill" id="streakFill"></div>
      </div>
    </div>
  </div>

  <h1>Welcome back Jy</h1>
  <div id="subtitle">Today's mixed workout</div>

  <div id="aiStage" class="ai-stage"></div>

  <div id="card">
    <div id="workoutTitle"></div>
    <div id="lines"></div>
  </div>

  <div id="weekSummary">
    <div class="engravedNum" id="engravedNum">0</div>
    <div class="weekText" id="weekText">workouts completed this week</div>
  </div>
</div>

<!-- Fixed actions -->
<div class="fixed-actions">
  <button id="generateBtn" class="btn">Generate Workout</button>
  <button id="exBtn" class="btn">Exercises</button>

  <div id="slideWrap">
    <div id="slideTrack" class="slide-track">
      <div id="slideFill" class="slide-fill"></div>
      <div class="slide-label" id="slideLabel">Slide to Complete</div>
      <div id="slideKnob" class="slide-knob"><span class="arrow">â†’</span></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal">
  <div class="sheet">
    <div class="sheetHeader">
      <div class="sheetTitle">Exercises</div>
      <button class="closeBtn" id="closeModal">Close</button>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="list" id="list"></div>

    <div class="addRow">
      <input id="newName" type="text" placeholder="New exercise name" />
      <input id="newReps" type="number" inputmode="numeric" placeholder="Reps" />
      <button class="addBtn" id="addBtn">Add</button>
    </div>
  </div>
</div>

<script>
/* ===================== STORAGE KEYS ===================== */
const LS = {
  streak: "jy_streak",
  weekKey: "jy_weekKey",
  weekState: "jy_weekState",      // {week, dates:[], counted:boolean}
  exercises: "jy_exercises"       // object by category
};

/* ===================== DATE / WEEK ===================== */
function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
/* ISO-ish week key (stable enough for streak logic) */
function weekKey(){
  const d=new Date();
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
  return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

/* ===================== STREAK / WEEK LOGIC ===================== */
function getStreak(){
  const n = parseInt(localStorage.getItem(LS.streak) || "0", 10);
  return Number.isFinite(n) && n > 0 ? n : 0;
}
function setStreak(n){
  localStorage.setItem(LS.streak, String(Math.max(0, n|0)));
}
function loadWeekState(){
  const raw = localStorage.getItem(LS.weekState);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function saveWeekState(obj){
  localStorage.setItem(LS.weekState, JSON.stringify(obj));
}

/* If week changes:
   - if last week < 3 workouts -> streak resets to 0
   - reset weekState for new week
*/
function rolloverWeekIfNeeded(){
  const cur = weekKey();
  const prev = localStorage.getItem(LS.weekKey);

  let wk = loadWeekState();
  if(!prev){
    localStorage.setItem(LS.weekKey, cur);
    if(!wk || wk.week !== cur){
      wk = { week: cur, dates: [], counted:false };
      saveWeekState(wk);
    }
    return;
  }

  if(prev !== cur){
    // evaluate last week
    if(wk && wk.week === prev){
      const done = Array.isArray(wk.dates) ? wk.dates.length : 0;
      if(done < 3){
        setStreak(0);
      }
    }
    // start new week
    localStorage.setItem(LS.weekKey, cur);
    wk = { week: cur, dates: [], counted:false };
    saveWeekState(wk);
  }else{
    if(!wk || wk.week !== cur){
      wk = { week: cur, dates: [], counted:false };
      saveWeekState(wk);
    }
  }
}

function workoutsThisWeek(){
  const wk = loadWeekState();
  if(!wk || wk.week !== weekKey()) return 0;
  return Array.isArray(wk.dates) ? wk.dates.length : 0;
}

/* On completion:
   - add today to dates if not already
   - if >=3 and not counted -> streak +1 and set counted true
*/
function markWorkoutComplete(){
  const curW = weekKey();
  let wk = loadWeekState();
  if(!wk || wk.week !== curW){
    wk = { week: curW, dates: [], counted:false };
  }
  const t = todayKey();
  if(!wk.dates.includes(t)){
    wk.dates.push(t);
  }

  let streak = getStreak();
  let streakIncreased = false;
  if(wk.dates.length >= 3 && !wk.counted){
    streak += 1;
    wk.counted = true;
    setStreak(streak);
    streakIncreased = true;
  }else{
    setStreak(streak);
  }

  saveWeekState(wk);
  return { done: wk.dates.length, streak, streakIncreased };
}

/* ===================== UI: STREAK BAR ===================== */
const streakCountEl = document.getElementById("streakCount");
const streakFillEl  = document.getElementById("streakFill");
let lastStreak = getStreak();

function renderStreakUI(opts={}){
  const done = workoutsThisWeek();
  const pct = Math.min(done / 3, 1);
  streakFillEl.style.transform = `scaleX(${pct})`;

  const streak = getStreak();
  const flip = !!opts.animateFlip && streak > lastStreak;
  if(flip){
    streakCountEl.classList.remove("flip");
    void streakCountEl.offsetWidth;
    streakCountEl.textContent = streak;
    streakCountEl.classList.add("flip");
    setTimeout(()=> streakCountEl.classList.remove("flip"), 320);
  }else{
    streakCountEl.textContent = streak;
  }
  lastStreak = streak;
}

/* ===================== WEATHER ===================== */
const weatherEl = document.getElementById("weather");

function weatherCodeToText(code){
  const map={
    0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
    45:"Fog",48:"Fog",
    51:"Drizzle",53:"Drizzle",55:"Drizzle",
    61:"Rain",63:"Rain",65:"Rain",
    71:"Snow",73:"Snow",75:"Snow",
    80:"Rain shower",81:"Rain shower",82:"Rain shower",
    95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
  };
  return map[code] || "Unknown";
}
function getWeatherEmoji(cond){
  const c=cond.toLowerCase();
  if(c.includes("clear")) return "â˜€ï¸";
  if(c.includes("cloud")) return "â›…";
  if(c.includes("rain")) return "ðŸŒ§ï¸";
  if(c.includes("drizzle")) return "ðŸŒ¦ï¸";
  if(c.includes("thunder")) return "ðŸŒ©ï¸";
  if(c.includes("snow")) return "â„ï¸";
  if(c.includes("fog")||c.includes("mist")) return "ðŸŒ«ï¸";
  return "ðŸŒ¡ï¸";
}
function updateWeatherUI(){
  if(!navigator.geolocation){
    weatherEl.textContent="Location unavailable";
    return;
  }
  weatherEl.textContent="Loading weatherâ€¦";
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res=await fetch(url);
      const data=await res.json();
      const temp=Math.round(data.current_weather.temperature);
      const cond=weatherCodeToText(data.current_weather.weathercode);
      const emoji=getWeatherEmoji(cond);
      let city="Your area";
      try{
        const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const r=await rev.json();
        city=r.address.city||r.address.town||r.address.village||r.address.county||city;
      }catch{}
      weatherEl.textContent=`${emoji} ${temp}Â°C ${city}`;
    }catch{
      weatherEl.textContent="Weather unavailable";
    }
  },()=>{
    weatherEl.textContent="Enable location for weather";
  },{timeout:10000,maximumAge:600000});
}

/* ===================== EXERCISES DATA (EDITABLE) ===================== */
const CATS = [
  { key:"push", label:"Push", pill:"pill-push" },
  { key:"pull", label:"Pull", pill:"pill-pull" },
  { key:"upper", label:"Upper", pill:"pill-upper" },
  { key:"shoulders", label:"Shoulders", pill:"pill-shoulders" },
  { key:"legs", label:"Legs", pill:"pill-legs" },
  { key:"abs", label:"Abs", pill:"pill-abs" },
  { key:"cardio", label:"Cardio", pill:"pill-cardio" },
  { key:"fullbody", label:"Fullbody", pill:"pill-fullbody" },
];

const DEFAULT_EXERCISES = {
  push: [
    { name:"Push-Ups", reps:10 },
    { name:"Dips", reps:10 },
    { name:"Decline Push-Ups", reps:10 },
    { name:"Diamond Push-Ups", reps:10 },
  ],
  pull: [
    { name:"Pull-Ups", reps:5 },
    { name:"Chin-Ups", reps:5 },
    { name:"Australian Chin-Ups", reps:10 },
  ],
  upper: [
    { name:"Muscle-Up", reps:1 },
  ],
  shoulders: [
    { name:"Pike Push-Ups", reps:10 },
    { name:"Dolphin Push-Ups", reps:10 },
  ],
  legs: [
    { name:"Jumping Squats", reps:15 },
    { name:"Jumping Lunges", reps:15 },
  ],
  abs: [
    { name:"Knee Raises", reps:20 },
    { name:"Full Body Raises", reps:20 },
    { name:"Oblique Twists", reps:10 },
  ],
  cardio: [
    { name:"Jumping Jacks", reps:20 },
    { name:"Mountain Climbers", reps:20 },
  ],
  fullbody: [
    { name:"Burpees", reps:10 },
    { name:"Kettlebell Swings", reps:10 },
  ],
};

function loadExercises(){
  const raw = localStorage.getItem(LS.exercises);
  if(!raw){
    localStorage.setItem(LS.exercises, JSON.stringify(DEFAULT_EXERCISES));
    return structuredClone(DEFAULT_EXERCISES);
  }
  try{
    const obj = JSON.parse(raw);
    // ensure all keys exist
    const merged = structuredClone(DEFAULT_EXERCISES);
    for(const k of Object.keys(merged)){
      if(Array.isArray(obj[k])) merged[k] = obj[k];
    }
    localStorage.setItem(LS.exercises, JSON.stringify(merged));
    return merged;
  }catch{
    localStorage.setItem(LS.exercises, JSON.stringify(DEFAULT_EXERCISES));
    return structuredClone(DEFAULT_EXERCISES);
  }
}

function saveExercises(ex){
  localStorage.setItem(LS.exercises, JSON.stringify(ex));
}

/* ===================== WORKOUT GENERATION ===================== */
const aiStage = document.getElementById("aiStage");
const cardEl = document.getElementById("card");
const linesEl = document.getElementById("lines");
const titleEl = document.getElementById("workoutTitle");
const subtitleEl = document.getElementById("subtitle");

const generateBtn = document.getElementById("generateBtn");
const exBtn = document.getElementById("exBtn");

const slideWrap = document.getElementById("slideWrap");
const slideTrack = document.getElementById("slideTrack");
const slideFill = document.getElementById("slideFill");
const slideKnob = document.getElementById("slideKnob");

const weekSummaryEl = document.getElementById("weekSummary");
const engravedNumEl = document.getElementById("engravedNum");
const weekTextEl = document.getElementById("weekText");

let currentWorkout = null; // {type, items[]}

/* probabilities for AMRAP categories */
function shouldInclude(catKey){
  if(catKey === "pull") return Math.random() < 0.80;
  if(catKey === "push") return Math.random() < 0.80;
  // upper + shoulders explicitly 50%
  if(catKey === "upper") return Math.random() < 0.50;
  if(catKey === "shoulders") return Math.random() < 0.50;
  // rest 50%
  return Math.random() < 0.50;
}

function rand(arr){
  return arr[Math.floor(Math.random()*arr.length)];
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function pickExercise(exByCat, catKey){
  const list = exByCat[catKey] || [];
  if(!list.length){
    return { name: catKey, reps: 10 };
  }
  const e = rand(list);
  return { name: String(e.name || catKey).trim() || catKey, reps: Number(e.reps || 10) };
}

/* Build AMRAP: MUST be 3â€“4 items */
function buildAMRAP(exByCat){
  // Step 1: choose categories by probability
  let chosen = CATS.map(c=>c.key).filter(k=> shouldInclude(k));

  // Step 2: enforce 3â€“4
  if(chosen.length < 3){
    // add random categories until 3
    const pool = shuffle(CATS.map(c=>c.key));
    for(const k of pool){
      if(chosen.includes(k)) continue;
      chosen.push(k);
      if(chosen.length >= 3) break;
    }
  }
  if(chosen.length > 4){
    chosen = shuffle(chosen).slice(0,4);
  }
  // If still 2 (extreme), force add
  while(chosen.length < 3){
    const k = rand(CATS.map(c=>c.key));
    if(!chosen.includes(k)) chosen.push(k);
  }
  // If 5+, trim
  if(chosen.length > 4) chosen = chosen.slice(0,4);

  // Build items
  const items = chosen.map(k=>{
    const meta = CATS.find(c=>c.key===k);
    const ex = pickExercise(exByCat, k);
    return {
      cat: k,
      pill: meta.pill,
      label: meta.label.toLowerCase(),
      name: ex.name,
      reps: ex.reps
    };
  });

  return { type:"amrap", title:"As Many Rounds As Possible", items };
}

/* Build MetCon: ALL 8 categories, shuffled order, NO reps shown */
function buildMetCon(exByCat){
  const order = shuffle(CATS.map(c=>c.key));
  const items = order.map(k=>{
    const meta = CATS.find(c=>c.key===k);
    const ex = pickExercise(exByCat, k);
    return {
      cat:k,
      pill: meta.pill,
      label: meta.label.toLowerCase(),
      name: ex.name
      // reps intentionally ignored on render
    };
  });
  return { type:"metcon", title:"Metabolic Conditioning", items };
}

function renderWorkout(workout){
  titleEl.textContent = workout.title;
  linesEl.innerHTML = "";

  workout.items.forEach(it=>{
    const row = document.createElement("div");
    row.className = "line";

    const txt = document.createElement("span");
    if(workout.type === "amrap"){
      txt.textContent = `${it.reps} ${it.name}`;
    }else{
      txt.textContent = `${it.name}`;
    }

    const pill = document.createElement("span");
    pill.className = `pill ${it.pill}`;
    pill.textContent = it.label;

    row.appendChild(txt);
    row.appendChild(pill);
    linesEl.appendChild(row);
  });

  cardEl.style.display = "block";
  cardEl.classList.remove("visible");
  void cardEl.offsetWidth;
  cardEl.classList.add("visible");
}

/* View controls */
function showGenerator(){
  // hide card + summary
  cardEl.style.display="none";
  cardEl.classList.remove("visible");
  weekSummaryEl.style.display="none";

  // show buttons
  generateBtn.style.display="block";
  exBtn.style.display="block";
  slideWrap.style.display="none";

  subtitleEl.textContent = "Today's mixed workout";
}

function showWorkoutView(){
  // hide buttons, show slider (exercise hidden while workout active)
  generateBtn.style.display="none";
  exBtn.style.display="none";
  slideWrap.style.display="block";
}

function showWeekSummary(doneCount){
  // hide card
  cardEl.style.display="none";
  cardEl.classList.remove("visible");

  weekSummaryEl.style.display="block";
  engravedNumEl.textContent = String(doneCount);
  weekTextEl.textContent = doneCount === 1 ? "workout completed this week" : "workouts completed this week";

  // bring buttons back
  generateBtn.style.display="block";
  exBtn.style.display="block";
  slideWrap.style.display="none";
}

/* Generate flow */
function handleGenerate(){
  const exByCat = loadExercises();

  // show mesh
  aiStage.classList.add("show");
  aiStage.style.display = "block";

  // hide anything currently
  weekSummaryEl.style.display="none";
  cardEl.style.display="none";
  cardEl.classList.remove("visible");

  // Generate after delay
  setTimeout(()=>{
    // choose type 50/50
    const type = Math.random() < 0.5 ? "amrap" : "metcon";
    currentWorkout = type === "amrap" ? buildAMRAP(exByCat) : buildMetCon(exByCat);

    aiStage.classList.remove("show");
    aiStage.style.display="none";

    renderWorkout(currentWorkout);
    showWorkoutView();
    resetSlider();
  }, 850);
}

/* ===================== SLIDER ===================== */
let sliding=false;
let startX=0;
let currentX=0;
let maxSlide=0;
let knobWidth=0;
let trackWidth=0;

function resetSlider(){
  const trackRect = slideTrack.getBoundingClientRect();
  const knobRect  = slideKnob.getBoundingClientRect();
  trackWidth = trackRect.width || 1;
  knobWidth  = knobRect.width || 50;
  maxSlide   = trackWidth - knobWidth - 12;

  slideTrack.classList.remove("filled");
  slideKnob.style.transition = "none";
  slideFill.style.transition = "none";

  slideKnob.style.transform = "translate(0,-50%)";
  slideFill.style.transform = "scaleX(0)";

  setTimeout(()=>{
    slideKnob.style.transition = "transform .2s ease-out";
    slideFill.style.transition = "transform .2s ease-out";
  }, 20);
}

slideKnob.addEventListener("pointerdown",e=>{
  e.preventDefault();
  sliding=true;
  slideKnob.setPointerCapture(e.pointerId);

  const trackRect = slideTrack.getBoundingClientRect();
  const knobRect  = slideKnob.getBoundingClientRect();
  trackWidth = trackRect.width || 1;
  knobWidth  = knobRect.width || 50;
  maxSlide   = trackWidth - knobWidth - 12;

  startX = e.clientX;
  currentX = 0;

  slideKnob.style.transition = "none";
  slideFill.style.transition = "none";
});

slideKnob.addEventListener("pointermove",e=>{
  if(!sliding) return;
  const dx = e.clientX - startX;
  let x = Math.max(0, Math.min(maxSlide, dx));
  currentX = x;

  const progress = maxSlide === 0 ? 0 : (x / maxSlide);

  slideKnob.style.transform = `translate(${x}px,-50%)`;
  slideFill.style.transform = `scaleX(${progress})`;

  /* KEY FIX: text turns white DURING slide */
  if(progress > 0.15){
    slideTrack.classList.add("filled");
  }else{
    slideTrack.classList.remove("filled");
  }
});

function endSlide(e){
  if(!sliding) return;
  sliding=false;
  if(e.pointerId) slideKnob.releasePointerCapture(e.pointerId);

  slideKnob.style.transition = "transform .22s ease-out";
  slideFill.style.transition = "transform .22s ease-out";

  const progress = maxSlide === 0 ? 0 : (currentX / maxSlide);

  if(progress > 0.92){
    // lock to end
    slideKnob.style.transform = `translate(${maxSlide}px,-50%)`;
    slideFill.style.transform = `scaleX(1)`;
    slideTrack.classList.add("filled");
    completeWorkout();
  }else{
    slideTrack.classList.remove("filled");
    slideKnob.style.transform = "translate(0,-50%)";
    slideFill.style.transform = "scaleX(0)";
  }
}
slideKnob.addEventListener("pointerup", endSlide);
slideKnob.addEventListener("pointercancel", endSlide);

/* Completion */
function completeWorkout(){
  // confetti behind the buttons (under slider), bursting from below
  if(window.confetti){
    confetti({
      particleCount:140,
      spread:78,
      startVelocity:30,
      gravity:0.95,
      ticks:220,
      origin:{ x:0.5, y:1.18 },  // below the button
      zIndex:5                    // behind fixed actions (z=20)
    });
  }

  const stats = markWorkoutComplete();
  renderStreakUI({ animateFlip: stats.streakIncreased });

  // transition out workout card then show summary
  cardEl.classList.remove("visible");
  setTimeout(()=>{
    showWeekSummary(stats.done);
    currentWorkout = null;
    // reset slider for next time
    resetSlider();
  }, 260);
}

/* ===================== MODAL (FULL HEIGHT) ===================== */
const modal = document.getElementById("modal");
const closeModalBtn = document.getElementById("closeModal");
const tabsEl = document.getElementById("tabs");
const listEl = document.getElementById("list");
const newNameEl = document.getElementById("newName");
const newRepsEl = document.getElementById("newReps");
const addBtnEl = document.getElementById("addBtn");

let activeTab = "push";
let EX = loadExercises();

function openModal(){
  EX = loadExercises();
  modal.classList.add("show");
  renderTabs();
  renderList();
  newNameEl.value="";
  newRepsEl.value="";
}
function closeModal(){
  modal.classList.remove("show");
}
closeModalBtn.addEventListener("click", closeModal);
modal.addEventListener("click",(e)=>{
  if(e.target === modal) closeModal();
});

function renderTabs(){
  tabsEl.innerHTML = "";
  CATS.forEach(c=>{
    const b = document.createElement("button");
    b.className = "tab" + (c.key===activeTab ? " active" : "");
    b.textContent = c.label;
    b.addEventListener("click", ()=>{
      activeTab = c.key;
      renderTabs();
      renderList();
    });
    tabsEl.appendChild(b);
  });
}

function renderList(){
  EX = loadExercises();
  listEl.innerHTML = "";

  const list = EX[activeTab] || [];
  list.forEach((item, idx)=>{
    const row = document.createElement("div");
    row.className="row";

    const name = document.createElement("input");
    name.type="text";
    name.value = item.name || "";
    name.placeholder="Exercise name";
    name.addEventListener("input", ()=>{
      EX[activeTab][idx].name = name.value;
      saveExercises(EX);
    });

    const reps = document.createElement("input");
    reps.type="number";
    reps.inputMode="numeric";
    reps.value = String(item.reps ?? "");
    reps.placeholder="Reps";
    reps.addEventListener("input", ()=>{
      const v = parseInt(reps.value,10);
      EX[activeTab][idx].reps = Number.isFinite(v) ? v : 0;
      saveExercises(EX);
    });

    const trash = document.createElement("button");
    trash.className="trash";
    trash.textContent="ðŸ—‘ï¸";
    trash.addEventListener("click", ()=>{
      EX[activeTab].splice(idx,1);
      saveExercises(EX);
      renderList();
    });

    row.appendChild(name);
    row.appendChild(reps);
    row.appendChild(trash);
    listEl.appendChild(row);
  });
}

addBtnEl.addEventListener("click", ()=>{
  const nm = (newNameEl.value || "").trim();
  const rp = parseInt(newRepsEl.value,10);

  if(!nm) return;

  if(!EX[activeTab]) EX[activeTab]=[];
  EX[activeTab].push({
    name:nm,
    reps:Number.isFinite(rp) ? rp : 10
  });

  saveExercises(EX);
  newNameEl.value="";
  newRepsEl.value="";
  renderList();
});

/* Buttons */
generateBtn.addEventListener("click", handleGenerate);
exBtn.addEventListener("click", openModal);

/* Boot */
rolloverWeekIfNeeded();
renderStreakUI();
updateWeatherUI();
showGenerator();
</script>

</body>
</html>
