<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jy Workout</title>

<style>
  :root{
    --brand:#2453f5;
    --ink:#0f172a;
    --sub:#64748b;
    --bg:#ffffff;
    --card:#f8fafc;
    --pill-blue:#e4ecff;
    --pill-green:#d9fbe3;
    --pill-orange:#ffe6bf;
    --pill-red:#ffe0e0;
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    padding:0;
    background:var(--bg);
    color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro",Segoe UI,Roboto,sans-serif;
  }

  .container{
    max-width:480px;
    margin:0 auto;
    padding:24px;
    padding-bottom:120px; /* room for bottom controls */
  }

  .weather{
    font-size:15px;
    color:var(--sub);
    margin-bottom:16px;
  }

  h1{
    font-size:30px;
    font-weight:700;
    margin:0 0 6px;
  }

  #subtitle{
    font-size:17px;
    font-weight:400;
    color:var(--sub);
    margin:0 0 18px;
  }

  /* RADIO ROW */
  #radioRow{
    display:flex;
    gap:22px;
    margin:0 auto 6px;
    justify-content:center;
  }

  .opt{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:14px;
    color:var(--ink);
  }

  .opt input{
    width:18px;
    height:18px;
  }

  .opt.disabled{
    opacity:.35;
    pointer-events:none;
  }

  .opt.active{
    color:var(--brand);
    font-weight:600;
  }

  /* ============================================
     MODE PREVIEW CARD (WIREFRAME LEFT + TAG RIGHT)
  ============================================ */
  .preview-card{
    position:relative;
    width:100%;
    max-width:420px;
    margin:32px auto 24px;
    border-radius:18px;
    background:#ffffff;
    box-shadow:0 18px 48px rgba(15,23,42,0.16);
    padding:18px 20px;
    opacity:0;
    transform:translateY(26px) scale(.96) rotateX(5deg);
    transition:
      opacity .32s ease,
      transform .32s cubic-bezier(.18,.84,.32,1.12);
    pointer-events:none;
  }

  .preview-card.show{
    opacity:1;
    transform:translateY(0) scale(1) rotateX(0deg);
  }

  .preview-card.hidden{
    display:none;
  }

  .preview-title{
    font-size:18px;
    font-weight:700;
    margin-bottom:14px;
  }

  .preview-lines{
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .preview-row{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    gap:8px; /* distance between wireframe + tag */
}

  .preview-wire{
    height:12px;
    width:32%;               /* âœ” your requested width */
    min-width:90px;
    background:#f2f3f5;
    border-radius:6px;
  }

  .preview-tag{
    padding:4px 10px;
    border-radius:999px;
    font-size:13px;
    font-weight:600;
    white-space:nowrap;
  }

  .preview-tag-weighted{ background:var(--pill-blue); color:var(--brand); }
  .preview-tag-abs{ background:var(--pill-green); color:#22c55e; }
  .preview-tag-shoulders,
  .preview-tag-biceps{ background:var(--pill-orange); color:#d97706; }
  .preview-tag-kettlebell{ background:var(--pill-red); color:#e11d48; }

  /* AI MESH STAGE */
  .ai-stage{
    position:absolute;
    left:50%;
    top:260px;
    transform:translateX(-50%);
    width:260px;
    height:260px;
    border-radius:50%;
    display:none;
    pointer-events:none;
    overflow:visible;
  }

  .ai-stage::before{
    content:"";
    position:absolute;
    inset:-20% -15% -25% -15%;
    filter:blur(84px) saturate(160%) contrast(115%);
    opacity:0;
    transition:opacity .25s ease;
    background:
      radial-gradient(22rem 22rem at 30% 36%, #3A7BFF77 0, #0000 50%),
      radial-gradient(22rem 22rem at 72% 34%, #7DFF5C77 0, #0000 54%),
      radial-gradient(24rem 20rem at 40% 72%, #FFA43A77 0, #0000 54%),
      radial-gradient(20rem 20rem at 70% 74%, #9B8FFF99 0, #0000 80%);
    background-blend-mode:screen;
    animation:meshBreath 2s ease-in-out infinite,
             meshDrift 3s ease-in-out infinite;
  }

  @keyframes meshBreath{
    0%,100%{ transform:scale(1); opacity:.7 }
    50%{ transform:scale(1.04); opacity:.35 }
  }
  @keyframes meshDrift{
    0%{ transform:translate3d(0,0,0); }
    50%{ transform:translate3d(2%,-1.5%,0); }
    100%{ transform:translate3d(0,0,0); }
  }

  /* REAL WORKOUT CARD */
  #card{
    background:var(--card);
    border-radius:16px;
    padding:20px;
    margin-top:4px;
    display:none;
  }

  #dayTitle{
    font-size:20px;
    font-weight:700;
    margin-bottom:10px;
  }

  .line{
    font-size:16px;
    margin-bottom:8px;
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }

  .pill{
    padding:3px 8px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }

  .pill-weighted{ background:var(--pill-blue); color:var(--brand); }
  .pill-abs{ background:var(--pill-green); color:#22c55e; }
  .pill-shoulders,
  .pill-biceps{ background:var(--pill-orange); color:#d97706; }
  .pill-kettlebell{ background:var(--pill-red); color:#e11d48; }

  /* GENERATE BUTTON */
  #mainBtn{
    position:fixed;
    left:50%;
    bottom:24px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
    height:56px;
    border-radius:28px;
    border:none;
    background:var(--brand);
    color:#fff;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
    transition:opacity .25s ease;
  }
  #mainBtn.hidden{ display:none; }
  #mainBtn.disabled{ opacity:.4; pointer-events:none; }

  /* BIG TIMER */
  #bigTimer{
    position:fixed;
    top:calc(50% + 2rem);
    left:50%;
    transform:translate(-50%,-50%);
    display:flex;
    gap:1.5rem;
    opacity:0;
    transition:opacity .45s ease;
  }
  #bigTimer.hidden{ display:none; }
  #bigTimer.show{ opacity:1; }

  .t-col{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    width:72px;
    text-align:center;
  }

  .t-num{
    font-size:48px;
    font-weight:400;
    color:var(--ink);
    font-variant-numeric:tabular-nums;
  }

  .t-label{
    font-size:14px;
    color:var(--sub);
    margin-top:6px;
    letter-spacing:1px;
  }

  /* SLIDE TO COMPLETE */
  .slide-wrap{
    position:fixed;
    left:50%;
    bottom:24px;
    transform:translateX(-50%);
    width:calc(100% - 48px);
    max-width:480px;
  }
  .slide-wrap.hidden{ display:none; }

  .slide-track{
    position:relative;
    height:56px;
    border-radius:999px;
    background:#f7f8f9;
    overflow:hidden;
    user-select:none;
    touch-action:none;
  }

  .slide-fill{
    position:absolute;
    inset:0;
    width:0;
    background:var(--brand);
    border-radius:999px;
    pointer-events:none;
    transition:width .18s ease-out;
    box-sizing:content-box;
    padding-right:8px;
  }

  .slide-label{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    font-size:17px;
    font-weight:600;
    letter-spacing:.2px;
  }

  .slide-label span{
    color:var(--brand);
    animation:slidePulse 1.8s ease-in-out infinite;
  }

  .slide-track.filled .slide-label span{
    color:#fff;
  }

  @keyframes slidePulse{
    0%,100%{ opacity:.75; }
    50%{ opacity:1; }
  }

  .slide-knob{
    position:absolute;
    top:50%;
    left:4px;
    width:48px;
    height:48px;
    border-radius:50%;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 8px 16px rgba(15,23,42,0.18);
    transform:translate(0,-50%);
    touch-action:none;
  }

  .slide-knob .arrow{
    font-size:20px;
    color:var(--brand);
  }
</style>
</head>

<body>
<div class="container">
  <div class="weather">Enable location for weather</div>

  <h1>Welcome back Jy</h1>
  <div id="subtitle">What would you like to train?</div>

  <div id="radioRow">
    <label class="opt" data-mode="pull">
      <input type="radio" name="mode" value="pull"> Pull
    </label>
    <label class="opt" data-mode="push">
      <input type="radio" name="mode" value="push"> Push
    </label>
    <label class="opt" data-mode="legs">
      <input type="radio" name="mode" value="legs"> Legs
    </label>
    <label class="opt" data-mode="full">
      <input type="radio" name="mode" value="full"> Full body
    </label>
  </div>

  <!-- PREVIEW CARD -->
  <div id="previewCard" class="preview-card hidden">
    <div id="previewTitle" class="preview-title"></div>
    <div id="previewLines" class="preview-lines"></div>
  </div>

  <div id="aiStage" class="ai-stage"></div>

  <div id="card">
    <div id="dayTitle"></div>
    <div id="lines"></div>
  </div>

  <div id="bigTimer" class="hidden">
    <div class="t-col">
      <div id="tHours" class="t-num">00</div>
      <div class="t-label">HOURS</div>
    </div>
    <div class="t-col">
      <div id="tMins" class="t-num">00</div>
      <div class="t-label">MINS</div>
    </div>
    <div class="t-col">
      <div id="tSecs" class="t-num">SECS</div>
      <div class="t-label">SECS</div>
    </div>
  </div>
</div>

<button id="mainBtn">Generate</button>

<div id="slideWrap" class="slide-wrap hidden">
  <div class="slide-track">
    <div class="slide-fill"></div>
    <div class="slide-label"><span>Slide To Complete</span></div>
    <div class="slide-knob">
      <span class="arrow">â†’</span>
    </div>
  </div>
</div>

<!-- CONFETTI LIB -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* -----------------------------------------
   CONFIG / UTIL
----------------------------------------- */
const DEV = new URLSearchParams(location.search).get("dev")==="true";
const START_HOUR = 17;
const START_MIN = 30;

const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

function todayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function weekKey(){
  const d=new Date();
  const jan1=new Date(d.getFullYear(),0,1);
  const days=Math.floor((d-jan1)/86400000);
  const week=Math.ceil((days+d.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
}

function getStartTime(tomorrow=false){
  const d=new Date();
  if(tomorrow) d.setDate(d.getDate()+1);
  d.setHours(START_HOUR,START_MIN,0,0);
  return d;
}

function afterStart(){
  if(DEV) return true;
  return new Date() >= getStartTime(false);
}

/* -----------------------------------------
   STORAGE
----------------------------------------- */
function resetWeekIfNeeded(){
  if(DEV) return;
  const cur=weekKey();
  const prev=localStorage.getItem("jy_weekKey");
  if(cur!==prev){
    localStorage.setItem("jy_weekKey",cur);
    localStorage.removeItem("jy_locks");
    localStorage.removeItem("jy_workoutToday");
    localStorage.removeItem("jy_completedToday");
  }
}

function loadLocks(){
  if(DEV) return {};
  try{
    return JSON.parse(localStorage.getItem("jy_locks")||"{}");
  }catch{return {};}
}

function saveLocks(obj){
  if(DEV) return;
  localStorage.setItem("jy_locks",JSON.stringify(obj));
}

function saveWorkoutToday(data){
  if(DEV) return;
  localStorage.setItem("jy_workoutToday",JSON.stringify({date:todayKey(),data}));
}

function loadWorkoutToday(){
  if(DEV) return null;
  const raw=localStorage.getItem("jy_workoutToday");
  if(!raw) return null;
  try{
    const obj=JSON.parse(raw);
    if(obj.date===todayKey()) return obj.data;
  }catch{}
  return null;
}

function saveCompletedToday(mode){
  if(DEV) return;
  localStorage.setItem("jy_completedToday",JSON.stringify({date:todayKey(),mode}));
}

function loadCompletedToday(){
  if(DEV) return null;
  const raw=localStorage.getItem("jy_completedToday");
  if(!raw) return null;
  try{
    const obj=JSON.parse(raw);
    if(obj.date===todayKey()) return obj;
  }catch{}
  return null;
}

/* -----------------------------------------
   DOM REFS
----------------------------------------- */
const subtitleEl = qs("#subtitle");
const radioRow   = qs("#radioRow");
const aiStage    = qs("#aiStage");
const cardEl     = qs("#card");
const dayTitleEl = qs("#dayTitle");
const linesEl    = qs("#lines");
const mainBtn    = qs("#mainBtn");
const bigTimer   = qs("#bigTimer");
const tH         = qs("#tHours");
const tM         = qs("#tMins");
const tS         = qs("#tSecs");
const weatherEl  = qs(".weather");

const slideWrap  = qs("#slideWrap");
const slideTrack = qs("#slideWrap .slide-track");
const slideFill  = qs("#slideWrap .slide-fill");
const slideLabel = qs("#slideWrap .slide-label span");
const slideKnob  = qs("#slideWrap .slide-knob");

/* Preview Card DOM */
const previewCard   = qs("#previewCard");
const previewTitle  = qs("#previewTitle");
const previewLines  = qs("#previewLines");

let selectedMode    = null;
let currentWorkout  = null;
let pendingWorkout  = null; 
let countdownInterval = null;

/* -----------------------------------------
   COUNTDOWN / BIG TIMER
----------------------------------------- */
function stopCountdown(){
  if(countdownInterval){
    clearInterval(countdownInterval);
    countdownInterval=null;
  }
}

function startBigTimer(target){
  stopCountdown();
  bigTimer.classList.remove("hidden");
  requestAnimationFrame(()=>bigTimer.classList.add("show"));

  function tick(){
    const now=new Date();
    let diff=target-now;
    if(diff<=0){
      stopCountdown();
      bigTimer.classList.remove("show");
      setTimeout(()=>{
        bigTimer.classList.add("hidden");
        initUI();
      },300);
      return;
    }
    const totalSec=Math.floor(diff/1000);
    const h=String(Math.floor(totalSec/3600)).padStart(2,"0");
    const m=String(Math.floor((totalSec%3600)/60)).padStart(2,"0");
    const s=String(totalSec%60).padStart(2,"0");
    tH.textContent=h;
    tM.textContent=m;
    tS.textContent=s;
  }

  tick();
  countdownInterval=setInterval(tick,1000);
}

/* -----------------------------------------
   LOCKS / RADIOS
----------------------------------------- */
function anyUnlockedModes(){
  if(DEV) return true;
  const locks=loadLocks();
  return ["pull","push","legs","full"].some(k=>!locks[k]);
}

function applyLocksToRadios(){
  const locks=loadLocks();
  qsa(".opt").forEach(lbl=>{
    const mode=lbl.dataset.mode;
    const input=lbl.querySelector("input");
    lbl.classList.remove("disabled");
    input.disabled=false;
    if(!DEV && locks[mode]){
      lbl.classList.add("disabled");
      input.disabled=true;
    }
  });
}

function clearRadioSelection(){
  qsa("input[name='mode']").forEach(r=>{r.checked=false;});
  qsa(".opt").forEach(lbl=>lbl.classList.remove("active"));
}

/* -----------------------------------------
   WORKOUT GENERATION LOGIC
----------------------------------------- */
const METALS = ["Metacon","EMOM","Ladder","AMRAP","Tabata"];
const rand = arr => arr[Math.floor(Math.random()*arr.length)];

function buildWorkout(mode){
  const items=[];
  let weightedUsed=false, absUsed=false, shouldersUsed=false,
      bicepsUsed=false, kettlebellUsed=false;

  if(mode==="push" || mode==="pull"){
    items.push({label:"Sets & Reps", weighted:true});
    weightedUsed=true;

    const m1={ label: rand(METALS) };
    const m2={ label: rand(METALS) };

    if(mode==="push" && Math.random()<0.5){
      m1.shoulders=true;
    }
    if(mode==="pull" && Math.random()<0.5){
      m1.biceps=true;
    }

    if(!absUsed && Math.random()<0.5){
      m2.abs=true;
      absUsed=true;
    }

    if(Math.random()<0.5) m1.weighted=true;
    else if(Math.random()<0.5) m2.weighted=true;

    items.push(m1,m2);

  } else if(mode==="legs"){
    const count=Math.random()<0.5 ? 2 : 3;
    for(let i=0;i<count;i++){
      const m={ label: rand(METALS) };

      if(!kettlebellUsed && Math.random()<0.5){
        m.kettlebell=true;
        kettlebellUsed=true;
      } else if(!weightedUsed && Math.random()<0.5){
        m.weighted=true;
        weightedUsed=true;
      }

      if(!absUsed && Math.random()<0.5){
        m.abs=true;
        absUsed=true;
      }

      items.push(m);
    }

  } else if(mode==="full"){
    const count=Math.random()<0.5 ? 3 : 4;
    for(let i=0;i<count;i++){
      const m={ label: rand(METALS) };

      if(!weightedUsed && Math.random()<0.5){
        m.weighted=true;
        weightedUsed=true;
      }
      if(!absUsed && Math.random()<0.5){
        m.abs=true;
        absUsed=true;
      }
      items.push(m);
    }
  }

  return {mode,items};
}

function modeTitle(mode){
  if(mode==="pull") return "Pull Day";
  if(mode==="push") return "Push Day";
  if(mode==="legs") return "Legs Day";
  if(mode==="full") return "Full Body Day";
  return "Workout";
}

/* -----------------------------------------
   PREVIEW CARD (RANDOMIZED, NO SPOILERS)
----------------------------------------- */

const PREVIEW_TAGS = [
  {label:"Weighted", class:"preview-tag preview-tag-weighted"},
  {label:"Abs", class:"preview-tag preview-tag-abs"},
  {label:"Shoulders", class:"preview-tag preview-tag-shoulders"},
  {label:"Biceps", class:"preview-tag preview-tag-biceps"},
  {label:"Kettlebell", class:"preview-tag preview-tag-kettlebell"},
  null, null // allow blank rows sometimes
];

function randomPreviewRows(){
  const rows = [];
  const count = 3; // always 3 rows

  for(let i=0;i<count;i++){
    const pick = PREVIEW_TAGS[Math.floor(Math.random()*PREVIEW_TAGS.length)];

    rows.push({
      tagLabel: pick ? pick.label : null,
      tagClass: pick ? pick.class : null
    });
  }
  return rows;
}

function renderPreviewCard(mode){
  if(!previewCard) return;

  previewTitle.textContent = modeTitle(mode);
  previewLines.innerHTML = "";

  const rows = randomPreviewRows();

  rows.forEach(r=>{
    const row = document.createElement("div");
    row.className = "preview-row";

    // wireframe (always)
    const wire = document.createElement("div");
    wire.className = "preview-wire";
    row.appendChild(wire);

    // tag (sometimes)
    if(r.tagLabel){
      const tag = document.createElement("span");
      tag.className = r.tagClass;
      tag.textContent = r.tagLabel;
      row.appendChild(tag);
    } else {
      const spacer = document.createElement("span");
      spacer.style.minWidth="50px";
      row.appendChild(spacer);
    }

    previewLines.appendChild(row);
  });
}

function showPreviewCard(){
  previewCard.classList.remove("hidden");
  previewCard.classList.remove("show");
  void previewCard.offsetWidth;
  previewCard.classList.add("show");
}

function hidePreviewCard(immediate=false){
  if(immediate){
    previewCard.classList.remove("show");
    previewCard.classList.add("hidden");
  } else {
    previewCard.classList.remove("show");
    setTimeout(()=>previewCard.classList.add("hidden"),260);
  }
}

function updatePreviewForMode(mode){
  if(!mode){
    hidePreviewCard();
    return;
  }
  renderPreviewCard(mode);
  showPreviewCard();
}

/* -----------------------------------------
   RENDER REAL WORKOUT CARD
----------------------------------------- */
function renderWorkoutCard(workout){
  const {mode,items}=workout;
  dayTitleEl.textContent = modeTitle(mode);
  linesEl.innerHTML = "";

  items.forEach(it=>{
    const row=document.createElement("div");
    row.className="line";
    row.appendChild(document.createTextNode(it.label));

    if(it.weighted){
      const p=document.createElement("span");
      p.className="pill pill-weighted";
      p.textContent="Weighted";
      row.appendChild(p);
    }
    if(it.abs){
      const p=document.createElement("span");
      p.className="pill pill-abs";
      p.textContent="Abs";
      row.appendChild(p);
    }
    if(it.shoulders){
      const p=document.createElement("span");
      p.className="pill pill-shoulders";
      p.textContent="Shoulders";
      row.appendChild(p);
    }
    if(it.biceps){
      const p=document.createElement("span");
      p.className="pill pill-biceps";
      p.textContent="Biceps";
      row.appendChild(p);
    }
    if(it.kettlebell){
      const p=document.createElement("span");
      p.className="pill pill-kettlebell";
      p.textContent="Kettlebell";
      row.appendChild(p);
    }

    linesEl.appendChild(row);
  });

  cardEl.style.display = "block";
}

/* -----------------------------------------
   VIEW STATES
----------------------------------------- */
function showSelectionState(){
  stopCountdown();
  bigTimer.classList.add("hidden");
  bigTimer.classList.remove("show");

  subtitleEl.textContent="What would you like to train?";
  radioRow.style.display="flex";
  applyLocksToRadios();
  cardEl.style.display="none";
  aiStage.style.display="none";

  mainBtn.textContent="Generate";
  mainBtn.onclick=handleGenerate;
  mainBtn.classList.remove("hidden");
  mainBtn.classList.add("disabled");

  slideWrap.classList.add("hidden");
  hidePreviewCard(true);
}

function showPreLockedState(){
  subtitleEl.textContent="Next workout in";
  radioRow.style.display="none";
  cardEl.style.display="none";
  aiStage.style.display="none";
  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");
  hidePreviewCard(true);
  startBigTimer(getStartTime(false));
}

function showWorkoutState(workout){
  stopCountdown();
  bigTimer.classList.add("hidden");
  bigTimer.classList.remove("show");

  currentWorkout = workout;

  subtitleEl.textContent="Today's workout";
  renderWorkoutCard(workout);
  radioRow.style.display="none";

  mainBtn.classList.add("hidden");
  slideWrap.classList.remove("hidden");
  resetSlider();

  hidePreviewCard(true);
}

function showCompletedState(){
  subtitleEl.textContent="Next workout in";
  radioRow.style.display="none";
  cardEl.style.display="none";
  aiStage.style.display="none";

  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");

  hidePreviewCard(true);
  startBigTimer(getStartTime(true));
}

function showAllUsedWeekState(){
  subtitleEl.textContent="All workouts used this week";
  radioRow.style.display="none";
  cardEl.style.display="none";
  aiStage.style.display="none";

  mainBtn.classList.add("hidden");
  slideWrap.classList.add("hidden");
  bigTimer.classList.add("hidden");

  hidePreviewCard(true);
}

/* -----------------------------------------
   INIT UI LOGIC
----------------------------------------- */
function initUI(){
  resetWeekIfNeeded();
  clearRadioSelection();
  pendingWorkout = null;
  selectedMode = null;
  hidePreviewCard(true);

  if(DEV){
    const workout = loadWorkoutToday();
    if(workout){
      showWorkoutState(workout);
    }else{
      showSelectionState();
    }
    return;
  }

  const workout = loadWorkoutToday();
  const completed = loadCompletedToday();
  const lockedByTime = !afterStart();

  if(!workout && !completed && lockedByTime){
    showPreLockedState();
    return;
  }

  if(completed){
    showCompletedState();
    return;
  }

  if(workout){
    showWorkoutState(workout);
    return;
  }

  if(!anyUnlockedModes()){
    showAllUsedWeekState();
    return;
  }

  showSelectionState();
}

/* -----------------------------------------
   WEATHER
----------------------------------------- */
function weatherCodeToText(code){
  const map={
    0:"Clear sky",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
    45:"Fog",48:"Fog",
    51:"Drizzle",53:"Drizzle",55:"Drizzle",
    61:"Rain",63:"Rain",65:"Rain",
    71:"Snow",73:"Snow",75:"Snow",
    80:"Rain shower",81:"Rain shower",82:"Rain shower",
    95:"Thunderstorm",96:"Thunderstorm",99:"Thunderstorm"
  };
  return map[code] || "Unknown";
}

function getWeatherEmoji(cond){
  const c=cond.toLowerCase();
  if(c.includes("clear")) return "â˜€ï¸";
  if(c.includes("cloud")) return "â›…";
  if(c.includes("rain")) return "ðŸŒ§ï¸";
  if(c.includes("drizzle")) return "ðŸŒ¦ï¸";
  if(c.includes("thunder")) return "ðŸŒ©ï¸";
  if(c.includes("snow")) return "â„ï¸";
  if(c.includes("fog")||c.includes("mist")) return "ðŸŒ«ï¸";
  return "ðŸŒ¡ï¸";
}

function updateWeatherUI(){
  if(!weatherEl) return;

  if(!navigator.geolocation){
    weatherEl.textContent="Location unavailable";
    return;
  }

  weatherEl.textContent="Loading weatherâ€¦";

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;

    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res=await fetch(url);
      const data=await res.json();

      const temp=Math.round(data.current_weather.temperature);
      const cond=weatherCodeToText(data.current_weather.weathercode);
      const emoji=getWeatherEmoji(cond);

      let city="Your area";
      try{
        const rev=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const r=await rev.json();
        city = r.address.city || r.address.town || r.address.village || r.address.county || city;
      }catch(e){}

      weatherEl.textContent=`${emoji} ${temp}Â°C ${city}`;
    }catch(e){
      weatherEl.textContent="Weather unavailable";
    }
  },err=>{
    weatherEl.textContent="Enable location for weather";
  },{
    timeout:10000,
    maximumAge:600000
  });
}

/* -----------------------------------------
   RADIO SELECTION
----------------------------------------- */
qsa("input[name='mode']").forEach(r=>{
  r.addEventListener("change",()=>{
    selectedMode = r.value;

    qsa(".opt").forEach(lbl=>{
      lbl.classList.toggle("active", lbl.dataset.mode === selectedMode);
    });

    mainBtn.textContent = `Generate ${modeTitle(selectedMode).replace(" Day","")}`;
    mainBtn.classList.remove("disabled");

    updatePreviewForMode(selectedMode);

    if(navigator.vibrate) navigator.vibrate(8);
  });
});

 /* -----------------------------------------
   GENERATE WORKOUT
----------------------------------------- */
function handleGenerate(){
  if(!selectedMode) return;

  hidePreviewCard();

  aiStage.style.display="block";
  aiStage.classList.add("show");
  mainBtn.disabled=true;
  mainBtn.textContent="Generating...";
  cardEl.style.display="none";

  setTimeout(()=>{
    const workout = pendingWorkout || buildWorkout(selectedMode);
    currentWorkout = workout;
    pendingWorkout = null;

    if(!DEV){
      saveWorkoutToday(workout);
      const locks=loadLocks();
      locks[selectedMode]=true;
      saveLocks(locks);
    }

    aiStage.classList.remove("show");
    aiStage.style.display="none";
    mainBtn.disabled=false;

    showWorkoutState(workout);
  },900);
}

/* -----------------------------------------
   COMPLETE WORKOUT (SLIDE SUCCESS)
----------------------------------------- */
function handleComplete(){
  if(window.confetti){
    confetti({
      particleCount:160,
      spread:90,
      startVelocity:35,
      origin:{ x:0.5, y:1.05 }
    });
  }

  if(navigator.vibrate){
    navigator.vibrate(15);
  }

  saveCompletedToday(currentWorkout?.mode || "workout");
  cardEl.style.display="none";
  slideWrap.classList.add("hidden");

  setTimeout(()=>{ showCompletedState(); },600);
}

/* -----------------------------------------
   SLIDER LOGIC
----------------------------------------- */
let sliding=false;
let slideStartX=0;
let maxSlide=0;

function resetSlider(){
  const knobW = slideKnob.offsetWidth || 48;

  slideKnob.style.transition="none";
  slideFill.style.transition="none";

  slideKnob.style.transform="translate(0,-50%)";
  slideFill.style.width=`${knobW}px`;
  slideTrack.classList.remove("filled");

  setTimeout(()=>{
    slideKnob.style.transition="";
    slideFill.style.transition="width .18s ease-out";
  },20);
}

slideKnob.addEventListener("pointerdown",(e)=>{
  e.preventDefault();
  sliding=true;

  slideKnob.setPointerCapture(e.pointerId);
  slideKnob.style.transition="none";
  slideFill.style.transition="none";

  const trackRect=slideTrack.getBoundingClientRect();
  const knobRect=slideKnob.getBoundingClientRect();

  maxSlide = trackRect.width - knobRect.width - 8;
  slideStartX = e.clientX;
});

slideKnob.addEventListener("pointermove",(e)=>{
  if(!sliding) return;

  const knobRect=slideKnob.getBoundingClientRect();
  const dx=e.clientX - slideStartX;
  let x = Math.max(0, Math.min(maxSlide, dx));

  slideKnob.style.transform = `translate(${x}px,-50%)`;
  slideFill.style.width = `${x + knobRect.width}px`;

  const trackWidth = slideTrack.offsetWidth;
  const labelCenter = trackWidth/2;
  const knobCenter = 4 + knobRect.width/2 + x;

  if(knobCenter > labelCenter){
    slideTrack.classList.add("filled");
  }else{
    slideTrack.classList.remove("filled");
  }
});

function endSlide(e){
  if(!sliding) return;
  sliding=false;

  if(e.pointerId){
    slideKnob.releasePointerCapture(e.pointerId);
  }

  const knobRect=slideKnob.getBoundingClientRect();
  const match=/translate\(([-0-9.]+)px/.exec(slideKnob.style.transform);
  const x = match ? parseFloat(match[1]) : 0;

  slideKnob.style.transition="transform .22s ease-out";
  slideFill.style.transition="width .22s ease-out";

  if(x >= maxSlide*0.9){
    slideKnob.style.transform=`translate(${maxSlide}px,-50%)`;
    slideFill.style.width=`${maxSlide + knobRect.width}px`;
    slideTrack.classList.add("filled");

    if(navigator.vibrate) navigator.vibrate(15);

    handleComplete();
  }else{
    slideTrack.classList.remove("filled");
    slideKnob.style.transform="translate(0,-50%)";
    slideFill.style.width=`${knobRect.width}px`;

    setTimeout(()=>{
      slideKnob.style.transition="";
      slideFill.style.transition="width .18s ease-out";
    },240);
  }
}

slideKnob.addEventListener("pointerup", endSlide);
slideKnob.addEventListener("pointercancel", endSlide);

/* -----------------------------------------
   BOOT
----------------------------------------- */
initUI();
updateWeatherUI();
</script>
</body>
</html> 
