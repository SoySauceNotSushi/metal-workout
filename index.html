<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metal Workout Builder</title>

<style>
:root {
  --brand:#2453f5;
  --ink:#0f172a;
  --sub:#64748b;
  --bg:#ffffff;
  --card:#f1f5f9;
  --pill:#8e8eff;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro", Segoe UI, Roboto, sans-serif;
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--ink);
}

/* Layout */
.container {
  padding: 24px;
  max-width: 480px;
  margin: auto;
}

/* Weather */
.weather {
  font-size: 16px;
  color: var(--sub);
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Typography */
h1 {
  font-size: 32px;
  margin: 16px 0 32px;
}

/* Workout card */
.workout-card {
  background: var(--card);
  padding: 24px;
  border-radius: 28px;
  margin-bottom: 24px;
}

.section-title {
  font-weight: 600;
  font-size: 20px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Timer */
#timerContainer {
  text-align: center;
  margin-top: 60px;
}

#timerRow {
  display: flex;
  justify-content: center;
  gap: 40px;
  margin-top: 12px;
}

.timeBlock {
  text-align: center;
}

.timeValue {
  font-size: 48px;
  color: var(--ink);
  font-weight: 400;
}

.timeLabel {
  margin-top: 6px;
  font-size: 14px;
  color: var(--sub);
  text-transform: uppercase;
}

/* Button */
.fab {
  width: 100%;
  background: var(--brand);
  color:#fff;
  border:none;
  border-radius:32px;
  font-size:20px;
  height:58px;
  cursor:pointer;
  margin-top:40px;
  display:flex;
  align-items:center;
  justify-content:center;
}
</style>
</head>

<body>
<div class="container">
  
  <!-- Weather -->
  <div id="weather" class="weather">Loading weatherâ€¦</div>
  
  <h1>Hi Jy, welcome back</h1>

  <!-- COUNTDOWN ONLY IN REAL MODE -->
  <div id="timerContainer" style="display:none;">
    <div style="font-size:18px; color:var(--sub); margin-bottom:18px;">Workout will open in</div>

    <div id="timerRow">
      <div class="timeBlock">
        <div id="h" class="timeValue">00</div>
        <div class="timeLabel">HOURS</div>
      </div>
      <div class="timeBlock">
        <div id="m" class="timeValue">00</div>
        <div class="timeLabel">MINS</div>
      </div>
      <div class="timeBlock">
        <div id="s" class="timeValue">00</div>
        <div class="timeLabel">SECS</div>
      </div>
    </div>
  </div>

  <!-- Workout output area -->
  <div id="workoutArea"></div>

  <!-- Create Workout Button -->
  <button id="createBtn" class="fab">Create Workout</button>

</div>

<script>
/* -------------------------------------------------------------
   DEV MODE
------------------------------------------------------------- */
const urlParams = new URLSearchParams(window.location.search);
const isDevMode = urlParams.get("dev") === "true";

/* -------------------------------------------------------------
   WEATHER
------------------------------------------------------------- */
async function getWeatherEmoji(code) {
  // simple mapping
  if (code === 0) return "â˜€ï¸";
  if ([1,2,3].includes(code)) return "ðŸŒ¤ï¸";
  if ([45,48].includes(code)) return "ðŸŒ«ï¸";
  if ([51,53,55,56,57].includes(code)) return "ðŸŒ¦ï¸";
  if ([61,63,65].includes(code)) return "ðŸŒ§ï¸";
  if ([71,73,75].includes(code)) return "â„ï¸";
  if ([95,96,99].includes(code)) return "â›ˆï¸";
  return "ðŸŒ¡ï¸";
}

async function updateWeather() {
  const weatherEl = document.getElementById("weather");
  
  try {
    if (!navigator.geolocation) {
      weatherEl.textContent = "Enable location for weather";
      return;
    }

    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // Fetch from Open-Meteo
      const w = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
      );
      const data = await w.json();

      const temp = data.current_weather.temperature;
      const code = data.current_weather.weathercode;
      const emoji = await getWeatherEmoji(code);

      // Reverse geocode city
      const rev = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
      );
      const r = await rev.json();
      const city = r.address.city || r.address.town || r.address.village || "Your area";

      weatherEl.innerHTML = `${emoji} ${temp}Â°C ${city}`;
    },
    () => { weatherEl.textContent = "Enable location for weather"; });
  } catch {
    weatherEl.textContent = "Weather unavailable";
  }
}
updateWeather();


/* -------------------------------------------------------------
   WORKOUT GENERATOR
------------------------------------------------------------- */

function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

function generateWorkoutContent() {
  const metalTypes = ["EMOM","AMRAP","Ladder","Tabata","Metacon"];
  
  const fullBodyChance = Math.random() < 0.5;
  let sections = [];

  if (fullBodyChance) {
    const count = Math.random() < 0.5 ? 2 : 3;
    const metals = [];
    while (metals.length < count) {
      const m = pick(metalTypes);
      if (!metals.includes(m)) metals.push(m);
    }
    sections.push({
      title: "ðŸ”¥ Full body",
      items: metals
    });
  } else {
    const upper = pick(metalTypes);
    const lower = pick(metalTypes.filter(x=>x!==upper));
    
    const upperCount = Math.random() < 0.5 ? 1 : 2;
    const lowerCount = upperCount === 1 ? 2 : 1; // opposite rule
    
    const upperList = [upper];
    while (upperList.length < upperCount) {
      const m = pick(metalTypes.filter(x=>!upperList.includes(x)));
      upperList.push(m);
    }

    const lowerList = [lower];
    while (lowerList.length < lowerCount) {
      const m = pick(metalTypes.filter(x=>!lowerList.includes(x)));
      lowerList.push(m);
    }

    sections.push({ title:"ðŸ’ª Upper Body", items:upperList });
    sections.push({ title:"ðŸ‹ï¸ Lower Body", items:lowerList });
  }

  return sections;
}

function renderWorkout(sections) {
  const area = document.getElementById("workoutArea");

  // In DEV MODE: infinite stacking
  // In LIVE MODE: clear and overwrite
  if (!isDevMode) {
    area.innerHTML = "";
  }

  sections.forEach(sec => {
    const card = document.createElement("div");
    card.className = "workout-card";

    let html = `<div class="section-title">${sec.title}</div>`;
    sec.items.forEach(i => {
      html += `<div style="font-size:18px; margin-bottom:6px;">${i}</div>`;
    });
    card.innerHTML = html;

    area.appendChild(card);
  });
}


/* -------------------------------------------------------------
   TIME WINDOW (REAL MODE ONLY)
------------------------------------------------------------- */

function isWithinOpenWindow() {
  if (isDevMode) return true; // dev bypass
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  
  // Allowed window: 17:30 â†’ 23:00
  if (h > 17 || (h === 17 && m >= 30)) return true;
  if (h < 23) return false;
  return false;
}

function nextOpeningTime() {
  const now = new Date();
  const open = new Date();
  open.setHours(17,30,0,0);

  if (now > open) {
    // already past open
    return now;
  }
  return open;
}

function updateCountdown() {
  if (isDevMode) {
    document.getElementById("timerContainer").style.display = "none";
    return;
  }

  if (isWithinOpenWindow()) {
    document.getElementById("timerContainer").style.display = "none";
    return;
  }

  const timer = document.getElementById("timerContainer");
  timer.style.display = "block";

  const open = nextOpeningTime();
  const now = new Date();
  let diff = Math.max(0, open - now);

  let h = Math.floor(diff / 3600000);
  let m = Math.floor((diff % 3600000) / 60000);
  let s = Math.floor((diff % 60000) / 1000);

  document.getElementById("h").textContent = String(h).padStart(2,"0");
  document.getElementById("m").textContent = String(m).padStart(2,"0");
  document.getElementById("s").textContent = String(s).padStart(2,"0");
}

setInterval(updateCountdown, 1000);
updateCountdown();


/* -------------------------------------------------------------
   BUTTON BEHAVIOR
------------------------------------------------------------- */
const createBtn = document.getElementById("createBtn");

function updateButtonState() {
  if (isDevMode) {
    createBtn.style.display = "block";
    return;
  }

  if (isWithinOpenWindow()) {
    createBtn.style.display = "block";
  } else {
    createBtn.style.display = "none";
  }
}

setInterval(updateButtonState, 1000);
updateButtonState();

createBtn.onclick = () => {
  const workout = generateWorkoutContent();
  renderWorkout(workout);
};
</script>

</body>
</html>
